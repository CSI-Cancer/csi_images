<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.0"/>
    <title>csi_images.csi_events API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#49483e}.pdoc-code{background:#272822; color:#f8f8f2}.pdoc-code .c{color:#75715e}.pdoc-code .err{color:#960050; background-color:#1e0010}.pdoc-code .esc{color:#f8f8f2}.pdoc-code .g{color:#f8f8f2}.pdoc-code .k{color:#66d9ef}.pdoc-code .l{color:#ae81ff}.pdoc-code .n{color:#f8f8f2}.pdoc-code .o{color:#f92672}.pdoc-code .x{color:#f8f8f2}.pdoc-code .p{color:#f8f8f2}.pdoc-code .ch{color:#75715e}.pdoc-code .cm{color:#75715e}.pdoc-code .cp{color:#75715e}.pdoc-code .cpf{color:#75715e}.pdoc-code .c1{color:#75715e}.pdoc-code .cs{color:#75715e}.pdoc-code .gd{color:#f92672}.pdoc-code .ge{color:#f8f8f2; font-style:italic}.pdoc-code .gr{color:#f8f8f2}.pdoc-code .gh{color:#f8f8f2}.pdoc-code .gi{color:#a6e22e}.pdoc-code .go{color:#66d9ef}.pdoc-code .gp{color:#f92672; font-weight:bold}.pdoc-code .gs{color:#f8f8f2; font-weight:bold}.pdoc-code .gu{color:#75715e}.pdoc-code .gt{color:#f8f8f2}.pdoc-code .kc{color:#66d9ef}.pdoc-code .kd{color:#66d9ef}.pdoc-code .kn{color:#f92672}.pdoc-code .kp{color:#66d9ef}.pdoc-code .kr{color:#66d9ef}.pdoc-code .kt{color:#66d9ef}.pdoc-code .ld{color:#e6db74}.pdoc-code .m{color:#ae81ff}.pdoc-code .s{color:#e6db74}.pdoc-code .na{color:#a6e22e}.pdoc-code .nb{color:#f8f8f2}.pdoc-code .nc{color:#a6e22e}.pdoc-code .no{color:#66d9ef}.pdoc-code .nd{color:#a6e22e}.pdoc-code .ni{color:#f8f8f2}.pdoc-code .ne{color:#a6e22e}.pdoc-code .nf{color:#a6e22e}.pdoc-code .nl{color:#f8f8f2}.pdoc-code .nn{color:#f8f8f2}.pdoc-code .nx{color:#a6e22e}.pdoc-code .py{color:#f8f8f2}.pdoc-code .nt{color:#f92672}.pdoc-code .nv{color:#f8f8f2}.pdoc-code .ow{color:#f92672}.pdoc-code .w{color:#f8f8f2}.pdoc-code .mb{color:#ae81ff}.pdoc-code .mf{color:#ae81ff}.pdoc-code .mh{color:#ae81ff}.pdoc-code .mi{color:#ae81ff}.pdoc-code .mo{color:#ae81ff}.pdoc-code .sa{color:#e6db74}.pdoc-code .sb{color:#e6db74}.pdoc-code .sc{color:#e6db74}.pdoc-code .dl{color:#e6db74}.pdoc-code .sd{color:#e6db74}.pdoc-code .s2{color:#e6db74}.pdoc-code .se{color:#ae81ff}.pdoc-code .sh{color:#e6db74}.pdoc-code .si{color:#e6db74}.pdoc-code .sx{color:#e6db74}.pdoc-code .sr{color:#e6db74}.pdoc-code .s1{color:#e6db74}.pdoc-code .ss{color:#e6db74}.pdoc-code .bp{color:#f8f8f2}.pdoc-code .fm{color:#a6e22e}.pdoc-code .vc{color:#f8f8f2}.pdoc-code .vg{color:#f8f8f2}.pdoc-code .vi{color:#f8f8f2}.pdoc-code .vm{color:#f8f8f2}</style>
    <style>/*! theme.css */:root{--pdoc-background:#212529;}.pdoc{--text:#f7f7f7;--muted:#9d9d9d;--link:#58a6ff;--link-hover:#3989ff;--code:#333;--active:#555;--accent:#343434;--accent2:#555;--nav-hover:rgba(0, 0, 0, 0.1);--name:#77C1FF;--def:#0cdd0c;--annotation:#00c037;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../csi_images.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;csi_images</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Event">Event</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Event.__init__">Event</a>
                        </li>
                        <li>
                                <a class="variable" href="#Event.SCAN_TO_SLIDE_TRANSFORM">SCAN_TO_SLIDE_TRANSFORM</a>
                        </li>
                        <li>
                                <a class="variable" href="#Event.scan">scan</a>
                        </li>
                        <li>
                                <a class="variable" href="#Event.tile">tile</a>
                        </li>
                        <li>
                                <a class="variable" href="#Event.x">x</a>
                        </li>
                        <li>
                                <a class="variable" href="#Event.y">y</a>
                        </li>
                        <li>
                                <a class="variable" href="#Event.size">size</a>
                        </li>
                        <li>
                                <a class="variable" href="#Event.metadata">metadata</a>
                        </li>
                        <li>
                                <a class="variable" href="#Event.features">features</a>
                        </li>
                        <li>
                                <a class="function" href="#Event.get_scan_position">get_scan_position</a>
                        </li>
                        <li>
                                <a class="function" href="#Event.get_slide_position">get_slide_position</a>
                        </li>
                        <li>
                                <a class="function" href="#Event.crop_images">crop_images</a>
                        </li>
                        <li>
                                <a class="function" href="#Event.extract_images">extract_images</a>
                        </li>
                        <li>
                                <a class="function" href="#Event.extract_images_for_list">extract_images_for_list</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#EventArray">EventArray</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#EventArray.__init__">EventArray</a>
                        </li>
                        <li>
                                <a class="variable" href="#EventArray.INFO_COLUMNS">INFO_COLUMNS</a>
                        </li>
                        <li>
                                <a class="variable" href="#EventArray.info">info</a>
                        </li>
                        <li>
                                <a class="variable" href="#EventArray.metadata">metadata</a>
                        </li>
                        <li>
                                <a class="variable" href="#EventArray.features">features</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.get_sort_order">get_sort_order</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.sort">sort</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.get">get</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.rows">rows</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.copy">copy</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.add_metadata">add_metadata</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.add_features">add_features</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.merge">merge</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.to_events">to_events</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.from_events">from_events</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.to_dataframe">to_dataframe</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.from_dataframe">from_dataframe</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.from_mask">from_mask</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.save_csv">save_csv</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.load_csv">load_csv</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.save_hdf5">save_hdf5</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.load_hdf5">load_hdf5</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.save_ocular">save_ocular</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.load_ocular">load_ocular</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../csi_images.html">csi_images</a><wbr>.csi_events    </h1>

                        <div class="docstring"><p>Contains the Event class, which represents a single event in a scan.
The Event class optionally holds metadata and features. Lists of events with
similar metadata or features can be combined into DataFrames for analysis.</p>

<p>The Event class holds the position of the event in the frame, which can be converted
to the position in the scanner or slide coordinate positions. See the
csi_utils.csi_scans documentation page for more information on the coordinate systems.</p>
</div>

                        <input id="mod-csi_events-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-csi_events-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="sd">Contains the Event class, which represents a single event in a scan.</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="sd">The Event class optionally holds metadata and features. Lists of events with</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="sd">similar metadata or features can be combined into DataFrames for analysis.</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="sd">The Event class holds the position of the event in the frame, which can be converted</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="sd">to the position in the scanner or slide coordinate positions. See the</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="sd">csi_utils.csi_scans documentation page for more information on the coordinate systems.</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">import</span> <span class="nn">math</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">import</span> <span class="nn">warnings</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Self</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="kn">from</span> <span class="nn">.csi_scans</span> <span class="kn">import</span> <span class="n">Scan</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="kn">from</span> <span class="nn">.csi_tiles</span> <span class="kn">import</span> <span class="n">Tile</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="kn">from</span> <span class="nn">.csi_frames</span> <span class="kn">import</span> <span class="n">Frame</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="c1"># Optional dependencies; will raise errors in particular functions if not installed</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="k">try</span><span class="p">:</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a>    <span class="kn">from</span> <span class="nn">.csi_images</span> <span class="kn">import</span> <span class="n">extract_mask_info</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a>    <span class="n">extract_mask_info</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="k">try</span><span class="p">:</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a>    <span class="kn">import</span> <span class="nn">pyreadr</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>    <span class="n">pyreadr</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="k">class</span> <span class="nc">Event</span><span class="p">:</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="sd">    A class that represents a single event in a scan, making it easy to evaluate</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="sd">    singular events. Required metadata is exposed as attributes, and optional</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="sd">    metadata and features are stored as DataFrames.</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>    <span class="n">SCAN_TO_SLIDE_TRANSFORM</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a>        <span class="c1"># Axioscan zero is in the top-right corner instead of top-left</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a>        <span class="n">Scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>            <span class="p">[</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">75000</span><span class="p">],</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a>            <span class="p">]</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>        <span class="p">),</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>        <span class="c1"># BZScanner coordinates are a special kind of messed up:</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>        <span class="c1"># - The slide is upside-down.</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a>        <span class="c1"># - The slide is oriented vertically, with the barcode at the bottom.</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>        <span class="c1"># - Tiles are numbered from the top-right</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>        <span class="n">Scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>            <span class="p">[</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">75000</span><span class="p">],</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>                <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">25000</span><span class="p">],</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>            <span class="p">]</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>        <span class="p">),</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>    <span class="p">}</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a><span class="sd">    Homogeneous transformation matrices for converting between scanner and slide</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="sd">    coordinates. The matrices are 3x3, with the final column representing the</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a><span class="sd">    translation in micrometers (um). For more information, see </span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a><span class="sd">    [affine transformations](https://en.wikipedia.org/wiki/Transformation_matrix#Affine_transformations).</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="sd">    </span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a><span class="sd">    Transformations are nominal, and accuracy is not guaranteed; this is due to </span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="sd">    imperfections in slides and alignment in the scanners. Units are in micrometers.</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>        <span class="n">scan</span><span class="p">:</span> <span class="n">Scan</span><span class="p">,</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>        <span class="n">tile</span><span class="p">:</span> <span class="n">Tile</span><span class="p">,</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>        <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>        <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>        <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>  <span class="c1"># End-to-end size in pixels</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>        <span class="n">features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>    <span class="p">):</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scan</span> <span class="o">=</span> <span class="n">scan</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile</span> <span class="o">=</span> <span class="n">tile</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>    <span class="k">def</span> <span class="nf">get_scan_position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a><span class="sd">        Get the position of the event in the scanner&#39;s coordinate frame.</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a><span class="sd">        :return: the scan position of the event in micrometers (um).</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>        <span class="c1"># Get overall pixel position</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>        <span class="n">pixel_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>        <span class="n">pixel_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>        <span class="c1"># Convert to micrometers</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>        <span class="n">x_um</span> <span class="o">=</span> <span class="n">pixel_x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>        <span class="n">y_um</span> <span class="o">=</span> <span class="n">pixel_y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>        <span class="c1"># Add the scan&#39;s origin in the scanner frame</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>        <span class="n">x_um</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n_roi</span><span class="p">]</span><span class="o">.</span><span class="n">origin_x_um</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>        <span class="n">y_um</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n_roi</span><span class="p">]</span><span class="o">.</span><span class="n">origin_y_um</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>        <span class="k">return</span> <span class="n">x_um</span><span class="p">,</span> <span class="n">y_um</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>    <span class="k">def</span> <span class="nf">get_slide_position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a><span class="sd">        Get the slide position of the event in micrometers (um).</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a><span class="sd">        :return: the slide position of the event.</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>        <span class="c1"># Turn scan_position into a 3x1 vector</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>        <span class="n">scan_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scan_position</span><span class="p">()</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>        <span class="n">scan_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">scan_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">scan_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>        <span class="c1"># Multiply by the appropriate homogeneous matrix</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>            <span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SCAN_TO_SLIDE_TRANSFORM</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">]</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>            <span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SCAN_TO_SLIDE_TRANSFORM</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">]</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scanner type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span><span class="si">}</span><span class="s2"> not supported.&quot;</span><span class="p">)</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>        <span class="n">slide_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">scan_position</span><span class="p">)</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">slide_position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">slide_position</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>    <span class="k">def</span> <span class="nf">crop_images</span><span class="p">(</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">crop_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a><span class="sd">        Get the event crops from the frame images. Called &quot;get&quot; because it does not</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a><span class="sd">        need to extract anything; it is very quick for extracting multiple events from</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a><span class="sd">        the same tile.</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a><span class="sd">        Use this if you&#39;re interested in many events.</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a><span class="sd">        :param images: the frame images.</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a><span class="sd">        :param crop_size: the square size of the image crop to get for this event.</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a><span class="sd">        :param in_pixels: whether the crop size is in pixels or micrometers. Defaults to pixels.</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a><span class="sd">        :return: image_size x image_size crops of the event in the provided frames. If</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a><span class="sd">        the event is too close to the edge, the crop will be smaller and not centered.</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>        <span class="c1"># Convert a crop size in micrometers to pixels</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_pixels</span><span class="p">:</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>            <span class="n">crop_size</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">crop_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span><span class="p">)</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>        <span class="c1"># Find the crop bounds</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">crop_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">crop_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>        <span class="p">]</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>        <span class="c1"># Determine how much the bounds violate the image size</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>        <span class="n">displacements</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>        <span class="p">]</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>        <span class="c1"># Cap off the bounds</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>            <span class="nb">min</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>            <span class="nb">min</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>        <span class="p">]</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>        <span class="c1"># Crop the images</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>        <span class="n">cropped_images</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>        <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>            <span class="c1"># Create a blank image of the right size</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>            <span class="n">cropped_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">crop_size</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>            <span class="c1"># Insert the cropped image into the blank image, leaving a black buffer</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>            <span class="c1"># around the edges if the crop would go beyond the original image bounds</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>            <span class="n">cropped_image</span><span class="p">[</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>                <span class="n">displacements</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">crop_size</span> <span class="o">-</span> <span class="n">displacements</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>                <span class="n">displacements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">crop_size</span> <span class="o">-</span> <span class="n">displacements</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>            <span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>            <span class="n">cropped_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cropped_image</span><span class="p">)</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>        <span class="k">return</span> <span class="n">cropped_images</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>    <span class="k">def</span> <span class="nf">extract_images</span><span class="p">(</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a><span class="sd">        Extract the images from the scan and tile, reading from the file. Called</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a><span class="sd">        &quot;extract&quot; because it must read and extract the images from file, which is slow.</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a><span class="sd">        Use this if you&#39;re interested in only a few events, as it is inefficient when</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a><span class="sd">        reading multiple events from the same tile.</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a><span class="sd">        :param crop_size: the square size of the image crop to get for this event.</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a><span class="sd">        :param in_pixels: whether the crop size is in pixels or micrometers. Defaults to pixels.</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a><span class="sd">        :return: a list of cropped images from the scan in the order of the channels.</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>        <span class="n">frames</span> <span class="o">=</span> <span class="n">Frame</span><span class="o">.</span><span class="n">get_frames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="p">)</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>        <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">get_image</span><span class="p">()</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">]</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_images</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="n">in_pixels</span><span class="p">)</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>    <span class="k">def</span> <span class="nf">extract_images_for_list</span><span class="p">(</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>        <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Self</span><span class="p">],</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>        <span class="n">crop_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>        <span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a><span class="sd">        Get the images for a list of events, ensuring that there is no wasteful reading</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a><span class="sd">        of the same tile multiple times. This function is more efficient than calling</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a><span class="sd">        extract_event_images for each event.</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a><span class="sd">        :param events: the events to extract images for.</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a><span class="sd">        :param crop_size: the square size of the image crop to get for this event.</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a><span class="sd">                          Defaults to four times the size of the event.</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a><span class="sd">        :param in_pixels: whether the crop size is in pixels or micrometers.</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a><span class="sd">                          Defaults to pixels, and is ignored if crop_size is None.</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a><span class="sd">        :return: a list of lists of cropped images for each event.</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>        <span class="c1"># Populate a crop size if none provided</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>        <span class="k">if</span> <span class="n">crop_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>            <span class="n">crop_size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span> <span class="o">*</span> <span class="n">event</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>            <span class="n">in_pixels</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>        <span class="c1"># Propagate a constant crop size</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crop_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>            <span class="n">crop_size</span> <span class="o">=</span> <span class="p">[</span><span class="n">crop_size</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>        <span class="c1"># Sort the events by tile; use a shallow copy to avoid modifying the original</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>        <span class="n">order</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">events</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()))</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>        <span class="c1"># Allocate the list to size</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>        <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>        <span class="n">last_tile</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>        <span class="n">frame_images</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Holds large numpy arrays, so expensive to compare</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>        <span class="c1"># Iterate through in sorted order</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>            <span class="k">if</span> <span class="n">last_tile</span> <span class="o">!=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tile</span><span class="p">:</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>                <span class="c1"># Gather the frame images, preserving them for the next event</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>                <span class="n">frames</span> <span class="o">=</span> <span class="n">Frame</span><span class="o">.</span><span class="n">get_frames</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tile</span><span class="p">)</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>                <span class="n">frame_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">get_image</span><span class="p">()</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">]</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>                <span class="n">last_tile</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tile</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>            <span class="c1"># Use the frame images to crop the event images</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>            <span class="c1"># Preserve the original order using order[i]</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>            <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">crop_images</span><span class="p">(</span><span class="n">frame_images</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">in_pixels</span><span class="p">)</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>        <span class="k">return</span> <span class="n">images</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a><span class="k">class</span> <span class="nc">EventArray</span><span class="p">:</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a><span class="sd">    A class that holds a large number of events&#39; data, making it easy to analyze and</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a><span class="sd">    manipulate many events at once. A more separated version of the Event class.</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>    <span class="n">INFO_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">,</span> <span class="s2">&quot;tile&quot;</span><span class="p">,</span> <span class="s2">&quot;roi&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">]</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>        <span class="n">info</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>        <span class="n">features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>    <span class="p">):</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>        <span class="c1"># Info must be a DataFrame with columns &quot;slide_id&quot;, &quot;tile&quot;, &quot;roi&quot;, &quot;x&quot;, &quot;y&quot;, &quot;size&quot;</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>        <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>            <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">INFO_COLUMNS</span><span class="p">:</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>                    <span class="s2">&quot;EventArray.info must have columns &#39;slide_id&#39;, &#39;tile&#39;, &#39;roi&#39;, &#39;x&#39;, &#39;y&#39;, &#39;size&#39;&quot;</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>                <span class="p">)</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>            <span class="c1"># Copy first to avoid modifying the original</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>            <span class="c1"># Ensure that the columns are the right types</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>        <span class="c1"># All DataFrames must all have the same number of rows</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="p">)):</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>                <span class="s2">&quot;If EventArray.metadata is not None, it should match rows with .info&quot;</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>            <span class="p">)</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>        <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)):</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>                <span class="s2">&quot;If EventArray.features is not None, it should match rows with .info&quot;</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>            <span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>        <span class="c1"># No columns named &quot;metadata_&quot;, &quot;features_&quot;, or &quot;None&quot;</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>        <span class="n">column_names</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>            <span class="n">column_names</span> <span class="o">+=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>        <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>            <span class="n">column_names</span> <span class="o">+=</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;metadata_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">]):</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;EventArray column names cannot start with &#39;metadata_&#39;&quot;</span><span class="p">)</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;features_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">]):</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;EventArray column names cannot start with &#39;features_&#39;&quot;</span><span class="p">)</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">]):</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;EventArray column names cannot be &#39;none&#39;&quot;</span><span class="p">)</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>        <span class="c1"># Convenience method to get the number of events</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>            <span class="k">return</span> <span class="mi">0</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>        <span class="n">is_equal</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>        <span class="c1"># Parse all possibilities for info</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>                <span class="n">is_equal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_equal</span><span class="p">:</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>        <span class="c1"># Parse all possibilities for metadata</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>                <span class="n">is_equal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_equal</span><span class="p">:</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>        <span class="c1"># Parse all possibilities for features</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>                <span class="n">is_equal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_equal</span><span class="p">:</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>        <span class="k">return</span> <span class="n">is_equal</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>    <span class="k">def</span> <span class="nf">get_sort_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ascending</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a><span class="sd">        Get the sort order for the EventArray by a column in the info, metadata, or features DataFrames.</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a><span class="sd">        :param by: name of the column(s) to sort by.</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a><span class="sd">        :param ascending: whether to sort in ascending order; can be a list to match by</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a><span class="sd">        :return: the order of the indices to sort by.</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">by</span><span class="p">)</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>        <span class="k">return</span> <span class="n">columns</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">by</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="n">ascending</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ascending</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a><span class="sd">        Sort the EventArray by column(s) in the info, metadata, or features DataFrames.</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a><span class="sd">        :param by: name of the column(s) to sort by.</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a><span class="sd">        :param ascending: whether to sort in ascending order; can be a list to match by</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a><span class="sd">        :return: a new, sorted EventArray.</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sort_order</span><span class="p">(</span><span class="n">by</span><span class="p">,</span> <span class="n">ascending</span><span class="p">)</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_names</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a><span class="sd">        Get a DataFrame with the specified columns from the EventArray, by value.</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a><span class="sd">        :param column_names: the names of the columns to get.</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a><span class="sd">        :return: a DataFrame with the specified columns.</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_names</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>            <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">column_names</span><span class="p">]</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>        <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>        <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">:</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>            <span class="k">if</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">column_name</span><span class="p">])</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">column_name</span><span class="p">])</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">column_name</span><span class="p">])</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column </span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s2"> not found in EventArray&quot;</span><span class="p">)</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>    <span class="k">def</span> <span class="nf">rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a><span class="sd">        Get a subset of the EventArray rows based on a boolean or integer index, by value.</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a><span class="sd">        :param rows: the indices to get as a 1D boolean/integer list/array/series</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a><span class="sd">        :return: a new EventArray with the subset of events.</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rows</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rows</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rows</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a><span class="sd">        Create a deep copy of the EventArray.</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a><span class="sd">        :return: a deep copy of the EventArray.</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>            <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>            <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>            <span class="n">features</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>        <span class="p">)</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>    <span class="k">def</span> <span class="nf">add_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a><span class="sd">        Add metadata to the EventArray. Removes the need to check if metadata is None.</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a><span class="sd">        Overwrites any existing metadata with the same column names as the new metadata.</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a><span class="sd">        :param new_metadata: the metadata to add.</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_metadata</span><span class="p">):</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;New metadata must match length of existing info&quot;</span><span class="p">)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">new_metadata</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_metadata</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">new_metadata</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_metadata</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>                <span class="c1"># It&#39;s a DataFrame</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">new_metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_metadata</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>    <span class="k">def</span> <span class="nf">add_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a><span class="sd">        Add features to the EventArray. Removes the need to check if features is None.</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a><span class="sd">        Overwrites any existing features with the same column names as the new features.</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a><span class="sd">        :param new_features: the features to add.</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_features</span><span class="p">):</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;New features must match length of existing info&quot;</span><span class="p">)</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">new_features</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_features</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">new_features</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_features</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>                <span class="c1"># It&#39;s a DataFrame</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">new_features</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_features</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Self</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a><span class="sd">        Combine EventArrays in a list into a single EventArray.</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a><span class="sd">        :param events: the new list of events.</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>        <span class="n">all_info</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>        <span class="n">all_metadata</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>        <span class="n">all_features</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>        <span class="k">for</span> <span class="n">event_array</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>            <span class="c1"># Skip empty EventArrays</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>            <span class="k">if</span> <span class="n">event_array</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>                <span class="n">all_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_array</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>            <span class="k">if</span> <span class="n">event_array</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>                <span class="n">all_metadata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_array</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>            <span class="k">if</span> <span class="n">event_array</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>                <span class="n">all_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_array</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>            <span class="k">return</span> <span class="n">EventArray</span><span class="p">()</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>            <span class="n">all_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_info</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_metadata</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>            <span class="n">all_metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>            <span class="n">all_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_metadata</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_features</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>            <span class="n">all_features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>            <span class="n">all_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_features</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">all_info</span><span class="p">,</span> <span class="n">all_metadata</span><span class="p">,</span> <span class="n">all_features</span><span class="p">)</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>    <span class="k">def</span> <span class="nf">to_events</span><span class="p">(</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>        <span class="n">scans</span><span class="p">:</span> <span class="n">Scan</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">Scan</span><span class="p">],</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>        <span class="n">ignore_missing_scans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>        <span class="n">ignore_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>        <span class="n">ignore_features</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Event</span><span class="p">]:</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a><span class="sd">        Get the events in the EventArray as a list of events.</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a><span class="sd">        :param scans: the scans that the events belong to, auto-matched by slide_id.</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a><span class="sd">        Pass None if you don&#39;t care about scan metadata (pass ignore_missing_scans).</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a><span class="sd">        :param ignore_missing_scans: whether to create blank scans for events without scans.</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a><span class="sd">        :param ignore_metadata: whether to ignore metadata or not</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a><span class="sd">        :param ignore_features: whether to ignore features or not</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a><span class="sd">        :return:</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scans</span><span class="p">,</span> <span class="n">Scan</span><span class="p">):</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>            <span class="n">scans</span> <span class="o">=</span> <span class="p">[</span><span class="n">scans</span><span class="p">]</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>        <span class="n">scans</span> <span class="o">=</span> <span class="p">{</span><span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span><span class="p">:</span> <span class="n">scan</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">}</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>        <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)):</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>            <span class="c1"># Determine the associated scan</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>            <span class="n">slide_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>            <span class="k">if</span> <span class="n">slide_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>                <span class="k">if</span> <span class="n">ignore_missing_scans</span><span class="p">:</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>                    <span class="c1"># Create a placeholder scan if the scan is missing</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>                    <span class="n">scan</span> <span class="o">=</span> <span class="n">Scan</span><span class="o">.</span><span class="n">make_placeholder</span><span class="p">(</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>                        <span class="n">slide_id</span><span class="p">,</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>                    <span class="p">)</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>                        <span class="sa">f</span><span class="s2">&quot;Scan </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;slide_id&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found for event </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>                    <span class="p">)</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>                <span class="n">scan</span> <span class="o">=</span> <span class="n">scans</span><span class="p">[</span><span class="n">slide_id</span><span class="p">]</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>            <span class="c1"># Prepare the metadata and features</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>            <span class="k">if</span> <span class="n">ignore_metadata</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>                <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>                <span class="c1"># This Series creation method is less efficient,</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>                <span class="c1"># but required for preserving dtypes</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>                <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>                    <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">},</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>                    <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">,</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>                <span class="p">)</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>            <span class="k">if</span> <span class="n">ignore_features</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>                <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>                <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>                    <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">},</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>                    <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">,</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>                <span class="p">)</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>            <span class="c1"># Create the event and append it to the list</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>                <span class="n">Event</span><span class="p">(</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>                    <span class="n">scan</span><span class="p">,</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>                    <span class="n">Tile</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>                    <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>                    <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>                    <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>                <span class="p">)</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>            <span class="p">)</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>        <span class="k">return</span> <span class="n">events</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>    <span class="k">def</span> <span class="nf">from_events</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Event</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a><span class="sd">        Set the events in the EventArray to a new list of events.</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a><span class="sd">        :param events: the new list of events.</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>        <span class="c1"># Return an empty array if we were passed nothing</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>        <span class="k">if</span> <span class="n">events</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>            <span class="k">return</span> <span class="n">EventArray</span><span class="p">()</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>        <span class="c1"># Otherwise, grab the info</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>            <span class="p">{</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>                <span class="s2">&quot;slide_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>                <span class="s2">&quot;tile&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>                <span class="s2">&quot;roi&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n_roi</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>                <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>            <span class="p">}</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>        <span class="p">)</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>        <span class="n">metadata_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">metadata</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>        <span class="c1"># Iterate through and ensure that all metadata is the same shape</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>        <span class="k">for</span> <span class="n">metadata</span> <span class="ow">in</span> <span class="n">metadata_list</span><span class="p">:</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">metadata_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All metadata must be the same type.&quot;</span><span class="p">)</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>            <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">metadata</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">metadata_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All metadata must be the same shape.&quot;</span><span class="p">)</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>        <span class="k">if</span> <span class="n">metadata_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metadata_list</span><span class="p">)</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>        <span class="n">features_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">features</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>        <span class="c1"># Iterate through and ensure that all features are the same shape</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>        <span class="k">for</span> <span class="n">features</span> <span class="ow">in</span> <span class="n">features_list</span><span class="p">:</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">features_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All features must be the same type.&quot;</span><span class="p">)</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>            <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">features</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">features_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All features must be the same shape.&quot;</span><span class="p">)</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>        <span class="k">if</span> <span class="n">features_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">features_list</span><span class="p">)</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>    <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a><span class="sd">        Convert all the data in the EventArray to a single DataFrame.</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a><span class="sd">        :return: a DataFrame with all the data in the EventArray.</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>        <span class="c1"># Make a copy of the info DataFrame and prepend &quot;info_&quot; to the column names</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;info_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>        <span class="c1"># Combine with the metadata and prepend &quot;metadata_&quot; to the column names</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>            <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;metadata_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">output</span><span class="p">,</span> <span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>        <span class="c1"># Combine with the features and prepend &quot;features_&quot; to the column names</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>            <span class="n">features</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;features_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">output</span><span class="p">,</span> <span class="n">features</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>        <span class="k">return</span> <span class="n">output</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>    <span class="k">def</span> <span class="nf">from_dataframe</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a><span class="sd">        From a single, special DataFrame, create an EventArray.</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a><span class="sd">        :return: a DataFrame with all the data in the EventArray.</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>        <span class="c1"># Split the columns into info, metadata, and features and strip prefix</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;info_&quot;</span><span class="p">)]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>        <span class="n">info</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;info_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;metadata_&quot;</span><span class="p">)]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>        <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;metadata_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>        <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>        <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;features_&quot;</span><span class="p">)]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>        <span class="n">features</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;features_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>        <span class="k">if</span> <span class="n">features</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>    <span class="k">def</span> <span class="nf">from_mask</span><span class="p">(</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>        <span class="n">slide_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>        <span class="n">tile_n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>        <span class="n">n_roi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>        <span class="n">include_cell_id</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>        <span class="n">images</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>        <span class="n">image_labels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>        <span class="n">properties</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a><span class="sd">        Extract events from a mask DataFrame, including metadata and features.</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a><span class="sd">        :param mask: the mask to extract events from.</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a><span class="sd">        :param slide_id: the slide ID the mask is from.</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a><span class="sd">        :param tile_n: the tile number the mask is from.</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a><span class="sd">        :param n_roi: the ROI number the mask is from.</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a><span class="sd">        :param include_cell_id: whether to include the cell_id, or numerical</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a><span class="sd">        mask label, as metadata in the EventArray.</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a><span class="sd">        :param images: the intensity images to extract features from.</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a><span class="sd">        :param image_labels: the labels for the intensity images.</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a><span class="sd">        :param properties: list of properties to extract in addition to the defaults:</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a><span class="sd">        :return: EventArray corresponding to the mask labels.</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>        <span class="k">if</span> <span class="n">extract_mask_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>            <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>                <span class="s2">&quot;csi_images.csi_images dependencies not installed. Install csi-images &quot;</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>                <span class="s2">&quot;with [imageio] option to resolve.&quot;</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>            <span class="p">)</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>        <span class="c1"># Gather mask_info</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>        <span class="k">if</span> <span class="n">images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">image_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_labels</span><span class="p">):</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Intensity images and labels must match lengths.&quot;</span><span class="p">)</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>        <span class="n">mask_info</span> <span class="o">=</span> <span class="n">extract_mask_info</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">image_labels</span><span class="p">,</span> <span class="n">properties</span><span class="p">)</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>            <span class="k">return</span> <span class="n">EventArray</span><span class="p">()</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>        <span class="c1"># Combine provided info and mask info</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>            <span class="p">{</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>                <span class="s2">&quot;slide_id&quot;</span><span class="p">:</span> <span class="n">slide_id</span><span class="p">,</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>                <span class="s2">&quot;tile&quot;</span><span class="p">:</span> <span class="n">tile_n</span><span class="p">,</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>                <span class="s2">&quot;roi&quot;</span><span class="p">:</span> <span class="n">n_roi</span><span class="p">,</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">mask_info</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">mask_info</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>                <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">mask_info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">],</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>            <span class="p">},</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>        <span class="p">)</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>        <span class="c1"># Extract a metadata column if desired</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>        <span class="k">if</span> <span class="n">include_cell_id</span><span class="p">:</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;cell_id&quot;</span><span class="p">:</span> <span class="n">mask_info</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]})</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>        <span class="c1"># If any additional properties were extracted, add them as features</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>        <span class="n">mask_info</span> <span class="o">=</span> <span class="n">mask_info</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_info</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="n">mask_info</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>    <span class="k">def</span> <span class="nf">save_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a><span class="sd">        Save the events to an CSV file, including metadata and features.</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a><span class="sd">        :param output_path:</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a><span class="sd">        :return:</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>    <span class="k">def</span> <span class="nf">load_csv</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a><span class="sd">        Load the events from an CSV file, including metadata and features.</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a><span class="sd">        :param input_path:</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a><span class="sd">        :return:</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>        <span class="c1"># Load the CSV file</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>    <span class="k">def</span> <span class="nf">save_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a><span class="sd">        Save the events to an HDF5 file, including metadata and features.</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a><span class="sd">        Uses the pandas-provided HDF5 functions for ease, and external compatibility,</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a><span class="sd">        though these files are slightly harder to view in HDFView or similar.</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a><span class="sd">        :param output_path:</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a><span class="sd">        :return:</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>        <span class="c1"># Open the output_path as an HDF5 file</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>        <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">store</span><span class="p">:</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>            <span class="c1"># Store the dataframes in the HDF5 file</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>                <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>                <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>                <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>    <span class="k">def</span> <span class="nf">load_hdf5</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a><span class="sd">        Load the events from an HDF5 file, including metadata and features.</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a><span class="sd">        :param input_path:</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a><span class="sd">        :return:</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>        <span class="c1"># Open the input_path as an HDF5 file</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>        <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">store</span><span class="p">:</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>            <span class="c1"># Load the dataframes from the HDF5 file</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;info&quot;</span> <span class="ow">in</span> <span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;features&quot;</span> <span class="ow">in</span> <span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>    <span class="k">def</span> <span class="nf">save_ocular</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cells&quot;</span><span class="p">):</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a><span class="sd">        Save the events to an OCULAR file. Relies on the dataframe originating</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a><span class="sd">        from an OCULAR file (same columns; duplicate metadata/info).</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a><span class="sd">        :param output_path:</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a><span class="sd">        :param event_type:</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a><span class="sd">        :return:</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>        <span class="k">if</span> <span class="n">pyreadr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>            <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>                <span class="s2">&quot;pyreadr not installed. Install pyreadr directly &quot;</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>                <span class="s2">&quot;or install csi-images with [rds] option to resolve.&quot;</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>            <span class="p">)</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>        <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;cells&quot;</span><span class="p">:</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>            <span class="n">file_stub</span> <span class="o">=</span> <span class="s2">&quot;rc-final&quot;</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>        <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;others&quot;</span><span class="p">:</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>            <span class="n">file_stub</span> <span class="o">=</span> <span class="s2">&quot;others-final&quot;</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid event type. Must be cells or others.&quot;</span><span class="p">)</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>        <span class="c1"># Ensure good metadata</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>            <span class="p">{</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>                <span class="s2">&quot;slide_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">],</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>                <span class="s2">&quot;frame_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">],</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>                <span class="s2">&quot;cell_id&quot;</span><span class="p">:</span> <span class="p">(</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>                    <span class="k">if</span> <span class="s2">&quot;cell_id&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">columns</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>                    <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">))</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>                <span class="p">),</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>                <span class="s2">&quot;cellx&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>                <span class="s2">&quot;celly&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>            <span class="p">}</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>        <span class="p">)</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>            <span class="n">metadata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>        <span class="c1"># Check for the &quot;ocular_interesting&quot; column</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>        <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;cells&quot;</span><span class="p">:</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>            <span class="k">if</span> <span class="s2">&quot;ocular_interesting&quot;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>                <span class="n">interesting_rows</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ocular_interesting&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>            <span class="k">elif</span> <span class="s2">&quot;hcpc&quot;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>                <span class="c1"># Interesting cells don&#39;t get an hcpc designation, leaving them as -1</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>                <span class="n">interesting_rows</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>                    <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;hcpc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>                <span class="p">)</span>  <span class="c1"># interesting cells</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>                <span class="n">interesting_rows</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">interesting_rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>                <span class="c1"># Split the metadata into interesting and regular</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>                <span class="n">interesting_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">(</span><span class="n">interesting_rows</span><span class="p">)</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>                <span class="n">interesting_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>                    <span class="p">[</span><span class="n">interesting_events</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">interesting_events</span><span class="o">.</span><span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>                <span class="p">)</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>                <span class="n">data_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">(</span><span class="o">~</span><span class="n">interesting_rows</span><span class="p">)</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>                <span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>                    <span class="p">[</span><span class="n">data_events</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">data_events</span><span class="o">.</span><span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>                <span class="p">)</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>                <span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ocular_interesting&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>                <span class="c1"># Drop particular columns for &quot;interesting&quot;</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>                <span class="n">interesting_df</span> <span class="o">=</span> <span class="n">interesting_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>                    <span class="p">[</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>                        <span class="s2">&quot;clust&quot;</span><span class="p">,</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>                        <span class="s2">&quot;hcpc&quot;</span><span class="p">,</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>                        <span class="s2">&quot;frame_id&quot;</span><span class="p">,</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>                        <span class="s2">&quot;cell_id&quot;</span><span class="p">,</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>                        <span class="s2">&quot;unique_id&quot;</span><span class="p">,</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>                        <span class="s2">&quot;ocular_interesting&quot;</span><span class="p">,</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>                    <span class="p">],</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>                    <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>                <span class="p">)</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>                <span class="c1"># Save both .csv and .rds</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>                <span class="n">interesting_stub</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;ocular_interesting&quot;</span><span class="p">)</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>                <span class="n">interesting_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">interesting_stub</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>                <span class="c1"># Suppress pandas FutureWarning</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>                <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>                    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>                    <span class="n">pyreadr</span><span class="o">.</span><span class="n">write_rds</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">interesting_stub</span><span class="si">}</span><span class="s2">.rds&quot;</span><span class="p">,</span> <span class="n">interesting_df</span><span class="p">)</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>                <span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>            <span class="c1"># Get all data and reset_index (will copy it)</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>            <span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>        <span class="c1"># Split based on cluster number to conform to *-final[1-4].rds</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>        <span class="n">n_clusters</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;clust&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>        <span class="n">split_idx</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">n_clusters</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>            <span class="n">subset</span> <span class="o">=</span> <span class="p">(</span><span class="n">split_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;clust&quot;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>                <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;clust&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">split_idx</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>            <span class="p">)</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>            <span class="n">data_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">subset</span><span class="p">,</span> <span class="s2">&quot;hcpc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>            <span class="n">subset</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>            <span class="c1"># Suppress pandas FutureWarning</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>                <span class="n">pyreadr</span><span class="o">.</span><span class="n">write_rds</span><span class="p">(</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_stub</span><span class="si">}{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.rds&quot;</span><span class="p">),</span> <span class="n">subset</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>                <span class="p">)</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>        <span class="c1"># Create new example cell strings</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>        <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;example_cell_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>            <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">]</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>            <span class="o">+</span> <span class="s2">&quot; &quot;</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>            <span class="o">+</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;frame_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>            <span class="o">+</span> <span class="s2">&quot; &quot;</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>            <span class="o">+</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>            <span class="o">+</span> <span class="s2">&quot; &quot;</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>            <span class="o">+</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;cellx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>            <span class="o">+</span> <span class="s2">&quot; &quot;</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>            <span class="o">+</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;celly&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>        <span class="p">)</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>        <span class="c1"># Find averagable data columns</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>        <span class="k">if</span> <span class="s2">&quot;cellcluster_id&quot;</span> <span class="ow">in</span> <span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s2">&quot;cellcluster_id&quot;</span><span class="p">)</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s2">&quot;slide_id&quot;</span><span class="p">)</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>        <span class="n">avg_cols</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="n">end_idx</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>        <span class="c1"># Group by cluster and average</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>        <span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;clust&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>            <span class="o">**</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">avg_cols</span><span class="p">},</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>            <span class="n">count</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;clust&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">),</span>  <span class="c1"># count rows in each cluster</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>            <span class="n">example_cells</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;example_cell_id&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>            <span class="n">hcpc</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;hcpc&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>        <span class="p">)</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>        <span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>  <span class="c1"># Do NOT drop, index is &quot;clust&quot;</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>        <span class="c1"># Create new columns</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>            <span class="p">{</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">],</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>                <span class="s2">&quot;example_cells&quot;</span><span class="p">:</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;example_cells&quot;</span><span class="p">],</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>                <span class="s2">&quot;clust&quot;</span><span class="p">:</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;clust&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>                <span class="s2">&quot;hcpc&quot;</span><span class="p">:</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;hcpc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;clust&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>                <span class="s2">&quot;cccluster&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>  <span class="c1"># Dummy value</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>                <span class="s2">&quot;ccdistance&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># Dummy value</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>                <span class="s2">&quot;rownum&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_df</span><span class="p">))),</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>                <span class="s2">&quot;framegroup&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Dummy value</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>            <span class="p">}</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>        <span class="p">)</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        <span class="c1"># Need to pad the features to 761 columns, as per OCULAR report needs</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>        <span class="n">additional_columns</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avg_cols</span><span class="p">),</span> <span class="mi">761</span><span class="p">)</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">additional_columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>            <span class="n">padding</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data_df</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">additional_columns</span><span class="p">))),</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;pad</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">additional_columns</span><span class="p">],</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>            <span class="p">)</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>            <span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data_df</span><span class="p">[</span><span class="n">avg_cols</span><span class="p">],</span> <span class="n">padding</span><span class="p">,</span> <span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>            <span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data_df</span><span class="p">[</span><span class="n">avg_cols</span><span class="p">],</span> <span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>        <span class="c1"># Save the cluster data</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>        <span class="n">data_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_stub</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">))</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>        <span class="c1"># Suppress pandas FutureWarning</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>            <span class="n">pyreadr</span><span class="o">.</span><span class="n">write_rds</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_stub</span><span class="si">}</span><span class="s2">.rds&quot;</span><span class="p">),</span> <span class="n">data_df</span><span class="p">)</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>    <span class="k">def</span> <span class="nf">load_ocular</span><span class="p">(</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>        <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>        <span class="n">event_type</span><span class="o">=</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>        <span class="n">cell_data_files</span><span class="o">=</span><span class="p">(</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>            <span class="s2">&quot;rc-final1.rds&quot;</span><span class="p">,</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>            <span class="s2">&quot;rc-final2.rds&quot;</span><span class="p">,</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>            <span class="s2">&quot;rc-final3.rds&quot;</span><span class="p">,</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>            <span class="s2">&quot;rc-final4.rds&quot;</span><span class="p">,</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>            <span class="s2">&quot;ocular_interesting.rds&quot;</span><span class="p">,</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>        <span class="p">),</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>        <span class="n">others_data_files</span><span class="o">=</span><span class="p">(</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>            <span class="s2">&quot;others-final1.rds&quot;</span><span class="p">,</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>            <span class="s2">&quot;others-final2.rds&quot;</span><span class="p">,</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>            <span class="s2">&quot;others-final3.rds&quot;</span><span class="p">,</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>            <span class="s2">&quot;others-final4.rds&quot;</span><span class="p">,</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>        <span class="p">),</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>        <span class="n">atlas_data_files</span><span class="o">=</span><span class="p">(</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>            <span class="s2">&quot;ocular_interesting.rds&quot;</span><span class="p">,</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>            <span class="s2">&quot;ocular_not_interesting.rds&quot;</span><span class="p">,</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>        <span class="p">),</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>        <span class="n">drop_common_events</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>        <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a><span class="sd">        :param input_path:</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a><span class="sd">        :param event_type:</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a><span class="sd">        :param cell_data_files:</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a><span class="sd">        :param others_data_files:</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a><span class="sd">        :param atlas_data_files:</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a><span class="sd">        :param drop_common_events:</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a><span class="sd">        :param log:</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a><span class="sd">        :return:</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>        <span class="k">if</span> <span class="n">pyreadr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>            <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>                <span class="s2">&quot;pyreadr not installed. Install pyreadr directly &quot;</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>                <span class="s2">&quot;or install csi-images with [rds] option to resolve.&quot;</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>            <span class="p">)</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>        <span class="c1"># Check if the input path is a directory or a file</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">input_path</span><span class="p">):</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>            <span class="n">data_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">input_path</span><span class="p">)]</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>            <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>        <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;cells&quot;</span><span class="p">:</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>            <span class="n">data_files</span> <span class="o">=</span> <span class="n">cell_data_files</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>        <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;others&quot;</span><span class="p">:</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>            <span class="n">data_files</span> <span class="o">=</span> <span class="n">others_data_files</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid event type.&quot;</span><span class="p">)</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>        <span class="c1"># Load the data from the OCULAR files</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>        <span class="n">file_data</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">:</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>                <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> not found for in </span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>                <span class="k">continue</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>            <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyreadr</span><span class="o">.</span><span class="n">read_r</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>            <span class="c1"># Get the DataFrame associated with None (pyreadr dict quirk)</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>            <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="kc">None</span><span class="p">]</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>                <span class="c1"># File gets dropped from the dict</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>                <span class="n">file_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>                <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> has no cells&quot;</span><span class="p">)</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>                <span class="k">continue</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>            <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">])</span><span class="si">}</span><span class="s2"> cells&quot;</span><span class="p">)</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>            <span class="c1"># Drop common cells if requested and in this file</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>                <span class="n">file</span> <span class="ow">in</span> <span class="n">atlas_data_files</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>                <span class="ow">and</span> <span class="n">drop_common_events</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>                <span class="ow">and</span> <span class="s2">&quot;catalogue_classification&quot;</span> <span class="ow">in</span> <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>            <span class="p">):</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>                <span class="n">common_cell_indices</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>                    <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="s2">&quot;catalogue_classification&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;common_cell&quot;</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>                <span class="p">)</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>                <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>                        <span class="sa">f</span><span class="s2">&quot;Dropping </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">common_cell_indices</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>                        <span class="sa">f</span><span class="s2">&quot;common cells from </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>                    <span class="p">)</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>                <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="n">common_cell_indices</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>                <span class="c1"># File gets dropped from the dict</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>                <span class="n">file_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>                <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> has no cells after dropping common cells&quot;</span><span class="p">)</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>                <span class="k">continue</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>            <span class="c1"># Extract frame_id and cell_id</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>            <span class="c1"># DAPI- events already have frame_id cell_id outside rowname</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>            <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">and</span> <span class="s2">&quot;frame_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>                <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="s2">&quot;rowname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="s2">&quot;rowname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>                <span class="c1"># get frame_id cell_id from rownames column and split into two columns</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>                <span class="n">split_res</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="s2">&quot;rowname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_res</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>                        <span class="sa">f</span><span class="s1">&#39;Expected &quot;frame_id cell_id&quot; but got </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="s2">&quot;rowname&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>                    <span class="p">)</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>                <span class="c1"># then assign it back to the dataframe</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>                <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][[</span><span class="s2">&quot;frame_id&quot;</span><span class="p">,</span> <span class="s2">&quot;cell_id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">split_res</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>            <span class="c1"># reset indexes since they can cause NaN values in concat</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>            <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>        <span class="c1"># Merge the data from all files</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>            <span class="k">return</span> <span class="n">EventArray</span><span class="p">()</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>        <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gathered a total of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> events&quot;</span><span class="p">)</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>        <span class="c1"># Others is missing the &quot;slide_id&quot;. Insert it right before &quot;frame_id&quot; column</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>        <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;others&quot;</span> <span class="ow">and</span> <span class="s2">&quot;slide_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ocular&quot;</span><span class="p">:</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>                <span class="n">slide_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">input_path</span><span class="p">))</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>                <span class="n">slide_id</span> <span class="o">=</span> <span class="s2">&quot;UNKNOWN&quot;</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s2">&quot;frame_id&quot;</span><span class="p">),</span> <span class="s2">&quot;slide_id&quot;</span><span class="p">,</span> <span class="n">slide_id</span><span class="p">)</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>        <span class="c1"># Sort according to ascending cell_id to keep the original, which is in manual_df</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>        <span class="c1"># Filter out duplicates by x &amp; y</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>            <span class="n">unique_id</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">]</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>            <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;frame_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>            <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cellx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>            <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;celly&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>        <span class="p">)</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;unique_id&quot;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>        <span class="c1"># Normal unique_id is with cell_id</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>            <span class="n">unique_id</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">]</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>            <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;frame_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>            <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>        <span class="p">)</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>        <span class="c1"># All columns up to &quot;slide_id&quot; are features; drop the &quot;slide_id&quot;</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>        <span class="n">features</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">:</span><span class="s2">&quot;slide_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;slide_id&quot;</span><span class="p">:]</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>        <span class="c1"># Grab the info columns</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">,</span> <span class="s2">&quot;frame_id&quot;</span><span class="p">,</span> <span class="s2">&quot;cellx&quot;</span><span class="p">,</span> <span class="s2">&quot;celly&quot;</span><span class="p">]]</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>        <span class="n">info</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">,</span> <span class="s2">&quot;tile&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>            <span class="n">roi</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># OCULAR only works on 1 ROI, as far as known</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>            <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>  <span class="c1"># Static, for later montaging</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>        <span class="p">)</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">[[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">,</span> <span class="s2">&quot;tile&quot;</span><span class="p">,</span> <span class="s2">&quot;roi&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">]]</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>        <span class="c1"># Metadata has duplicate columns for later convenience</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>        <span class="c1"># Certain columns tend to be problematic with mixed data formats...</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TRITC&quot;</span><span class="p">,</span> <span class="s2">&quot;CY5&quot;</span><span class="p">,</span> <span class="s2">&quot;FITC&quot;</span><span class="p">]:</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>                <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>                    <span class="s2">&quot;False&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>                    <span class="s2">&quot;True&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>                    <span class="s2">&quot;FALSE&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>                    <span class="s2">&quot;TRUE&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>                <span class="p">}</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>                <span class="n">metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;catalogue_id&quot;</span><span class="p">,</span> <span class="s2">&quot;catalogue_distance&quot;</span><span class="p">,</span> <span class="s2">&quot;clust&quot;</span><span class="p">,</span> <span class="s2">&quot;hcpc&quot;</span><span class="p">]:</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>                <span class="n">metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="Event">
                            <input id="Event-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Event</span>:

                <label class="view-source-button" for="Event-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Event"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Event-35"><a href="#Event-35"><span class="linenos"> 35</span></a><span class="k">class</span> <span class="nc">Event</span><span class="p">:</span>
</span><span id="Event-36"><a href="#Event-36"><span class="linenos"> 36</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event-37"><a href="#Event-37"><span class="linenos"> 37</span></a><span class="sd">    A class that represents a single event in a scan, making it easy to evaluate</span>
</span><span id="Event-38"><a href="#Event-38"><span class="linenos"> 38</span></a><span class="sd">    singular events. Required metadata is exposed as attributes, and optional</span>
</span><span id="Event-39"><a href="#Event-39"><span class="linenos"> 39</span></a><span class="sd">    metadata and features are stored as DataFrames.</span>
</span><span id="Event-40"><a href="#Event-40"><span class="linenos"> 40</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Event-41"><a href="#Event-41"><span class="linenos"> 41</span></a>
</span><span id="Event-42"><a href="#Event-42"><span class="linenos"> 42</span></a>    <span class="n">SCAN_TO_SLIDE_TRANSFORM</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Event-43"><a href="#Event-43"><span class="linenos"> 43</span></a>        <span class="c1"># Axioscan zero is in the top-right corner instead of top-left</span>
</span><span id="Event-44"><a href="#Event-44"><span class="linenos"> 44</span></a>        <span class="n">Scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="Event-45"><a href="#Event-45"><span class="linenos"> 45</span></a>            <span class="p">[</span>
</span><span id="Event-46"><a href="#Event-46"><span class="linenos"> 46</span></a>                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">75000</span><span class="p">],</span>
</span><span id="Event-47"><a href="#Event-47"><span class="linenos"> 47</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="Event-48"><a href="#Event-48"><span class="linenos"> 48</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="Event-49"><a href="#Event-49"><span class="linenos"> 49</span></a>            <span class="p">]</span>
</span><span id="Event-50"><a href="#Event-50"><span class="linenos"> 50</span></a>        <span class="p">),</span>
</span><span id="Event-51"><a href="#Event-51"><span class="linenos"> 51</span></a>        <span class="c1"># BZScanner coordinates are a special kind of messed up:</span>
</span><span id="Event-52"><a href="#Event-52"><span class="linenos"> 52</span></a>        <span class="c1"># - The slide is upside-down.</span>
</span><span id="Event-53"><a href="#Event-53"><span class="linenos"> 53</span></a>        <span class="c1"># - The slide is oriented vertically, with the barcode at the bottom.</span>
</span><span id="Event-54"><a href="#Event-54"><span class="linenos"> 54</span></a>        <span class="c1"># - Tiles are numbered from the top-right</span>
</span><span id="Event-55"><a href="#Event-55"><span class="linenos"> 55</span></a>        <span class="n">Scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="Event-56"><a href="#Event-56"><span class="linenos"> 56</span></a>            <span class="p">[</span>
</span><span id="Event-57"><a href="#Event-57"><span class="linenos"> 57</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">75000</span><span class="p">],</span>
</span><span id="Event-58"><a href="#Event-58"><span class="linenos"> 58</span></a>                <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">25000</span><span class="p">],</span>
</span><span id="Event-59"><a href="#Event-59"><span class="linenos"> 59</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="Event-60"><a href="#Event-60"><span class="linenos"> 60</span></a>            <span class="p">]</span>
</span><span id="Event-61"><a href="#Event-61"><span class="linenos"> 61</span></a>        <span class="p">),</span>
</span><span id="Event-62"><a href="#Event-62"><span class="linenos"> 62</span></a>    <span class="p">}</span>
</span><span id="Event-63"><a href="#Event-63"><span class="linenos"> 63</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event-64"><a href="#Event-64"><span class="linenos"> 64</span></a><span class="sd">    Homogeneous transformation matrices for converting between scanner and slide</span>
</span><span id="Event-65"><a href="#Event-65"><span class="linenos"> 65</span></a><span class="sd">    coordinates. The matrices are 3x3, with the final column representing the</span>
</span><span id="Event-66"><a href="#Event-66"><span class="linenos"> 66</span></a><span class="sd">    translation in micrometers (um). For more information, see </span>
</span><span id="Event-67"><a href="#Event-67"><span class="linenos"> 67</span></a><span class="sd">    [affine transformations](https://en.wikipedia.org/wiki/Transformation_matrix#Affine_transformations).</span>
</span><span id="Event-68"><a href="#Event-68"><span class="linenos"> 68</span></a><span class="sd">    </span>
</span><span id="Event-69"><a href="#Event-69"><span class="linenos"> 69</span></a><span class="sd">    Transformations are nominal, and accuracy is not guaranteed; this is due to </span>
</span><span id="Event-70"><a href="#Event-70"><span class="linenos"> 70</span></a><span class="sd">    imperfections in slides and alignment in the scanners. Units are in micrometers.</span>
</span><span id="Event-71"><a href="#Event-71"><span class="linenos"> 71</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Event-72"><a href="#Event-72"><span class="linenos"> 72</span></a>
</span><span id="Event-73"><a href="#Event-73"><span class="linenos"> 73</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Event-74"><a href="#Event-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Event-75"><a href="#Event-75"><span class="linenos"> 75</span></a>        <span class="n">scan</span><span class="p">:</span> <span class="n">Scan</span><span class="p">,</span>
</span><span id="Event-76"><a href="#Event-76"><span class="linenos"> 76</span></a>        <span class="n">tile</span><span class="p">:</span> <span class="n">Tile</span><span class="p">,</span>
</span><span id="Event-77"><a href="#Event-77"><span class="linenos"> 77</span></a>        <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="Event-78"><a href="#Event-78"><span class="linenos"> 78</span></a>        <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="Event-79"><a href="#Event-79"><span class="linenos"> 79</span></a>        <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>  <span class="c1"># End-to-end size in pixels</span>
</span><span id="Event-80"><a href="#Event-80"><span class="linenos"> 80</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Event-81"><a href="#Event-81"><span class="linenos"> 81</span></a>        <span class="n">features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Event-82"><a href="#Event-82"><span class="linenos"> 82</span></a>    <span class="p">):</span>
</span><span id="Event-83"><a href="#Event-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scan</span> <span class="o">=</span> <span class="n">scan</span>
</span><span id="Event-84"><a href="#Event-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile</span> <span class="o">=</span> <span class="n">tile</span>
</span><span id="Event-85"><a href="#Event-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="Event-86"><a href="#Event-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="Event-87"><a href="#Event-87"><span class="linenos"> 87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
</span><span id="Event-88"><a href="#Event-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
</span><span id="Event-89"><a href="#Event-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
</span><span id="Event-90"><a href="#Event-90"><span class="linenos"> 90</span></a>
</span><span id="Event-91"><a href="#Event-91"><span class="linenos"> 91</span></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Event-92"><a href="#Event-92"><span class="linenos"> 92</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Event-93"><a href="#Event-93"><span class="linenos"> 93</span></a>
</span><span id="Event-94"><a href="#Event-94"><span class="linenos"> 94</span></a>    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Event-95"><a href="#Event-95"><span class="linenos"> 95</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
</span><span id="Event-96"><a href="#Event-96"><span class="linenos"> 96</span></a>
</span><span id="Event-97"><a href="#Event-97"><span class="linenos"> 97</span></a>    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="Event-98"><a href="#Event-98"><span class="linenos"> 98</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
</span><span id="Event-99"><a href="#Event-99"><span class="linenos"> 99</span></a>
</span><span id="Event-100"><a href="#Event-100"><span class="linenos">100</span></a>    <span class="k">def</span> <span class="nf">get_scan_position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Event-101"><a href="#Event-101"><span class="linenos">101</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event-102"><a href="#Event-102"><span class="linenos">102</span></a><span class="sd">        Get the position of the event in the scanner&#39;s coordinate frame.</span>
</span><span id="Event-103"><a href="#Event-103"><span class="linenos">103</span></a><span class="sd">        :return: the scan position of the event in micrometers (um).</span>
</span><span id="Event-104"><a href="#Event-104"><span class="linenos">104</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Event-105"><a href="#Event-105"><span class="linenos">105</span></a>        <span class="c1"># Get overall pixel position</span>
</span><span id="Event-106"><a href="#Event-106"><span class="linenos">106</span></a>        <span class="n">pixel_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</span><span id="Event-107"><a href="#Event-107"><span class="linenos">107</span></a>        <span class="n">pixel_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="Event-108"><a href="#Event-108"><span class="linenos">108</span></a>        <span class="c1"># Convert to micrometers</span>
</span><span id="Event-109"><a href="#Event-109"><span class="linenos">109</span></a>        <span class="n">x_um</span> <span class="o">=</span> <span class="n">pixel_x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span>
</span><span id="Event-110"><a href="#Event-110"><span class="linenos">110</span></a>        <span class="n">y_um</span> <span class="o">=</span> <span class="n">pixel_y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span>
</span><span id="Event-111"><a href="#Event-111"><span class="linenos">111</span></a>        <span class="c1"># Add the scan&#39;s origin in the scanner frame</span>
</span><span id="Event-112"><a href="#Event-112"><span class="linenos">112</span></a>        <span class="n">x_um</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n_roi</span><span class="p">]</span><span class="o">.</span><span class="n">origin_x_um</span>
</span><span id="Event-113"><a href="#Event-113"><span class="linenos">113</span></a>        <span class="n">y_um</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n_roi</span><span class="p">]</span><span class="o">.</span><span class="n">origin_y_um</span>
</span><span id="Event-114"><a href="#Event-114"><span class="linenos">114</span></a>        <span class="k">return</span> <span class="n">x_um</span><span class="p">,</span> <span class="n">y_um</span>
</span><span id="Event-115"><a href="#Event-115"><span class="linenos">115</span></a>
</span><span id="Event-116"><a href="#Event-116"><span class="linenos">116</span></a>    <span class="k">def</span> <span class="nf">get_slide_position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Event-117"><a href="#Event-117"><span class="linenos">117</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event-118"><a href="#Event-118"><span class="linenos">118</span></a><span class="sd">        Get the slide position of the event in micrometers (um).</span>
</span><span id="Event-119"><a href="#Event-119"><span class="linenos">119</span></a><span class="sd">        :return: the slide position of the event.</span>
</span><span id="Event-120"><a href="#Event-120"><span class="linenos">120</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Event-121"><a href="#Event-121"><span class="linenos">121</span></a>        <span class="c1"># Turn scan_position into a 3x1 vector</span>
</span><span id="Event-122"><a href="#Event-122"><span class="linenos">122</span></a>        <span class="n">scan_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scan_position</span><span class="p">()</span>
</span><span id="Event-123"><a href="#Event-123"><span class="linenos">123</span></a>        <span class="n">scan_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">scan_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">scan_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
</span><span id="Event-124"><a href="#Event-124"><span class="linenos">124</span></a>
</span><span id="Event-125"><a href="#Event-125"><span class="linenos">125</span></a>        <span class="c1"># Multiply by the appropriate homogeneous matrix</span>
</span><span id="Event-126"><a href="#Event-126"><span class="linenos">126</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
</span><span id="Event-127"><a href="#Event-127"><span class="linenos">127</span></a>            <span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SCAN_TO_SLIDE_TRANSFORM</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">]</span>
</span><span id="Event-128"><a href="#Event-128"><span class="linenos">128</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
</span><span id="Event-129"><a href="#Event-129"><span class="linenos">129</span></a>            <span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SCAN_TO_SLIDE_TRANSFORM</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">]</span>
</span><span id="Event-130"><a href="#Event-130"><span class="linenos">130</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Event-131"><a href="#Event-131"><span class="linenos">131</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scanner type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span><span class="si">}</span><span class="s2"> not supported.&quot;</span><span class="p">)</span>
</span><span id="Event-132"><a href="#Event-132"><span class="linenos">132</span></a>        <span class="n">slide_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">scan_position</span><span class="p">)</span>
</span><span id="Event-133"><a href="#Event-133"><span class="linenos">133</span></a>        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">slide_position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">slide_position</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Event-134"><a href="#Event-134"><span class="linenos">134</span></a>
</span><span id="Event-135"><a href="#Event-135"><span class="linenos">135</span></a>    <span class="k">def</span> <span class="nf">crop_images</span><span class="p">(</span>
</span><span id="Event-136"><a href="#Event-136"><span class="linenos">136</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">crop_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Event-137"><a href="#Event-137"><span class="linenos">137</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="Event-138"><a href="#Event-138"><span class="linenos">138</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event-139"><a href="#Event-139"><span class="linenos">139</span></a><span class="sd">        Get the event crops from the frame images. Called &quot;get&quot; because it does not</span>
</span><span id="Event-140"><a href="#Event-140"><span class="linenos">140</span></a><span class="sd">        need to extract anything; it is very quick for extracting multiple events from</span>
</span><span id="Event-141"><a href="#Event-141"><span class="linenos">141</span></a><span class="sd">        the same tile.</span>
</span><span id="Event-142"><a href="#Event-142"><span class="linenos">142</span></a><span class="sd">        Use this if you&#39;re interested in many events.</span>
</span><span id="Event-143"><a href="#Event-143"><span class="linenos">143</span></a><span class="sd">        :param images: the frame images.</span>
</span><span id="Event-144"><a href="#Event-144"><span class="linenos">144</span></a><span class="sd">        :param crop_size: the square size of the image crop to get for this event.</span>
</span><span id="Event-145"><a href="#Event-145"><span class="linenos">145</span></a><span class="sd">        :param in_pixels: whether the crop size is in pixels or micrometers. Defaults to pixels.</span>
</span><span id="Event-146"><a href="#Event-146"><span class="linenos">146</span></a><span class="sd">        :return: image_size x image_size crops of the event in the provided frames. If</span>
</span><span id="Event-147"><a href="#Event-147"><span class="linenos">147</span></a><span class="sd">        the event is too close to the edge, the crop will be smaller and not centered.</span>
</span><span id="Event-148"><a href="#Event-148"><span class="linenos">148</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Event-149"><a href="#Event-149"><span class="linenos">149</span></a>        <span class="c1"># Convert a crop size in micrometers to pixels</span>
</span><span id="Event-150"><a href="#Event-150"><span class="linenos">150</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_pixels</span><span class="p">:</span>
</span><span id="Event-151"><a href="#Event-151"><span class="linenos">151</span></a>            <span class="n">crop_size</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">crop_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span><span class="p">)</span>
</span><span id="Event-152"><a href="#Event-152"><span class="linenos">152</span></a>        <span class="c1"># Find the crop bounds</span>
</span><span id="Event-153"><a href="#Event-153"><span class="linenos">153</span></a>        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Event-154"><a href="#Event-154"><span class="linenos">154</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="Event-155"><a href="#Event-155"><span class="linenos">155</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="Event-156"><a href="#Event-156"><span class="linenos">156</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">crop_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Event-157"><a href="#Event-157"><span class="linenos">157</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">crop_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Event-158"><a href="#Event-158"><span class="linenos">158</span></a>        <span class="p">]</span>
</span><span id="Event-159"><a href="#Event-159"><span class="linenos">159</span></a>        <span class="c1"># Determine how much the bounds violate the image size</span>
</span><span id="Event-160"><a href="#Event-160"><span class="linenos">160</span></a>        <span class="n">displacements</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Event-161"><a href="#Event-161"><span class="linenos">161</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="Event-162"><a href="#Event-162"><span class="linenos">162</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="Event-163"><a href="#Event-163"><span class="linenos">163</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="Event-164"><a href="#Event-164"><span class="linenos">164</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="Event-165"><a href="#Event-165"><span class="linenos">165</span></a>        <span class="p">]</span>
</span><span id="Event-166"><a href="#Event-166"><span class="linenos">166</span></a>        <span class="c1"># Cap off the bounds</span>
</span><span id="Event-167"><a href="#Event-167"><span class="linenos">167</span></a>        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Event-168"><a href="#Event-168"><span class="linenos">168</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="Event-169"><a href="#Event-169"><span class="linenos">169</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="Event-170"><a href="#Event-170"><span class="linenos">170</span></a>            <span class="nb">min</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="Event-171"><a href="#Event-171"><span class="linenos">171</span></a>            <span class="nb">min</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="Event-172"><a href="#Event-172"><span class="linenos">172</span></a>        <span class="p">]</span>
</span><span id="Event-173"><a href="#Event-173"><span class="linenos">173</span></a>
</span><span id="Event-174"><a href="#Event-174"><span class="linenos">174</span></a>        <span class="c1"># Crop the images</span>
</span><span id="Event-175"><a href="#Event-175"><span class="linenos">175</span></a>        <span class="n">cropped_images</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Event-176"><a href="#Event-176"><span class="linenos">176</span></a>        <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
</span><span id="Event-177"><a href="#Event-177"><span class="linenos">177</span></a>            <span class="c1"># Create a blank image of the right size</span>
</span><span id="Event-178"><a href="#Event-178"><span class="linenos">178</span></a>            <span class="n">cropped_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">crop_size</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="Event-179"><a href="#Event-179"><span class="linenos">179</span></a>
</span><span id="Event-180"><a href="#Event-180"><span class="linenos">180</span></a>            <span class="c1"># Insert the cropped image into the blank image, leaving a black buffer</span>
</span><span id="Event-181"><a href="#Event-181"><span class="linenos">181</span></a>            <span class="c1"># around the edges if the crop would go beyond the original image bounds</span>
</span><span id="Event-182"><a href="#Event-182"><span class="linenos">182</span></a>            <span class="n">cropped_image</span><span class="p">[</span>
</span><span id="Event-183"><a href="#Event-183"><span class="linenos">183</span></a>                <span class="n">displacements</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">crop_size</span> <span class="o">-</span> <span class="n">displacements</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span id="Event-184"><a href="#Event-184"><span class="linenos">184</span></a>                <span class="n">displacements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">crop_size</span> <span class="o">-</span> <span class="n">displacements</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="Event-185"><a href="#Event-185"><span class="linenos">185</span></a>            <span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
</span><span id="Event-186"><a href="#Event-186"><span class="linenos">186</span></a>            <span class="n">cropped_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cropped_image</span><span class="p">)</span>
</span><span id="Event-187"><a href="#Event-187"><span class="linenos">187</span></a>        <span class="k">return</span> <span class="n">cropped_images</span>
</span><span id="Event-188"><a href="#Event-188"><span class="linenos">188</span></a>
</span><span id="Event-189"><a href="#Event-189"><span class="linenos">189</span></a>    <span class="k">def</span> <span class="nf">extract_images</span><span class="p">(</span>
</span><span id="Event-190"><a href="#Event-190"><span class="linenos">190</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Event-191"><a href="#Event-191"><span class="linenos">191</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="Event-192"><a href="#Event-192"><span class="linenos">192</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event-193"><a href="#Event-193"><span class="linenos">193</span></a><span class="sd">        Extract the images from the scan and tile, reading from the file. Called</span>
</span><span id="Event-194"><a href="#Event-194"><span class="linenos">194</span></a><span class="sd">        &quot;extract&quot; because it must read and extract the images from file, which is slow.</span>
</span><span id="Event-195"><a href="#Event-195"><span class="linenos">195</span></a><span class="sd">        Use this if you&#39;re interested in only a few events, as it is inefficient when</span>
</span><span id="Event-196"><a href="#Event-196"><span class="linenos">196</span></a><span class="sd">        reading multiple events from the same tile.</span>
</span><span id="Event-197"><a href="#Event-197"><span class="linenos">197</span></a><span class="sd">        :param crop_size: the square size of the image crop to get for this event.</span>
</span><span id="Event-198"><a href="#Event-198"><span class="linenos">198</span></a><span class="sd">        :param in_pixels: whether the crop size is in pixels or micrometers. Defaults to pixels.</span>
</span><span id="Event-199"><a href="#Event-199"><span class="linenos">199</span></a><span class="sd">        :return: a list of cropped images from the scan in the order of the channels.</span>
</span><span id="Event-200"><a href="#Event-200"><span class="linenos">200</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Event-201"><a href="#Event-201"><span class="linenos">201</span></a>        <span class="n">frames</span> <span class="o">=</span> <span class="n">Frame</span><span class="o">.</span><span class="n">get_frames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="p">)</span>
</span><span id="Event-202"><a href="#Event-202"><span class="linenos">202</span></a>        <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">get_image</span><span class="p">()</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">]</span>
</span><span id="Event-203"><a href="#Event-203"><span class="linenos">203</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_images</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="n">in_pixels</span><span class="p">)</span>
</span><span id="Event-204"><a href="#Event-204"><span class="linenos">204</span></a>
</span><span id="Event-205"><a href="#Event-205"><span class="linenos">205</span></a>    <span class="nd">@classmethod</span>
</span><span id="Event-206"><a href="#Event-206"><span class="linenos">206</span></a>    <span class="k">def</span> <span class="nf">extract_images_for_list</span><span class="p">(</span>
</span><span id="Event-207"><a href="#Event-207"><span class="linenos">207</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="Event-208"><a href="#Event-208"><span class="linenos">208</span></a>        <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Self</span><span class="p">],</span>
</span><span id="Event-209"><a href="#Event-209"><span class="linenos">209</span></a>        <span class="n">crop_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Event-210"><a href="#Event-210"><span class="linenos">210</span></a>        <span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Event-211"><a href="#Event-211"><span class="linenos">211</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
</span><span id="Event-212"><a href="#Event-212"><span class="linenos">212</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event-213"><a href="#Event-213"><span class="linenos">213</span></a><span class="sd">        Get the images for a list of events, ensuring that there is no wasteful reading</span>
</span><span id="Event-214"><a href="#Event-214"><span class="linenos">214</span></a><span class="sd">        of the same tile multiple times. This function is more efficient than calling</span>
</span><span id="Event-215"><a href="#Event-215"><span class="linenos">215</span></a><span class="sd">        extract_event_images for each event.</span>
</span><span id="Event-216"><a href="#Event-216"><span class="linenos">216</span></a><span class="sd">        :param events: the events to extract images for.</span>
</span><span id="Event-217"><a href="#Event-217"><span class="linenos">217</span></a><span class="sd">        :param crop_size: the square size of the image crop to get for this event.</span>
</span><span id="Event-218"><a href="#Event-218"><span class="linenos">218</span></a><span class="sd">                          Defaults to four times the size of the event.</span>
</span><span id="Event-219"><a href="#Event-219"><span class="linenos">219</span></a><span class="sd">        :param in_pixels: whether the crop size is in pixels or micrometers.</span>
</span><span id="Event-220"><a href="#Event-220"><span class="linenos">220</span></a><span class="sd">                          Defaults to pixels, and is ignored if crop_size is None.</span>
</span><span id="Event-221"><a href="#Event-221"><span class="linenos">221</span></a><span class="sd">        :return: a list of lists of cropped images for each event.</span>
</span><span id="Event-222"><a href="#Event-222"><span class="linenos">222</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Event-223"><a href="#Event-223"><span class="linenos">223</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Event-224"><a href="#Event-224"><span class="linenos">224</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="Event-225"><a href="#Event-225"><span class="linenos">225</span></a>
</span><span id="Event-226"><a href="#Event-226"><span class="linenos">226</span></a>        <span class="c1"># Populate a crop size if none provided</span>
</span><span id="Event-227"><a href="#Event-227"><span class="linenos">227</span></a>        <span class="k">if</span> <span class="n">crop_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Event-228"><a href="#Event-228"><span class="linenos">228</span></a>            <span class="n">crop_size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span> <span class="o">*</span> <span class="n">event</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
</span><span id="Event-229"><a href="#Event-229"><span class="linenos">229</span></a>            <span class="n">in_pixels</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Event-230"><a href="#Event-230"><span class="linenos">230</span></a>        <span class="c1"># Propagate a constant crop size</span>
</span><span id="Event-231"><a href="#Event-231"><span class="linenos">231</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crop_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="Event-232"><a href="#Event-232"><span class="linenos">232</span></a>            <span class="n">crop_size</span> <span class="o">=</span> <span class="p">[</span><span class="n">crop_size</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</span><span id="Event-233"><a href="#Event-233"><span class="linenos">233</span></a>
</span><span id="Event-234"><a href="#Event-234"><span class="linenos">234</span></a>        <span class="c1"># Sort the events by tile; use a shallow copy to avoid modifying the original</span>
</span><span id="Event-235"><a href="#Event-235"><span class="linenos">235</span></a>        <span class="n">order</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">events</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()))</span>
</span><span id="Event-236"><a href="#Event-236"><span class="linenos">236</span></a>
</span><span id="Event-237"><a href="#Event-237"><span class="linenos">237</span></a>        <span class="c1"># Allocate the list to size</span>
</span><span id="Event-238"><a href="#Event-238"><span class="linenos">238</span></a>        <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</span><span id="Event-239"><a href="#Event-239"><span class="linenos">239</span></a>        <span class="n">last_tile</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Event-240"><a href="#Event-240"><span class="linenos">240</span></a>        <span class="n">frame_images</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Holds large numpy arrays, so expensive to compare</span>
</span><span id="Event-241"><a href="#Event-241"><span class="linenos">241</span></a>        <span class="c1"># Iterate through in sorted order</span>
</span><span id="Event-242"><a href="#Event-242"><span class="linenos">242</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
</span><span id="Event-243"><a href="#Event-243"><span class="linenos">243</span></a>            <span class="k">if</span> <span class="n">last_tile</span> <span class="o">!=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tile</span><span class="p">:</span>
</span><span id="Event-244"><a href="#Event-244"><span class="linenos">244</span></a>                <span class="c1"># Gather the frame images, preserving them for the next event</span>
</span><span id="Event-245"><a href="#Event-245"><span class="linenos">245</span></a>                <span class="n">frames</span> <span class="o">=</span> <span class="n">Frame</span><span class="o">.</span><span class="n">get_frames</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tile</span><span class="p">)</span>
</span><span id="Event-246"><a href="#Event-246"><span class="linenos">246</span></a>                <span class="n">frame_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">get_image</span><span class="p">()</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">]</span>
</span><span id="Event-247"><a href="#Event-247"><span class="linenos">247</span></a>
</span><span id="Event-248"><a href="#Event-248"><span class="linenos">248</span></a>                <span class="n">last_tile</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tile</span>
</span><span id="Event-249"><a href="#Event-249"><span class="linenos">249</span></a>            <span class="c1"># Use the frame images to crop the event images</span>
</span><span id="Event-250"><a href="#Event-250"><span class="linenos">250</span></a>            <span class="c1"># Preserve the original order using order[i]</span>
</span><span id="Event-251"><a href="#Event-251"><span class="linenos">251</span></a>            <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">crop_images</span><span class="p">(</span><span class="n">frame_images</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">in_pixels</span><span class="p">)</span>
</span><span id="Event-252"><a href="#Event-252"><span class="linenos">252</span></a>        <span class="k">return</span> <span class="n">images</span>
</span></pre></div>


            <div class="docstring"><p>A class that represents a single event in a scan, making it easy to evaluate
singular events. Required metadata is exposed as attributes, and optional
metadata and features are stored as DataFrames.</p>
</div>


                            <div id="Event.__init__" class="classattr">
                                        <input id="Event.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Event</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">scan</span><span class="p">:</span> <span class="n"><a href="csi_scans.html#Scan">csi_images.csi_scans.Scan</a></span>,</span><span class="param">	<span class="n">tile</span><span class="p">:</span> <span class="n"><a href="csi_tiles.html#Tile">csi_images.csi_tiles.Tile</a></span>,</span><span class="param">	<span class="n">x</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">y</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span>,</span><span class="param">	<span class="n">metadata</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">features</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="Event.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Event.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Event.__init__-73"><a href="#Event.__init__-73"><span class="linenos">73</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Event.__init__-74"><a href="#Event.__init__-74"><span class="linenos">74</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Event.__init__-75"><a href="#Event.__init__-75"><span class="linenos">75</span></a>        <span class="n">scan</span><span class="p">:</span> <span class="n">Scan</span><span class="p">,</span>
</span><span id="Event.__init__-76"><a href="#Event.__init__-76"><span class="linenos">76</span></a>        <span class="n">tile</span><span class="p">:</span> <span class="n">Tile</span><span class="p">,</span>
</span><span id="Event.__init__-77"><a href="#Event.__init__-77"><span class="linenos">77</span></a>        <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="Event.__init__-78"><a href="#Event.__init__-78"><span class="linenos">78</span></a>        <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="Event.__init__-79"><a href="#Event.__init__-79"><span class="linenos">79</span></a>        <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>  <span class="c1"># End-to-end size in pixels</span>
</span><span id="Event.__init__-80"><a href="#Event.__init__-80"><span class="linenos">80</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Event.__init__-81"><a href="#Event.__init__-81"><span class="linenos">81</span></a>        <span class="n">features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Event.__init__-82"><a href="#Event.__init__-82"><span class="linenos">82</span></a>    <span class="p">):</span>
</span><span id="Event.__init__-83"><a href="#Event.__init__-83"><span class="linenos">83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scan</span> <span class="o">=</span> <span class="n">scan</span>
</span><span id="Event.__init__-84"><a href="#Event.__init__-84"><span class="linenos">84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile</span> <span class="o">=</span> <span class="n">tile</span>
</span><span id="Event.__init__-85"><a href="#Event.__init__-85"><span class="linenos">85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="Event.__init__-86"><a href="#Event.__init__-86"><span class="linenos">86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="Event.__init__-87"><a href="#Event.__init__-87"><span class="linenos">87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
</span><span id="Event.__init__-88"><a href="#Event.__init__-88"><span class="linenos">88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
</span><span id="Event.__init__-89"><a href="#Event.__init__-89"><span class="linenos">89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
</span></pre></div>


    

                            </div>
                            <div id="Event.SCAN_TO_SLIDE_TRANSFORM" class="classattr">
                                <div class="attr variable">
            <span class="name">SCAN_TO_SLIDE_TRANSFORM</span>        =
<input id="Event.SCAN_TO_SLIDE_TRANSFORM-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="Event.SCAN_TO_SLIDE_TRANSFORM-view-value"></label><span class="default_value">{&lt;Type.AXIOSCAN7: &#39;axioscan7&#39;&gt;: array([[    1,     0, 75000],
       [    0,     1,     0],
       [    0,     0,     1]]), &lt;Type.BZSCANNER: &#39;bzscanner&#39;&gt;: array([[    0,    -1, 75000],
       [   -1,     0, 25000],
       [    0,     0,     1]])}</span>

        
    </div>
    <a class="headerlink" href="#Event.SCAN_TO_SLIDE_TRANSFORM"></a>
    
            <div class="docstring"><p>Homogeneous transformation matrices for converting between scanner and slide
coordinates. The matrices are 3x3, with the final column representing the
translation in micrometers (um). For more information, see 
<a href="https://en.wikipedia.org/wiki/Transformation_matrix#Affine_transformations">affine transformations</a>.</p>

<p>Transformations are nominal, and accuracy is not guaranteed; this is due to 
imperfections in slides and alignment in the scanners. Units are in micrometers.</p>
</div>


                            </div>
                            <div id="Event.scan" class="classattr">
                                <div class="attr variable">
            <span class="name">scan</span>

        
    </div>
    <a class="headerlink" href="#Event.scan"></a>
    
    

                            </div>
                            <div id="Event.tile" class="classattr">
                                <div class="attr variable">
            <span class="name">tile</span>

        
    </div>
    <a class="headerlink" href="#Event.tile"></a>
    
    

                            </div>
                            <div id="Event.x" class="classattr">
                                <div class="attr variable">
            <span class="name">x</span>

        
    </div>
    <a class="headerlink" href="#Event.x"></a>
    
    

                            </div>
                            <div id="Event.y" class="classattr">
                                <div class="attr variable">
            <span class="name">y</span>

        
    </div>
    <a class="headerlink" href="#Event.y"></a>
    
    

                            </div>
                            <div id="Event.size" class="classattr">
                                <div class="attr variable">
            <span class="name">size</span>

        
    </div>
    <a class="headerlink" href="#Event.size"></a>
    
    

                            </div>
                            <div id="Event.metadata" class="classattr">
                                <div class="attr variable">
            <span class="name">metadata</span>

        
    </div>
    <a class="headerlink" href="#Event.metadata"></a>
    
    

                            </div>
                            <div id="Event.features" class="classattr">
                                <div class="attr variable">
            <span class="name">features</span>

        
    </div>
    <a class="headerlink" href="#Event.features"></a>
    
    

                            </div>
                            <div id="Event.get_scan_position" class="classattr">
                                        <input id="Event.get_scan_position-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_scan_position</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Event.get_scan_position-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Event.get_scan_position"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Event.get_scan_position-100"><a href="#Event.get_scan_position-100"><span class="linenos">100</span></a>    <span class="k">def</span> <span class="nf">get_scan_position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Event.get_scan_position-101"><a href="#Event.get_scan_position-101"><span class="linenos">101</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event.get_scan_position-102"><a href="#Event.get_scan_position-102"><span class="linenos">102</span></a><span class="sd">        Get the position of the event in the scanner&#39;s coordinate frame.</span>
</span><span id="Event.get_scan_position-103"><a href="#Event.get_scan_position-103"><span class="linenos">103</span></a><span class="sd">        :return: the scan position of the event in micrometers (um).</span>
</span><span id="Event.get_scan_position-104"><a href="#Event.get_scan_position-104"><span class="linenos">104</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Event.get_scan_position-105"><a href="#Event.get_scan_position-105"><span class="linenos">105</span></a>        <span class="c1"># Get overall pixel position</span>
</span><span id="Event.get_scan_position-106"><a href="#Event.get_scan_position-106"><span class="linenos">106</span></a>        <span class="n">pixel_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</span><span id="Event.get_scan_position-107"><a href="#Event.get_scan_position-107"><span class="linenos">107</span></a>        <span class="n">pixel_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="Event.get_scan_position-108"><a href="#Event.get_scan_position-108"><span class="linenos">108</span></a>        <span class="c1"># Convert to micrometers</span>
</span><span id="Event.get_scan_position-109"><a href="#Event.get_scan_position-109"><span class="linenos">109</span></a>        <span class="n">x_um</span> <span class="o">=</span> <span class="n">pixel_x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span>
</span><span id="Event.get_scan_position-110"><a href="#Event.get_scan_position-110"><span class="linenos">110</span></a>        <span class="n">y_um</span> <span class="o">=</span> <span class="n">pixel_y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span>
</span><span id="Event.get_scan_position-111"><a href="#Event.get_scan_position-111"><span class="linenos">111</span></a>        <span class="c1"># Add the scan&#39;s origin in the scanner frame</span>
</span><span id="Event.get_scan_position-112"><a href="#Event.get_scan_position-112"><span class="linenos">112</span></a>        <span class="n">x_um</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n_roi</span><span class="p">]</span><span class="o">.</span><span class="n">origin_x_um</span>
</span><span id="Event.get_scan_position-113"><a href="#Event.get_scan_position-113"><span class="linenos">113</span></a>        <span class="n">y_um</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n_roi</span><span class="p">]</span><span class="o">.</span><span class="n">origin_y_um</span>
</span><span id="Event.get_scan_position-114"><a href="#Event.get_scan_position-114"><span class="linenos">114</span></a>        <span class="k">return</span> <span class="n">x_um</span><span class="p">,</span> <span class="n">y_um</span>
</span></pre></div>


            <div class="docstring"><p>Get the position of the event in the scanner's coordinate frame.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>the scan position of the event in micrometers (um).</p>
</blockquote>
</div>


                            </div>
                            <div id="Event.get_slide_position" class="classattr">
                                        <input id="Event.get_slide_position-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_slide_position</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Event.get_slide_position-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Event.get_slide_position"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Event.get_slide_position-116"><a href="#Event.get_slide_position-116"><span class="linenos">116</span></a>    <span class="k">def</span> <span class="nf">get_slide_position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Event.get_slide_position-117"><a href="#Event.get_slide_position-117"><span class="linenos">117</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event.get_slide_position-118"><a href="#Event.get_slide_position-118"><span class="linenos">118</span></a><span class="sd">        Get the slide position of the event in micrometers (um).</span>
</span><span id="Event.get_slide_position-119"><a href="#Event.get_slide_position-119"><span class="linenos">119</span></a><span class="sd">        :return: the slide position of the event.</span>
</span><span id="Event.get_slide_position-120"><a href="#Event.get_slide_position-120"><span class="linenos">120</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Event.get_slide_position-121"><a href="#Event.get_slide_position-121"><span class="linenos">121</span></a>        <span class="c1"># Turn scan_position into a 3x1 vector</span>
</span><span id="Event.get_slide_position-122"><a href="#Event.get_slide_position-122"><span class="linenos">122</span></a>        <span class="n">scan_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scan_position</span><span class="p">()</span>
</span><span id="Event.get_slide_position-123"><a href="#Event.get_slide_position-123"><span class="linenos">123</span></a>        <span class="n">scan_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">scan_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">scan_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
</span><span id="Event.get_slide_position-124"><a href="#Event.get_slide_position-124"><span class="linenos">124</span></a>
</span><span id="Event.get_slide_position-125"><a href="#Event.get_slide_position-125"><span class="linenos">125</span></a>        <span class="c1"># Multiply by the appropriate homogeneous matrix</span>
</span><span id="Event.get_slide_position-126"><a href="#Event.get_slide_position-126"><span class="linenos">126</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
</span><span id="Event.get_slide_position-127"><a href="#Event.get_slide_position-127"><span class="linenos">127</span></a>            <span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SCAN_TO_SLIDE_TRANSFORM</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">]</span>
</span><span id="Event.get_slide_position-128"><a href="#Event.get_slide_position-128"><span class="linenos">128</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
</span><span id="Event.get_slide_position-129"><a href="#Event.get_slide_position-129"><span class="linenos">129</span></a>            <span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SCAN_TO_SLIDE_TRANSFORM</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">]</span>
</span><span id="Event.get_slide_position-130"><a href="#Event.get_slide_position-130"><span class="linenos">130</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Event.get_slide_position-131"><a href="#Event.get_slide_position-131"><span class="linenos">131</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scanner type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span><span class="si">}</span><span class="s2"> not supported.&quot;</span><span class="p">)</span>
</span><span id="Event.get_slide_position-132"><a href="#Event.get_slide_position-132"><span class="linenos">132</span></a>        <span class="n">slide_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">scan_position</span><span class="p">)</span>
</span><span id="Event.get_slide_position-133"><a href="#Event.get_slide_position-133"><span class="linenos">133</span></a>        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">slide_position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">slide_position</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Get the slide position of the event in micrometers (um).</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>the slide position of the event.</p>
</blockquote>
</div>


                            </div>
                            <div id="Event.crop_images" class="classattr">
                                        <input id="Event.crop_images-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">crop_images</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">images</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>,</span><span class="param">	<span class="n">crop_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>,</span><span class="param">	<span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Event.crop_images-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Event.crop_images"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Event.crop_images-135"><a href="#Event.crop_images-135"><span class="linenos">135</span></a>    <span class="k">def</span> <span class="nf">crop_images</span><span class="p">(</span>
</span><span id="Event.crop_images-136"><a href="#Event.crop_images-136"><span class="linenos">136</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">crop_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Event.crop_images-137"><a href="#Event.crop_images-137"><span class="linenos">137</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="Event.crop_images-138"><a href="#Event.crop_images-138"><span class="linenos">138</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event.crop_images-139"><a href="#Event.crop_images-139"><span class="linenos">139</span></a><span class="sd">        Get the event crops from the frame images. Called &quot;get&quot; because it does not</span>
</span><span id="Event.crop_images-140"><a href="#Event.crop_images-140"><span class="linenos">140</span></a><span class="sd">        need to extract anything; it is very quick for extracting multiple events from</span>
</span><span id="Event.crop_images-141"><a href="#Event.crop_images-141"><span class="linenos">141</span></a><span class="sd">        the same tile.</span>
</span><span id="Event.crop_images-142"><a href="#Event.crop_images-142"><span class="linenos">142</span></a><span class="sd">        Use this if you&#39;re interested in many events.</span>
</span><span id="Event.crop_images-143"><a href="#Event.crop_images-143"><span class="linenos">143</span></a><span class="sd">        :param images: the frame images.</span>
</span><span id="Event.crop_images-144"><a href="#Event.crop_images-144"><span class="linenos">144</span></a><span class="sd">        :param crop_size: the square size of the image crop to get for this event.</span>
</span><span id="Event.crop_images-145"><a href="#Event.crop_images-145"><span class="linenos">145</span></a><span class="sd">        :param in_pixels: whether the crop size is in pixels or micrometers. Defaults to pixels.</span>
</span><span id="Event.crop_images-146"><a href="#Event.crop_images-146"><span class="linenos">146</span></a><span class="sd">        :return: image_size x image_size crops of the event in the provided frames. If</span>
</span><span id="Event.crop_images-147"><a href="#Event.crop_images-147"><span class="linenos">147</span></a><span class="sd">        the event is too close to the edge, the crop will be smaller and not centered.</span>
</span><span id="Event.crop_images-148"><a href="#Event.crop_images-148"><span class="linenos">148</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Event.crop_images-149"><a href="#Event.crop_images-149"><span class="linenos">149</span></a>        <span class="c1"># Convert a crop size in micrometers to pixels</span>
</span><span id="Event.crop_images-150"><a href="#Event.crop_images-150"><span class="linenos">150</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_pixels</span><span class="p">:</span>
</span><span id="Event.crop_images-151"><a href="#Event.crop_images-151"><span class="linenos">151</span></a>            <span class="n">crop_size</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">crop_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span><span class="p">)</span>
</span><span id="Event.crop_images-152"><a href="#Event.crop_images-152"><span class="linenos">152</span></a>        <span class="c1"># Find the crop bounds</span>
</span><span id="Event.crop_images-153"><a href="#Event.crop_images-153"><span class="linenos">153</span></a>        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Event.crop_images-154"><a href="#Event.crop_images-154"><span class="linenos">154</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="Event.crop_images-155"><a href="#Event.crop_images-155"><span class="linenos">155</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="Event.crop_images-156"><a href="#Event.crop_images-156"><span class="linenos">156</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">crop_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Event.crop_images-157"><a href="#Event.crop_images-157"><span class="linenos">157</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">crop_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Event.crop_images-158"><a href="#Event.crop_images-158"><span class="linenos">158</span></a>        <span class="p">]</span>
</span><span id="Event.crop_images-159"><a href="#Event.crop_images-159"><span class="linenos">159</span></a>        <span class="c1"># Determine how much the bounds violate the image size</span>
</span><span id="Event.crop_images-160"><a href="#Event.crop_images-160"><span class="linenos">160</span></a>        <span class="n">displacements</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Event.crop_images-161"><a href="#Event.crop_images-161"><span class="linenos">161</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="Event.crop_images-162"><a href="#Event.crop_images-162"><span class="linenos">162</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="Event.crop_images-163"><a href="#Event.crop_images-163"><span class="linenos">163</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="Event.crop_images-164"><a href="#Event.crop_images-164"><span class="linenos">164</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="Event.crop_images-165"><a href="#Event.crop_images-165"><span class="linenos">165</span></a>        <span class="p">]</span>
</span><span id="Event.crop_images-166"><a href="#Event.crop_images-166"><span class="linenos">166</span></a>        <span class="c1"># Cap off the bounds</span>
</span><span id="Event.crop_images-167"><a href="#Event.crop_images-167"><span class="linenos">167</span></a>        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Event.crop_images-168"><a href="#Event.crop_images-168"><span class="linenos">168</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="Event.crop_images-169"><a href="#Event.crop_images-169"><span class="linenos">169</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="Event.crop_images-170"><a href="#Event.crop_images-170"><span class="linenos">170</span></a>            <span class="nb">min</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="Event.crop_images-171"><a href="#Event.crop_images-171"><span class="linenos">171</span></a>            <span class="nb">min</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="Event.crop_images-172"><a href="#Event.crop_images-172"><span class="linenos">172</span></a>        <span class="p">]</span>
</span><span id="Event.crop_images-173"><a href="#Event.crop_images-173"><span class="linenos">173</span></a>
</span><span id="Event.crop_images-174"><a href="#Event.crop_images-174"><span class="linenos">174</span></a>        <span class="c1"># Crop the images</span>
</span><span id="Event.crop_images-175"><a href="#Event.crop_images-175"><span class="linenos">175</span></a>        <span class="n">cropped_images</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Event.crop_images-176"><a href="#Event.crop_images-176"><span class="linenos">176</span></a>        <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
</span><span id="Event.crop_images-177"><a href="#Event.crop_images-177"><span class="linenos">177</span></a>            <span class="c1"># Create a blank image of the right size</span>
</span><span id="Event.crop_images-178"><a href="#Event.crop_images-178"><span class="linenos">178</span></a>            <span class="n">cropped_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">crop_size</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="Event.crop_images-179"><a href="#Event.crop_images-179"><span class="linenos">179</span></a>
</span><span id="Event.crop_images-180"><a href="#Event.crop_images-180"><span class="linenos">180</span></a>            <span class="c1"># Insert the cropped image into the blank image, leaving a black buffer</span>
</span><span id="Event.crop_images-181"><a href="#Event.crop_images-181"><span class="linenos">181</span></a>            <span class="c1"># around the edges if the crop would go beyond the original image bounds</span>
</span><span id="Event.crop_images-182"><a href="#Event.crop_images-182"><span class="linenos">182</span></a>            <span class="n">cropped_image</span><span class="p">[</span>
</span><span id="Event.crop_images-183"><a href="#Event.crop_images-183"><span class="linenos">183</span></a>                <span class="n">displacements</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">crop_size</span> <span class="o">-</span> <span class="n">displacements</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span id="Event.crop_images-184"><a href="#Event.crop_images-184"><span class="linenos">184</span></a>                <span class="n">displacements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">crop_size</span> <span class="o">-</span> <span class="n">displacements</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="Event.crop_images-185"><a href="#Event.crop_images-185"><span class="linenos">185</span></a>            <span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
</span><span id="Event.crop_images-186"><a href="#Event.crop_images-186"><span class="linenos">186</span></a>            <span class="n">cropped_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cropped_image</span><span class="p">)</span>
</span><span id="Event.crop_images-187"><a href="#Event.crop_images-187"><span class="linenos">187</span></a>        <span class="k">return</span> <span class="n">cropped_images</span>
</span></pre></div>


            <div class="docstring"><p>Get the event crops from the frame images. Called "get" because it does not
need to extract anything; it is very quick for extracting multiple events from
the same tile.
Use this if you're interested in many events.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>images</strong>:  the frame images.</li>
<li><strong>crop_size</strong>:  the square size of the image crop to get for this event.</li>
<li><strong>in_pixels</strong>:  whether the crop size is in pixels or micrometers. Defaults to pixels.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>image_size x image_size crops of the event in the provided frames. If
  the event is too close to the edge, the crop will be smaller and not centered.</p>
</blockquote>
</div>


                            </div>
                            <div id="Event.extract_images" class="classattr">
                                        <input id="Event.extract_images-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">extract_images</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">crop_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>,</span><span class="param">	<span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Event.extract_images-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Event.extract_images"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Event.extract_images-189"><a href="#Event.extract_images-189"><span class="linenos">189</span></a>    <span class="k">def</span> <span class="nf">extract_images</span><span class="p">(</span>
</span><span id="Event.extract_images-190"><a href="#Event.extract_images-190"><span class="linenos">190</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Event.extract_images-191"><a href="#Event.extract_images-191"><span class="linenos">191</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="Event.extract_images-192"><a href="#Event.extract_images-192"><span class="linenos">192</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event.extract_images-193"><a href="#Event.extract_images-193"><span class="linenos">193</span></a><span class="sd">        Extract the images from the scan and tile, reading from the file. Called</span>
</span><span id="Event.extract_images-194"><a href="#Event.extract_images-194"><span class="linenos">194</span></a><span class="sd">        &quot;extract&quot; because it must read and extract the images from file, which is slow.</span>
</span><span id="Event.extract_images-195"><a href="#Event.extract_images-195"><span class="linenos">195</span></a><span class="sd">        Use this if you&#39;re interested in only a few events, as it is inefficient when</span>
</span><span id="Event.extract_images-196"><a href="#Event.extract_images-196"><span class="linenos">196</span></a><span class="sd">        reading multiple events from the same tile.</span>
</span><span id="Event.extract_images-197"><a href="#Event.extract_images-197"><span class="linenos">197</span></a><span class="sd">        :param crop_size: the square size of the image crop to get for this event.</span>
</span><span id="Event.extract_images-198"><a href="#Event.extract_images-198"><span class="linenos">198</span></a><span class="sd">        :param in_pixels: whether the crop size is in pixels or micrometers. Defaults to pixels.</span>
</span><span id="Event.extract_images-199"><a href="#Event.extract_images-199"><span class="linenos">199</span></a><span class="sd">        :return: a list of cropped images from the scan in the order of the channels.</span>
</span><span id="Event.extract_images-200"><a href="#Event.extract_images-200"><span class="linenos">200</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Event.extract_images-201"><a href="#Event.extract_images-201"><span class="linenos">201</span></a>        <span class="n">frames</span> <span class="o">=</span> <span class="n">Frame</span><span class="o">.</span><span class="n">get_frames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="p">)</span>
</span><span id="Event.extract_images-202"><a href="#Event.extract_images-202"><span class="linenos">202</span></a>        <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">get_image</span><span class="p">()</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">]</span>
</span><span id="Event.extract_images-203"><a href="#Event.extract_images-203"><span class="linenos">203</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_images</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="n">in_pixels</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Extract the images from the scan and tile, reading from the file. Called
"extract" because it must read and extract the images from file, which is slow.
Use this if you're interested in only a few events, as it is inefficient when
reading multiple events from the same tile.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>crop_size</strong>:  the square size of the image crop to get for this event.</li>
<li><strong>in_pixels</strong>:  whether the crop size is in pixels or micrometers. Defaults to pixels.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a list of cropped images from the scan in the order of the channels.</p>
</blockquote>
</div>


                            </div>
                            <div id="Event.extract_images_for_list" class="classattr">
                                        <input id="Event.extract_images_for_list-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">extract_images_for_list</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">cls</span>,</span><span class="param">	<span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Self</span><span class="p">]</span>,</span><span class="param">	<span class="n">crop_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="Event.extract_images_for_list-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Event.extract_images_for_list"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Event.extract_images_for_list-205"><a href="#Event.extract_images_for_list-205"><span class="linenos">205</span></a>    <span class="nd">@classmethod</span>
</span><span id="Event.extract_images_for_list-206"><a href="#Event.extract_images_for_list-206"><span class="linenos">206</span></a>    <span class="k">def</span> <span class="nf">extract_images_for_list</span><span class="p">(</span>
</span><span id="Event.extract_images_for_list-207"><a href="#Event.extract_images_for_list-207"><span class="linenos">207</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="Event.extract_images_for_list-208"><a href="#Event.extract_images_for_list-208"><span class="linenos">208</span></a>        <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Self</span><span class="p">],</span>
</span><span id="Event.extract_images_for_list-209"><a href="#Event.extract_images_for_list-209"><span class="linenos">209</span></a>        <span class="n">crop_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Event.extract_images_for_list-210"><a href="#Event.extract_images_for_list-210"><span class="linenos">210</span></a>        <span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Event.extract_images_for_list-211"><a href="#Event.extract_images_for_list-211"><span class="linenos">211</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
</span><span id="Event.extract_images_for_list-212"><a href="#Event.extract_images_for_list-212"><span class="linenos">212</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event.extract_images_for_list-213"><a href="#Event.extract_images_for_list-213"><span class="linenos">213</span></a><span class="sd">        Get the images for a list of events, ensuring that there is no wasteful reading</span>
</span><span id="Event.extract_images_for_list-214"><a href="#Event.extract_images_for_list-214"><span class="linenos">214</span></a><span class="sd">        of the same tile multiple times. This function is more efficient than calling</span>
</span><span id="Event.extract_images_for_list-215"><a href="#Event.extract_images_for_list-215"><span class="linenos">215</span></a><span class="sd">        extract_event_images for each event.</span>
</span><span id="Event.extract_images_for_list-216"><a href="#Event.extract_images_for_list-216"><span class="linenos">216</span></a><span class="sd">        :param events: the events to extract images for.</span>
</span><span id="Event.extract_images_for_list-217"><a href="#Event.extract_images_for_list-217"><span class="linenos">217</span></a><span class="sd">        :param crop_size: the square size of the image crop to get for this event.</span>
</span><span id="Event.extract_images_for_list-218"><a href="#Event.extract_images_for_list-218"><span class="linenos">218</span></a><span class="sd">                          Defaults to four times the size of the event.</span>
</span><span id="Event.extract_images_for_list-219"><a href="#Event.extract_images_for_list-219"><span class="linenos">219</span></a><span class="sd">        :param in_pixels: whether the crop size is in pixels or micrometers.</span>
</span><span id="Event.extract_images_for_list-220"><a href="#Event.extract_images_for_list-220"><span class="linenos">220</span></a><span class="sd">                          Defaults to pixels, and is ignored if crop_size is None.</span>
</span><span id="Event.extract_images_for_list-221"><a href="#Event.extract_images_for_list-221"><span class="linenos">221</span></a><span class="sd">        :return: a list of lists of cropped images for each event.</span>
</span><span id="Event.extract_images_for_list-222"><a href="#Event.extract_images_for_list-222"><span class="linenos">222</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Event.extract_images_for_list-223"><a href="#Event.extract_images_for_list-223"><span class="linenos">223</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Event.extract_images_for_list-224"><a href="#Event.extract_images_for_list-224"><span class="linenos">224</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="Event.extract_images_for_list-225"><a href="#Event.extract_images_for_list-225"><span class="linenos">225</span></a>
</span><span id="Event.extract_images_for_list-226"><a href="#Event.extract_images_for_list-226"><span class="linenos">226</span></a>        <span class="c1"># Populate a crop size if none provided</span>
</span><span id="Event.extract_images_for_list-227"><a href="#Event.extract_images_for_list-227"><span class="linenos">227</span></a>        <span class="k">if</span> <span class="n">crop_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Event.extract_images_for_list-228"><a href="#Event.extract_images_for_list-228"><span class="linenos">228</span></a>            <span class="n">crop_size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span> <span class="o">*</span> <span class="n">event</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
</span><span id="Event.extract_images_for_list-229"><a href="#Event.extract_images_for_list-229"><span class="linenos">229</span></a>            <span class="n">in_pixels</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Event.extract_images_for_list-230"><a href="#Event.extract_images_for_list-230"><span class="linenos">230</span></a>        <span class="c1"># Propagate a constant crop size</span>
</span><span id="Event.extract_images_for_list-231"><a href="#Event.extract_images_for_list-231"><span class="linenos">231</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crop_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="Event.extract_images_for_list-232"><a href="#Event.extract_images_for_list-232"><span class="linenos">232</span></a>            <span class="n">crop_size</span> <span class="o">=</span> <span class="p">[</span><span class="n">crop_size</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</span><span id="Event.extract_images_for_list-233"><a href="#Event.extract_images_for_list-233"><span class="linenos">233</span></a>
</span><span id="Event.extract_images_for_list-234"><a href="#Event.extract_images_for_list-234"><span class="linenos">234</span></a>        <span class="c1"># Sort the events by tile; use a shallow copy to avoid modifying the original</span>
</span><span id="Event.extract_images_for_list-235"><a href="#Event.extract_images_for_list-235"><span class="linenos">235</span></a>        <span class="n">order</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">events</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()))</span>
</span><span id="Event.extract_images_for_list-236"><a href="#Event.extract_images_for_list-236"><span class="linenos">236</span></a>
</span><span id="Event.extract_images_for_list-237"><a href="#Event.extract_images_for_list-237"><span class="linenos">237</span></a>        <span class="c1"># Allocate the list to size</span>
</span><span id="Event.extract_images_for_list-238"><a href="#Event.extract_images_for_list-238"><span class="linenos">238</span></a>        <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</span><span id="Event.extract_images_for_list-239"><a href="#Event.extract_images_for_list-239"><span class="linenos">239</span></a>        <span class="n">last_tile</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Event.extract_images_for_list-240"><a href="#Event.extract_images_for_list-240"><span class="linenos">240</span></a>        <span class="n">frame_images</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Holds large numpy arrays, so expensive to compare</span>
</span><span id="Event.extract_images_for_list-241"><a href="#Event.extract_images_for_list-241"><span class="linenos">241</span></a>        <span class="c1"># Iterate through in sorted order</span>
</span><span id="Event.extract_images_for_list-242"><a href="#Event.extract_images_for_list-242"><span class="linenos">242</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
</span><span id="Event.extract_images_for_list-243"><a href="#Event.extract_images_for_list-243"><span class="linenos">243</span></a>            <span class="k">if</span> <span class="n">last_tile</span> <span class="o">!=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tile</span><span class="p">:</span>
</span><span id="Event.extract_images_for_list-244"><a href="#Event.extract_images_for_list-244"><span class="linenos">244</span></a>                <span class="c1"># Gather the frame images, preserving them for the next event</span>
</span><span id="Event.extract_images_for_list-245"><a href="#Event.extract_images_for_list-245"><span class="linenos">245</span></a>                <span class="n">frames</span> <span class="o">=</span> <span class="n">Frame</span><span class="o">.</span><span class="n">get_frames</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tile</span><span class="p">)</span>
</span><span id="Event.extract_images_for_list-246"><a href="#Event.extract_images_for_list-246"><span class="linenos">246</span></a>                <span class="n">frame_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">get_image</span><span class="p">()</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">]</span>
</span><span id="Event.extract_images_for_list-247"><a href="#Event.extract_images_for_list-247"><span class="linenos">247</span></a>
</span><span id="Event.extract_images_for_list-248"><a href="#Event.extract_images_for_list-248"><span class="linenos">248</span></a>                <span class="n">last_tile</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tile</span>
</span><span id="Event.extract_images_for_list-249"><a href="#Event.extract_images_for_list-249"><span class="linenos">249</span></a>            <span class="c1"># Use the frame images to crop the event images</span>
</span><span id="Event.extract_images_for_list-250"><a href="#Event.extract_images_for_list-250"><span class="linenos">250</span></a>            <span class="c1"># Preserve the original order using order[i]</span>
</span><span id="Event.extract_images_for_list-251"><a href="#Event.extract_images_for_list-251"><span class="linenos">251</span></a>            <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">crop_images</span><span class="p">(</span><span class="n">frame_images</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">in_pixels</span><span class="p">)</span>
</span><span id="Event.extract_images_for_list-252"><a href="#Event.extract_images_for_list-252"><span class="linenos">252</span></a>        <span class="k">return</span> <span class="n">images</span>
</span></pre></div>


            <div class="docstring"><p>Get the images for a list of events, ensuring that there is no wasteful reading
of the same tile multiple times. This function is more efficient than calling
extract_event_images for each event.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>events</strong>:  the events to extract images for.</li>
<li><strong>crop_size</strong>:  the square size of the image crop to get for this event.
Defaults to four times the size of the event.</li>
<li><strong>in_pixels</strong>:  whether the crop size is in pixels or micrometers.
Defaults to pixels, and is ignored if crop_size is None.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a list of lists of cropped images for each event.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="EventArray">
                            <input id="EventArray-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">EventArray</span>:

                <label class="view-source-button" for="EventArray-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray-255"><a href="#EventArray-255"><span class="linenos"> 255</span></a><span class="k">class</span> <span class="nc">EventArray</span><span class="p">:</span>
</span><span id="EventArray-256"><a href="#EventArray-256"><span class="linenos"> 256</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-257"><a href="#EventArray-257"><span class="linenos"> 257</span></a><span class="sd">    A class that holds a large number of events&#39; data, making it easy to analyze and</span>
</span><span id="EventArray-258"><a href="#EventArray-258"><span class="linenos"> 258</span></a><span class="sd">    manipulate many events at once. A more separated version of the Event class.</span>
</span><span id="EventArray-259"><a href="#EventArray-259"><span class="linenos"> 259</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="EventArray-260"><a href="#EventArray-260"><span class="linenos"> 260</span></a>
</span><span id="EventArray-261"><a href="#EventArray-261"><span class="linenos"> 261</span></a>    <span class="n">INFO_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">,</span> <span class="s2">&quot;tile&quot;</span><span class="p">,</span> <span class="s2">&quot;roi&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">]</span>
</span><span id="EventArray-262"><a href="#EventArray-262"><span class="linenos"> 262</span></a>
</span><span id="EventArray-263"><a href="#EventArray-263"><span class="linenos"> 263</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="EventArray-264"><a href="#EventArray-264"><span class="linenos"> 264</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="EventArray-265"><a href="#EventArray-265"><span class="linenos"> 265</span></a>        <span class="n">info</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EventArray-266"><a href="#EventArray-266"><span class="linenos"> 266</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EventArray-267"><a href="#EventArray-267"><span class="linenos"> 267</span></a>        <span class="n">features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EventArray-268"><a href="#EventArray-268"><span class="linenos"> 268</span></a>    <span class="p">):</span>
</span><span id="EventArray-269"><a href="#EventArray-269"><span class="linenos"> 269</span></a>        <span class="c1"># Info must be a DataFrame with columns &quot;slide_id&quot;, &quot;tile&quot;, &quot;roi&quot;, &quot;x&quot;, &quot;y&quot;, &quot;size&quot;</span>
</span><span id="EventArray-270"><a href="#EventArray-270"><span class="linenos"> 270</span></a>        <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-271"><a href="#EventArray-271"><span class="linenos"> 271</span></a>            <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">INFO_COLUMNS</span><span class="p">:</span>
</span><span id="EventArray-272"><a href="#EventArray-272"><span class="linenos"> 272</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="EventArray-273"><a href="#EventArray-273"><span class="linenos"> 273</span></a>                    <span class="s2">&quot;EventArray.info must have columns &#39;slide_id&#39;, &#39;tile&#39;, &#39;roi&#39;, &#39;x&#39;, &#39;y&#39;, &#39;size&#39;&quot;</span>
</span><span id="EventArray-274"><a href="#EventArray-274"><span class="linenos"> 274</span></a>                <span class="p">)</span>
</span><span id="EventArray-275"><a href="#EventArray-275"><span class="linenos"> 275</span></a>            <span class="c1"># Copy first to avoid modifying the original</span>
</span><span id="EventArray-276"><a href="#EventArray-276"><span class="linenos"> 276</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray-277"><a href="#EventArray-277"><span class="linenos"> 277</span></a>            <span class="c1"># Ensure that the columns are the right types</span>
</span><span id="EventArray-278"><a href="#EventArray-278"><span class="linenos"> 278</span></a>            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="EventArray-279"><a href="#EventArray-279"><span class="linenos"> 279</span></a>            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="EventArray-280"><a href="#EventArray-280"><span class="linenos"> 280</span></a>            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="EventArray-281"><a href="#EventArray-281"><span class="linenos"> 281</span></a>            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="EventArray-282"><a href="#EventArray-282"><span class="linenos"> 282</span></a>            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="EventArray-283"><a href="#EventArray-283"><span class="linenos"> 283</span></a>            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="EventArray-284"><a href="#EventArray-284"><span class="linenos"> 284</span></a>        <span class="c1"># All DataFrames must all have the same number of rows</span>
</span><span id="EventArray-285"><a href="#EventArray-285"><span class="linenos"> 285</span></a>        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="p">)):</span>
</span><span id="EventArray-286"><a href="#EventArray-286"><span class="linenos"> 286</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="EventArray-287"><a href="#EventArray-287"><span class="linenos"> 287</span></a>                <span class="s2">&quot;If EventArray.metadata is not None, it should match rows with .info&quot;</span>
</span><span id="EventArray-288"><a href="#EventArray-288"><span class="linenos"> 288</span></a>            <span class="p">)</span>
</span><span id="EventArray-289"><a href="#EventArray-289"><span class="linenos"> 289</span></a>        <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)):</span>
</span><span id="EventArray-290"><a href="#EventArray-290"><span class="linenos"> 290</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="EventArray-291"><a href="#EventArray-291"><span class="linenos"> 291</span></a>                <span class="s2">&quot;If EventArray.features is not None, it should match rows with .info&quot;</span>
</span><span id="EventArray-292"><a href="#EventArray-292"><span class="linenos"> 292</span></a>            <span class="p">)</span>
</span><span id="EventArray-293"><a href="#EventArray-293"><span class="linenos"> 293</span></a>        <span class="c1"># No columns named &quot;metadata_&quot;, &quot;features_&quot;, or &quot;None&quot;</span>
</span><span id="EventArray-294"><a href="#EventArray-294"><span class="linenos"> 294</span></a>        <span class="n">column_names</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray-295"><a href="#EventArray-295"><span class="linenos"> 295</span></a>        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-296"><a href="#EventArray-296"><span class="linenos"> 296</span></a>            <span class="n">column_names</span> <span class="o">+=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="EventArray-297"><a href="#EventArray-297"><span class="linenos"> 297</span></a>        <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-298"><a href="#EventArray-298"><span class="linenos"> 298</span></a>            <span class="n">column_names</span> <span class="o">+=</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="EventArray-299"><a href="#EventArray-299"><span class="linenos"> 299</span></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;metadata_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">]):</span>
</span><span id="EventArray-300"><a href="#EventArray-300"><span class="linenos"> 300</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;EventArray column names cannot start with &#39;metadata_&#39;&quot;</span><span class="p">)</span>
</span><span id="EventArray-301"><a href="#EventArray-301"><span class="linenos"> 301</span></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;features_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">]):</span>
</span><span id="EventArray-302"><a href="#EventArray-302"><span class="linenos"> 302</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;EventArray column names cannot start with &#39;features_&#39;&quot;</span><span class="p">)</span>
</span><span id="EventArray-303"><a href="#EventArray-303"><span class="linenos"> 303</span></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">]):</span>
</span><span id="EventArray-304"><a href="#EventArray-304"><span class="linenos"> 304</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;EventArray column names cannot be &#39;none&#39;&quot;</span><span class="p">)</span>
</span><span id="EventArray-305"><a href="#EventArray-305"><span class="linenos"> 305</span></a>
</span><span id="EventArray-306"><a href="#EventArray-306"><span class="linenos"> 306</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
</span><span id="EventArray-307"><a href="#EventArray-307"><span class="linenos"> 307</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
</span><span id="EventArray-308"><a href="#EventArray-308"><span class="linenos"> 308</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
</span><span id="EventArray-309"><a href="#EventArray-309"><span class="linenos"> 309</span></a>
</span><span id="EventArray-310"><a href="#EventArray-310"><span class="linenos"> 310</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="EventArray-311"><a href="#EventArray-311"><span class="linenos"> 311</span></a>        <span class="c1"># Convenience method to get the number of events</span>
</span><span id="EventArray-312"><a href="#EventArray-312"><span class="linenos"> 312</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-313"><a href="#EventArray-313"><span class="linenos"> 313</span></a>            <span class="k">return</span> <span class="mi">0</span>
</span><span id="EventArray-314"><a href="#EventArray-314"><span class="linenos"> 314</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-315"><a href="#EventArray-315"><span class="linenos"> 315</span></a>            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
</span><span id="EventArray-316"><a href="#EventArray-316"><span class="linenos"> 316</span></a>
</span><span id="EventArray-317"><a href="#EventArray-317"><span class="linenos"> 317</span></a>    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="EventArray-318"><a href="#EventArray-318"><span class="linenos"> 318</span></a>        <span class="n">is_equal</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="EventArray-319"><a href="#EventArray-319"><span class="linenos"> 319</span></a>        <span class="c1"># Parse all possibilities for info</span>
</span><span id="EventArray-320"><a href="#EventArray-320"><span class="linenos"> 320</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="EventArray-321"><a href="#EventArray-321"><span class="linenos"> 321</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="EventArray-322"><a href="#EventArray-322"><span class="linenos"> 322</span></a>                <span class="n">is_equal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
</span><span id="EventArray-323"><a href="#EventArray-323"><span class="linenos"> 323</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_equal</span><span class="p">:</span>
</span><span id="EventArray-324"><a href="#EventArray-324"><span class="linenos"> 324</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="EventArray-325"><a href="#EventArray-325"><span class="linenos"> 325</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-326"><a href="#EventArray-326"><span class="linenos"> 326</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="EventArray-327"><a href="#EventArray-327"><span class="linenos"> 327</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-328"><a href="#EventArray-328"><span class="linenos"> 328</span></a>            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-329"><a href="#EventArray-329"><span class="linenos"> 329</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="EventArray-330"><a href="#EventArray-330"><span class="linenos"> 330</span></a>
</span><span id="EventArray-331"><a href="#EventArray-331"><span class="linenos"> 331</span></a>        <span class="c1"># Parse all possibilities for metadata</span>
</span><span id="EventArray-332"><a href="#EventArray-332"><span class="linenos"> 332</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="EventArray-333"><a href="#EventArray-333"><span class="linenos"> 333</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="EventArray-334"><a href="#EventArray-334"><span class="linenos"> 334</span></a>                <span class="n">is_equal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
</span><span id="EventArray-335"><a href="#EventArray-335"><span class="linenos"> 335</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_equal</span><span class="p">:</span>
</span><span id="EventArray-336"><a href="#EventArray-336"><span class="linenos"> 336</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="EventArray-337"><a href="#EventArray-337"><span class="linenos"> 337</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-338"><a href="#EventArray-338"><span class="linenos"> 338</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="EventArray-339"><a href="#EventArray-339"><span class="linenos"> 339</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-340"><a href="#EventArray-340"><span class="linenos"> 340</span></a>            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-341"><a href="#EventArray-341"><span class="linenos"> 341</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="EventArray-342"><a href="#EventArray-342"><span class="linenos"> 342</span></a>
</span><span id="EventArray-343"><a href="#EventArray-343"><span class="linenos"> 343</span></a>        <span class="c1"># Parse all possibilities for features</span>
</span><span id="EventArray-344"><a href="#EventArray-344"><span class="linenos"> 344</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="EventArray-345"><a href="#EventArray-345"><span class="linenos"> 345</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="EventArray-346"><a href="#EventArray-346"><span class="linenos"> 346</span></a>                <span class="n">is_equal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
</span><span id="EventArray-347"><a href="#EventArray-347"><span class="linenos"> 347</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_equal</span><span class="p">:</span>
</span><span id="EventArray-348"><a href="#EventArray-348"><span class="linenos"> 348</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="EventArray-349"><a href="#EventArray-349"><span class="linenos"> 349</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-350"><a href="#EventArray-350"><span class="linenos"> 350</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="EventArray-351"><a href="#EventArray-351"><span class="linenos"> 351</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-352"><a href="#EventArray-352"><span class="linenos"> 352</span></a>            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-353"><a href="#EventArray-353"><span class="linenos"> 353</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="EventArray-354"><a href="#EventArray-354"><span class="linenos"> 354</span></a>
</span><span id="EventArray-355"><a href="#EventArray-355"><span class="linenos"> 355</span></a>        <span class="k">return</span> <span class="n">is_equal</span>
</span><span id="EventArray-356"><a href="#EventArray-356"><span class="linenos"> 356</span></a>
</span><span id="EventArray-357"><a href="#EventArray-357"><span class="linenos"> 357</span></a>    <span class="k">def</span> <span class="nf">get_sort_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ascending</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
</span><span id="EventArray-358"><a href="#EventArray-358"><span class="linenos"> 358</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-359"><a href="#EventArray-359"><span class="linenos"> 359</span></a><span class="sd">        Get the sort order for the EventArray by a column in the info, metadata, or features DataFrames.</span>
</span><span id="EventArray-360"><a href="#EventArray-360"><span class="linenos"> 360</span></a><span class="sd">        :param by: name of the column(s) to sort by.</span>
</span><span id="EventArray-361"><a href="#EventArray-361"><span class="linenos"> 361</span></a><span class="sd">        :param ascending: whether to sort in ascending order; can be a list to match by</span>
</span><span id="EventArray-362"><a href="#EventArray-362"><span class="linenos"> 362</span></a><span class="sd">        :return: the order of the indices to sort by.</span>
</span><span id="EventArray-363"><a href="#EventArray-363"><span class="linenos"> 363</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-364"><a href="#EventArray-364"><span class="linenos"> 364</span></a>        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">by</span><span class="p">)</span>
</span><span id="EventArray-365"><a href="#EventArray-365"><span class="linenos"> 365</span></a>        <span class="k">return</span> <span class="n">columns</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">by</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="n">ascending</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
</span><span id="EventArray-366"><a href="#EventArray-366"><span class="linenos"> 366</span></a>
</span><span id="EventArray-367"><a href="#EventArray-367"><span class="linenos"> 367</span></a>    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ascending</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray-368"><a href="#EventArray-368"><span class="linenos"> 368</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-369"><a href="#EventArray-369"><span class="linenos"> 369</span></a><span class="sd">        Sort the EventArray by column(s) in the info, metadata, or features DataFrames.</span>
</span><span id="EventArray-370"><a href="#EventArray-370"><span class="linenos"> 370</span></a><span class="sd">        :param by: name of the column(s) to sort by.</span>
</span><span id="EventArray-371"><a href="#EventArray-371"><span class="linenos"> 371</span></a><span class="sd">        :param ascending: whether to sort in ascending order; can be a list to match by</span>
</span><span id="EventArray-372"><a href="#EventArray-372"><span class="linenos"> 372</span></a><span class="sd">        :return: a new, sorted EventArray.</span>
</span><span id="EventArray-373"><a href="#EventArray-373"><span class="linenos"> 373</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-374"><a href="#EventArray-374"><span class="linenos"> 374</span></a>        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sort_order</span><span class="p">(</span><span class="n">by</span><span class="p">,</span> <span class="n">ascending</span><span class="p">)</span>
</span><span id="EventArray-375"><a href="#EventArray-375"><span class="linenos"> 375</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray-376"><a href="#EventArray-376"><span class="linenos"> 376</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-377"><a href="#EventArray-377"><span class="linenos"> 377</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray-378"><a href="#EventArray-378"><span class="linenos"> 378</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-379"><a href="#EventArray-379"><span class="linenos"> 379</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-380"><a href="#EventArray-380"><span class="linenos"> 380</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-381"><a href="#EventArray-381"><span class="linenos"> 381</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray-382"><a href="#EventArray-382"><span class="linenos"> 382</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-383"><a href="#EventArray-383"><span class="linenos"> 383</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-384"><a href="#EventArray-384"><span class="linenos"> 384</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
</span><span id="EventArray-385"><a href="#EventArray-385"><span class="linenos"> 385</span></a>
</span><span id="EventArray-386"><a href="#EventArray-386"><span class="linenos"> 386</span></a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_names</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="EventArray-387"><a href="#EventArray-387"><span class="linenos"> 387</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-388"><a href="#EventArray-388"><span class="linenos"> 388</span></a><span class="sd">        Get a DataFrame with the specified columns from the EventArray, by value.</span>
</span><span id="EventArray-389"><a href="#EventArray-389"><span class="linenos"> 389</span></a><span class="sd">        :param column_names: the names of the columns to get.</span>
</span><span id="EventArray-390"><a href="#EventArray-390"><span class="linenos"> 390</span></a><span class="sd">        :return: a DataFrame with the specified columns.</span>
</span><span id="EventArray-391"><a href="#EventArray-391"><span class="linenos"> 391</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-392"><a href="#EventArray-392"><span class="linenos"> 392</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_names</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="EventArray-393"><a href="#EventArray-393"><span class="linenos"> 393</span></a>            <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">column_names</span><span class="p">]</span>
</span><span id="EventArray-394"><a href="#EventArray-394"><span class="linenos"> 394</span></a>        <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray-395"><a href="#EventArray-395"><span class="linenos"> 395</span></a>        <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">:</span>
</span><span id="EventArray-396"><a href="#EventArray-396"><span class="linenos"> 396</span></a>            <span class="k">if</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="EventArray-397"><a href="#EventArray-397"><span class="linenos"> 397</span></a>                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">column_name</span><span class="p">])</span>
</span><span id="EventArray-398"><a href="#EventArray-398"><span class="linenos"> 398</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="EventArray-399"><a href="#EventArray-399"><span class="linenos"> 399</span></a>                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">column_name</span><span class="p">])</span>
</span><span id="EventArray-400"><a href="#EventArray-400"><span class="linenos"> 400</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="EventArray-401"><a href="#EventArray-401"><span class="linenos"> 401</span></a>                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">column_name</span><span class="p">])</span>
</span><span id="EventArray-402"><a href="#EventArray-402"><span class="linenos"> 402</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-403"><a href="#EventArray-403"><span class="linenos"> 403</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column </span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s2"> not found in EventArray&quot;</span><span class="p">)</span>
</span><span id="EventArray-404"><a href="#EventArray-404"><span class="linenos"> 404</span></a>        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventArray-405"><a href="#EventArray-405"><span class="linenos"> 405</span></a>
</span><span id="EventArray-406"><a href="#EventArray-406"><span class="linenos"> 406</span></a>    <span class="k">def</span> <span class="nf">rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray-407"><a href="#EventArray-407"><span class="linenos"> 407</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-408"><a href="#EventArray-408"><span class="linenos"> 408</span></a><span class="sd">        Get a subset of the EventArray rows based on a boolean or integer index, by value.</span>
</span><span id="EventArray-409"><a href="#EventArray-409"><span class="linenos"> 409</span></a><span class="sd">        :param rows: the indices to get as a 1D boolean/integer list/array/series</span>
</span><span id="EventArray-410"><a href="#EventArray-410"><span class="linenos"> 410</span></a><span class="sd">        :return: a new EventArray with the subset of events.</span>
</span><span id="EventArray-411"><a href="#EventArray-411"><span class="linenos"> 411</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-412"><a href="#EventArray-412"><span class="linenos"> 412</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rows</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray-413"><a href="#EventArray-413"><span class="linenos"> 413</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-414"><a href="#EventArray-414"><span class="linenos"> 414</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rows</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray-415"><a href="#EventArray-415"><span class="linenos"> 415</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-416"><a href="#EventArray-416"><span class="linenos"> 416</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-417"><a href="#EventArray-417"><span class="linenos"> 417</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-418"><a href="#EventArray-418"><span class="linenos"> 418</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rows</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray-419"><a href="#EventArray-419"><span class="linenos"> 419</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-420"><a href="#EventArray-420"><span class="linenos"> 420</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-421"><a href="#EventArray-421"><span class="linenos"> 421</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
</span><span id="EventArray-422"><a href="#EventArray-422"><span class="linenos"> 422</span></a>
</span><span id="EventArray-423"><a href="#EventArray-423"><span class="linenos"> 423</span></a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray-424"><a href="#EventArray-424"><span class="linenos"> 424</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-425"><a href="#EventArray-425"><span class="linenos"> 425</span></a><span class="sd">        Create a deep copy of the EventArray.</span>
</span><span id="EventArray-426"><a href="#EventArray-426"><span class="linenos"> 426</span></a><span class="sd">        :return: a deep copy of the EventArray.</span>
</span><span id="EventArray-427"><a href="#EventArray-427"><span class="linenos"> 427</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-428"><a href="#EventArray-428"><span class="linenos"> 428</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span>
</span><span id="EventArray-429"><a href="#EventArray-429"><span class="linenos"> 429</span></a>            <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
</span><span id="EventArray-430"><a href="#EventArray-430"><span class="linenos"> 430</span></a>            <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
</span><span id="EventArray-431"><a href="#EventArray-431"><span class="linenos"> 431</span></a>            <span class="n">features</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
</span><span id="EventArray-432"><a href="#EventArray-432"><span class="linenos"> 432</span></a>        <span class="p">)</span>
</span><span id="EventArray-433"><a href="#EventArray-433"><span class="linenos"> 433</span></a>
</span><span id="EventArray-434"><a href="#EventArray-434"><span class="linenos"> 434</span></a>    <span class="k">def</span> <span class="nf">add_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-435"><a href="#EventArray-435"><span class="linenos"> 435</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-436"><a href="#EventArray-436"><span class="linenos"> 436</span></a><span class="sd">        Add metadata to the EventArray. Removes the need to check if metadata is None.</span>
</span><span id="EventArray-437"><a href="#EventArray-437"><span class="linenos"> 437</span></a><span class="sd">        Overwrites any existing metadata with the same column names as the new metadata.</span>
</span><span id="EventArray-438"><a href="#EventArray-438"><span class="linenos"> 438</span></a><span class="sd">        :param new_metadata: the metadata to add.</span>
</span><span id="EventArray-439"><a href="#EventArray-439"><span class="linenos"> 439</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-440"><a href="#EventArray-440"><span class="linenos"> 440</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_metadata</span><span class="p">):</span>
</span><span id="EventArray-441"><a href="#EventArray-441"><span class="linenos"> 441</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;New metadata must match length of existing info&quot;</span><span class="p">)</span>
</span><span id="EventArray-442"><a href="#EventArray-442"><span class="linenos"> 442</span></a>
</span><span id="EventArray-443"><a href="#EventArray-443"><span class="linenos"> 443</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-444"><a href="#EventArray-444"><span class="linenos"> 444</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">new_metadata</span>
</span><span id="EventArray-445"><a href="#EventArray-445"><span class="linenos"> 445</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-446"><a href="#EventArray-446"><span class="linenos"> 446</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_metadata</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
</span><span id="EventArray-447"><a href="#EventArray-447"><span class="linenos"> 447</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">new_metadata</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_metadata</span>
</span><span id="EventArray-448"><a href="#EventArray-448"><span class="linenos"> 448</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-449"><a href="#EventArray-449"><span class="linenos"> 449</span></a>                <span class="c1"># It&#39;s a DataFrame</span>
</span><span id="EventArray-450"><a href="#EventArray-450"><span class="linenos"> 450</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">new_metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_metadata</span>
</span><span id="EventArray-451"><a href="#EventArray-451"><span class="linenos"> 451</span></a>
</span><span id="EventArray-452"><a href="#EventArray-452"><span class="linenos"> 452</span></a>    <span class="k">def</span> <span class="nf">add_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-453"><a href="#EventArray-453"><span class="linenos"> 453</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-454"><a href="#EventArray-454"><span class="linenos"> 454</span></a><span class="sd">        Add features to the EventArray. Removes the need to check if features is None.</span>
</span><span id="EventArray-455"><a href="#EventArray-455"><span class="linenos"> 455</span></a><span class="sd">        Overwrites any existing features with the same column names as the new features.</span>
</span><span id="EventArray-456"><a href="#EventArray-456"><span class="linenos"> 456</span></a><span class="sd">        :param new_features: the features to add.</span>
</span><span id="EventArray-457"><a href="#EventArray-457"><span class="linenos"> 457</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-458"><a href="#EventArray-458"><span class="linenos"> 458</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_features</span><span class="p">):</span>
</span><span id="EventArray-459"><a href="#EventArray-459"><span class="linenos"> 459</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;New features must match length of existing info&quot;</span><span class="p">)</span>
</span><span id="EventArray-460"><a href="#EventArray-460"><span class="linenos"> 460</span></a>
</span><span id="EventArray-461"><a href="#EventArray-461"><span class="linenos"> 461</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-462"><a href="#EventArray-462"><span class="linenos"> 462</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">new_features</span>
</span><span id="EventArray-463"><a href="#EventArray-463"><span class="linenos"> 463</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-464"><a href="#EventArray-464"><span class="linenos"> 464</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_features</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
</span><span id="EventArray-465"><a href="#EventArray-465"><span class="linenos"> 465</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">new_features</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_features</span>
</span><span id="EventArray-466"><a href="#EventArray-466"><span class="linenos"> 466</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-467"><a href="#EventArray-467"><span class="linenos"> 467</span></a>                <span class="c1"># It&#39;s a DataFrame</span>
</span><span id="EventArray-468"><a href="#EventArray-468"><span class="linenos"> 468</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">new_features</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_features</span>
</span><span id="EventArray-469"><a href="#EventArray-469"><span class="linenos"> 469</span></a>
</span><span id="EventArray-470"><a href="#EventArray-470"><span class="linenos"> 470</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray-471"><a href="#EventArray-471"><span class="linenos"> 471</span></a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Self</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray-472"><a href="#EventArray-472"><span class="linenos"> 472</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-473"><a href="#EventArray-473"><span class="linenos"> 473</span></a><span class="sd">        Combine EventArrays in a list into a single EventArray.</span>
</span><span id="EventArray-474"><a href="#EventArray-474"><span class="linenos"> 474</span></a><span class="sd">        :param events: the new list of events.</span>
</span><span id="EventArray-475"><a href="#EventArray-475"><span class="linenos"> 475</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-476"><a href="#EventArray-476"><span class="linenos"> 476</span></a>        <span class="n">all_info</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray-477"><a href="#EventArray-477"><span class="linenos"> 477</span></a>        <span class="n">all_metadata</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray-478"><a href="#EventArray-478"><span class="linenos"> 478</span></a>        <span class="n">all_features</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray-479"><a href="#EventArray-479"><span class="linenos"> 479</span></a>        <span class="k">for</span> <span class="n">event_array</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="EventArray-480"><a href="#EventArray-480"><span class="linenos"> 480</span></a>            <span class="c1"># Skip empty EventArrays</span>
</span><span id="EventArray-481"><a href="#EventArray-481"><span class="linenos"> 481</span></a>            <span class="k">if</span> <span class="n">event_array</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-482"><a href="#EventArray-482"><span class="linenos"> 482</span></a>                <span class="n">all_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_array</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
</span><span id="EventArray-483"><a href="#EventArray-483"><span class="linenos"> 483</span></a>            <span class="k">if</span> <span class="n">event_array</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-484"><a href="#EventArray-484"><span class="linenos"> 484</span></a>                <span class="n">all_metadata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_array</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
</span><span id="EventArray-485"><a href="#EventArray-485"><span class="linenos"> 485</span></a>            <span class="k">if</span> <span class="n">event_array</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-486"><a href="#EventArray-486"><span class="linenos"> 486</span></a>                <span class="n">all_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_array</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
</span><span id="EventArray-487"><a href="#EventArray-487"><span class="linenos"> 487</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray-488"><a href="#EventArray-488"><span class="linenos"> 488</span></a>            <span class="k">return</span> <span class="n">EventArray</span><span class="p">()</span>
</span><span id="EventArray-489"><a href="#EventArray-489"><span class="linenos"> 489</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-490"><a href="#EventArray-490"><span class="linenos"> 490</span></a>            <span class="n">all_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_info</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray-491"><a href="#EventArray-491"><span class="linenos"> 491</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_metadata</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray-492"><a href="#EventArray-492"><span class="linenos"> 492</span></a>            <span class="n">all_metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-493"><a href="#EventArray-493"><span class="linenos"> 493</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-494"><a href="#EventArray-494"><span class="linenos"> 494</span></a>            <span class="n">all_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_metadata</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray-495"><a href="#EventArray-495"><span class="linenos"> 495</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_features</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray-496"><a href="#EventArray-496"><span class="linenos"> 496</span></a>            <span class="n">all_features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-497"><a href="#EventArray-497"><span class="linenos"> 497</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-498"><a href="#EventArray-498"><span class="linenos"> 498</span></a>            <span class="n">all_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_features</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray-499"><a href="#EventArray-499"><span class="linenos"> 499</span></a>
</span><span id="EventArray-500"><a href="#EventArray-500"><span class="linenos"> 500</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">all_info</span><span class="p">,</span> <span class="n">all_metadata</span><span class="p">,</span> <span class="n">all_features</span><span class="p">)</span>
</span><span id="EventArray-501"><a href="#EventArray-501"><span class="linenos"> 501</span></a>
</span><span id="EventArray-502"><a href="#EventArray-502"><span class="linenos"> 502</span></a>    <span class="k">def</span> <span class="nf">to_events</span><span class="p">(</span>
</span><span id="EventArray-503"><a href="#EventArray-503"><span class="linenos"> 503</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="EventArray-504"><a href="#EventArray-504"><span class="linenos"> 504</span></a>        <span class="n">scans</span><span class="p">:</span> <span class="n">Scan</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">Scan</span><span class="p">],</span>
</span><span id="EventArray-505"><a href="#EventArray-505"><span class="linenos"> 505</span></a>        <span class="n">ignore_missing_scans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="EventArray-506"><a href="#EventArray-506"><span class="linenos"> 506</span></a>        <span class="n">ignore_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="EventArray-507"><a href="#EventArray-507"><span class="linenos"> 507</span></a>        <span class="n">ignore_features</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="EventArray-508"><a href="#EventArray-508"><span class="linenos"> 508</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Event</span><span class="p">]:</span>
</span><span id="EventArray-509"><a href="#EventArray-509"><span class="linenos"> 509</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-510"><a href="#EventArray-510"><span class="linenos"> 510</span></a><span class="sd">        Get the events in the EventArray as a list of events.</span>
</span><span id="EventArray-511"><a href="#EventArray-511"><span class="linenos"> 511</span></a><span class="sd">        :param scans: the scans that the events belong to, auto-matched by slide_id.</span>
</span><span id="EventArray-512"><a href="#EventArray-512"><span class="linenos"> 512</span></a><span class="sd">        Pass None if you don&#39;t care about scan metadata (pass ignore_missing_scans).</span>
</span><span id="EventArray-513"><a href="#EventArray-513"><span class="linenos"> 513</span></a><span class="sd">        :param ignore_missing_scans: whether to create blank scans for events without scans.</span>
</span><span id="EventArray-514"><a href="#EventArray-514"><span class="linenos"> 514</span></a><span class="sd">        :param ignore_metadata: whether to ignore metadata or not</span>
</span><span id="EventArray-515"><a href="#EventArray-515"><span class="linenos"> 515</span></a><span class="sd">        :param ignore_features: whether to ignore features or not</span>
</span><span id="EventArray-516"><a href="#EventArray-516"><span class="linenos"> 516</span></a><span class="sd">        :return:</span>
</span><span id="EventArray-517"><a href="#EventArray-517"><span class="linenos"> 517</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-518"><a href="#EventArray-518"><span class="linenos"> 518</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scans</span><span class="p">,</span> <span class="n">Scan</span><span class="p">):</span>
</span><span id="EventArray-519"><a href="#EventArray-519"><span class="linenos"> 519</span></a>            <span class="n">scans</span> <span class="o">=</span> <span class="p">[</span><span class="n">scans</span><span class="p">]</span>
</span><span id="EventArray-520"><a href="#EventArray-520"><span class="linenos"> 520</span></a>        <span class="n">scans</span> <span class="o">=</span> <span class="p">{</span><span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span><span class="p">:</span> <span class="n">scan</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">}</span>
</span><span id="EventArray-521"><a href="#EventArray-521"><span class="linenos"> 521</span></a>        <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray-522"><a href="#EventArray-522"><span class="linenos"> 522</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)):</span>
</span><span id="EventArray-523"><a href="#EventArray-523"><span class="linenos"> 523</span></a>            <span class="c1"># Determine the associated scan</span>
</span><span id="EventArray-524"><a href="#EventArray-524"><span class="linenos"> 524</span></a>            <span class="n">slide_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span id="EventArray-525"><a href="#EventArray-525"><span class="linenos"> 525</span></a>            <span class="k">if</span> <span class="n">slide_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
</span><span id="EventArray-526"><a href="#EventArray-526"><span class="linenos"> 526</span></a>                <span class="k">if</span> <span class="n">ignore_missing_scans</span><span class="p">:</span>
</span><span id="EventArray-527"><a href="#EventArray-527"><span class="linenos"> 527</span></a>                    <span class="c1"># Create a placeholder scan if the scan is missing</span>
</span><span id="EventArray-528"><a href="#EventArray-528"><span class="linenos"> 528</span></a>                    <span class="n">scan</span> <span class="o">=</span> <span class="n">Scan</span><span class="o">.</span><span class="n">make_placeholder</span><span class="p">(</span>
</span><span id="EventArray-529"><a href="#EventArray-529"><span class="linenos"> 529</span></a>                        <span class="n">slide_id</span><span class="p">,</span>
</span><span id="EventArray-530"><a href="#EventArray-530"><span class="linenos"> 530</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray-531"><a href="#EventArray-531"><span class="linenos"> 531</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray-532"><a href="#EventArray-532"><span class="linenos"> 532</span></a>                    <span class="p">)</span>
</span><span id="EventArray-533"><a href="#EventArray-533"><span class="linenos"> 533</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-534"><a href="#EventArray-534"><span class="linenos"> 534</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="EventArray-535"><a href="#EventArray-535"><span class="linenos"> 535</span></a>                        <span class="sa">f</span><span class="s2">&quot;Scan </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;slide_id&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found for event </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="EventArray-536"><a href="#EventArray-536"><span class="linenos"> 536</span></a>                    <span class="p">)</span>
</span><span id="EventArray-537"><a href="#EventArray-537"><span class="linenos"> 537</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-538"><a href="#EventArray-538"><span class="linenos"> 538</span></a>                <span class="n">scan</span> <span class="o">=</span> <span class="n">scans</span><span class="p">[</span><span class="n">slide_id</span><span class="p">]</span>
</span><span id="EventArray-539"><a href="#EventArray-539"><span class="linenos"> 539</span></a>
</span><span id="EventArray-540"><a href="#EventArray-540"><span class="linenos"> 540</span></a>            <span class="c1"># Prepare the metadata and features</span>
</span><span id="EventArray-541"><a href="#EventArray-541"><span class="linenos"> 541</span></a>            <span class="k">if</span> <span class="n">ignore_metadata</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-542"><a href="#EventArray-542"><span class="linenos"> 542</span></a>                <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-543"><a href="#EventArray-543"><span class="linenos"> 543</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-544"><a href="#EventArray-544"><span class="linenos"> 544</span></a>                <span class="c1"># This Series creation method is less efficient,</span>
</span><span id="EventArray-545"><a href="#EventArray-545"><span class="linenos"> 545</span></a>                <span class="c1"># but required for preserving dtypes</span>
</span><span id="EventArray-546"><a href="#EventArray-546"><span class="linenos"> 546</span></a>                <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
</span><span id="EventArray-547"><a href="#EventArray-547"><span class="linenos"> 547</span></a>                    <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">},</span>
</span><span id="EventArray-548"><a href="#EventArray-548"><span class="linenos"> 548</span></a>                    <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">,</span>
</span><span id="EventArray-549"><a href="#EventArray-549"><span class="linenos"> 549</span></a>                <span class="p">)</span>
</span><span id="EventArray-550"><a href="#EventArray-550"><span class="linenos"> 550</span></a>            <span class="k">if</span> <span class="n">ignore_features</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-551"><a href="#EventArray-551"><span class="linenos"> 551</span></a>                <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-552"><a href="#EventArray-552"><span class="linenos"> 552</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-553"><a href="#EventArray-553"><span class="linenos"> 553</span></a>                <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
</span><span id="EventArray-554"><a href="#EventArray-554"><span class="linenos"> 554</span></a>                    <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">},</span>
</span><span id="EventArray-555"><a href="#EventArray-555"><span class="linenos"> 555</span></a>                    <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">,</span>
</span><span id="EventArray-556"><a href="#EventArray-556"><span class="linenos"> 556</span></a>                <span class="p">)</span>
</span><span id="EventArray-557"><a href="#EventArray-557"><span class="linenos"> 557</span></a>            <span class="c1"># Create the event and append it to the list</span>
</span><span id="EventArray-558"><a href="#EventArray-558"><span class="linenos"> 558</span></a>            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="EventArray-559"><a href="#EventArray-559"><span class="linenos"> 559</span></a>                <span class="n">Event</span><span class="p">(</span>
</span><span id="EventArray-560"><a href="#EventArray-560"><span class="linenos"> 560</span></a>                    <span class="n">scan</span><span class="p">,</span>
</span><span id="EventArray-561"><a href="#EventArray-561"><span class="linenos"> 561</span></a>                    <span class="n">Tile</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
</span><span id="EventArray-562"><a href="#EventArray-562"><span class="linenos"> 562</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray-563"><a href="#EventArray-563"><span class="linenos"> 563</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray-564"><a href="#EventArray-564"><span class="linenos"> 564</span></a>                    <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray-565"><a href="#EventArray-565"><span class="linenos"> 565</span></a>                    <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
</span><span id="EventArray-566"><a href="#EventArray-566"><span class="linenos"> 566</span></a>                    <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
</span><span id="EventArray-567"><a href="#EventArray-567"><span class="linenos"> 567</span></a>                <span class="p">)</span>
</span><span id="EventArray-568"><a href="#EventArray-568"><span class="linenos"> 568</span></a>            <span class="p">)</span>
</span><span id="EventArray-569"><a href="#EventArray-569"><span class="linenos"> 569</span></a>        <span class="k">return</span> <span class="n">events</span>
</span><span id="EventArray-570"><a href="#EventArray-570"><span class="linenos"> 570</span></a>
</span><span id="EventArray-571"><a href="#EventArray-571"><span class="linenos"> 571</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray-572"><a href="#EventArray-572"><span class="linenos"> 572</span></a>    <span class="k">def</span> <span class="nf">from_events</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Event</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray-573"><a href="#EventArray-573"><span class="linenos"> 573</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-574"><a href="#EventArray-574"><span class="linenos"> 574</span></a><span class="sd">        Set the events in the EventArray to a new list of events.</span>
</span><span id="EventArray-575"><a href="#EventArray-575"><span class="linenos"> 575</span></a><span class="sd">        :param events: the new list of events.</span>
</span><span id="EventArray-576"><a href="#EventArray-576"><span class="linenos"> 576</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-577"><a href="#EventArray-577"><span class="linenos"> 577</span></a>        <span class="c1"># Return an empty array if we were passed nothing</span>
</span><span id="EventArray-578"><a href="#EventArray-578"><span class="linenos"> 578</span></a>        <span class="k">if</span> <span class="n">events</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray-579"><a href="#EventArray-579"><span class="linenos"> 579</span></a>            <span class="k">return</span> <span class="n">EventArray</span><span class="p">()</span>
</span><span id="EventArray-580"><a href="#EventArray-580"><span class="linenos"> 580</span></a>        <span class="c1"># Otherwise, grab the info</span>
</span><span id="EventArray-581"><a href="#EventArray-581"><span class="linenos"> 581</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="EventArray-582"><a href="#EventArray-582"><span class="linenos"> 582</span></a>            <span class="p">{</span>
</span><span id="EventArray-583"><a href="#EventArray-583"><span class="linenos"> 583</span></a>                <span class="s2">&quot;slide_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray-584"><a href="#EventArray-584"><span class="linenos"> 584</span></a>                <span class="s2">&quot;tile&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray-585"><a href="#EventArray-585"><span class="linenos"> 585</span></a>                <span class="s2">&quot;roi&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n_roi</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray-586"><a href="#EventArray-586"><span class="linenos"> 586</span></a>                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray-587"><a href="#EventArray-587"><span class="linenos"> 587</span></a>                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray-588"><a href="#EventArray-588"><span class="linenos"> 588</span></a>                <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray-589"><a href="#EventArray-589"><span class="linenos"> 589</span></a>            <span class="p">}</span>
</span><span id="EventArray-590"><a href="#EventArray-590"><span class="linenos"> 590</span></a>        <span class="p">)</span>
</span><span id="EventArray-591"><a href="#EventArray-591"><span class="linenos"> 591</span></a>        <span class="n">metadata_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">metadata</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
</span><span id="EventArray-592"><a href="#EventArray-592"><span class="linenos"> 592</span></a>        <span class="c1"># Iterate through and ensure that all metadata is the same shape</span>
</span><span id="EventArray-593"><a href="#EventArray-593"><span class="linenos"> 593</span></a>        <span class="k">for</span> <span class="n">metadata</span> <span class="ow">in</span> <span class="n">metadata_list</span><span class="p">:</span>
</span><span id="EventArray-594"><a href="#EventArray-594"><span class="linenos"> 594</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">metadata_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="EventArray-595"><a href="#EventArray-595"><span class="linenos"> 595</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All metadata must be the same type.&quot;</span><span class="p">)</span>
</span><span id="EventArray-596"><a href="#EventArray-596"><span class="linenos"> 596</span></a>            <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">metadata</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">metadata_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="EventArray-597"><a href="#EventArray-597"><span class="linenos"> 597</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All metadata must be the same shape.&quot;</span><span class="p">)</span>
</span><span id="EventArray-598"><a href="#EventArray-598"><span class="linenos"> 598</span></a>        <span class="k">if</span> <span class="n">metadata_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-599"><a href="#EventArray-599"><span class="linenos"> 599</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-600"><a href="#EventArray-600"><span class="linenos"> 600</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-601"><a href="#EventArray-601"><span class="linenos"> 601</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metadata_list</span><span class="p">)</span>
</span><span id="EventArray-602"><a href="#EventArray-602"><span class="linenos"> 602</span></a>        <span class="n">features_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">features</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
</span><span id="EventArray-603"><a href="#EventArray-603"><span class="linenos"> 603</span></a>        <span class="c1"># Iterate through and ensure that all features are the same shape</span>
</span><span id="EventArray-604"><a href="#EventArray-604"><span class="linenos"> 604</span></a>        <span class="k">for</span> <span class="n">features</span> <span class="ow">in</span> <span class="n">features_list</span><span class="p">:</span>
</span><span id="EventArray-605"><a href="#EventArray-605"><span class="linenos"> 605</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">features_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="EventArray-606"><a href="#EventArray-606"><span class="linenos"> 606</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All features must be the same type.&quot;</span><span class="p">)</span>
</span><span id="EventArray-607"><a href="#EventArray-607"><span class="linenos"> 607</span></a>            <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">features</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">features_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="EventArray-608"><a href="#EventArray-608"><span class="linenos"> 608</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All features must be the same shape.&quot;</span><span class="p">)</span>
</span><span id="EventArray-609"><a href="#EventArray-609"><span class="linenos"> 609</span></a>        <span class="k">if</span> <span class="n">features_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-610"><a href="#EventArray-610"><span class="linenos"> 610</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-611"><a href="#EventArray-611"><span class="linenos"> 611</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-612"><a href="#EventArray-612"><span class="linenos"> 612</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">features_list</span><span class="p">)</span>
</span><span id="EventArray-613"><a href="#EventArray-613"><span class="linenos"> 613</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
</span><span id="EventArray-614"><a href="#EventArray-614"><span class="linenos"> 614</span></a>
</span><span id="EventArray-615"><a href="#EventArray-615"><span class="linenos"> 615</span></a>    <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="EventArray-616"><a href="#EventArray-616"><span class="linenos"> 616</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-617"><a href="#EventArray-617"><span class="linenos"> 617</span></a><span class="sd">        Convert all the data in the EventArray to a single DataFrame.</span>
</span><span id="EventArray-618"><a href="#EventArray-618"><span class="linenos"> 618</span></a><span class="sd">        :return: a DataFrame with all the data in the EventArray.</span>
</span><span id="EventArray-619"><a href="#EventArray-619"><span class="linenos"> 619</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-620"><a href="#EventArray-620"><span class="linenos"> 620</span></a>        <span class="c1"># Make a copy of the info DataFrame and prepend &quot;info_&quot; to the column names</span>
</span><span id="EventArray-621"><a href="#EventArray-621"><span class="linenos"> 621</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray-622"><a href="#EventArray-622"><span class="linenos"> 622</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;info_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray-623"><a href="#EventArray-623"><span class="linenos"> 623</span></a>        <span class="c1"># Combine with the metadata and prepend &quot;metadata_&quot; to the column names</span>
</span><span id="EventArray-624"><a href="#EventArray-624"><span class="linenos"> 624</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-625"><a href="#EventArray-625"><span class="linenos"> 625</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray-626"><a href="#EventArray-626"><span class="linenos"> 626</span></a>            <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;metadata_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray-627"><a href="#EventArray-627"><span class="linenos"> 627</span></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">output</span><span class="p">,</span> <span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventArray-628"><a href="#EventArray-628"><span class="linenos"> 628</span></a>        <span class="c1"># Combine with the features and prepend &quot;features_&quot; to the column names</span>
</span><span id="EventArray-629"><a href="#EventArray-629"><span class="linenos"> 629</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-630"><a href="#EventArray-630"><span class="linenos"> 630</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray-631"><a href="#EventArray-631"><span class="linenos"> 631</span></a>            <span class="n">features</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;features_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray-632"><a href="#EventArray-632"><span class="linenos"> 632</span></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">output</span><span class="p">,</span> <span class="n">features</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventArray-633"><a href="#EventArray-633"><span class="linenos"> 633</span></a>        <span class="k">return</span> <span class="n">output</span>
</span><span id="EventArray-634"><a href="#EventArray-634"><span class="linenos"> 634</span></a>
</span><span id="EventArray-635"><a href="#EventArray-635"><span class="linenos"> 635</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray-636"><a href="#EventArray-636"><span class="linenos"> 636</span></a>    <span class="k">def</span> <span class="nf">from_dataframe</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray-637"><a href="#EventArray-637"><span class="linenos"> 637</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-638"><a href="#EventArray-638"><span class="linenos"> 638</span></a><span class="sd">        From a single, special DataFrame, create an EventArray.</span>
</span><span id="EventArray-639"><a href="#EventArray-639"><span class="linenos"> 639</span></a><span class="sd">        :return: a DataFrame with all the data in the EventArray.</span>
</span><span id="EventArray-640"><a href="#EventArray-640"><span class="linenos"> 640</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-641"><a href="#EventArray-641"><span class="linenos"> 641</span></a>        <span class="c1"># Split the columns into info, metadata, and features and strip prefix</span>
</span><span id="EventArray-642"><a href="#EventArray-642"><span class="linenos"> 642</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;info_&quot;</span><span class="p">)]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray-643"><a href="#EventArray-643"><span class="linenos"> 643</span></a>        <span class="n">info</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;info_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray-644"><a href="#EventArray-644"><span class="linenos"> 644</span></a>        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray-645"><a href="#EventArray-645"><span class="linenos"> 645</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-646"><a href="#EventArray-646"><span class="linenos"> 646</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;metadata_&quot;</span><span class="p">)]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray-647"><a href="#EventArray-647"><span class="linenos"> 647</span></a>        <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;metadata_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray-648"><a href="#EventArray-648"><span class="linenos"> 648</span></a>        <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray-649"><a href="#EventArray-649"><span class="linenos"> 649</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-650"><a href="#EventArray-650"><span class="linenos"> 650</span></a>        <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;features_&quot;</span><span class="p">)]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray-651"><a href="#EventArray-651"><span class="linenos"> 651</span></a>        <span class="n">features</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;features_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray-652"><a href="#EventArray-652"><span class="linenos"> 652</span></a>        <span class="k">if</span> <span class="n">features</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray-653"><a href="#EventArray-653"><span class="linenos"> 653</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-654"><a href="#EventArray-654"><span class="linenos"> 654</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
</span><span id="EventArray-655"><a href="#EventArray-655"><span class="linenos"> 655</span></a>
</span><span id="EventArray-656"><a href="#EventArray-656"><span class="linenos"> 656</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray-657"><a href="#EventArray-657"><span class="linenos"> 657</span></a>    <span class="k">def</span> <span class="nf">from_mask</span><span class="p">(</span>
</span><span id="EventArray-658"><a href="#EventArray-658"><span class="linenos"> 658</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="EventArray-659"><a href="#EventArray-659"><span class="linenos"> 659</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="EventArray-660"><a href="#EventArray-660"><span class="linenos"> 660</span></a>        <span class="n">slide_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="EventArray-661"><a href="#EventArray-661"><span class="linenos"> 661</span></a>        <span class="n">tile_n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="EventArray-662"><a href="#EventArray-662"><span class="linenos"> 662</span></a>        <span class="n">n_roi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="EventArray-663"><a href="#EventArray-663"><span class="linenos"> 663</span></a>        <span class="n">include_cell_id</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="EventArray-664"><a href="#EventArray-664"><span class="linenos"> 664</span></a>        <span class="n">images</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EventArray-665"><a href="#EventArray-665"><span class="linenos"> 665</span></a>        <span class="n">image_labels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EventArray-666"><a href="#EventArray-666"><span class="linenos"> 666</span></a>        <span class="n">properties</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EventArray-667"><a href="#EventArray-667"><span class="linenos"> 667</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray-668"><a href="#EventArray-668"><span class="linenos"> 668</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-669"><a href="#EventArray-669"><span class="linenos"> 669</span></a><span class="sd">        Extract events from a mask DataFrame, including metadata and features.</span>
</span><span id="EventArray-670"><a href="#EventArray-670"><span class="linenos"> 670</span></a><span class="sd">        :param mask: the mask to extract events from.</span>
</span><span id="EventArray-671"><a href="#EventArray-671"><span class="linenos"> 671</span></a><span class="sd">        :param slide_id: the slide ID the mask is from.</span>
</span><span id="EventArray-672"><a href="#EventArray-672"><span class="linenos"> 672</span></a><span class="sd">        :param tile_n: the tile number the mask is from.</span>
</span><span id="EventArray-673"><a href="#EventArray-673"><span class="linenos"> 673</span></a><span class="sd">        :param n_roi: the ROI number the mask is from.</span>
</span><span id="EventArray-674"><a href="#EventArray-674"><span class="linenos"> 674</span></a><span class="sd">        :param include_cell_id: whether to include the cell_id, or numerical</span>
</span><span id="EventArray-675"><a href="#EventArray-675"><span class="linenos"> 675</span></a><span class="sd">        mask label, as metadata in the EventArray.</span>
</span><span id="EventArray-676"><a href="#EventArray-676"><span class="linenos"> 676</span></a><span class="sd">        :param images: the intensity images to extract features from.</span>
</span><span id="EventArray-677"><a href="#EventArray-677"><span class="linenos"> 677</span></a><span class="sd">        :param image_labels: the labels for the intensity images.</span>
</span><span id="EventArray-678"><a href="#EventArray-678"><span class="linenos"> 678</span></a><span class="sd">        :param properties: list of properties to extract in addition to the defaults:</span>
</span><span id="EventArray-679"><a href="#EventArray-679"><span class="linenos"> 679</span></a><span class="sd">        :return: EventArray corresponding to the mask labels.</span>
</span><span id="EventArray-680"><a href="#EventArray-680"><span class="linenos"> 680</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-681"><a href="#EventArray-681"><span class="linenos"> 681</span></a>        <span class="k">if</span> <span class="n">extract_mask_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-682"><a href="#EventArray-682"><span class="linenos"> 682</span></a>            <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span>
</span><span id="EventArray-683"><a href="#EventArray-683"><span class="linenos"> 683</span></a>                <span class="s2">&quot;csi_images.csi_images dependencies not installed. Install csi-images &quot;</span>
</span><span id="EventArray-684"><a href="#EventArray-684"><span class="linenos"> 684</span></a>                <span class="s2">&quot;with [imageio] option to resolve.&quot;</span>
</span><span id="EventArray-685"><a href="#EventArray-685"><span class="linenos"> 685</span></a>            <span class="p">)</span>
</span><span id="EventArray-686"><a href="#EventArray-686"><span class="linenos"> 686</span></a>        <span class="c1"># Gather mask_info</span>
</span><span id="EventArray-687"><a href="#EventArray-687"><span class="linenos"> 687</span></a>        <span class="k">if</span> <span class="n">images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">image_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-688"><a href="#EventArray-688"><span class="linenos"> 688</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_labels</span><span class="p">):</span>
</span><span id="EventArray-689"><a href="#EventArray-689"><span class="linenos"> 689</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Intensity images and labels must match lengths.&quot;</span><span class="p">)</span>
</span><span id="EventArray-690"><a href="#EventArray-690"><span class="linenos"> 690</span></a>
</span><span id="EventArray-691"><a href="#EventArray-691"><span class="linenos"> 691</span></a>        <span class="n">mask_info</span> <span class="o">=</span> <span class="n">extract_mask_info</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">image_labels</span><span class="p">,</span> <span class="n">properties</span><span class="p">)</span>
</span><span id="EventArray-692"><a href="#EventArray-692"><span class="linenos"> 692</span></a>
</span><span id="EventArray-693"><a href="#EventArray-693"><span class="linenos"> 693</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray-694"><a href="#EventArray-694"><span class="linenos"> 694</span></a>            <span class="k">return</span> <span class="n">EventArray</span><span class="p">()</span>
</span><span id="EventArray-695"><a href="#EventArray-695"><span class="linenos"> 695</span></a>
</span><span id="EventArray-696"><a href="#EventArray-696"><span class="linenos"> 696</span></a>        <span class="c1"># Combine provided info and mask info</span>
</span><span id="EventArray-697"><a href="#EventArray-697"><span class="linenos"> 697</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="EventArray-698"><a href="#EventArray-698"><span class="linenos"> 698</span></a>            <span class="p">{</span>
</span><span id="EventArray-699"><a href="#EventArray-699"><span class="linenos"> 699</span></a>                <span class="s2">&quot;slide_id&quot;</span><span class="p">:</span> <span class="n">slide_id</span><span class="p">,</span>
</span><span id="EventArray-700"><a href="#EventArray-700"><span class="linenos"> 700</span></a>                <span class="s2">&quot;tile&quot;</span><span class="p">:</span> <span class="n">tile_n</span><span class="p">,</span>
</span><span id="EventArray-701"><a href="#EventArray-701"><span class="linenos"> 701</span></a>                <span class="s2">&quot;roi&quot;</span><span class="p">:</span> <span class="n">n_roi</span><span class="p">,</span>
</span><span id="EventArray-702"><a href="#EventArray-702"><span class="linenos"> 702</span></a>                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">mask_info</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span>
</span><span id="EventArray-703"><a href="#EventArray-703"><span class="linenos"> 703</span></a>                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">mask_info</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span>
</span><span id="EventArray-704"><a href="#EventArray-704"><span class="linenos"> 704</span></a>                <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">mask_info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">],</span>
</span><span id="EventArray-705"><a href="#EventArray-705"><span class="linenos"> 705</span></a>            <span class="p">},</span>
</span><span id="EventArray-706"><a href="#EventArray-706"><span class="linenos"> 706</span></a>        <span class="p">)</span>
</span><span id="EventArray-707"><a href="#EventArray-707"><span class="linenos"> 707</span></a>        <span class="c1"># Extract a metadata column if desired</span>
</span><span id="EventArray-708"><a href="#EventArray-708"><span class="linenos"> 708</span></a>        <span class="k">if</span> <span class="n">include_cell_id</span><span class="p">:</span>
</span><span id="EventArray-709"><a href="#EventArray-709"><span class="linenos"> 709</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;cell_id&quot;</span><span class="p">:</span> <span class="n">mask_info</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]})</span>
</span><span id="EventArray-710"><a href="#EventArray-710"><span class="linenos"> 710</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-711"><a href="#EventArray-711"><span class="linenos"> 711</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-712"><a href="#EventArray-712"><span class="linenos"> 712</span></a>        <span class="c1"># If any additional properties were extracted, add them as features</span>
</span><span id="EventArray-713"><a href="#EventArray-713"><span class="linenos"> 713</span></a>        <span class="n">mask_info</span> <span class="o">=</span> <span class="n">mask_info</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</span><span id="EventArray-714"><a href="#EventArray-714"><span class="linenos"> 714</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_info</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray-715"><a href="#EventArray-715"><span class="linenos"> 715</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="n">mask_info</span>
</span><span id="EventArray-716"><a href="#EventArray-716"><span class="linenos"> 716</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-717"><a href="#EventArray-717"><span class="linenos"> 717</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-718"><a href="#EventArray-718"><span class="linenos"> 718</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
</span><span id="EventArray-719"><a href="#EventArray-719"><span class="linenos"> 719</span></a>
</span><span id="EventArray-720"><a href="#EventArray-720"><span class="linenos"> 720</span></a>    <span class="k">def</span> <span class="nf">save_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="EventArray-721"><a href="#EventArray-721"><span class="linenos"> 721</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-722"><a href="#EventArray-722"><span class="linenos"> 722</span></a><span class="sd">        Save the events to an CSV file, including metadata and features.</span>
</span><span id="EventArray-723"><a href="#EventArray-723"><span class="linenos"> 723</span></a><span class="sd">        :param output_path:</span>
</span><span id="EventArray-724"><a href="#EventArray-724"><span class="linenos"> 724</span></a><span class="sd">        :return:</span>
</span><span id="EventArray-725"><a href="#EventArray-725"><span class="linenos"> 725</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-726"><a href="#EventArray-726"><span class="linenos"> 726</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="EventArray-727"><a href="#EventArray-727"><span class="linenos"> 727</span></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</span><span id="EventArray-728"><a href="#EventArray-728"><span class="linenos"> 728</span></a>
</span><span id="EventArray-729"><a href="#EventArray-729"><span class="linenos"> 729</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray-730"><a href="#EventArray-730"><span class="linenos"> 730</span></a>    <span class="k">def</span> <span class="nf">load_csv</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray-731"><a href="#EventArray-731"><span class="linenos"> 731</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-732"><a href="#EventArray-732"><span class="linenos"> 732</span></a><span class="sd">        Load the events from an CSV file, including metadata and features.</span>
</span><span id="EventArray-733"><a href="#EventArray-733"><span class="linenos"> 733</span></a><span class="sd">        :param input_path:</span>
</span><span id="EventArray-734"><a href="#EventArray-734"><span class="linenos"> 734</span></a><span class="sd">        :return:</span>
</span><span id="EventArray-735"><a href="#EventArray-735"><span class="linenos"> 735</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-736"><a href="#EventArray-736"><span class="linenos"> 736</span></a>        <span class="c1"># Load the CSV file</span>
</span><span id="EventArray-737"><a href="#EventArray-737"><span class="linenos"> 737</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="EventArray-738"><a href="#EventArray-738"><span class="linenos"> 738</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="EventArray-739"><a href="#EventArray-739"><span class="linenos"> 739</span></a>
</span><span id="EventArray-740"><a href="#EventArray-740"><span class="linenos"> 740</span></a>    <span class="k">def</span> <span class="nf">save_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="EventArray-741"><a href="#EventArray-741"><span class="linenos"> 741</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-742"><a href="#EventArray-742"><span class="linenos"> 742</span></a><span class="sd">        Save the events to an HDF5 file, including metadata and features.</span>
</span><span id="EventArray-743"><a href="#EventArray-743"><span class="linenos"> 743</span></a><span class="sd">        Uses the pandas-provided HDF5 functions for ease, and external compatibility,</span>
</span><span id="EventArray-744"><a href="#EventArray-744"><span class="linenos"> 744</span></a><span class="sd">        though these files are slightly harder to view in HDFView or similar.</span>
</span><span id="EventArray-745"><a href="#EventArray-745"><span class="linenos"> 745</span></a><span class="sd">        :param output_path:</span>
</span><span id="EventArray-746"><a href="#EventArray-746"><span class="linenos"> 746</span></a><span class="sd">        :return:</span>
</span><span id="EventArray-747"><a href="#EventArray-747"><span class="linenos"> 747</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-748"><a href="#EventArray-748"><span class="linenos"> 748</span></a>        <span class="c1"># Open the output_path as an HDF5 file</span>
</span><span id="EventArray-749"><a href="#EventArray-749"><span class="linenos"> 749</span></a>        <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">store</span><span class="p">:</span>
</span><span id="EventArray-750"><a href="#EventArray-750"><span class="linenos"> 750</span></a>            <span class="c1"># Store the dataframes in the HDF5 file</span>
</span><span id="EventArray-751"><a href="#EventArray-751"><span class="linenos"> 751</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-752"><a href="#EventArray-752"><span class="linenos"> 752</span></a>                <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="EventArray-753"><a href="#EventArray-753"><span class="linenos"> 753</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-754"><a href="#EventArray-754"><span class="linenos"> 754</span></a>                <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="EventArray-755"><a href="#EventArray-755"><span class="linenos"> 755</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-756"><a href="#EventArray-756"><span class="linenos"> 756</span></a>                <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="EventArray-757"><a href="#EventArray-757"><span class="linenos"> 757</span></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</span><span id="EventArray-758"><a href="#EventArray-758"><span class="linenos"> 758</span></a>
</span><span id="EventArray-759"><a href="#EventArray-759"><span class="linenos"> 759</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray-760"><a href="#EventArray-760"><span class="linenos"> 760</span></a>    <span class="k">def</span> <span class="nf">load_hdf5</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray-761"><a href="#EventArray-761"><span class="linenos"> 761</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-762"><a href="#EventArray-762"><span class="linenos"> 762</span></a><span class="sd">        Load the events from an HDF5 file, including metadata and features.</span>
</span><span id="EventArray-763"><a href="#EventArray-763"><span class="linenos"> 763</span></a><span class="sd">        :param input_path:</span>
</span><span id="EventArray-764"><a href="#EventArray-764"><span class="linenos"> 764</span></a><span class="sd">        :return:</span>
</span><span id="EventArray-765"><a href="#EventArray-765"><span class="linenos"> 765</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-766"><a href="#EventArray-766"><span class="linenos"> 766</span></a>        <span class="c1"># Open the input_path as an HDF5 file</span>
</span><span id="EventArray-767"><a href="#EventArray-767"><span class="linenos"> 767</span></a>        <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">store</span><span class="p">:</span>
</span><span id="EventArray-768"><a href="#EventArray-768"><span class="linenos"> 768</span></a>            <span class="c1"># Load the dataframes from the HDF5 file</span>
</span><span id="EventArray-769"><a href="#EventArray-769"><span class="linenos"> 769</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;info&quot;</span> <span class="ow">in</span> <span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="EventArray-770"><a href="#EventArray-770"><span class="linenos"> 770</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="EventArray-771"><a href="#EventArray-771"><span class="linenos"> 771</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;features&quot;</span> <span class="ow">in</span> <span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="EventArray-772"><a href="#EventArray-772"><span class="linenos"> 772</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
</span><span id="EventArray-773"><a href="#EventArray-773"><span class="linenos"> 773</span></a>
</span><span id="EventArray-774"><a href="#EventArray-774"><span class="linenos"> 774</span></a>    <span class="k">def</span> <span class="nf">save_ocular</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cells&quot;</span><span class="p">):</span>
</span><span id="EventArray-775"><a href="#EventArray-775"><span class="linenos"> 775</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-776"><a href="#EventArray-776"><span class="linenos"> 776</span></a><span class="sd">        Save the events to an OCULAR file. Relies on the dataframe originating</span>
</span><span id="EventArray-777"><a href="#EventArray-777"><span class="linenos"> 777</span></a><span class="sd">        from an OCULAR file (same columns; duplicate metadata/info).</span>
</span><span id="EventArray-778"><a href="#EventArray-778"><span class="linenos"> 778</span></a><span class="sd">        :param output_path:</span>
</span><span id="EventArray-779"><a href="#EventArray-779"><span class="linenos"> 779</span></a><span class="sd">        :param event_type:</span>
</span><span id="EventArray-780"><a href="#EventArray-780"><span class="linenos"> 780</span></a><span class="sd">        :return:</span>
</span><span id="EventArray-781"><a href="#EventArray-781"><span class="linenos"> 781</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-782"><a href="#EventArray-782"><span class="linenos"> 782</span></a>        <span class="k">if</span> <span class="n">pyreadr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-783"><a href="#EventArray-783"><span class="linenos"> 783</span></a>            <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span>
</span><span id="EventArray-784"><a href="#EventArray-784"><span class="linenos"> 784</span></a>                <span class="s2">&quot;pyreadr not installed. Install pyreadr directly &quot;</span>
</span><span id="EventArray-785"><a href="#EventArray-785"><span class="linenos"> 785</span></a>                <span class="s2">&quot;or install csi-images with [rds] option to resolve.&quot;</span>
</span><span id="EventArray-786"><a href="#EventArray-786"><span class="linenos"> 786</span></a>            <span class="p">)</span>
</span><span id="EventArray-787"><a href="#EventArray-787"><span class="linenos"> 787</span></a>        <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;cells&quot;</span><span class="p">:</span>
</span><span id="EventArray-788"><a href="#EventArray-788"><span class="linenos"> 788</span></a>            <span class="n">file_stub</span> <span class="o">=</span> <span class="s2">&quot;rc-final&quot;</span>
</span><span id="EventArray-789"><a href="#EventArray-789"><span class="linenos"> 789</span></a>        <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;others&quot;</span><span class="p">:</span>
</span><span id="EventArray-790"><a href="#EventArray-790"><span class="linenos"> 790</span></a>            <span class="n">file_stub</span> <span class="o">=</span> <span class="s2">&quot;others-final&quot;</span>
</span><span id="EventArray-791"><a href="#EventArray-791"><span class="linenos"> 791</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-792"><a href="#EventArray-792"><span class="linenos"> 792</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid event type. Must be cells or others.&quot;</span><span class="p">)</span>
</span><span id="EventArray-793"><a href="#EventArray-793"><span class="linenos"> 793</span></a>
</span><span id="EventArray-794"><a href="#EventArray-794"><span class="linenos"> 794</span></a>        <span class="c1"># Ensure good metadata</span>
</span><span id="EventArray-795"><a href="#EventArray-795"><span class="linenos"> 795</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="EventArray-796"><a href="#EventArray-796"><span class="linenos"> 796</span></a>            <span class="p">{</span>
</span><span id="EventArray-797"><a href="#EventArray-797"><span class="linenos"> 797</span></a>                <span class="s2">&quot;slide_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">],</span>
</span><span id="EventArray-798"><a href="#EventArray-798"><span class="linenos"> 798</span></a>                <span class="s2">&quot;frame_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">],</span>
</span><span id="EventArray-799"><a href="#EventArray-799"><span class="linenos"> 799</span></a>                <span class="s2">&quot;cell_id&quot;</span><span class="p">:</span> <span class="p">(</span>
</span><span id="EventArray-800"><a href="#EventArray-800"><span class="linenos"> 800</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span>
</span><span id="EventArray-801"><a href="#EventArray-801"><span class="linenos"> 801</span></a>                    <span class="k">if</span> <span class="s2">&quot;cell_id&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">columns</span>
</span><span id="EventArray-802"><a href="#EventArray-802"><span class="linenos"> 802</span></a>                    <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">))</span>
</span><span id="EventArray-803"><a href="#EventArray-803"><span class="linenos"> 803</span></a>                <span class="p">),</span>
</span><span id="EventArray-804"><a href="#EventArray-804"><span class="linenos"> 804</span></a>                <span class="s2">&quot;cellx&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span>
</span><span id="EventArray-805"><a href="#EventArray-805"><span class="linenos"> 805</span></a>                <span class="s2">&quot;celly&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span>
</span><span id="EventArray-806"><a href="#EventArray-806"><span class="linenos"> 806</span></a>            <span class="p">}</span>
</span><span id="EventArray-807"><a href="#EventArray-807"><span class="linenos"> 807</span></a>        <span class="p">)</span>
</span><span id="EventArray-808"><a href="#EventArray-808"><span class="linenos"> 808</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-809"><a href="#EventArray-809"><span class="linenos"> 809</span></a>            <span class="n">metadata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray-810"><a href="#EventArray-810"><span class="linenos"> 810</span></a>
</span><span id="EventArray-811"><a href="#EventArray-811"><span class="linenos"> 811</span></a>        <span class="c1"># Check for the &quot;ocular_interesting&quot; column</span>
</span><span id="EventArray-812"><a href="#EventArray-812"><span class="linenos"> 812</span></a>        <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;cells&quot;</span><span class="p">:</span>
</span><span id="EventArray-813"><a href="#EventArray-813"><span class="linenos"> 813</span></a>            <span class="k">if</span> <span class="s2">&quot;ocular_interesting&quot;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="EventArray-814"><a href="#EventArray-814"><span class="linenos"> 814</span></a>                <span class="n">interesting_rows</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ocular_interesting&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span><span id="EventArray-815"><a href="#EventArray-815"><span class="linenos"> 815</span></a>            <span class="k">elif</span> <span class="s2">&quot;hcpc&quot;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="EventArray-816"><a href="#EventArray-816"><span class="linenos"> 816</span></a>                <span class="c1"># Interesting cells don&#39;t get an hcpc designation, leaving them as -1</span>
</span><span id="EventArray-817"><a href="#EventArray-817"><span class="linenos"> 817</span></a>                <span class="n">interesting_rows</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="EventArray-818"><a href="#EventArray-818"><span class="linenos"> 818</span></a>                    <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;hcpc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="EventArray-819"><a href="#EventArray-819"><span class="linenos"> 819</span></a>                <span class="p">)</span>  <span class="c1"># interesting cells</span>
</span><span id="EventArray-820"><a href="#EventArray-820"><span class="linenos"> 820</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-821"><a href="#EventArray-821"><span class="linenos"> 821</span></a>                <span class="n">interesting_rows</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray-822"><a href="#EventArray-822"><span class="linenos"> 822</span></a>            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">interesting_rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray-823"><a href="#EventArray-823"><span class="linenos"> 823</span></a>                <span class="c1"># Split the metadata into interesting and regular</span>
</span><span id="EventArray-824"><a href="#EventArray-824"><span class="linenos"> 824</span></a>                <span class="n">interesting_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">(</span><span class="n">interesting_rows</span><span class="p">)</span>
</span><span id="EventArray-825"><a href="#EventArray-825"><span class="linenos"> 825</span></a>                <span class="n">interesting_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
</span><span id="EventArray-826"><a href="#EventArray-826"><span class="linenos"> 826</span></a>                    <span class="p">[</span><span class="n">interesting_events</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">interesting_events</span><span class="o">.</span><span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
</span><span id="EventArray-827"><a href="#EventArray-827"><span class="linenos"> 827</span></a>                <span class="p">)</span>
</span><span id="EventArray-828"><a href="#EventArray-828"><span class="linenos"> 828</span></a>                <span class="n">data_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">(</span><span class="o">~</span><span class="n">interesting_rows</span><span class="p">)</span>
</span><span id="EventArray-829"><a href="#EventArray-829"><span class="linenos"> 829</span></a>                <span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
</span><span id="EventArray-830"><a href="#EventArray-830"><span class="linenos"> 830</span></a>                    <span class="p">[</span><span class="n">data_events</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">data_events</span><span class="o">.</span><span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
</span><span id="EventArray-831"><a href="#EventArray-831"><span class="linenos"> 831</span></a>                <span class="p">)</span>
</span><span id="EventArray-832"><a href="#EventArray-832"><span class="linenos"> 832</span></a>                <span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ocular_interesting&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</span><span id="EventArray-833"><a href="#EventArray-833"><span class="linenos"> 833</span></a>
</span><span id="EventArray-834"><a href="#EventArray-834"><span class="linenos"> 834</span></a>                <span class="c1"># Drop particular columns for &quot;interesting&quot;</span>
</span><span id="EventArray-835"><a href="#EventArray-835"><span class="linenos"> 835</span></a>                <span class="n">interesting_df</span> <span class="o">=</span> <span class="n">interesting_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="EventArray-836"><a href="#EventArray-836"><span class="linenos"> 836</span></a>                    <span class="p">[</span>
</span><span id="EventArray-837"><a href="#EventArray-837"><span class="linenos"> 837</span></a>                        <span class="s2">&quot;clust&quot;</span><span class="p">,</span>
</span><span id="EventArray-838"><a href="#EventArray-838"><span class="linenos"> 838</span></a>                        <span class="s2">&quot;hcpc&quot;</span><span class="p">,</span>
</span><span id="EventArray-839"><a href="#EventArray-839"><span class="linenos"> 839</span></a>                        <span class="s2">&quot;frame_id&quot;</span><span class="p">,</span>
</span><span id="EventArray-840"><a href="#EventArray-840"><span class="linenos"> 840</span></a>                        <span class="s2">&quot;cell_id&quot;</span><span class="p">,</span>
</span><span id="EventArray-841"><a href="#EventArray-841"><span class="linenos"> 841</span></a>                        <span class="s2">&quot;unique_id&quot;</span><span class="p">,</span>
</span><span id="EventArray-842"><a href="#EventArray-842"><span class="linenos"> 842</span></a>                        <span class="s2">&quot;ocular_interesting&quot;</span><span class="p">,</span>
</span><span id="EventArray-843"><a href="#EventArray-843"><span class="linenos"> 843</span></a>                    <span class="p">],</span>
</span><span id="EventArray-844"><a href="#EventArray-844"><span class="linenos"> 844</span></a>                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="EventArray-845"><a href="#EventArray-845"><span class="linenos"> 845</span></a>                    <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
</span><span id="EventArray-846"><a href="#EventArray-846"><span class="linenos"> 846</span></a>                <span class="p">)</span>
</span><span id="EventArray-847"><a href="#EventArray-847"><span class="linenos"> 847</span></a>                <span class="c1"># Save both .csv and .rds</span>
</span><span id="EventArray-848"><a href="#EventArray-848"><span class="linenos"> 848</span></a>                <span class="n">interesting_stub</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;ocular_interesting&quot;</span><span class="p">)</span>
</span><span id="EventArray-849"><a href="#EventArray-849"><span class="linenos"> 849</span></a>                <span class="n">interesting_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">interesting_stub</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
</span><span id="EventArray-850"><a href="#EventArray-850"><span class="linenos"> 850</span></a>                <span class="c1"># Suppress pandas FutureWarning</span>
</span><span id="EventArray-851"><a href="#EventArray-851"><span class="linenos"> 851</span></a>                <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
</span><span id="EventArray-852"><a href="#EventArray-852"><span class="linenos"> 852</span></a>                    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
</span><span id="EventArray-853"><a href="#EventArray-853"><span class="linenos"> 853</span></a>                    <span class="n">pyreadr</span><span class="o">.</span><span class="n">write_rds</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">interesting_stub</span><span class="si">}</span><span class="s2">.rds&quot;</span><span class="p">,</span> <span class="n">interesting_df</span><span class="p">)</span>
</span><span id="EventArray-854"><a href="#EventArray-854"><span class="linenos"> 854</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-855"><a href="#EventArray-855"><span class="linenos"> 855</span></a>                <span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventArray-856"><a href="#EventArray-856"><span class="linenos"> 856</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-857"><a href="#EventArray-857"><span class="linenos"> 857</span></a>            <span class="c1"># Get all data and reset_index (will copy it)</span>
</span><span id="EventArray-858"><a href="#EventArray-858"><span class="linenos"> 858</span></a>            <span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventArray-859"><a href="#EventArray-859"><span class="linenos"> 859</span></a>
</span><span id="EventArray-860"><a href="#EventArray-860"><span class="linenos"> 860</span></a>        <span class="c1"># Split based on cluster number to conform to *-final[1-4].rds</span>
</span><span id="EventArray-861"><a href="#EventArray-861"><span class="linenos"> 861</span></a>        <span class="n">n_clusters</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;clust&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="EventArray-862"><a href="#EventArray-862"><span class="linenos"> 862</span></a>        <span class="n">split_idx</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">n_clusters</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
</span><span id="EventArray-863"><a href="#EventArray-863"><span class="linenos"> 863</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span><span id="EventArray-864"><a href="#EventArray-864"><span class="linenos"> 864</span></a>            <span class="n">subset</span> <span class="o">=</span> <span class="p">(</span><span class="n">split_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;clust&quot;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span>
</span><span id="EventArray-865"><a href="#EventArray-865"><span class="linenos"> 865</span></a>                <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;clust&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">split_idx</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="EventArray-866"><a href="#EventArray-866"><span class="linenos"> 866</span></a>            <span class="p">)</span>
</span><span id="EventArray-867"><a href="#EventArray-867"><span class="linenos"> 867</span></a>            <span class="n">data_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">subset</span><span class="p">,</span> <span class="s2">&quot;hcpc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="EventArray-868"><a href="#EventArray-868"><span class="linenos"> 868</span></a>            <span class="n">subset</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray-869"><a href="#EventArray-869"><span class="linenos"> 869</span></a>            <span class="c1"># Suppress pandas FutureWarning</span>
</span><span id="EventArray-870"><a href="#EventArray-870"><span class="linenos"> 870</span></a>            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
</span><span id="EventArray-871"><a href="#EventArray-871"><span class="linenos"> 871</span></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
</span><span id="EventArray-872"><a href="#EventArray-872"><span class="linenos"> 872</span></a>                <span class="n">pyreadr</span><span class="o">.</span><span class="n">write_rds</span><span class="p">(</span>
</span><span id="EventArray-873"><a href="#EventArray-873"><span class="linenos"> 873</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_stub</span><span class="si">}{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.rds&quot;</span><span class="p">),</span> <span class="n">subset</span>
</span><span id="EventArray-874"><a href="#EventArray-874"><span class="linenos"> 874</span></a>                <span class="p">)</span>
</span><span id="EventArray-875"><a href="#EventArray-875"><span class="linenos"> 875</span></a>
</span><span id="EventArray-876"><a href="#EventArray-876"><span class="linenos"> 876</span></a>        <span class="c1"># Create new example cell strings</span>
</span><span id="EventArray-877"><a href="#EventArray-877"><span class="linenos"> 877</span></a>        <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;example_cell_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="EventArray-878"><a href="#EventArray-878"><span class="linenos"> 878</span></a>            <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">]</span>
</span><span id="EventArray-879"><a href="#EventArray-879"><span class="linenos"> 879</span></a>            <span class="o">+</span> <span class="s2">&quot; &quot;</span>
</span><span id="EventArray-880"><a href="#EventArray-880"><span class="linenos"> 880</span></a>            <span class="o">+</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;frame_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="EventArray-881"><a href="#EventArray-881"><span class="linenos"> 881</span></a>            <span class="o">+</span> <span class="s2">&quot; &quot;</span>
</span><span id="EventArray-882"><a href="#EventArray-882"><span class="linenos"> 882</span></a>            <span class="o">+</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="EventArray-883"><a href="#EventArray-883"><span class="linenos"> 883</span></a>            <span class="o">+</span> <span class="s2">&quot; &quot;</span>
</span><span id="EventArray-884"><a href="#EventArray-884"><span class="linenos"> 884</span></a>            <span class="o">+</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;cellx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="EventArray-885"><a href="#EventArray-885"><span class="linenos"> 885</span></a>            <span class="o">+</span> <span class="s2">&quot; &quot;</span>
</span><span id="EventArray-886"><a href="#EventArray-886"><span class="linenos"> 886</span></a>            <span class="o">+</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;celly&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="EventArray-887"><a href="#EventArray-887"><span class="linenos"> 887</span></a>        <span class="p">)</span>
</span><span id="EventArray-888"><a href="#EventArray-888"><span class="linenos"> 888</span></a>        <span class="c1"># Find averagable data columns</span>
</span><span id="EventArray-889"><a href="#EventArray-889"><span class="linenos"> 889</span></a>        <span class="k">if</span> <span class="s2">&quot;cellcluster_id&quot;</span> <span class="ow">in</span> <span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="EventArray-890"><a href="#EventArray-890"><span class="linenos"> 890</span></a>            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s2">&quot;cellcluster_id&quot;</span><span class="p">)</span>
</span><span id="EventArray-891"><a href="#EventArray-891"><span class="linenos"> 891</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-892"><a href="#EventArray-892"><span class="linenos"> 892</span></a>            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s2">&quot;slide_id&quot;</span><span class="p">)</span>
</span><span id="EventArray-893"><a href="#EventArray-893"><span class="linenos"> 893</span></a>        <span class="n">avg_cols</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="n">end_idx</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="EventArray-894"><a href="#EventArray-894"><span class="linenos"> 894</span></a>        <span class="c1"># Group by cluster and average</span>
</span><span id="EventArray-895"><a href="#EventArray-895"><span class="linenos"> 895</span></a>        <span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;clust&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
</span><span id="EventArray-896"><a href="#EventArray-896"><span class="linenos"> 896</span></a>            <span class="o">**</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">avg_cols</span><span class="p">},</span>
</span><span id="EventArray-897"><a href="#EventArray-897"><span class="linenos"> 897</span></a>            <span class="n">count</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;clust&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">),</span>  <span class="c1"># count rows in each cluster</span>
</span><span id="EventArray-898"><a href="#EventArray-898"><span class="linenos"> 898</span></a>            <span class="n">example_cells</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;example_cell_id&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
</span><span id="EventArray-899"><a href="#EventArray-899"><span class="linenos"> 899</span></a>            <span class="n">hcpc</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;hcpc&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="EventArray-900"><a href="#EventArray-900"><span class="linenos"> 900</span></a>        <span class="p">)</span>
</span><span id="EventArray-901"><a href="#EventArray-901"><span class="linenos"> 901</span></a>        <span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>  <span class="c1"># Do NOT drop, index is &quot;clust&quot;</span>
</span><span id="EventArray-902"><a href="#EventArray-902"><span class="linenos"> 902</span></a>        <span class="c1"># Create new columns</span>
</span><span id="EventArray-903"><a href="#EventArray-903"><span class="linenos"> 903</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="EventArray-904"><a href="#EventArray-904"><span class="linenos"> 904</span></a>            <span class="p">{</span>
</span><span id="EventArray-905"><a href="#EventArray-905"><span class="linenos"> 905</span></a>                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">],</span>
</span><span id="EventArray-906"><a href="#EventArray-906"><span class="linenos"> 906</span></a>                <span class="s2">&quot;example_cells&quot;</span><span class="p">:</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;example_cells&quot;</span><span class="p">],</span>
</span><span id="EventArray-907"><a href="#EventArray-907"><span class="linenos"> 907</span></a>                <span class="s2">&quot;clust&quot;</span><span class="p">:</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;clust&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
</span><span id="EventArray-908"><a href="#EventArray-908"><span class="linenos"> 908</span></a>                <span class="s2">&quot;hcpc&quot;</span><span class="p">:</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;hcpc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
</span><span id="EventArray-909"><a href="#EventArray-909"><span class="linenos"> 909</span></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;clust&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span>
</span><span id="EventArray-910"><a href="#EventArray-910"><span class="linenos"> 910</span></a>                <span class="s2">&quot;cccluster&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>  <span class="c1"># Dummy value</span>
</span><span id="EventArray-911"><a href="#EventArray-911"><span class="linenos"> 911</span></a>                <span class="s2">&quot;ccdistance&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># Dummy value</span>
</span><span id="EventArray-912"><a href="#EventArray-912"><span class="linenos"> 912</span></a>                <span class="s2">&quot;rownum&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_df</span><span class="p">))),</span>
</span><span id="EventArray-913"><a href="#EventArray-913"><span class="linenos"> 913</span></a>                <span class="s2">&quot;framegroup&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Dummy value</span>
</span><span id="EventArray-914"><a href="#EventArray-914"><span class="linenos"> 914</span></a>            <span class="p">}</span>
</span><span id="EventArray-915"><a href="#EventArray-915"><span class="linenos"> 915</span></a>        <span class="p">)</span>
</span><span id="EventArray-916"><a href="#EventArray-916"><span class="linenos"> 916</span></a>        <span class="c1"># Need to pad the features to 761 columns, as per OCULAR report needs</span>
</span><span id="EventArray-917"><a href="#EventArray-917"><span class="linenos"> 917</span></a>        <span class="n">additional_columns</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avg_cols</span><span class="p">),</span> <span class="mi">761</span><span class="p">)</span>
</span><span id="EventArray-918"><a href="#EventArray-918"><span class="linenos"> 918</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">additional_columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray-919"><a href="#EventArray-919"><span class="linenos"> 919</span></a>            <span class="n">padding</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="EventArray-920"><a href="#EventArray-920"><span class="linenos"> 920</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data_df</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">additional_columns</span><span class="p">))),</span>
</span><span id="EventArray-921"><a href="#EventArray-921"><span class="linenos"> 921</span></a>                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;pad</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">additional_columns</span><span class="p">],</span>
</span><span id="EventArray-922"><a href="#EventArray-922"><span class="linenos"> 922</span></a>            <span class="p">)</span>
</span><span id="EventArray-923"><a href="#EventArray-923"><span class="linenos"> 923</span></a>            <span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data_df</span><span class="p">[</span><span class="n">avg_cols</span><span class="p">],</span> <span class="n">padding</span><span class="p">,</span> <span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventArray-924"><a href="#EventArray-924"><span class="linenos"> 924</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-925"><a href="#EventArray-925"><span class="linenos"> 925</span></a>            <span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data_df</span><span class="p">[</span><span class="n">avg_cols</span><span class="p">],</span> <span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventArray-926"><a href="#EventArray-926"><span class="linenos"> 926</span></a>
</span><span id="EventArray-927"><a href="#EventArray-927"><span class="linenos"> 927</span></a>        <span class="c1"># Save the cluster data</span>
</span><span id="EventArray-928"><a href="#EventArray-928"><span class="linenos"> 928</span></a>        <span class="n">data_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_stub</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">))</span>
</span><span id="EventArray-929"><a href="#EventArray-929"><span class="linenos"> 929</span></a>        <span class="c1"># Suppress pandas FutureWarning</span>
</span><span id="EventArray-930"><a href="#EventArray-930"><span class="linenos"> 930</span></a>        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
</span><span id="EventArray-931"><a href="#EventArray-931"><span class="linenos"> 931</span></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
</span><span id="EventArray-932"><a href="#EventArray-932"><span class="linenos"> 932</span></a>            <span class="n">pyreadr</span><span class="o">.</span><span class="n">write_rds</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_stub</span><span class="si">}</span><span class="s2">.rds&quot;</span><span class="p">),</span> <span class="n">data_df</span><span class="p">)</span>
</span><span id="EventArray-933"><a href="#EventArray-933"><span class="linenos"> 933</span></a>
</span><span id="EventArray-934"><a href="#EventArray-934"><span class="linenos"> 934</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray-935"><a href="#EventArray-935"><span class="linenos"> 935</span></a>    <span class="k">def</span> <span class="nf">load_ocular</span><span class="p">(</span>
</span><span id="EventArray-936"><a href="#EventArray-936"><span class="linenos"> 936</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="EventArray-937"><a href="#EventArray-937"><span class="linenos"> 937</span></a>        <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="EventArray-938"><a href="#EventArray-938"><span class="linenos"> 938</span></a>        <span class="n">event_type</span><span class="o">=</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span>
</span><span id="EventArray-939"><a href="#EventArray-939"><span class="linenos"> 939</span></a>        <span class="n">cell_data_files</span><span class="o">=</span><span class="p">(</span>
</span><span id="EventArray-940"><a href="#EventArray-940"><span class="linenos"> 940</span></a>            <span class="s2">&quot;rc-final1.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray-941"><a href="#EventArray-941"><span class="linenos"> 941</span></a>            <span class="s2">&quot;rc-final2.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray-942"><a href="#EventArray-942"><span class="linenos"> 942</span></a>            <span class="s2">&quot;rc-final3.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray-943"><a href="#EventArray-943"><span class="linenos"> 943</span></a>            <span class="s2">&quot;rc-final4.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray-944"><a href="#EventArray-944"><span class="linenos"> 944</span></a>            <span class="s2">&quot;ocular_interesting.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray-945"><a href="#EventArray-945"><span class="linenos"> 945</span></a>        <span class="p">),</span>
</span><span id="EventArray-946"><a href="#EventArray-946"><span class="linenos"> 946</span></a>        <span class="n">others_data_files</span><span class="o">=</span><span class="p">(</span>
</span><span id="EventArray-947"><a href="#EventArray-947"><span class="linenos"> 947</span></a>            <span class="s2">&quot;others-final1.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray-948"><a href="#EventArray-948"><span class="linenos"> 948</span></a>            <span class="s2">&quot;others-final2.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray-949"><a href="#EventArray-949"><span class="linenos"> 949</span></a>            <span class="s2">&quot;others-final3.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray-950"><a href="#EventArray-950"><span class="linenos"> 950</span></a>            <span class="s2">&quot;others-final4.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray-951"><a href="#EventArray-951"><span class="linenos"> 951</span></a>        <span class="p">),</span>
</span><span id="EventArray-952"><a href="#EventArray-952"><span class="linenos"> 952</span></a>        <span class="n">atlas_data_files</span><span class="o">=</span><span class="p">(</span>
</span><span id="EventArray-953"><a href="#EventArray-953"><span class="linenos"> 953</span></a>            <span class="s2">&quot;ocular_interesting.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray-954"><a href="#EventArray-954"><span class="linenos"> 954</span></a>            <span class="s2">&quot;ocular_not_interesting.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray-955"><a href="#EventArray-955"><span class="linenos"> 955</span></a>        <span class="p">),</span>
</span><span id="EventArray-956"><a href="#EventArray-956"><span class="linenos"> 956</span></a>        <span class="n">drop_common_events</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="EventArray-957"><a href="#EventArray-957"><span class="linenos"> 957</span></a>        <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="EventArray-958"><a href="#EventArray-958"><span class="linenos"> 958</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray-959"><a href="#EventArray-959"><span class="linenos"> 959</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-960"><a href="#EventArray-960"><span class="linenos"> 960</span></a>
</span><span id="EventArray-961"><a href="#EventArray-961"><span class="linenos"> 961</span></a><span class="sd">        :param input_path:</span>
</span><span id="EventArray-962"><a href="#EventArray-962"><span class="linenos"> 962</span></a><span class="sd">        :param event_type:</span>
</span><span id="EventArray-963"><a href="#EventArray-963"><span class="linenos"> 963</span></a><span class="sd">        :param cell_data_files:</span>
</span><span id="EventArray-964"><a href="#EventArray-964"><span class="linenos"> 964</span></a><span class="sd">        :param others_data_files:</span>
</span><span id="EventArray-965"><a href="#EventArray-965"><span class="linenos"> 965</span></a><span class="sd">        :param atlas_data_files:</span>
</span><span id="EventArray-966"><a href="#EventArray-966"><span class="linenos"> 966</span></a><span class="sd">        :param drop_common_events:</span>
</span><span id="EventArray-967"><a href="#EventArray-967"><span class="linenos"> 967</span></a><span class="sd">        :param log:</span>
</span><span id="EventArray-968"><a href="#EventArray-968"><span class="linenos"> 968</span></a><span class="sd">        :return:</span>
</span><span id="EventArray-969"><a href="#EventArray-969"><span class="linenos"> 969</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-970"><a href="#EventArray-970"><span class="linenos"> 970</span></a>        <span class="k">if</span> <span class="n">pyreadr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-971"><a href="#EventArray-971"><span class="linenos"> 971</span></a>            <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span>
</span><span id="EventArray-972"><a href="#EventArray-972"><span class="linenos"> 972</span></a>                <span class="s2">&quot;pyreadr not installed. Install pyreadr directly &quot;</span>
</span><span id="EventArray-973"><a href="#EventArray-973"><span class="linenos"> 973</span></a>                <span class="s2">&quot;or install csi-images with [rds] option to resolve.&quot;</span>
</span><span id="EventArray-974"><a href="#EventArray-974"><span class="linenos"> 974</span></a>            <span class="p">)</span>
</span><span id="EventArray-975"><a href="#EventArray-975"><span class="linenos"> 975</span></a>        <span class="c1"># Check if the input path is a directory or a file</span>
</span><span id="EventArray-976"><a href="#EventArray-976"><span class="linenos"> 976</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">input_path</span><span class="p">):</span>
</span><span id="EventArray-977"><a href="#EventArray-977"><span class="linenos"> 977</span></a>            <span class="n">data_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">input_path</span><span class="p">)]</span>
</span><span id="EventArray-978"><a href="#EventArray-978"><span class="linenos"> 978</span></a>            <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="EventArray-979"><a href="#EventArray-979"><span class="linenos"> 979</span></a>        <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;cells&quot;</span><span class="p">:</span>
</span><span id="EventArray-980"><a href="#EventArray-980"><span class="linenos"> 980</span></a>            <span class="n">data_files</span> <span class="o">=</span> <span class="n">cell_data_files</span>
</span><span id="EventArray-981"><a href="#EventArray-981"><span class="linenos"> 981</span></a>        <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;others&quot;</span><span class="p">:</span>
</span><span id="EventArray-982"><a href="#EventArray-982"><span class="linenos"> 982</span></a>            <span class="n">data_files</span> <span class="o">=</span> <span class="n">others_data_files</span>
</span><span id="EventArray-983"><a href="#EventArray-983"><span class="linenos"> 983</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-984"><a href="#EventArray-984"><span class="linenos"> 984</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid event type.&quot;</span><span class="p">)</span>
</span><span id="EventArray-985"><a href="#EventArray-985"><span class="linenos"> 985</span></a>
</span><span id="EventArray-986"><a href="#EventArray-986"><span class="linenos"> 986</span></a>        <span class="c1"># Load the data from the OCULAR files</span>
</span><span id="EventArray-987"><a href="#EventArray-987"><span class="linenos"> 987</span></a>        <span class="n">file_data</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="EventArray-988"><a href="#EventArray-988"><span class="linenos"> 988</span></a>        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">:</span>
</span><span id="EventArray-989"><a href="#EventArray-989"><span class="linenos"> 989</span></a>            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</span><span id="EventArray-990"><a href="#EventArray-990"><span class="linenos"> 990</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
</span><span id="EventArray-991"><a href="#EventArray-991"><span class="linenos"> 991</span></a>                <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-992"><a href="#EventArray-992"><span class="linenos"> 992</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> not found for in </span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="EventArray-993"><a href="#EventArray-993"><span class="linenos"> 993</span></a>                <span class="k">continue</span>
</span><span id="EventArray-994"><a href="#EventArray-994"><span class="linenos"> 994</span></a>            <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyreadr</span><span class="o">.</span><span class="n">read_r</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="EventArray-995"><a href="#EventArray-995"><span class="linenos"> 995</span></a>            <span class="c1"># Get the DataFrame associated with None (pyreadr dict quirk)</span>
</span><span id="EventArray-996"><a href="#EventArray-996"><span class="linenos"> 996</span></a>            <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="kc">None</span><span class="p">]</span>
</span><span id="EventArray-997"><a href="#EventArray-997"><span class="linenos"> 997</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray-998"><a href="#EventArray-998"><span class="linenos"> 998</span></a>                <span class="c1"># File gets dropped from the dict</span>
</span><span id="EventArray-999"><a href="#EventArray-999"><span class="linenos"> 999</span></a>                <span class="n">file_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="EventArray-1000"><a href="#EventArray-1000"><span class="linenos">1000</span></a>                <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-1001"><a href="#EventArray-1001"><span class="linenos">1001</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> has no cells&quot;</span><span class="p">)</span>
</span><span id="EventArray-1002"><a href="#EventArray-1002"><span class="linenos">1002</span></a>                <span class="k">continue</span>
</span><span id="EventArray-1003"><a href="#EventArray-1003"><span class="linenos">1003</span></a>
</span><span id="EventArray-1004"><a href="#EventArray-1004"><span class="linenos">1004</span></a>            <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-1005"><a href="#EventArray-1005"><span class="linenos">1005</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">])</span><span class="si">}</span><span class="s2"> cells&quot;</span><span class="p">)</span>
</span><span id="EventArray-1006"><a href="#EventArray-1006"><span class="linenos">1006</span></a>
</span><span id="EventArray-1007"><a href="#EventArray-1007"><span class="linenos">1007</span></a>            <span class="c1"># Drop common cells if requested and in this file</span>
</span><span id="EventArray-1008"><a href="#EventArray-1008"><span class="linenos">1008</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="EventArray-1009"><a href="#EventArray-1009"><span class="linenos">1009</span></a>                <span class="n">file</span> <span class="ow">in</span> <span class="n">atlas_data_files</span>
</span><span id="EventArray-1010"><a href="#EventArray-1010"><span class="linenos">1010</span></a>                <span class="ow">and</span> <span class="n">drop_common_events</span>
</span><span id="EventArray-1011"><a href="#EventArray-1011"><span class="linenos">1011</span></a>                <span class="ow">and</span> <span class="s2">&quot;catalogue_classification&quot;</span> <span class="ow">in</span> <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span>
</span><span id="EventArray-1012"><a href="#EventArray-1012"><span class="linenos">1012</span></a>            <span class="p">):</span>
</span><span id="EventArray-1013"><a href="#EventArray-1013"><span class="linenos">1013</span></a>                <span class="n">common_cell_indices</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="EventArray-1014"><a href="#EventArray-1014"><span class="linenos">1014</span></a>                    <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="s2">&quot;catalogue_classification&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;common_cell&quot;</span>
</span><span id="EventArray-1015"><a href="#EventArray-1015"><span class="linenos">1015</span></a>                <span class="p">)</span>
</span><span id="EventArray-1016"><a href="#EventArray-1016"><span class="linenos">1016</span></a>                <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-1017"><a href="#EventArray-1017"><span class="linenos">1017</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="EventArray-1018"><a href="#EventArray-1018"><span class="linenos">1018</span></a>                        <span class="sa">f</span><span class="s2">&quot;Dropping </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">common_cell_indices</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="EventArray-1019"><a href="#EventArray-1019"><span class="linenos">1019</span></a>                        <span class="sa">f</span><span class="s2">&quot;common cells from </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="EventArray-1020"><a href="#EventArray-1020"><span class="linenos">1020</span></a>                    <span class="p">)</span>
</span><span id="EventArray-1021"><a href="#EventArray-1021"><span class="linenos">1021</span></a>                <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="n">common_cell_indices</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
</span><span id="EventArray-1022"><a href="#EventArray-1022"><span class="linenos">1022</span></a>
</span><span id="EventArray-1023"><a href="#EventArray-1023"><span class="linenos">1023</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray-1024"><a href="#EventArray-1024"><span class="linenos">1024</span></a>                <span class="c1"># File gets dropped from the dict</span>
</span><span id="EventArray-1025"><a href="#EventArray-1025"><span class="linenos">1025</span></a>                <span class="n">file_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="EventArray-1026"><a href="#EventArray-1026"><span class="linenos">1026</span></a>                <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-1027"><a href="#EventArray-1027"><span class="linenos">1027</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> has no cells after dropping common cells&quot;</span><span class="p">)</span>
</span><span id="EventArray-1028"><a href="#EventArray-1028"><span class="linenos">1028</span></a>                <span class="k">continue</span>
</span><span id="EventArray-1029"><a href="#EventArray-1029"><span class="linenos">1029</span></a>
</span><span id="EventArray-1030"><a href="#EventArray-1030"><span class="linenos">1030</span></a>            <span class="c1"># Extract frame_id and cell_id</span>
</span><span id="EventArray-1031"><a href="#EventArray-1031"><span class="linenos">1031</span></a>            <span class="c1"># DAPI- events already have frame_id cell_id outside rowname</span>
</span><span id="EventArray-1032"><a href="#EventArray-1032"><span class="linenos">1032</span></a>            <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">and</span> <span class="s2">&quot;frame_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="EventArray-1033"><a href="#EventArray-1033"><span class="linenos">1033</span></a>                <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="s2">&quot;rowname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="s2">&quot;rowname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>
</span><span id="EventArray-1034"><a href="#EventArray-1034"><span class="linenos">1034</span></a>                <span class="c1"># get frame_id cell_id from rownames column and split into two columns</span>
</span><span id="EventArray-1035"><a href="#EventArray-1035"><span class="linenos">1035</span></a>                <span class="n">split_res</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="s2">&quot;rowname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray-1036"><a href="#EventArray-1036"><span class="linenos">1036</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_res</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="EventArray-1037"><a href="#EventArray-1037"><span class="linenos">1037</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="EventArray-1038"><a href="#EventArray-1038"><span class="linenos">1038</span></a>                        <span class="sa">f</span><span class="s1">&#39;Expected &quot;frame_id cell_id&quot; but got </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="s2">&quot;rowname&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="EventArray-1039"><a href="#EventArray-1039"><span class="linenos">1039</span></a>                    <span class="p">)</span>
</span><span id="EventArray-1040"><a href="#EventArray-1040"><span class="linenos">1040</span></a>                <span class="c1"># then assign it back to the dataframe</span>
</span><span id="EventArray-1041"><a href="#EventArray-1041"><span class="linenos">1041</span></a>                <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][[</span><span class="s2">&quot;frame_id&quot;</span><span class="p">,</span> <span class="s2">&quot;cell_id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">split_res</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
</span><span id="EventArray-1042"><a href="#EventArray-1042"><span class="linenos">1042</span></a>            <span class="c1"># reset indexes since they can cause NaN values in concat</span>
</span><span id="EventArray-1043"><a href="#EventArray-1043"><span class="linenos">1043</span></a>            <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray-1044"><a href="#EventArray-1044"><span class="linenos">1044</span></a>
</span><span id="EventArray-1045"><a href="#EventArray-1045"><span class="linenos">1045</span></a>        <span class="c1"># Merge the data from all files</span>
</span><span id="EventArray-1046"><a href="#EventArray-1046"><span class="linenos">1046</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray-1047"><a href="#EventArray-1047"><span class="linenos">1047</span></a>            <span class="k">return</span> <span class="n">EventArray</span><span class="p">()</span>
</span><span id="EventArray-1048"><a href="#EventArray-1048"><span class="linenos">1048</span></a>        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="EventArray-1049"><a href="#EventArray-1049"><span class="linenos">1049</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="EventArray-1050"><a href="#EventArray-1050"><span class="linenos">1050</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-1051"><a href="#EventArray-1051"><span class="linenos">1051</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="EventArray-1052"><a href="#EventArray-1052"><span class="linenos">1052</span></a>
</span><span id="EventArray-1053"><a href="#EventArray-1053"><span class="linenos">1053</span></a>        <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-1054"><a href="#EventArray-1054"><span class="linenos">1054</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gathered a total of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> events&quot;</span><span class="p">)</span>
</span><span id="EventArray-1055"><a href="#EventArray-1055"><span class="linenos">1055</span></a>
</span><span id="EventArray-1056"><a href="#EventArray-1056"><span class="linenos">1056</span></a>        <span class="c1"># Others is missing the &quot;slide_id&quot;. Insert it right before &quot;frame_id&quot; column</span>
</span><span id="EventArray-1057"><a href="#EventArray-1057"><span class="linenos">1057</span></a>        <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;others&quot;</span> <span class="ow">and</span> <span class="s2">&quot;slide_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="EventArray-1058"><a href="#EventArray-1058"><span class="linenos">1058</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ocular&quot;</span><span class="p">:</span>
</span><span id="EventArray-1059"><a href="#EventArray-1059"><span class="linenos">1059</span></a>                <span class="n">slide_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">input_path</span><span class="p">))</span>
</span><span id="EventArray-1060"><a href="#EventArray-1060"><span class="linenos">1060</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-1061"><a href="#EventArray-1061"><span class="linenos">1061</span></a>                <span class="n">slide_id</span> <span class="o">=</span> <span class="s2">&quot;UNKNOWN&quot;</span>
</span><span id="EventArray-1062"><a href="#EventArray-1062"><span class="linenos">1062</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s2">&quot;frame_id&quot;</span><span class="p">),</span> <span class="s2">&quot;slide_id&quot;</span><span class="p">,</span> <span class="n">slide_id</span><span class="p">)</span>
</span><span id="EventArray-1063"><a href="#EventArray-1063"><span class="linenos">1063</span></a>
</span><span id="EventArray-1064"><a href="#EventArray-1064"><span class="linenos">1064</span></a>        <span class="c1"># Sort according to ascending cell_id to keep the original, which is in manual_df</span>
</span><span id="EventArray-1065"><a href="#EventArray-1065"><span class="linenos">1065</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray-1066"><a href="#EventArray-1066"><span class="linenos">1066</span></a>        <span class="c1"># Filter out duplicates by x &amp; y</span>
</span><span id="EventArray-1067"><a href="#EventArray-1067"><span class="linenos">1067</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="EventArray-1068"><a href="#EventArray-1068"><span class="linenos">1068</span></a>            <span class="n">unique_id</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">]</span>
</span><span id="EventArray-1069"><a href="#EventArray-1069"><span class="linenos">1069</span></a>            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
</span><span id="EventArray-1070"><a href="#EventArray-1070"><span class="linenos">1070</span></a>            <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;frame_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="EventArray-1071"><a href="#EventArray-1071"><span class="linenos">1071</span></a>            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
</span><span id="EventArray-1072"><a href="#EventArray-1072"><span class="linenos">1072</span></a>            <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cellx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="EventArray-1073"><a href="#EventArray-1073"><span class="linenos">1073</span></a>            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
</span><span id="EventArray-1074"><a href="#EventArray-1074"><span class="linenos">1074</span></a>            <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;celly&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="EventArray-1075"><a href="#EventArray-1075"><span class="linenos">1075</span></a>        <span class="p">)</span>
</span><span id="EventArray-1076"><a href="#EventArray-1076"><span class="linenos">1076</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;unique_id&quot;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>
</span><span id="EventArray-1077"><a href="#EventArray-1077"><span class="linenos">1077</span></a>        <span class="c1"># Normal unique_id is with cell_id</span>
</span><span id="EventArray-1078"><a href="#EventArray-1078"><span class="linenos">1078</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="EventArray-1079"><a href="#EventArray-1079"><span class="linenos">1079</span></a>            <span class="n">unique_id</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">]</span>
</span><span id="EventArray-1080"><a href="#EventArray-1080"><span class="linenos">1080</span></a>            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
</span><span id="EventArray-1081"><a href="#EventArray-1081"><span class="linenos">1081</span></a>            <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;frame_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="EventArray-1082"><a href="#EventArray-1082"><span class="linenos">1082</span></a>            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
</span><span id="EventArray-1083"><a href="#EventArray-1083"><span class="linenos">1083</span></a>            <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="EventArray-1084"><a href="#EventArray-1084"><span class="linenos">1084</span></a>        <span class="p">)</span>
</span><span id="EventArray-1085"><a href="#EventArray-1085"><span class="linenos">1085</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray-1086"><a href="#EventArray-1086"><span class="linenos">1086</span></a>        <span class="c1"># All columns up to &quot;slide_id&quot; are features; drop the &quot;slide_id&quot;</span>
</span><span id="EventArray-1087"><a href="#EventArray-1087"><span class="linenos">1087</span></a>        <span class="n">features</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">:</span><span class="s2">&quot;slide_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="EventArray-1088"><a href="#EventArray-1088"><span class="linenos">1088</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;slide_id&quot;</span><span class="p">:]</span>
</span><span id="EventArray-1089"><a href="#EventArray-1089"><span class="linenos">1089</span></a>        <span class="c1"># Grab the info columns</span>
</span><span id="EventArray-1090"><a href="#EventArray-1090"><span class="linenos">1090</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">,</span> <span class="s2">&quot;frame_id&quot;</span><span class="p">,</span> <span class="s2">&quot;cellx&quot;</span><span class="p">,</span> <span class="s2">&quot;celly&quot;</span><span class="p">]]</span>
</span><span id="EventArray-1091"><a href="#EventArray-1091"><span class="linenos">1091</span></a>        <span class="n">info</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">,</span> <span class="s2">&quot;tile&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]</span>
</span><span id="EventArray-1092"><a href="#EventArray-1092"><span class="linenos">1092</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="EventArray-1093"><a href="#EventArray-1093"><span class="linenos">1093</span></a>            <span class="n">roi</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># OCULAR only works on 1 ROI, as far as known</span>
</span><span id="EventArray-1094"><a href="#EventArray-1094"><span class="linenos">1094</span></a>            <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>  <span class="c1"># Static, for later montaging</span>
</span><span id="EventArray-1095"><a href="#EventArray-1095"><span class="linenos">1095</span></a>        <span class="p">)</span>
</span><span id="EventArray-1096"><a href="#EventArray-1096"><span class="linenos">1096</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">[[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">,</span> <span class="s2">&quot;tile&quot;</span><span class="p">,</span> <span class="s2">&quot;roi&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">]]</span>
</span><span id="EventArray-1097"><a href="#EventArray-1097"><span class="linenos">1097</span></a>        <span class="c1"># Metadata has duplicate columns for later convenience</span>
</span><span id="EventArray-1098"><a href="#EventArray-1098"><span class="linenos">1098</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="EventArray-1099"><a href="#EventArray-1099"><span class="linenos">1099</span></a>        <span class="c1"># Certain columns tend to be problematic with mixed data formats...</span>
</span><span id="EventArray-1100"><a href="#EventArray-1100"><span class="linenos">1100</span></a>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TRITC&quot;</span><span class="p">,</span> <span class="s2">&quot;CY5&quot;</span><span class="p">,</span> <span class="s2">&quot;FITC&quot;</span><span class="p">]:</span>
</span><span id="EventArray-1101"><a href="#EventArray-1101"><span class="linenos">1101</span></a>            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
</span><span id="EventArray-1102"><a href="#EventArray-1102"><span class="linenos">1102</span></a>                <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="EventArray-1103"><a href="#EventArray-1103"><span class="linenos">1103</span></a>                    <span class="s2">&quot;False&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="EventArray-1104"><a href="#EventArray-1104"><span class="linenos">1104</span></a>                    <span class="s2">&quot;True&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="EventArray-1105"><a href="#EventArray-1105"><span class="linenos">1105</span></a>                    <span class="s2">&quot;FALSE&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="EventArray-1106"><a href="#EventArray-1106"><span class="linenos">1106</span></a>                    <span class="s2">&quot;TRUE&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="EventArray-1107"><a href="#EventArray-1107"><span class="linenos">1107</span></a>                <span class="p">}</span>
</span><span id="EventArray-1108"><a href="#EventArray-1108"><span class="linenos">1108</span></a>                <span class="n">metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
</span><span id="EventArray-1109"><a href="#EventArray-1109"><span class="linenos">1109</span></a>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;catalogue_id&quot;</span><span class="p">,</span> <span class="s2">&quot;catalogue_distance&quot;</span><span class="p">,</span> <span class="s2">&quot;clust&quot;</span><span class="p">,</span> <span class="s2">&quot;hcpc&quot;</span><span class="p">]:</span>
</span><span id="EventArray-1110"><a href="#EventArray-1110"><span class="linenos">1110</span></a>            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
</span><span id="EventArray-1111"><a href="#EventArray-1111"><span class="linenos">1111</span></a>                <span class="n">metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="EventArray-1112"><a href="#EventArray-1112"><span class="linenos">1112</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>A class that holds a large number of events' data, making it easy to analyze and
manipulate many events at once. A more separated version of the Event class.</p>
</div>


                            <div id="EventArray.__init__" class="classattr">
                                        <input id="EventArray.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">EventArray</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">info</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">metadata</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">features</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="EventArray.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.__init__-263"><a href="#EventArray.__init__-263"><span class="linenos">263</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="EventArray.__init__-264"><a href="#EventArray.__init__-264"><span class="linenos">264</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="EventArray.__init__-265"><a href="#EventArray.__init__-265"><span class="linenos">265</span></a>        <span class="n">info</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EventArray.__init__-266"><a href="#EventArray.__init__-266"><span class="linenos">266</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EventArray.__init__-267"><a href="#EventArray.__init__-267"><span class="linenos">267</span></a>        <span class="n">features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EventArray.__init__-268"><a href="#EventArray.__init__-268"><span class="linenos">268</span></a>    <span class="p">):</span>
</span><span id="EventArray.__init__-269"><a href="#EventArray.__init__-269"><span class="linenos">269</span></a>        <span class="c1"># Info must be a DataFrame with columns &quot;slide_id&quot;, &quot;tile&quot;, &quot;roi&quot;, &quot;x&quot;, &quot;y&quot;, &quot;size&quot;</span>
</span><span id="EventArray.__init__-270"><a href="#EventArray.__init__-270"><span class="linenos">270</span></a>        <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.__init__-271"><a href="#EventArray.__init__-271"><span class="linenos">271</span></a>            <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">INFO_COLUMNS</span><span class="p">:</span>
</span><span id="EventArray.__init__-272"><a href="#EventArray.__init__-272"><span class="linenos">272</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="EventArray.__init__-273"><a href="#EventArray.__init__-273"><span class="linenos">273</span></a>                    <span class="s2">&quot;EventArray.info must have columns &#39;slide_id&#39;, &#39;tile&#39;, &#39;roi&#39;, &#39;x&#39;, &#39;y&#39;, &#39;size&#39;&quot;</span>
</span><span id="EventArray.__init__-274"><a href="#EventArray.__init__-274"><span class="linenos">274</span></a>                <span class="p">)</span>
</span><span id="EventArray.__init__-275"><a href="#EventArray.__init__-275"><span class="linenos">275</span></a>            <span class="c1"># Copy first to avoid modifying the original</span>
</span><span id="EventArray.__init__-276"><a href="#EventArray.__init__-276"><span class="linenos">276</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray.__init__-277"><a href="#EventArray.__init__-277"><span class="linenos">277</span></a>            <span class="c1"># Ensure that the columns are the right types</span>
</span><span id="EventArray.__init__-278"><a href="#EventArray.__init__-278"><span class="linenos">278</span></a>            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="EventArray.__init__-279"><a href="#EventArray.__init__-279"><span class="linenos">279</span></a>            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="EventArray.__init__-280"><a href="#EventArray.__init__-280"><span class="linenos">280</span></a>            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="EventArray.__init__-281"><a href="#EventArray.__init__-281"><span class="linenos">281</span></a>            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="EventArray.__init__-282"><a href="#EventArray.__init__-282"><span class="linenos">282</span></a>            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="EventArray.__init__-283"><a href="#EventArray.__init__-283"><span class="linenos">283</span></a>            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="EventArray.__init__-284"><a href="#EventArray.__init__-284"><span class="linenos">284</span></a>        <span class="c1"># All DataFrames must all have the same number of rows</span>
</span><span id="EventArray.__init__-285"><a href="#EventArray.__init__-285"><span class="linenos">285</span></a>        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="p">)):</span>
</span><span id="EventArray.__init__-286"><a href="#EventArray.__init__-286"><span class="linenos">286</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="EventArray.__init__-287"><a href="#EventArray.__init__-287"><span class="linenos">287</span></a>                <span class="s2">&quot;If EventArray.metadata is not None, it should match rows with .info&quot;</span>
</span><span id="EventArray.__init__-288"><a href="#EventArray.__init__-288"><span class="linenos">288</span></a>            <span class="p">)</span>
</span><span id="EventArray.__init__-289"><a href="#EventArray.__init__-289"><span class="linenos">289</span></a>        <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)):</span>
</span><span id="EventArray.__init__-290"><a href="#EventArray.__init__-290"><span class="linenos">290</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="EventArray.__init__-291"><a href="#EventArray.__init__-291"><span class="linenos">291</span></a>                <span class="s2">&quot;If EventArray.features is not None, it should match rows with .info&quot;</span>
</span><span id="EventArray.__init__-292"><a href="#EventArray.__init__-292"><span class="linenos">292</span></a>            <span class="p">)</span>
</span><span id="EventArray.__init__-293"><a href="#EventArray.__init__-293"><span class="linenos">293</span></a>        <span class="c1"># No columns named &quot;metadata_&quot;, &quot;features_&quot;, or &quot;None&quot;</span>
</span><span id="EventArray.__init__-294"><a href="#EventArray.__init__-294"><span class="linenos">294</span></a>        <span class="n">column_names</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray.__init__-295"><a href="#EventArray.__init__-295"><span class="linenos">295</span></a>        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.__init__-296"><a href="#EventArray.__init__-296"><span class="linenos">296</span></a>            <span class="n">column_names</span> <span class="o">+=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="EventArray.__init__-297"><a href="#EventArray.__init__-297"><span class="linenos">297</span></a>        <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.__init__-298"><a href="#EventArray.__init__-298"><span class="linenos">298</span></a>            <span class="n">column_names</span> <span class="o">+=</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="EventArray.__init__-299"><a href="#EventArray.__init__-299"><span class="linenos">299</span></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;metadata_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">]):</span>
</span><span id="EventArray.__init__-300"><a href="#EventArray.__init__-300"><span class="linenos">300</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;EventArray column names cannot start with &#39;metadata_&#39;&quot;</span><span class="p">)</span>
</span><span id="EventArray.__init__-301"><a href="#EventArray.__init__-301"><span class="linenos">301</span></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;features_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">]):</span>
</span><span id="EventArray.__init__-302"><a href="#EventArray.__init__-302"><span class="linenos">302</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;EventArray column names cannot start with &#39;features_&#39;&quot;</span><span class="p">)</span>
</span><span id="EventArray.__init__-303"><a href="#EventArray.__init__-303"><span class="linenos">303</span></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">]):</span>
</span><span id="EventArray.__init__-304"><a href="#EventArray.__init__-304"><span class="linenos">304</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;EventArray column names cannot be &#39;none&#39;&quot;</span><span class="p">)</span>
</span><span id="EventArray.__init__-305"><a href="#EventArray.__init__-305"><span class="linenos">305</span></a>
</span><span id="EventArray.__init__-306"><a href="#EventArray.__init__-306"><span class="linenos">306</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
</span><span id="EventArray.__init__-307"><a href="#EventArray.__init__-307"><span class="linenos">307</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
</span><span id="EventArray.__init__-308"><a href="#EventArray.__init__-308"><span class="linenos">308</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
</span></pre></div>


    

                            </div>
                            <div id="EventArray.INFO_COLUMNS" class="classattr">
                                <div class="attr variable">
            <span class="name">INFO_COLUMNS</span>        =
<span class="default_value">[&#39;slide_id&#39;, &#39;tile&#39;, &#39;roi&#39;, &#39;x&#39;, &#39;y&#39;, &#39;size&#39;]</span>

        
    </div>
    <a class="headerlink" href="#EventArray.INFO_COLUMNS"></a>
    
    

                            </div>
                            <div id="EventArray.info" class="classattr">
                                <div class="attr variable">
            <span class="name">info</span>

        
    </div>
    <a class="headerlink" href="#EventArray.info"></a>
    
    

                            </div>
                            <div id="EventArray.metadata" class="classattr">
                                <div class="attr variable">
            <span class="name">metadata</span>

        
    </div>
    <a class="headerlink" href="#EventArray.metadata"></a>
    
    

                            </div>
                            <div id="EventArray.features" class="classattr">
                                <div class="attr variable">
            <span class="name">features</span>

        
    </div>
    <a class="headerlink" href="#EventArray.features"></a>
    
    

                            </div>
                            <div id="EventArray.get_sort_order" class="classattr">
                                        <input id="EventArray.get_sort_order-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_sort_order</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>, </span><span class="param"><span class="n">ascending</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="EventArray.get_sort_order-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.get_sort_order"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.get_sort_order-357"><a href="#EventArray.get_sort_order-357"><span class="linenos">357</span></a>    <span class="k">def</span> <span class="nf">get_sort_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ascending</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
</span><span id="EventArray.get_sort_order-358"><a href="#EventArray.get_sort_order-358"><span class="linenos">358</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.get_sort_order-359"><a href="#EventArray.get_sort_order-359"><span class="linenos">359</span></a><span class="sd">        Get the sort order for the EventArray by a column in the info, metadata, or features DataFrames.</span>
</span><span id="EventArray.get_sort_order-360"><a href="#EventArray.get_sort_order-360"><span class="linenos">360</span></a><span class="sd">        :param by: name of the column(s) to sort by.</span>
</span><span id="EventArray.get_sort_order-361"><a href="#EventArray.get_sort_order-361"><span class="linenos">361</span></a><span class="sd">        :param ascending: whether to sort in ascending order; can be a list to match by</span>
</span><span id="EventArray.get_sort_order-362"><a href="#EventArray.get_sort_order-362"><span class="linenos">362</span></a><span class="sd">        :return: the order of the indices to sort by.</span>
</span><span id="EventArray.get_sort_order-363"><a href="#EventArray.get_sort_order-363"><span class="linenos">363</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.get_sort_order-364"><a href="#EventArray.get_sort_order-364"><span class="linenos">364</span></a>        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">by</span><span class="p">)</span>
</span><span id="EventArray.get_sort_order-365"><a href="#EventArray.get_sort_order-365"><span class="linenos">365</span></a>        <span class="k">return</span> <span class="n">columns</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">by</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="n">ascending</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
</span></pre></div>


            <div class="docstring"><p>Get the sort order for the EventArray by a column in the info, metadata, or features DataFrames.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>by</strong>:  name of the column(s) to sort by.</li>
<li><strong>ascending</strong>:  whether to sort in ascending order; can be a list to match by</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>the order of the indices to sort by.</p>
</blockquote>
</div>


                            </div>
                            <div id="EventArray.sort" class="classattr">
                                        <input id="EventArray.sort-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sort</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>, </span><span class="param"><span class="n">ascending</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">) -> <span class="n">Self</span>:</span></span>

                <label class="view-source-button" for="EventArray.sort-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.sort"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.sort-367"><a href="#EventArray.sort-367"><span class="linenos">367</span></a>    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ascending</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray.sort-368"><a href="#EventArray.sort-368"><span class="linenos">368</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.sort-369"><a href="#EventArray.sort-369"><span class="linenos">369</span></a><span class="sd">        Sort the EventArray by column(s) in the info, metadata, or features DataFrames.</span>
</span><span id="EventArray.sort-370"><a href="#EventArray.sort-370"><span class="linenos">370</span></a><span class="sd">        :param by: name of the column(s) to sort by.</span>
</span><span id="EventArray.sort-371"><a href="#EventArray.sort-371"><span class="linenos">371</span></a><span class="sd">        :param ascending: whether to sort in ascending order; can be a list to match by</span>
</span><span id="EventArray.sort-372"><a href="#EventArray.sort-372"><span class="linenos">372</span></a><span class="sd">        :return: a new, sorted EventArray.</span>
</span><span id="EventArray.sort-373"><a href="#EventArray.sort-373"><span class="linenos">373</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.sort-374"><a href="#EventArray.sort-374"><span class="linenos">374</span></a>        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sort_order</span><span class="p">(</span><span class="n">by</span><span class="p">,</span> <span class="n">ascending</span><span class="p">)</span>
</span><span id="EventArray.sort-375"><a href="#EventArray.sort-375"><span class="linenos">375</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray.sort-376"><a href="#EventArray.sort-376"><span class="linenos">376</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.sort-377"><a href="#EventArray.sort-377"><span class="linenos">377</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray.sort-378"><a href="#EventArray.sort-378"><span class="linenos">378</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.sort-379"><a href="#EventArray.sort-379"><span class="linenos">379</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.sort-380"><a href="#EventArray.sort-380"><span class="linenos">380</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.sort-381"><a href="#EventArray.sort-381"><span class="linenos">381</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray.sort-382"><a href="#EventArray.sort-382"><span class="linenos">382</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.sort-383"><a href="#EventArray.sort-383"><span class="linenos">383</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.sort-384"><a href="#EventArray.sort-384"><span class="linenos">384</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sort the EventArray by column(s) in the info, metadata, or features DataFrames.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>by</strong>:  name of the column(s) to sort by.</li>
<li><strong>ascending</strong>:  whether to sort in ascending order; can be a list to match by</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a new, sorted EventArray.</p>
</blockquote>
</div>


                            </div>
                            <div id="EventArray.get" class="classattr">
                                        <input id="EventArray.get-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">column_names</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>:</span></span>

                <label class="view-source-button" for="EventArray.get-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.get"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.get-386"><a href="#EventArray.get-386"><span class="linenos">386</span></a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_names</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="EventArray.get-387"><a href="#EventArray.get-387"><span class="linenos">387</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.get-388"><a href="#EventArray.get-388"><span class="linenos">388</span></a><span class="sd">        Get a DataFrame with the specified columns from the EventArray, by value.</span>
</span><span id="EventArray.get-389"><a href="#EventArray.get-389"><span class="linenos">389</span></a><span class="sd">        :param column_names: the names of the columns to get.</span>
</span><span id="EventArray.get-390"><a href="#EventArray.get-390"><span class="linenos">390</span></a><span class="sd">        :return: a DataFrame with the specified columns.</span>
</span><span id="EventArray.get-391"><a href="#EventArray.get-391"><span class="linenos">391</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.get-392"><a href="#EventArray.get-392"><span class="linenos">392</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_names</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="EventArray.get-393"><a href="#EventArray.get-393"><span class="linenos">393</span></a>            <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">column_names</span><span class="p">]</span>
</span><span id="EventArray.get-394"><a href="#EventArray.get-394"><span class="linenos">394</span></a>        <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray.get-395"><a href="#EventArray.get-395"><span class="linenos">395</span></a>        <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">:</span>
</span><span id="EventArray.get-396"><a href="#EventArray.get-396"><span class="linenos">396</span></a>            <span class="k">if</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="EventArray.get-397"><a href="#EventArray.get-397"><span class="linenos">397</span></a>                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">column_name</span><span class="p">])</span>
</span><span id="EventArray.get-398"><a href="#EventArray.get-398"><span class="linenos">398</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="EventArray.get-399"><a href="#EventArray.get-399"><span class="linenos">399</span></a>                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">column_name</span><span class="p">])</span>
</span><span id="EventArray.get-400"><a href="#EventArray.get-400"><span class="linenos">400</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="EventArray.get-401"><a href="#EventArray.get-401"><span class="linenos">401</span></a>                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">column_name</span><span class="p">])</span>
</span><span id="EventArray.get-402"><a href="#EventArray.get-402"><span class="linenos">402</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.get-403"><a href="#EventArray.get-403"><span class="linenos">403</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column </span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s2"> not found in EventArray&quot;</span><span class="p">)</span>
</span><span id="EventArray.get-404"><a href="#EventArray.get-404"><span class="linenos">404</span></a>        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get a DataFrame with the specified columns from the EventArray, by value.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>column_names</strong>:  the names of the columns to get.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a DataFrame with the specified columns.</p>
</blockquote>
</div>


                            </div>
                            <div id="EventArray.rows" class="classattr">
                                        <input id="EventArray.rows-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">rows</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">rows</span></span><span class="return-annotation">) -> <span class="n">Self</span>:</span></span>

                <label class="view-source-button" for="EventArray.rows-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.rows"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.rows-406"><a href="#EventArray.rows-406"><span class="linenos">406</span></a>    <span class="k">def</span> <span class="nf">rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray.rows-407"><a href="#EventArray.rows-407"><span class="linenos">407</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.rows-408"><a href="#EventArray.rows-408"><span class="linenos">408</span></a><span class="sd">        Get a subset of the EventArray rows based on a boolean or integer index, by value.</span>
</span><span id="EventArray.rows-409"><a href="#EventArray.rows-409"><span class="linenos">409</span></a><span class="sd">        :param rows: the indices to get as a 1D boolean/integer list/array/series</span>
</span><span id="EventArray.rows-410"><a href="#EventArray.rows-410"><span class="linenos">410</span></a><span class="sd">        :return: a new EventArray with the subset of events.</span>
</span><span id="EventArray.rows-411"><a href="#EventArray.rows-411"><span class="linenos">411</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.rows-412"><a href="#EventArray.rows-412"><span class="linenos">412</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rows</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray.rows-413"><a href="#EventArray.rows-413"><span class="linenos">413</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.rows-414"><a href="#EventArray.rows-414"><span class="linenos">414</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rows</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray.rows-415"><a href="#EventArray.rows-415"><span class="linenos">415</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.rows-416"><a href="#EventArray.rows-416"><span class="linenos">416</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.rows-417"><a href="#EventArray.rows-417"><span class="linenos">417</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.rows-418"><a href="#EventArray.rows-418"><span class="linenos">418</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rows</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray.rows-419"><a href="#EventArray.rows-419"><span class="linenos">419</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.rows-420"><a href="#EventArray.rows-420"><span class="linenos">420</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.rows-421"><a href="#EventArray.rows-421"><span class="linenos">421</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get a subset of the EventArray rows based on a boolean or integer index, by value.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>rows</strong>:  the indices to get as a 1D boolean/integer list/array/series</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a new EventArray with the subset of events.</p>
</blockquote>
</div>


                            </div>
                            <div id="EventArray.copy" class="classattr">
                                        <input id="EventArray.copy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">copy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Self</span>:</span></span>

                <label class="view-source-button" for="EventArray.copy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.copy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.copy-423"><a href="#EventArray.copy-423"><span class="linenos">423</span></a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray.copy-424"><a href="#EventArray.copy-424"><span class="linenos">424</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.copy-425"><a href="#EventArray.copy-425"><span class="linenos">425</span></a><span class="sd">        Create a deep copy of the EventArray.</span>
</span><span id="EventArray.copy-426"><a href="#EventArray.copy-426"><span class="linenos">426</span></a><span class="sd">        :return: a deep copy of the EventArray.</span>
</span><span id="EventArray.copy-427"><a href="#EventArray.copy-427"><span class="linenos">427</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.copy-428"><a href="#EventArray.copy-428"><span class="linenos">428</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span>
</span><span id="EventArray.copy-429"><a href="#EventArray.copy-429"><span class="linenos">429</span></a>            <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
</span><span id="EventArray.copy-430"><a href="#EventArray.copy-430"><span class="linenos">430</span></a>            <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
</span><span id="EventArray.copy-431"><a href="#EventArray.copy-431"><span class="linenos">431</span></a>            <span class="n">features</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
</span><span id="EventArray.copy-432"><a href="#EventArray.copy-432"><span class="linenos">432</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create a deep copy of the EventArray.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a deep copy of the EventArray.</p>
</blockquote>
</div>


                            </div>
                            <div id="EventArray.add_metadata" class="classattr">
                                        <input id="EventArray.add_metadata-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_metadata</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">new_metadata</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="EventArray.add_metadata-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.add_metadata"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.add_metadata-434"><a href="#EventArray.add_metadata-434"><span class="linenos">434</span></a>    <span class="k">def</span> <span class="nf">add_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.add_metadata-435"><a href="#EventArray.add_metadata-435"><span class="linenos">435</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.add_metadata-436"><a href="#EventArray.add_metadata-436"><span class="linenos">436</span></a><span class="sd">        Add metadata to the EventArray. Removes the need to check if metadata is None.</span>
</span><span id="EventArray.add_metadata-437"><a href="#EventArray.add_metadata-437"><span class="linenos">437</span></a><span class="sd">        Overwrites any existing metadata with the same column names as the new metadata.</span>
</span><span id="EventArray.add_metadata-438"><a href="#EventArray.add_metadata-438"><span class="linenos">438</span></a><span class="sd">        :param new_metadata: the metadata to add.</span>
</span><span id="EventArray.add_metadata-439"><a href="#EventArray.add_metadata-439"><span class="linenos">439</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.add_metadata-440"><a href="#EventArray.add_metadata-440"><span class="linenos">440</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_metadata</span><span class="p">):</span>
</span><span id="EventArray.add_metadata-441"><a href="#EventArray.add_metadata-441"><span class="linenos">441</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;New metadata must match length of existing info&quot;</span><span class="p">)</span>
</span><span id="EventArray.add_metadata-442"><a href="#EventArray.add_metadata-442"><span class="linenos">442</span></a>
</span><span id="EventArray.add_metadata-443"><a href="#EventArray.add_metadata-443"><span class="linenos">443</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.add_metadata-444"><a href="#EventArray.add_metadata-444"><span class="linenos">444</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">new_metadata</span>
</span><span id="EventArray.add_metadata-445"><a href="#EventArray.add_metadata-445"><span class="linenos">445</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.add_metadata-446"><a href="#EventArray.add_metadata-446"><span class="linenos">446</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_metadata</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
</span><span id="EventArray.add_metadata-447"><a href="#EventArray.add_metadata-447"><span class="linenos">447</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">new_metadata</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_metadata</span>
</span><span id="EventArray.add_metadata-448"><a href="#EventArray.add_metadata-448"><span class="linenos">448</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.add_metadata-449"><a href="#EventArray.add_metadata-449"><span class="linenos">449</span></a>                <span class="c1"># It&#39;s a DataFrame</span>
</span><span id="EventArray.add_metadata-450"><a href="#EventArray.add_metadata-450"><span class="linenos">450</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">new_metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_metadata</span>
</span></pre></div>


            <div class="docstring"><p>Add metadata to the EventArray. Removes the need to check if metadata is None.
Overwrites any existing metadata with the same column names as the new metadata.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>new_metadata</strong>:  the metadata to add.</li>
</ul>
</div>


                            </div>
                            <div id="EventArray.add_features" class="classattr">
                                        <input id="EventArray.add_features-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_features</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">new_features</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="EventArray.add_features-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.add_features"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.add_features-452"><a href="#EventArray.add_features-452"><span class="linenos">452</span></a>    <span class="k">def</span> <span class="nf">add_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.add_features-453"><a href="#EventArray.add_features-453"><span class="linenos">453</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.add_features-454"><a href="#EventArray.add_features-454"><span class="linenos">454</span></a><span class="sd">        Add features to the EventArray. Removes the need to check if features is None.</span>
</span><span id="EventArray.add_features-455"><a href="#EventArray.add_features-455"><span class="linenos">455</span></a><span class="sd">        Overwrites any existing features with the same column names as the new features.</span>
</span><span id="EventArray.add_features-456"><a href="#EventArray.add_features-456"><span class="linenos">456</span></a><span class="sd">        :param new_features: the features to add.</span>
</span><span id="EventArray.add_features-457"><a href="#EventArray.add_features-457"><span class="linenos">457</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.add_features-458"><a href="#EventArray.add_features-458"><span class="linenos">458</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_features</span><span class="p">):</span>
</span><span id="EventArray.add_features-459"><a href="#EventArray.add_features-459"><span class="linenos">459</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;New features must match length of existing info&quot;</span><span class="p">)</span>
</span><span id="EventArray.add_features-460"><a href="#EventArray.add_features-460"><span class="linenos">460</span></a>
</span><span id="EventArray.add_features-461"><a href="#EventArray.add_features-461"><span class="linenos">461</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.add_features-462"><a href="#EventArray.add_features-462"><span class="linenos">462</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">new_features</span>
</span><span id="EventArray.add_features-463"><a href="#EventArray.add_features-463"><span class="linenos">463</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.add_features-464"><a href="#EventArray.add_features-464"><span class="linenos">464</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_features</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
</span><span id="EventArray.add_features-465"><a href="#EventArray.add_features-465"><span class="linenos">465</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">new_features</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_features</span>
</span><span id="EventArray.add_features-466"><a href="#EventArray.add_features-466"><span class="linenos">466</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.add_features-467"><a href="#EventArray.add_features-467"><span class="linenos">467</span></a>                <span class="c1"># It&#39;s a DataFrame</span>
</span><span id="EventArray.add_features-468"><a href="#EventArray.add_features-468"><span class="linenos">468</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">new_features</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_features</span>
</span></pre></div>


            <div class="docstring"><p>Add features to the EventArray. Removes the need to check if features is None.
Overwrites any existing features with the same column names as the new features.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>new_features</strong>:  the features to add.</li>
</ul>
</div>


                            </div>
                            <div id="EventArray.merge" class="classattr">
                                        <input id="EventArray.merge-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">merge</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Self</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">Self</span>:</span></span>

                <label class="view-source-button" for="EventArray.merge-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.merge"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.merge-470"><a href="#EventArray.merge-470"><span class="linenos">470</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray.merge-471"><a href="#EventArray.merge-471"><span class="linenos">471</span></a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Self</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray.merge-472"><a href="#EventArray.merge-472"><span class="linenos">472</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.merge-473"><a href="#EventArray.merge-473"><span class="linenos">473</span></a><span class="sd">        Combine EventArrays in a list into a single EventArray.</span>
</span><span id="EventArray.merge-474"><a href="#EventArray.merge-474"><span class="linenos">474</span></a><span class="sd">        :param events: the new list of events.</span>
</span><span id="EventArray.merge-475"><a href="#EventArray.merge-475"><span class="linenos">475</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.merge-476"><a href="#EventArray.merge-476"><span class="linenos">476</span></a>        <span class="n">all_info</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray.merge-477"><a href="#EventArray.merge-477"><span class="linenos">477</span></a>        <span class="n">all_metadata</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray.merge-478"><a href="#EventArray.merge-478"><span class="linenos">478</span></a>        <span class="n">all_features</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray.merge-479"><a href="#EventArray.merge-479"><span class="linenos">479</span></a>        <span class="k">for</span> <span class="n">event_array</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="EventArray.merge-480"><a href="#EventArray.merge-480"><span class="linenos">480</span></a>            <span class="c1"># Skip empty EventArrays</span>
</span><span id="EventArray.merge-481"><a href="#EventArray.merge-481"><span class="linenos">481</span></a>            <span class="k">if</span> <span class="n">event_array</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.merge-482"><a href="#EventArray.merge-482"><span class="linenos">482</span></a>                <span class="n">all_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_array</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
</span><span id="EventArray.merge-483"><a href="#EventArray.merge-483"><span class="linenos">483</span></a>            <span class="k">if</span> <span class="n">event_array</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.merge-484"><a href="#EventArray.merge-484"><span class="linenos">484</span></a>                <span class="n">all_metadata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_array</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
</span><span id="EventArray.merge-485"><a href="#EventArray.merge-485"><span class="linenos">485</span></a>            <span class="k">if</span> <span class="n">event_array</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.merge-486"><a href="#EventArray.merge-486"><span class="linenos">486</span></a>                <span class="n">all_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_array</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
</span><span id="EventArray.merge-487"><a href="#EventArray.merge-487"><span class="linenos">487</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray.merge-488"><a href="#EventArray.merge-488"><span class="linenos">488</span></a>            <span class="k">return</span> <span class="n">EventArray</span><span class="p">()</span>
</span><span id="EventArray.merge-489"><a href="#EventArray.merge-489"><span class="linenos">489</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.merge-490"><a href="#EventArray.merge-490"><span class="linenos">490</span></a>            <span class="n">all_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_info</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray.merge-491"><a href="#EventArray.merge-491"><span class="linenos">491</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_metadata</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray.merge-492"><a href="#EventArray.merge-492"><span class="linenos">492</span></a>            <span class="n">all_metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.merge-493"><a href="#EventArray.merge-493"><span class="linenos">493</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.merge-494"><a href="#EventArray.merge-494"><span class="linenos">494</span></a>            <span class="n">all_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_metadata</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray.merge-495"><a href="#EventArray.merge-495"><span class="linenos">495</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_features</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray.merge-496"><a href="#EventArray.merge-496"><span class="linenos">496</span></a>            <span class="n">all_features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.merge-497"><a href="#EventArray.merge-497"><span class="linenos">497</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.merge-498"><a href="#EventArray.merge-498"><span class="linenos">498</span></a>            <span class="n">all_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_features</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray.merge-499"><a href="#EventArray.merge-499"><span class="linenos">499</span></a>
</span><span id="EventArray.merge-500"><a href="#EventArray.merge-500"><span class="linenos">500</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">all_info</span><span class="p">,</span> <span class="n">all_metadata</span><span class="p">,</span> <span class="n">all_features</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Combine EventArrays in a list into a single EventArray.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>events</strong>:  the new list of events.</li>
</ul>
</div>


                            </div>
                            <div id="EventArray.to_events" class="classattr">
                                        <input id="EventArray.to_events-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">to_events</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">scans</span><span class="p">:</span> <span class="n"><a href="csi_scans.html#Scan">csi_images.csi_scans.Scan</a></span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="csi_scans.html#Scan">csi_images.csi_scans.Scan</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">ignore_missing_scans</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">ignore_metadata</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">ignore_features</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="#Event">Event</a></span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="EventArray.to_events-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.to_events"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.to_events-502"><a href="#EventArray.to_events-502"><span class="linenos">502</span></a>    <span class="k">def</span> <span class="nf">to_events</span><span class="p">(</span>
</span><span id="EventArray.to_events-503"><a href="#EventArray.to_events-503"><span class="linenos">503</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="EventArray.to_events-504"><a href="#EventArray.to_events-504"><span class="linenos">504</span></a>        <span class="n">scans</span><span class="p">:</span> <span class="n">Scan</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">Scan</span><span class="p">],</span>
</span><span id="EventArray.to_events-505"><a href="#EventArray.to_events-505"><span class="linenos">505</span></a>        <span class="n">ignore_missing_scans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="EventArray.to_events-506"><a href="#EventArray.to_events-506"><span class="linenos">506</span></a>        <span class="n">ignore_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="EventArray.to_events-507"><a href="#EventArray.to_events-507"><span class="linenos">507</span></a>        <span class="n">ignore_features</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="EventArray.to_events-508"><a href="#EventArray.to_events-508"><span class="linenos">508</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Event</span><span class="p">]:</span>
</span><span id="EventArray.to_events-509"><a href="#EventArray.to_events-509"><span class="linenos">509</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.to_events-510"><a href="#EventArray.to_events-510"><span class="linenos">510</span></a><span class="sd">        Get the events in the EventArray as a list of events.</span>
</span><span id="EventArray.to_events-511"><a href="#EventArray.to_events-511"><span class="linenos">511</span></a><span class="sd">        :param scans: the scans that the events belong to, auto-matched by slide_id.</span>
</span><span id="EventArray.to_events-512"><a href="#EventArray.to_events-512"><span class="linenos">512</span></a><span class="sd">        Pass None if you don&#39;t care about scan metadata (pass ignore_missing_scans).</span>
</span><span id="EventArray.to_events-513"><a href="#EventArray.to_events-513"><span class="linenos">513</span></a><span class="sd">        :param ignore_missing_scans: whether to create blank scans for events without scans.</span>
</span><span id="EventArray.to_events-514"><a href="#EventArray.to_events-514"><span class="linenos">514</span></a><span class="sd">        :param ignore_metadata: whether to ignore metadata or not</span>
</span><span id="EventArray.to_events-515"><a href="#EventArray.to_events-515"><span class="linenos">515</span></a><span class="sd">        :param ignore_features: whether to ignore features or not</span>
</span><span id="EventArray.to_events-516"><a href="#EventArray.to_events-516"><span class="linenos">516</span></a><span class="sd">        :return:</span>
</span><span id="EventArray.to_events-517"><a href="#EventArray.to_events-517"><span class="linenos">517</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.to_events-518"><a href="#EventArray.to_events-518"><span class="linenos">518</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scans</span><span class="p">,</span> <span class="n">Scan</span><span class="p">):</span>
</span><span id="EventArray.to_events-519"><a href="#EventArray.to_events-519"><span class="linenos">519</span></a>            <span class="n">scans</span> <span class="o">=</span> <span class="p">[</span><span class="n">scans</span><span class="p">]</span>
</span><span id="EventArray.to_events-520"><a href="#EventArray.to_events-520"><span class="linenos">520</span></a>        <span class="n">scans</span> <span class="o">=</span> <span class="p">{</span><span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span><span class="p">:</span> <span class="n">scan</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">}</span>
</span><span id="EventArray.to_events-521"><a href="#EventArray.to_events-521"><span class="linenos">521</span></a>        <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray.to_events-522"><a href="#EventArray.to_events-522"><span class="linenos">522</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)):</span>
</span><span id="EventArray.to_events-523"><a href="#EventArray.to_events-523"><span class="linenos">523</span></a>            <span class="c1"># Determine the associated scan</span>
</span><span id="EventArray.to_events-524"><a href="#EventArray.to_events-524"><span class="linenos">524</span></a>            <span class="n">slide_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span id="EventArray.to_events-525"><a href="#EventArray.to_events-525"><span class="linenos">525</span></a>            <span class="k">if</span> <span class="n">slide_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
</span><span id="EventArray.to_events-526"><a href="#EventArray.to_events-526"><span class="linenos">526</span></a>                <span class="k">if</span> <span class="n">ignore_missing_scans</span><span class="p">:</span>
</span><span id="EventArray.to_events-527"><a href="#EventArray.to_events-527"><span class="linenos">527</span></a>                    <span class="c1"># Create a placeholder scan if the scan is missing</span>
</span><span id="EventArray.to_events-528"><a href="#EventArray.to_events-528"><span class="linenos">528</span></a>                    <span class="n">scan</span> <span class="o">=</span> <span class="n">Scan</span><span class="o">.</span><span class="n">make_placeholder</span><span class="p">(</span>
</span><span id="EventArray.to_events-529"><a href="#EventArray.to_events-529"><span class="linenos">529</span></a>                        <span class="n">slide_id</span><span class="p">,</span>
</span><span id="EventArray.to_events-530"><a href="#EventArray.to_events-530"><span class="linenos">530</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray.to_events-531"><a href="#EventArray.to_events-531"><span class="linenos">531</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray.to_events-532"><a href="#EventArray.to_events-532"><span class="linenos">532</span></a>                    <span class="p">)</span>
</span><span id="EventArray.to_events-533"><a href="#EventArray.to_events-533"><span class="linenos">533</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.to_events-534"><a href="#EventArray.to_events-534"><span class="linenos">534</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="EventArray.to_events-535"><a href="#EventArray.to_events-535"><span class="linenos">535</span></a>                        <span class="sa">f</span><span class="s2">&quot;Scan </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;slide_id&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found for event </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="EventArray.to_events-536"><a href="#EventArray.to_events-536"><span class="linenos">536</span></a>                    <span class="p">)</span>
</span><span id="EventArray.to_events-537"><a href="#EventArray.to_events-537"><span class="linenos">537</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.to_events-538"><a href="#EventArray.to_events-538"><span class="linenos">538</span></a>                <span class="n">scan</span> <span class="o">=</span> <span class="n">scans</span><span class="p">[</span><span class="n">slide_id</span><span class="p">]</span>
</span><span id="EventArray.to_events-539"><a href="#EventArray.to_events-539"><span class="linenos">539</span></a>
</span><span id="EventArray.to_events-540"><a href="#EventArray.to_events-540"><span class="linenos">540</span></a>            <span class="c1"># Prepare the metadata and features</span>
</span><span id="EventArray.to_events-541"><a href="#EventArray.to_events-541"><span class="linenos">541</span></a>            <span class="k">if</span> <span class="n">ignore_metadata</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.to_events-542"><a href="#EventArray.to_events-542"><span class="linenos">542</span></a>                <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.to_events-543"><a href="#EventArray.to_events-543"><span class="linenos">543</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.to_events-544"><a href="#EventArray.to_events-544"><span class="linenos">544</span></a>                <span class="c1"># This Series creation method is less efficient,</span>
</span><span id="EventArray.to_events-545"><a href="#EventArray.to_events-545"><span class="linenos">545</span></a>                <span class="c1"># but required for preserving dtypes</span>
</span><span id="EventArray.to_events-546"><a href="#EventArray.to_events-546"><span class="linenos">546</span></a>                <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
</span><span id="EventArray.to_events-547"><a href="#EventArray.to_events-547"><span class="linenos">547</span></a>                    <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">},</span>
</span><span id="EventArray.to_events-548"><a href="#EventArray.to_events-548"><span class="linenos">548</span></a>                    <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">,</span>
</span><span id="EventArray.to_events-549"><a href="#EventArray.to_events-549"><span class="linenos">549</span></a>                <span class="p">)</span>
</span><span id="EventArray.to_events-550"><a href="#EventArray.to_events-550"><span class="linenos">550</span></a>            <span class="k">if</span> <span class="n">ignore_features</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.to_events-551"><a href="#EventArray.to_events-551"><span class="linenos">551</span></a>                <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.to_events-552"><a href="#EventArray.to_events-552"><span class="linenos">552</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.to_events-553"><a href="#EventArray.to_events-553"><span class="linenos">553</span></a>                <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
</span><span id="EventArray.to_events-554"><a href="#EventArray.to_events-554"><span class="linenos">554</span></a>                    <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">},</span>
</span><span id="EventArray.to_events-555"><a href="#EventArray.to_events-555"><span class="linenos">555</span></a>                    <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">,</span>
</span><span id="EventArray.to_events-556"><a href="#EventArray.to_events-556"><span class="linenos">556</span></a>                <span class="p">)</span>
</span><span id="EventArray.to_events-557"><a href="#EventArray.to_events-557"><span class="linenos">557</span></a>            <span class="c1"># Create the event and append it to the list</span>
</span><span id="EventArray.to_events-558"><a href="#EventArray.to_events-558"><span class="linenos">558</span></a>            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="EventArray.to_events-559"><a href="#EventArray.to_events-559"><span class="linenos">559</span></a>                <span class="n">Event</span><span class="p">(</span>
</span><span id="EventArray.to_events-560"><a href="#EventArray.to_events-560"><span class="linenos">560</span></a>                    <span class="n">scan</span><span class="p">,</span>
</span><span id="EventArray.to_events-561"><a href="#EventArray.to_events-561"><span class="linenos">561</span></a>                    <span class="n">Tile</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
</span><span id="EventArray.to_events-562"><a href="#EventArray.to_events-562"><span class="linenos">562</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray.to_events-563"><a href="#EventArray.to_events-563"><span class="linenos">563</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray.to_events-564"><a href="#EventArray.to_events-564"><span class="linenos">564</span></a>                    <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray.to_events-565"><a href="#EventArray.to_events-565"><span class="linenos">565</span></a>                    <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
</span><span id="EventArray.to_events-566"><a href="#EventArray.to_events-566"><span class="linenos">566</span></a>                    <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
</span><span id="EventArray.to_events-567"><a href="#EventArray.to_events-567"><span class="linenos">567</span></a>                <span class="p">)</span>
</span><span id="EventArray.to_events-568"><a href="#EventArray.to_events-568"><span class="linenos">568</span></a>            <span class="p">)</span>
</span><span id="EventArray.to_events-569"><a href="#EventArray.to_events-569"><span class="linenos">569</span></a>        <span class="k">return</span> <span class="n">events</span>
</span></pre></div>


            <div class="docstring"><p>Get the events in the EventArray as a list of events.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>scans</strong>:  the scans that the events belong to, auto-matched by slide_id.
Pass None if you don't care about scan metadata (pass ignore_missing_scans).</li>
<li><strong>ignore_missing_scans</strong>:  whether to create blank scans for events without scans.</li>
<li><strong>ignore_metadata</strong>:  whether to ignore metadata or not</li>
<li><strong>ignore_features</strong>:  whether to ignore features or not</li>
</ul>

<h6 id="returns">Returns</h6>
</div>


                            </div>
                            <div id="EventArray.from_events" class="classattr">
                                        <input id="EventArray.from_events-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">from_events</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="#Event">Event</a></span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">Self</span>:</span></span>

                <label class="view-source-button" for="EventArray.from_events-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.from_events"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.from_events-571"><a href="#EventArray.from_events-571"><span class="linenos">571</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray.from_events-572"><a href="#EventArray.from_events-572"><span class="linenos">572</span></a>    <span class="k">def</span> <span class="nf">from_events</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Event</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray.from_events-573"><a href="#EventArray.from_events-573"><span class="linenos">573</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.from_events-574"><a href="#EventArray.from_events-574"><span class="linenos">574</span></a><span class="sd">        Set the events in the EventArray to a new list of events.</span>
</span><span id="EventArray.from_events-575"><a href="#EventArray.from_events-575"><span class="linenos">575</span></a><span class="sd">        :param events: the new list of events.</span>
</span><span id="EventArray.from_events-576"><a href="#EventArray.from_events-576"><span class="linenos">576</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.from_events-577"><a href="#EventArray.from_events-577"><span class="linenos">577</span></a>        <span class="c1"># Return an empty array if we were passed nothing</span>
</span><span id="EventArray.from_events-578"><a href="#EventArray.from_events-578"><span class="linenos">578</span></a>        <span class="k">if</span> <span class="n">events</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray.from_events-579"><a href="#EventArray.from_events-579"><span class="linenos">579</span></a>            <span class="k">return</span> <span class="n">EventArray</span><span class="p">()</span>
</span><span id="EventArray.from_events-580"><a href="#EventArray.from_events-580"><span class="linenos">580</span></a>        <span class="c1"># Otherwise, grab the info</span>
</span><span id="EventArray.from_events-581"><a href="#EventArray.from_events-581"><span class="linenos">581</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="EventArray.from_events-582"><a href="#EventArray.from_events-582"><span class="linenos">582</span></a>            <span class="p">{</span>
</span><span id="EventArray.from_events-583"><a href="#EventArray.from_events-583"><span class="linenos">583</span></a>                <span class="s2">&quot;slide_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray.from_events-584"><a href="#EventArray.from_events-584"><span class="linenos">584</span></a>                <span class="s2">&quot;tile&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray.from_events-585"><a href="#EventArray.from_events-585"><span class="linenos">585</span></a>                <span class="s2">&quot;roi&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n_roi</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray.from_events-586"><a href="#EventArray.from_events-586"><span class="linenos">586</span></a>                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray.from_events-587"><a href="#EventArray.from_events-587"><span class="linenos">587</span></a>                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray.from_events-588"><a href="#EventArray.from_events-588"><span class="linenos">588</span></a>                <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray.from_events-589"><a href="#EventArray.from_events-589"><span class="linenos">589</span></a>            <span class="p">}</span>
</span><span id="EventArray.from_events-590"><a href="#EventArray.from_events-590"><span class="linenos">590</span></a>        <span class="p">)</span>
</span><span id="EventArray.from_events-591"><a href="#EventArray.from_events-591"><span class="linenos">591</span></a>        <span class="n">metadata_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">metadata</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
</span><span id="EventArray.from_events-592"><a href="#EventArray.from_events-592"><span class="linenos">592</span></a>        <span class="c1"># Iterate through and ensure that all metadata is the same shape</span>
</span><span id="EventArray.from_events-593"><a href="#EventArray.from_events-593"><span class="linenos">593</span></a>        <span class="k">for</span> <span class="n">metadata</span> <span class="ow">in</span> <span class="n">metadata_list</span><span class="p">:</span>
</span><span id="EventArray.from_events-594"><a href="#EventArray.from_events-594"><span class="linenos">594</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">metadata_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="EventArray.from_events-595"><a href="#EventArray.from_events-595"><span class="linenos">595</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All metadata must be the same type.&quot;</span><span class="p">)</span>
</span><span id="EventArray.from_events-596"><a href="#EventArray.from_events-596"><span class="linenos">596</span></a>            <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">metadata</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">metadata_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="EventArray.from_events-597"><a href="#EventArray.from_events-597"><span class="linenos">597</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All metadata must be the same shape.&quot;</span><span class="p">)</span>
</span><span id="EventArray.from_events-598"><a href="#EventArray.from_events-598"><span class="linenos">598</span></a>        <span class="k">if</span> <span class="n">metadata_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.from_events-599"><a href="#EventArray.from_events-599"><span class="linenos">599</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.from_events-600"><a href="#EventArray.from_events-600"><span class="linenos">600</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.from_events-601"><a href="#EventArray.from_events-601"><span class="linenos">601</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metadata_list</span><span class="p">)</span>
</span><span id="EventArray.from_events-602"><a href="#EventArray.from_events-602"><span class="linenos">602</span></a>        <span class="n">features_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">features</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
</span><span id="EventArray.from_events-603"><a href="#EventArray.from_events-603"><span class="linenos">603</span></a>        <span class="c1"># Iterate through and ensure that all features are the same shape</span>
</span><span id="EventArray.from_events-604"><a href="#EventArray.from_events-604"><span class="linenos">604</span></a>        <span class="k">for</span> <span class="n">features</span> <span class="ow">in</span> <span class="n">features_list</span><span class="p">:</span>
</span><span id="EventArray.from_events-605"><a href="#EventArray.from_events-605"><span class="linenos">605</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">features_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="EventArray.from_events-606"><a href="#EventArray.from_events-606"><span class="linenos">606</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All features must be the same type.&quot;</span><span class="p">)</span>
</span><span id="EventArray.from_events-607"><a href="#EventArray.from_events-607"><span class="linenos">607</span></a>            <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">features</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">features_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="EventArray.from_events-608"><a href="#EventArray.from_events-608"><span class="linenos">608</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All features must be the same shape.&quot;</span><span class="p">)</span>
</span><span id="EventArray.from_events-609"><a href="#EventArray.from_events-609"><span class="linenos">609</span></a>        <span class="k">if</span> <span class="n">features_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.from_events-610"><a href="#EventArray.from_events-610"><span class="linenos">610</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.from_events-611"><a href="#EventArray.from_events-611"><span class="linenos">611</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.from_events-612"><a href="#EventArray.from_events-612"><span class="linenos">612</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">features_list</span><span class="p">)</span>
</span><span id="EventArray.from_events-613"><a href="#EventArray.from_events-613"><span class="linenos">613</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Set the events in the EventArray to a new list of events.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>events</strong>:  the new list of events.</li>
</ul>
</div>


                            </div>
                            <div id="EventArray.to_dataframe" class="classattr">
                                        <input id="EventArray.to_dataframe-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">to_dataframe</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>:</span></span>

                <label class="view-source-button" for="EventArray.to_dataframe-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.to_dataframe"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.to_dataframe-615"><a href="#EventArray.to_dataframe-615"><span class="linenos">615</span></a>    <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="EventArray.to_dataframe-616"><a href="#EventArray.to_dataframe-616"><span class="linenos">616</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.to_dataframe-617"><a href="#EventArray.to_dataframe-617"><span class="linenos">617</span></a><span class="sd">        Convert all the data in the EventArray to a single DataFrame.</span>
</span><span id="EventArray.to_dataframe-618"><a href="#EventArray.to_dataframe-618"><span class="linenos">618</span></a><span class="sd">        :return: a DataFrame with all the data in the EventArray.</span>
</span><span id="EventArray.to_dataframe-619"><a href="#EventArray.to_dataframe-619"><span class="linenos">619</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.to_dataframe-620"><a href="#EventArray.to_dataframe-620"><span class="linenos">620</span></a>        <span class="c1"># Make a copy of the info DataFrame and prepend &quot;info_&quot; to the column names</span>
</span><span id="EventArray.to_dataframe-621"><a href="#EventArray.to_dataframe-621"><span class="linenos">621</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray.to_dataframe-622"><a href="#EventArray.to_dataframe-622"><span class="linenos">622</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;info_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray.to_dataframe-623"><a href="#EventArray.to_dataframe-623"><span class="linenos">623</span></a>        <span class="c1"># Combine with the metadata and prepend &quot;metadata_&quot; to the column names</span>
</span><span id="EventArray.to_dataframe-624"><a href="#EventArray.to_dataframe-624"><span class="linenos">624</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.to_dataframe-625"><a href="#EventArray.to_dataframe-625"><span class="linenos">625</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray.to_dataframe-626"><a href="#EventArray.to_dataframe-626"><span class="linenos">626</span></a>            <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;metadata_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray.to_dataframe-627"><a href="#EventArray.to_dataframe-627"><span class="linenos">627</span></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">output</span><span class="p">,</span> <span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventArray.to_dataframe-628"><a href="#EventArray.to_dataframe-628"><span class="linenos">628</span></a>        <span class="c1"># Combine with the features and prepend &quot;features_&quot; to the column names</span>
</span><span id="EventArray.to_dataframe-629"><a href="#EventArray.to_dataframe-629"><span class="linenos">629</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.to_dataframe-630"><a href="#EventArray.to_dataframe-630"><span class="linenos">630</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray.to_dataframe-631"><a href="#EventArray.to_dataframe-631"><span class="linenos">631</span></a>            <span class="n">features</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;features_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray.to_dataframe-632"><a href="#EventArray.to_dataframe-632"><span class="linenos">632</span></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">output</span><span class="p">,</span> <span class="n">features</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventArray.to_dataframe-633"><a href="#EventArray.to_dataframe-633"><span class="linenos">633</span></a>        <span class="k">return</span> <span class="n">output</span>
</span></pre></div>


            <div class="docstring"><p>Convert all the data in the EventArray to a single DataFrame.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a DataFrame with all the data in the EventArray.</p>
</blockquote>
</div>


                            </div>
                            <div id="EventArray.from_dataframe" class="classattr">
                                        <input id="EventArray.from_dataframe-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">from_dataframe</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">df</span></span><span class="return-annotation">) -> <span class="n">Self</span>:</span></span>

                <label class="view-source-button" for="EventArray.from_dataframe-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.from_dataframe"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.from_dataframe-635"><a href="#EventArray.from_dataframe-635"><span class="linenos">635</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray.from_dataframe-636"><a href="#EventArray.from_dataframe-636"><span class="linenos">636</span></a>    <span class="k">def</span> <span class="nf">from_dataframe</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray.from_dataframe-637"><a href="#EventArray.from_dataframe-637"><span class="linenos">637</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.from_dataframe-638"><a href="#EventArray.from_dataframe-638"><span class="linenos">638</span></a><span class="sd">        From a single, special DataFrame, create an EventArray.</span>
</span><span id="EventArray.from_dataframe-639"><a href="#EventArray.from_dataframe-639"><span class="linenos">639</span></a><span class="sd">        :return: a DataFrame with all the data in the EventArray.</span>
</span><span id="EventArray.from_dataframe-640"><a href="#EventArray.from_dataframe-640"><span class="linenos">640</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.from_dataframe-641"><a href="#EventArray.from_dataframe-641"><span class="linenos">641</span></a>        <span class="c1"># Split the columns into info, metadata, and features and strip prefix</span>
</span><span id="EventArray.from_dataframe-642"><a href="#EventArray.from_dataframe-642"><span class="linenos">642</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;info_&quot;</span><span class="p">)]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray.from_dataframe-643"><a href="#EventArray.from_dataframe-643"><span class="linenos">643</span></a>        <span class="n">info</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;info_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray.from_dataframe-644"><a href="#EventArray.from_dataframe-644"><span class="linenos">644</span></a>        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray.from_dataframe-645"><a href="#EventArray.from_dataframe-645"><span class="linenos">645</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.from_dataframe-646"><a href="#EventArray.from_dataframe-646"><span class="linenos">646</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;metadata_&quot;</span><span class="p">)]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray.from_dataframe-647"><a href="#EventArray.from_dataframe-647"><span class="linenos">647</span></a>        <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;metadata_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray.from_dataframe-648"><a href="#EventArray.from_dataframe-648"><span class="linenos">648</span></a>        <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray.from_dataframe-649"><a href="#EventArray.from_dataframe-649"><span class="linenos">649</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.from_dataframe-650"><a href="#EventArray.from_dataframe-650"><span class="linenos">650</span></a>        <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;features_&quot;</span><span class="p">)]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray.from_dataframe-651"><a href="#EventArray.from_dataframe-651"><span class="linenos">651</span></a>        <span class="n">features</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;features_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray.from_dataframe-652"><a href="#EventArray.from_dataframe-652"><span class="linenos">652</span></a>        <span class="k">if</span> <span class="n">features</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray.from_dataframe-653"><a href="#EventArray.from_dataframe-653"><span class="linenos">653</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.from_dataframe-654"><a href="#EventArray.from_dataframe-654"><span class="linenos">654</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>From a single, special DataFrame, create an EventArray.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a DataFrame with all the data in the EventArray.</p>
</blockquote>
</div>


                            </div>
                            <div id="EventArray.from_mask" class="classattr">
                                        <input id="EventArray.from_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">from_mask</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">cls</span>,</span><span class="param">	<span class="n">mask</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">slide_id</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">tile_n</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">n_roi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">include_cell_id</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">images</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">image_labels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">properties</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Self</span>:</span></span>

                <label class="view-source-button" for="EventArray.from_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.from_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.from_mask-656"><a href="#EventArray.from_mask-656"><span class="linenos">656</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray.from_mask-657"><a href="#EventArray.from_mask-657"><span class="linenos">657</span></a>    <span class="k">def</span> <span class="nf">from_mask</span><span class="p">(</span>
</span><span id="EventArray.from_mask-658"><a href="#EventArray.from_mask-658"><span class="linenos">658</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="EventArray.from_mask-659"><a href="#EventArray.from_mask-659"><span class="linenos">659</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="EventArray.from_mask-660"><a href="#EventArray.from_mask-660"><span class="linenos">660</span></a>        <span class="n">slide_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="EventArray.from_mask-661"><a href="#EventArray.from_mask-661"><span class="linenos">661</span></a>        <span class="n">tile_n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="EventArray.from_mask-662"><a href="#EventArray.from_mask-662"><span class="linenos">662</span></a>        <span class="n">n_roi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="EventArray.from_mask-663"><a href="#EventArray.from_mask-663"><span class="linenos">663</span></a>        <span class="n">include_cell_id</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="EventArray.from_mask-664"><a href="#EventArray.from_mask-664"><span class="linenos">664</span></a>        <span class="n">images</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EventArray.from_mask-665"><a href="#EventArray.from_mask-665"><span class="linenos">665</span></a>        <span class="n">image_labels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EventArray.from_mask-666"><a href="#EventArray.from_mask-666"><span class="linenos">666</span></a>        <span class="n">properties</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EventArray.from_mask-667"><a href="#EventArray.from_mask-667"><span class="linenos">667</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray.from_mask-668"><a href="#EventArray.from_mask-668"><span class="linenos">668</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.from_mask-669"><a href="#EventArray.from_mask-669"><span class="linenos">669</span></a><span class="sd">        Extract events from a mask DataFrame, including metadata and features.</span>
</span><span id="EventArray.from_mask-670"><a href="#EventArray.from_mask-670"><span class="linenos">670</span></a><span class="sd">        :param mask: the mask to extract events from.</span>
</span><span id="EventArray.from_mask-671"><a href="#EventArray.from_mask-671"><span class="linenos">671</span></a><span class="sd">        :param slide_id: the slide ID the mask is from.</span>
</span><span id="EventArray.from_mask-672"><a href="#EventArray.from_mask-672"><span class="linenos">672</span></a><span class="sd">        :param tile_n: the tile number the mask is from.</span>
</span><span id="EventArray.from_mask-673"><a href="#EventArray.from_mask-673"><span class="linenos">673</span></a><span class="sd">        :param n_roi: the ROI number the mask is from.</span>
</span><span id="EventArray.from_mask-674"><a href="#EventArray.from_mask-674"><span class="linenos">674</span></a><span class="sd">        :param include_cell_id: whether to include the cell_id, or numerical</span>
</span><span id="EventArray.from_mask-675"><a href="#EventArray.from_mask-675"><span class="linenos">675</span></a><span class="sd">        mask label, as metadata in the EventArray.</span>
</span><span id="EventArray.from_mask-676"><a href="#EventArray.from_mask-676"><span class="linenos">676</span></a><span class="sd">        :param images: the intensity images to extract features from.</span>
</span><span id="EventArray.from_mask-677"><a href="#EventArray.from_mask-677"><span class="linenos">677</span></a><span class="sd">        :param image_labels: the labels for the intensity images.</span>
</span><span id="EventArray.from_mask-678"><a href="#EventArray.from_mask-678"><span class="linenos">678</span></a><span class="sd">        :param properties: list of properties to extract in addition to the defaults:</span>
</span><span id="EventArray.from_mask-679"><a href="#EventArray.from_mask-679"><span class="linenos">679</span></a><span class="sd">        :return: EventArray corresponding to the mask labels.</span>
</span><span id="EventArray.from_mask-680"><a href="#EventArray.from_mask-680"><span class="linenos">680</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.from_mask-681"><a href="#EventArray.from_mask-681"><span class="linenos">681</span></a>        <span class="k">if</span> <span class="n">extract_mask_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.from_mask-682"><a href="#EventArray.from_mask-682"><span class="linenos">682</span></a>            <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span>
</span><span id="EventArray.from_mask-683"><a href="#EventArray.from_mask-683"><span class="linenos">683</span></a>                <span class="s2">&quot;csi_images.csi_images dependencies not installed. Install csi-images &quot;</span>
</span><span id="EventArray.from_mask-684"><a href="#EventArray.from_mask-684"><span class="linenos">684</span></a>                <span class="s2">&quot;with [imageio] option to resolve.&quot;</span>
</span><span id="EventArray.from_mask-685"><a href="#EventArray.from_mask-685"><span class="linenos">685</span></a>            <span class="p">)</span>
</span><span id="EventArray.from_mask-686"><a href="#EventArray.from_mask-686"><span class="linenos">686</span></a>        <span class="c1"># Gather mask_info</span>
</span><span id="EventArray.from_mask-687"><a href="#EventArray.from_mask-687"><span class="linenos">687</span></a>        <span class="k">if</span> <span class="n">images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">image_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.from_mask-688"><a href="#EventArray.from_mask-688"><span class="linenos">688</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_labels</span><span class="p">):</span>
</span><span id="EventArray.from_mask-689"><a href="#EventArray.from_mask-689"><span class="linenos">689</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Intensity images and labels must match lengths.&quot;</span><span class="p">)</span>
</span><span id="EventArray.from_mask-690"><a href="#EventArray.from_mask-690"><span class="linenos">690</span></a>
</span><span id="EventArray.from_mask-691"><a href="#EventArray.from_mask-691"><span class="linenos">691</span></a>        <span class="n">mask_info</span> <span class="o">=</span> <span class="n">extract_mask_info</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">image_labels</span><span class="p">,</span> <span class="n">properties</span><span class="p">)</span>
</span><span id="EventArray.from_mask-692"><a href="#EventArray.from_mask-692"><span class="linenos">692</span></a>
</span><span id="EventArray.from_mask-693"><a href="#EventArray.from_mask-693"><span class="linenos">693</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray.from_mask-694"><a href="#EventArray.from_mask-694"><span class="linenos">694</span></a>            <span class="k">return</span> <span class="n">EventArray</span><span class="p">()</span>
</span><span id="EventArray.from_mask-695"><a href="#EventArray.from_mask-695"><span class="linenos">695</span></a>
</span><span id="EventArray.from_mask-696"><a href="#EventArray.from_mask-696"><span class="linenos">696</span></a>        <span class="c1"># Combine provided info and mask info</span>
</span><span id="EventArray.from_mask-697"><a href="#EventArray.from_mask-697"><span class="linenos">697</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="EventArray.from_mask-698"><a href="#EventArray.from_mask-698"><span class="linenos">698</span></a>            <span class="p">{</span>
</span><span id="EventArray.from_mask-699"><a href="#EventArray.from_mask-699"><span class="linenos">699</span></a>                <span class="s2">&quot;slide_id&quot;</span><span class="p">:</span> <span class="n">slide_id</span><span class="p">,</span>
</span><span id="EventArray.from_mask-700"><a href="#EventArray.from_mask-700"><span class="linenos">700</span></a>                <span class="s2">&quot;tile&quot;</span><span class="p">:</span> <span class="n">tile_n</span><span class="p">,</span>
</span><span id="EventArray.from_mask-701"><a href="#EventArray.from_mask-701"><span class="linenos">701</span></a>                <span class="s2">&quot;roi&quot;</span><span class="p">:</span> <span class="n">n_roi</span><span class="p">,</span>
</span><span id="EventArray.from_mask-702"><a href="#EventArray.from_mask-702"><span class="linenos">702</span></a>                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">mask_info</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span>
</span><span id="EventArray.from_mask-703"><a href="#EventArray.from_mask-703"><span class="linenos">703</span></a>                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">mask_info</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span>
</span><span id="EventArray.from_mask-704"><a href="#EventArray.from_mask-704"><span class="linenos">704</span></a>                <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">mask_info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">],</span>
</span><span id="EventArray.from_mask-705"><a href="#EventArray.from_mask-705"><span class="linenos">705</span></a>            <span class="p">},</span>
</span><span id="EventArray.from_mask-706"><a href="#EventArray.from_mask-706"><span class="linenos">706</span></a>        <span class="p">)</span>
</span><span id="EventArray.from_mask-707"><a href="#EventArray.from_mask-707"><span class="linenos">707</span></a>        <span class="c1"># Extract a metadata column if desired</span>
</span><span id="EventArray.from_mask-708"><a href="#EventArray.from_mask-708"><span class="linenos">708</span></a>        <span class="k">if</span> <span class="n">include_cell_id</span><span class="p">:</span>
</span><span id="EventArray.from_mask-709"><a href="#EventArray.from_mask-709"><span class="linenos">709</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;cell_id&quot;</span><span class="p">:</span> <span class="n">mask_info</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]})</span>
</span><span id="EventArray.from_mask-710"><a href="#EventArray.from_mask-710"><span class="linenos">710</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.from_mask-711"><a href="#EventArray.from_mask-711"><span class="linenos">711</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.from_mask-712"><a href="#EventArray.from_mask-712"><span class="linenos">712</span></a>        <span class="c1"># If any additional properties were extracted, add them as features</span>
</span><span id="EventArray.from_mask-713"><a href="#EventArray.from_mask-713"><span class="linenos">713</span></a>        <span class="n">mask_info</span> <span class="o">=</span> <span class="n">mask_info</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</span><span id="EventArray.from_mask-714"><a href="#EventArray.from_mask-714"><span class="linenos">714</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_info</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray.from_mask-715"><a href="#EventArray.from_mask-715"><span class="linenos">715</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="n">mask_info</span>
</span><span id="EventArray.from_mask-716"><a href="#EventArray.from_mask-716"><span class="linenos">716</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.from_mask-717"><a href="#EventArray.from_mask-717"><span class="linenos">717</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.from_mask-718"><a href="#EventArray.from_mask-718"><span class="linenos">718</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Extract events from a mask DataFrame, including metadata and features.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>mask</strong>:  the mask to extract events from.</li>
<li><strong>slide_id</strong>:  the slide ID the mask is from.</li>
<li><strong>tile_n</strong>:  the tile number the mask is from.</li>
<li><strong>n_roi</strong>:  the ROI number the mask is from.</li>
<li><strong>include_cell_id</strong>:  whether to include the cell_id, or numerical
mask label, as metadata in the EventArray.</li>
<li><strong>images</strong>:  the intensity images to extract features from.</li>
<li><strong>image_labels</strong>:  the labels for the intensity images.</li>
<li><strong>properties: list of properties to extract in addition to the defaults</strong>: </li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>EventArray corresponding to the mask labels.</p>
</blockquote>
</div>


                            </div>
                            <div id="EventArray.save_csv" class="classattr">
                                        <input id="EventArray.save_csv-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_csv</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="EventArray.save_csv-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.save_csv"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.save_csv-720"><a href="#EventArray.save_csv-720"><span class="linenos">720</span></a>    <span class="k">def</span> <span class="nf">save_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="EventArray.save_csv-721"><a href="#EventArray.save_csv-721"><span class="linenos">721</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.save_csv-722"><a href="#EventArray.save_csv-722"><span class="linenos">722</span></a><span class="sd">        Save the events to an CSV file, including metadata and features.</span>
</span><span id="EventArray.save_csv-723"><a href="#EventArray.save_csv-723"><span class="linenos">723</span></a><span class="sd">        :param output_path:</span>
</span><span id="EventArray.save_csv-724"><a href="#EventArray.save_csv-724"><span class="linenos">724</span></a><span class="sd">        :return:</span>
</span><span id="EventArray.save_csv-725"><a href="#EventArray.save_csv-725"><span class="linenos">725</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.save_csv-726"><a href="#EventArray.save_csv-726"><span class="linenos">726</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="EventArray.save_csv-727"><a href="#EventArray.save_csv-727"><span class="linenos">727</span></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save the events to an CSV file, including metadata and features.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>output_path</strong>: </li>
</ul>

<h6 id="returns">Returns</h6>
</div>


                            </div>
                            <div id="EventArray.load_csv" class="classattr">
                                        <input id="EventArray.load_csv-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">load_csv</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Self</span>:</span></span>

                <label class="view-source-button" for="EventArray.load_csv-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.load_csv"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.load_csv-729"><a href="#EventArray.load_csv-729"><span class="linenos">729</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray.load_csv-730"><a href="#EventArray.load_csv-730"><span class="linenos">730</span></a>    <span class="k">def</span> <span class="nf">load_csv</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray.load_csv-731"><a href="#EventArray.load_csv-731"><span class="linenos">731</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.load_csv-732"><a href="#EventArray.load_csv-732"><span class="linenos">732</span></a><span class="sd">        Load the events from an CSV file, including metadata and features.</span>
</span><span id="EventArray.load_csv-733"><a href="#EventArray.load_csv-733"><span class="linenos">733</span></a><span class="sd">        :param input_path:</span>
</span><span id="EventArray.load_csv-734"><a href="#EventArray.load_csv-734"><span class="linenos">734</span></a><span class="sd">        :return:</span>
</span><span id="EventArray.load_csv-735"><a href="#EventArray.load_csv-735"><span class="linenos">735</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.load_csv-736"><a href="#EventArray.load_csv-736"><span class="linenos">736</span></a>        <span class="c1"># Load the CSV file</span>
</span><span id="EventArray.load_csv-737"><a href="#EventArray.load_csv-737"><span class="linenos">737</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="EventArray.load_csv-738"><a href="#EventArray.load_csv-738"><span class="linenos">738</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Load the events from an CSV file, including metadata and features.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>input_path</strong>: </li>
</ul>

<h6 id="returns">Returns</h6>
</div>


                            </div>
                            <div id="EventArray.save_hdf5" class="classattr">
                                        <input id="EventArray.save_hdf5-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_hdf5</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="EventArray.save_hdf5-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.save_hdf5"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.save_hdf5-740"><a href="#EventArray.save_hdf5-740"><span class="linenos">740</span></a>    <span class="k">def</span> <span class="nf">save_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="EventArray.save_hdf5-741"><a href="#EventArray.save_hdf5-741"><span class="linenos">741</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.save_hdf5-742"><a href="#EventArray.save_hdf5-742"><span class="linenos">742</span></a><span class="sd">        Save the events to an HDF5 file, including metadata and features.</span>
</span><span id="EventArray.save_hdf5-743"><a href="#EventArray.save_hdf5-743"><span class="linenos">743</span></a><span class="sd">        Uses the pandas-provided HDF5 functions for ease, and external compatibility,</span>
</span><span id="EventArray.save_hdf5-744"><a href="#EventArray.save_hdf5-744"><span class="linenos">744</span></a><span class="sd">        though these files are slightly harder to view in HDFView or similar.</span>
</span><span id="EventArray.save_hdf5-745"><a href="#EventArray.save_hdf5-745"><span class="linenos">745</span></a><span class="sd">        :param output_path:</span>
</span><span id="EventArray.save_hdf5-746"><a href="#EventArray.save_hdf5-746"><span class="linenos">746</span></a><span class="sd">        :return:</span>
</span><span id="EventArray.save_hdf5-747"><a href="#EventArray.save_hdf5-747"><span class="linenos">747</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.save_hdf5-748"><a href="#EventArray.save_hdf5-748"><span class="linenos">748</span></a>        <span class="c1"># Open the output_path as an HDF5 file</span>
</span><span id="EventArray.save_hdf5-749"><a href="#EventArray.save_hdf5-749"><span class="linenos">749</span></a>        <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">store</span><span class="p">:</span>
</span><span id="EventArray.save_hdf5-750"><a href="#EventArray.save_hdf5-750"><span class="linenos">750</span></a>            <span class="c1"># Store the dataframes in the HDF5 file</span>
</span><span id="EventArray.save_hdf5-751"><a href="#EventArray.save_hdf5-751"><span class="linenos">751</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.save_hdf5-752"><a href="#EventArray.save_hdf5-752"><span class="linenos">752</span></a>                <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="EventArray.save_hdf5-753"><a href="#EventArray.save_hdf5-753"><span class="linenos">753</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.save_hdf5-754"><a href="#EventArray.save_hdf5-754"><span class="linenos">754</span></a>                <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="EventArray.save_hdf5-755"><a href="#EventArray.save_hdf5-755"><span class="linenos">755</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.save_hdf5-756"><a href="#EventArray.save_hdf5-756"><span class="linenos">756</span></a>                <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="EventArray.save_hdf5-757"><a href="#EventArray.save_hdf5-757"><span class="linenos">757</span></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save the events to an HDF5 file, including metadata and features.
Uses the pandas-provided HDF5 functions for ease, and external compatibility,
though these files are slightly harder to view in HDFView or similar.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>output_path</strong>: </li>
</ul>

<h6 id="returns">Returns</h6>
</div>


                            </div>
                            <div id="EventArray.load_hdf5" class="classattr">
                                        <input id="EventArray.load_hdf5-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">load_hdf5</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Self</span>:</span></span>

                <label class="view-source-button" for="EventArray.load_hdf5-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.load_hdf5"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.load_hdf5-759"><a href="#EventArray.load_hdf5-759"><span class="linenos">759</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray.load_hdf5-760"><a href="#EventArray.load_hdf5-760"><span class="linenos">760</span></a>    <span class="k">def</span> <span class="nf">load_hdf5</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray.load_hdf5-761"><a href="#EventArray.load_hdf5-761"><span class="linenos">761</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.load_hdf5-762"><a href="#EventArray.load_hdf5-762"><span class="linenos">762</span></a><span class="sd">        Load the events from an HDF5 file, including metadata and features.</span>
</span><span id="EventArray.load_hdf5-763"><a href="#EventArray.load_hdf5-763"><span class="linenos">763</span></a><span class="sd">        :param input_path:</span>
</span><span id="EventArray.load_hdf5-764"><a href="#EventArray.load_hdf5-764"><span class="linenos">764</span></a><span class="sd">        :return:</span>
</span><span id="EventArray.load_hdf5-765"><a href="#EventArray.load_hdf5-765"><span class="linenos">765</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.load_hdf5-766"><a href="#EventArray.load_hdf5-766"><span class="linenos">766</span></a>        <span class="c1"># Open the input_path as an HDF5 file</span>
</span><span id="EventArray.load_hdf5-767"><a href="#EventArray.load_hdf5-767"><span class="linenos">767</span></a>        <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">store</span><span class="p">:</span>
</span><span id="EventArray.load_hdf5-768"><a href="#EventArray.load_hdf5-768"><span class="linenos">768</span></a>            <span class="c1"># Load the dataframes from the HDF5 file</span>
</span><span id="EventArray.load_hdf5-769"><a href="#EventArray.load_hdf5-769"><span class="linenos">769</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;info&quot;</span> <span class="ow">in</span> <span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="EventArray.load_hdf5-770"><a href="#EventArray.load_hdf5-770"><span class="linenos">770</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="EventArray.load_hdf5-771"><a href="#EventArray.load_hdf5-771"><span class="linenos">771</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;features&quot;</span> <span class="ow">in</span> <span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="EventArray.load_hdf5-772"><a href="#EventArray.load_hdf5-772"><span class="linenos">772</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Load the events from an HDF5 file, including metadata and features.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>input_path</strong>: </li>
</ul>

<h6 id="returns">Returns</h6>
</div>


                            </div>
                            <div id="EventArray.save_ocular" class="classattr">
                                        <input id="EventArray.save_ocular-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_ocular</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cells&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="EventArray.save_ocular-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.save_ocular"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.save_ocular-774"><a href="#EventArray.save_ocular-774"><span class="linenos">774</span></a>    <span class="k">def</span> <span class="nf">save_ocular</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cells&quot;</span><span class="p">):</span>
</span><span id="EventArray.save_ocular-775"><a href="#EventArray.save_ocular-775"><span class="linenos">775</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.save_ocular-776"><a href="#EventArray.save_ocular-776"><span class="linenos">776</span></a><span class="sd">        Save the events to an OCULAR file. Relies on the dataframe originating</span>
</span><span id="EventArray.save_ocular-777"><a href="#EventArray.save_ocular-777"><span class="linenos">777</span></a><span class="sd">        from an OCULAR file (same columns; duplicate metadata/info).</span>
</span><span id="EventArray.save_ocular-778"><a href="#EventArray.save_ocular-778"><span class="linenos">778</span></a><span class="sd">        :param output_path:</span>
</span><span id="EventArray.save_ocular-779"><a href="#EventArray.save_ocular-779"><span class="linenos">779</span></a><span class="sd">        :param event_type:</span>
</span><span id="EventArray.save_ocular-780"><a href="#EventArray.save_ocular-780"><span class="linenos">780</span></a><span class="sd">        :return:</span>
</span><span id="EventArray.save_ocular-781"><a href="#EventArray.save_ocular-781"><span class="linenos">781</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.save_ocular-782"><a href="#EventArray.save_ocular-782"><span class="linenos">782</span></a>        <span class="k">if</span> <span class="n">pyreadr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.save_ocular-783"><a href="#EventArray.save_ocular-783"><span class="linenos">783</span></a>            <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span>
</span><span id="EventArray.save_ocular-784"><a href="#EventArray.save_ocular-784"><span class="linenos">784</span></a>                <span class="s2">&quot;pyreadr not installed. Install pyreadr directly &quot;</span>
</span><span id="EventArray.save_ocular-785"><a href="#EventArray.save_ocular-785"><span class="linenos">785</span></a>                <span class="s2">&quot;or install csi-images with [rds] option to resolve.&quot;</span>
</span><span id="EventArray.save_ocular-786"><a href="#EventArray.save_ocular-786"><span class="linenos">786</span></a>            <span class="p">)</span>
</span><span id="EventArray.save_ocular-787"><a href="#EventArray.save_ocular-787"><span class="linenos">787</span></a>        <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;cells&quot;</span><span class="p">:</span>
</span><span id="EventArray.save_ocular-788"><a href="#EventArray.save_ocular-788"><span class="linenos">788</span></a>            <span class="n">file_stub</span> <span class="o">=</span> <span class="s2">&quot;rc-final&quot;</span>
</span><span id="EventArray.save_ocular-789"><a href="#EventArray.save_ocular-789"><span class="linenos">789</span></a>        <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;others&quot;</span><span class="p">:</span>
</span><span id="EventArray.save_ocular-790"><a href="#EventArray.save_ocular-790"><span class="linenos">790</span></a>            <span class="n">file_stub</span> <span class="o">=</span> <span class="s2">&quot;others-final&quot;</span>
</span><span id="EventArray.save_ocular-791"><a href="#EventArray.save_ocular-791"><span class="linenos">791</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.save_ocular-792"><a href="#EventArray.save_ocular-792"><span class="linenos">792</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid event type. Must be cells or others.&quot;</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-793"><a href="#EventArray.save_ocular-793"><span class="linenos">793</span></a>
</span><span id="EventArray.save_ocular-794"><a href="#EventArray.save_ocular-794"><span class="linenos">794</span></a>        <span class="c1"># Ensure good metadata</span>
</span><span id="EventArray.save_ocular-795"><a href="#EventArray.save_ocular-795"><span class="linenos">795</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="EventArray.save_ocular-796"><a href="#EventArray.save_ocular-796"><span class="linenos">796</span></a>            <span class="p">{</span>
</span><span id="EventArray.save_ocular-797"><a href="#EventArray.save_ocular-797"><span class="linenos">797</span></a>                <span class="s2">&quot;slide_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">],</span>
</span><span id="EventArray.save_ocular-798"><a href="#EventArray.save_ocular-798"><span class="linenos">798</span></a>                <span class="s2">&quot;frame_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">],</span>
</span><span id="EventArray.save_ocular-799"><a href="#EventArray.save_ocular-799"><span class="linenos">799</span></a>                <span class="s2">&quot;cell_id&quot;</span><span class="p">:</span> <span class="p">(</span>
</span><span id="EventArray.save_ocular-800"><a href="#EventArray.save_ocular-800"><span class="linenos">800</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span>
</span><span id="EventArray.save_ocular-801"><a href="#EventArray.save_ocular-801"><span class="linenos">801</span></a>                    <span class="k">if</span> <span class="s2">&quot;cell_id&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">columns</span>
</span><span id="EventArray.save_ocular-802"><a href="#EventArray.save_ocular-802"><span class="linenos">802</span></a>                    <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">))</span>
</span><span id="EventArray.save_ocular-803"><a href="#EventArray.save_ocular-803"><span class="linenos">803</span></a>                <span class="p">),</span>
</span><span id="EventArray.save_ocular-804"><a href="#EventArray.save_ocular-804"><span class="linenos">804</span></a>                <span class="s2">&quot;cellx&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span>
</span><span id="EventArray.save_ocular-805"><a href="#EventArray.save_ocular-805"><span class="linenos">805</span></a>                <span class="s2">&quot;celly&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span>
</span><span id="EventArray.save_ocular-806"><a href="#EventArray.save_ocular-806"><span class="linenos">806</span></a>            <span class="p">}</span>
</span><span id="EventArray.save_ocular-807"><a href="#EventArray.save_ocular-807"><span class="linenos">807</span></a>        <span class="p">)</span>
</span><span id="EventArray.save_ocular-808"><a href="#EventArray.save_ocular-808"><span class="linenos">808</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.save_ocular-809"><a href="#EventArray.save_ocular-809"><span class="linenos">809</span></a>            <span class="n">metadata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray.save_ocular-810"><a href="#EventArray.save_ocular-810"><span class="linenos">810</span></a>
</span><span id="EventArray.save_ocular-811"><a href="#EventArray.save_ocular-811"><span class="linenos">811</span></a>        <span class="c1"># Check for the &quot;ocular_interesting&quot; column</span>
</span><span id="EventArray.save_ocular-812"><a href="#EventArray.save_ocular-812"><span class="linenos">812</span></a>        <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;cells&quot;</span><span class="p">:</span>
</span><span id="EventArray.save_ocular-813"><a href="#EventArray.save_ocular-813"><span class="linenos">813</span></a>            <span class="k">if</span> <span class="s2">&quot;ocular_interesting&quot;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="EventArray.save_ocular-814"><a href="#EventArray.save_ocular-814"><span class="linenos">814</span></a>                <span class="n">interesting_rows</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ocular_interesting&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-815"><a href="#EventArray.save_ocular-815"><span class="linenos">815</span></a>            <span class="k">elif</span> <span class="s2">&quot;hcpc&quot;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="EventArray.save_ocular-816"><a href="#EventArray.save_ocular-816"><span class="linenos">816</span></a>                <span class="c1"># Interesting cells don&#39;t get an hcpc designation, leaving them as -1</span>
</span><span id="EventArray.save_ocular-817"><a href="#EventArray.save_ocular-817"><span class="linenos">817</span></a>                <span class="n">interesting_rows</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="EventArray.save_ocular-818"><a href="#EventArray.save_ocular-818"><span class="linenos">818</span></a>                    <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;hcpc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="EventArray.save_ocular-819"><a href="#EventArray.save_ocular-819"><span class="linenos">819</span></a>                <span class="p">)</span>  <span class="c1"># interesting cells</span>
</span><span id="EventArray.save_ocular-820"><a href="#EventArray.save_ocular-820"><span class="linenos">820</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.save_ocular-821"><a href="#EventArray.save_ocular-821"><span class="linenos">821</span></a>                <span class="n">interesting_rows</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray.save_ocular-822"><a href="#EventArray.save_ocular-822"><span class="linenos">822</span></a>            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">interesting_rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray.save_ocular-823"><a href="#EventArray.save_ocular-823"><span class="linenos">823</span></a>                <span class="c1"># Split the metadata into interesting and regular</span>
</span><span id="EventArray.save_ocular-824"><a href="#EventArray.save_ocular-824"><span class="linenos">824</span></a>                <span class="n">interesting_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">(</span><span class="n">interesting_rows</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-825"><a href="#EventArray.save_ocular-825"><span class="linenos">825</span></a>                <span class="n">interesting_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
</span><span id="EventArray.save_ocular-826"><a href="#EventArray.save_ocular-826"><span class="linenos">826</span></a>                    <span class="p">[</span><span class="n">interesting_events</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">interesting_events</span><span class="o">.</span><span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
</span><span id="EventArray.save_ocular-827"><a href="#EventArray.save_ocular-827"><span class="linenos">827</span></a>                <span class="p">)</span>
</span><span id="EventArray.save_ocular-828"><a href="#EventArray.save_ocular-828"><span class="linenos">828</span></a>                <span class="n">data_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">(</span><span class="o">~</span><span class="n">interesting_rows</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-829"><a href="#EventArray.save_ocular-829"><span class="linenos">829</span></a>                <span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
</span><span id="EventArray.save_ocular-830"><a href="#EventArray.save_ocular-830"><span class="linenos">830</span></a>                    <span class="p">[</span><span class="n">data_events</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">data_events</span><span class="o">.</span><span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
</span><span id="EventArray.save_ocular-831"><a href="#EventArray.save_ocular-831"><span class="linenos">831</span></a>                <span class="p">)</span>
</span><span id="EventArray.save_ocular-832"><a href="#EventArray.save_ocular-832"><span class="linenos">832</span></a>                <span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ocular_interesting&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-833"><a href="#EventArray.save_ocular-833"><span class="linenos">833</span></a>
</span><span id="EventArray.save_ocular-834"><a href="#EventArray.save_ocular-834"><span class="linenos">834</span></a>                <span class="c1"># Drop particular columns for &quot;interesting&quot;</span>
</span><span id="EventArray.save_ocular-835"><a href="#EventArray.save_ocular-835"><span class="linenos">835</span></a>                <span class="n">interesting_df</span> <span class="o">=</span> <span class="n">interesting_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="EventArray.save_ocular-836"><a href="#EventArray.save_ocular-836"><span class="linenos">836</span></a>                    <span class="p">[</span>
</span><span id="EventArray.save_ocular-837"><a href="#EventArray.save_ocular-837"><span class="linenos">837</span></a>                        <span class="s2">&quot;clust&quot;</span><span class="p">,</span>
</span><span id="EventArray.save_ocular-838"><a href="#EventArray.save_ocular-838"><span class="linenos">838</span></a>                        <span class="s2">&quot;hcpc&quot;</span><span class="p">,</span>
</span><span id="EventArray.save_ocular-839"><a href="#EventArray.save_ocular-839"><span class="linenos">839</span></a>                        <span class="s2">&quot;frame_id&quot;</span><span class="p">,</span>
</span><span id="EventArray.save_ocular-840"><a href="#EventArray.save_ocular-840"><span class="linenos">840</span></a>                        <span class="s2">&quot;cell_id&quot;</span><span class="p">,</span>
</span><span id="EventArray.save_ocular-841"><a href="#EventArray.save_ocular-841"><span class="linenos">841</span></a>                        <span class="s2">&quot;unique_id&quot;</span><span class="p">,</span>
</span><span id="EventArray.save_ocular-842"><a href="#EventArray.save_ocular-842"><span class="linenos">842</span></a>                        <span class="s2">&quot;ocular_interesting&quot;</span><span class="p">,</span>
</span><span id="EventArray.save_ocular-843"><a href="#EventArray.save_ocular-843"><span class="linenos">843</span></a>                    <span class="p">],</span>
</span><span id="EventArray.save_ocular-844"><a href="#EventArray.save_ocular-844"><span class="linenos">844</span></a>                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="EventArray.save_ocular-845"><a href="#EventArray.save_ocular-845"><span class="linenos">845</span></a>                    <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
</span><span id="EventArray.save_ocular-846"><a href="#EventArray.save_ocular-846"><span class="linenos">846</span></a>                <span class="p">)</span>
</span><span id="EventArray.save_ocular-847"><a href="#EventArray.save_ocular-847"><span class="linenos">847</span></a>                <span class="c1"># Save both .csv and .rds</span>
</span><span id="EventArray.save_ocular-848"><a href="#EventArray.save_ocular-848"><span class="linenos">848</span></a>                <span class="n">interesting_stub</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;ocular_interesting&quot;</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-849"><a href="#EventArray.save_ocular-849"><span class="linenos">849</span></a>                <span class="n">interesting_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">interesting_stub</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-850"><a href="#EventArray.save_ocular-850"><span class="linenos">850</span></a>                <span class="c1"># Suppress pandas FutureWarning</span>
</span><span id="EventArray.save_ocular-851"><a href="#EventArray.save_ocular-851"><span class="linenos">851</span></a>                <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
</span><span id="EventArray.save_ocular-852"><a href="#EventArray.save_ocular-852"><span class="linenos">852</span></a>                    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-853"><a href="#EventArray.save_ocular-853"><span class="linenos">853</span></a>                    <span class="n">pyreadr</span><span class="o">.</span><span class="n">write_rds</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">interesting_stub</span><span class="si">}</span><span class="s2">.rds&quot;</span><span class="p">,</span> <span class="n">interesting_df</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-854"><a href="#EventArray.save_ocular-854"><span class="linenos">854</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.save_ocular-855"><a href="#EventArray.save_ocular-855"><span class="linenos">855</span></a>                <span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-856"><a href="#EventArray.save_ocular-856"><span class="linenos">856</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.save_ocular-857"><a href="#EventArray.save_ocular-857"><span class="linenos">857</span></a>            <span class="c1"># Get all data and reset_index (will copy it)</span>
</span><span id="EventArray.save_ocular-858"><a href="#EventArray.save_ocular-858"><span class="linenos">858</span></a>            <span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-859"><a href="#EventArray.save_ocular-859"><span class="linenos">859</span></a>
</span><span id="EventArray.save_ocular-860"><a href="#EventArray.save_ocular-860"><span class="linenos">860</span></a>        <span class="c1"># Split based on cluster number to conform to *-final[1-4].rds</span>
</span><span id="EventArray.save_ocular-861"><a href="#EventArray.save_ocular-861"><span class="linenos">861</span></a>        <span class="n">n_clusters</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;clust&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="EventArray.save_ocular-862"><a href="#EventArray.save_ocular-862"><span class="linenos">862</span></a>        <span class="n">split_idx</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">n_clusters</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
</span><span id="EventArray.save_ocular-863"><a href="#EventArray.save_ocular-863"><span class="linenos">863</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span><span id="EventArray.save_ocular-864"><a href="#EventArray.save_ocular-864"><span class="linenos">864</span></a>            <span class="n">subset</span> <span class="o">=</span> <span class="p">(</span><span class="n">split_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;clust&quot;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span>
</span><span id="EventArray.save_ocular-865"><a href="#EventArray.save_ocular-865"><span class="linenos">865</span></a>                <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;clust&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">split_idx</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="EventArray.save_ocular-866"><a href="#EventArray.save_ocular-866"><span class="linenos">866</span></a>            <span class="p">)</span>
</span><span id="EventArray.save_ocular-867"><a href="#EventArray.save_ocular-867"><span class="linenos">867</span></a>            <span class="n">data_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">subset</span><span class="p">,</span> <span class="s2">&quot;hcpc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="EventArray.save_ocular-868"><a href="#EventArray.save_ocular-868"><span class="linenos">868</span></a>            <span class="n">subset</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-869"><a href="#EventArray.save_ocular-869"><span class="linenos">869</span></a>            <span class="c1"># Suppress pandas FutureWarning</span>
</span><span id="EventArray.save_ocular-870"><a href="#EventArray.save_ocular-870"><span class="linenos">870</span></a>            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
</span><span id="EventArray.save_ocular-871"><a href="#EventArray.save_ocular-871"><span class="linenos">871</span></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-872"><a href="#EventArray.save_ocular-872"><span class="linenos">872</span></a>                <span class="n">pyreadr</span><span class="o">.</span><span class="n">write_rds</span><span class="p">(</span>
</span><span id="EventArray.save_ocular-873"><a href="#EventArray.save_ocular-873"><span class="linenos">873</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_stub</span><span class="si">}{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.rds&quot;</span><span class="p">),</span> <span class="n">subset</span>
</span><span id="EventArray.save_ocular-874"><a href="#EventArray.save_ocular-874"><span class="linenos">874</span></a>                <span class="p">)</span>
</span><span id="EventArray.save_ocular-875"><a href="#EventArray.save_ocular-875"><span class="linenos">875</span></a>
</span><span id="EventArray.save_ocular-876"><a href="#EventArray.save_ocular-876"><span class="linenos">876</span></a>        <span class="c1"># Create new example cell strings</span>
</span><span id="EventArray.save_ocular-877"><a href="#EventArray.save_ocular-877"><span class="linenos">877</span></a>        <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;example_cell_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="EventArray.save_ocular-878"><a href="#EventArray.save_ocular-878"><span class="linenos">878</span></a>            <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">]</span>
</span><span id="EventArray.save_ocular-879"><a href="#EventArray.save_ocular-879"><span class="linenos">879</span></a>            <span class="o">+</span> <span class="s2">&quot; &quot;</span>
</span><span id="EventArray.save_ocular-880"><a href="#EventArray.save_ocular-880"><span class="linenos">880</span></a>            <span class="o">+</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;frame_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-881"><a href="#EventArray.save_ocular-881"><span class="linenos">881</span></a>            <span class="o">+</span> <span class="s2">&quot; &quot;</span>
</span><span id="EventArray.save_ocular-882"><a href="#EventArray.save_ocular-882"><span class="linenos">882</span></a>            <span class="o">+</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-883"><a href="#EventArray.save_ocular-883"><span class="linenos">883</span></a>            <span class="o">+</span> <span class="s2">&quot; &quot;</span>
</span><span id="EventArray.save_ocular-884"><a href="#EventArray.save_ocular-884"><span class="linenos">884</span></a>            <span class="o">+</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;cellx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-885"><a href="#EventArray.save_ocular-885"><span class="linenos">885</span></a>            <span class="o">+</span> <span class="s2">&quot; &quot;</span>
</span><span id="EventArray.save_ocular-886"><a href="#EventArray.save_ocular-886"><span class="linenos">886</span></a>            <span class="o">+</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;celly&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-887"><a href="#EventArray.save_ocular-887"><span class="linenos">887</span></a>        <span class="p">)</span>
</span><span id="EventArray.save_ocular-888"><a href="#EventArray.save_ocular-888"><span class="linenos">888</span></a>        <span class="c1"># Find averagable data columns</span>
</span><span id="EventArray.save_ocular-889"><a href="#EventArray.save_ocular-889"><span class="linenos">889</span></a>        <span class="k">if</span> <span class="s2">&quot;cellcluster_id&quot;</span> <span class="ow">in</span> <span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="EventArray.save_ocular-890"><a href="#EventArray.save_ocular-890"><span class="linenos">890</span></a>            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s2">&quot;cellcluster_id&quot;</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-891"><a href="#EventArray.save_ocular-891"><span class="linenos">891</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.save_ocular-892"><a href="#EventArray.save_ocular-892"><span class="linenos">892</span></a>            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s2">&quot;slide_id&quot;</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-893"><a href="#EventArray.save_ocular-893"><span class="linenos">893</span></a>        <span class="n">avg_cols</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="n">end_idx</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="EventArray.save_ocular-894"><a href="#EventArray.save_ocular-894"><span class="linenos">894</span></a>        <span class="c1"># Group by cluster and average</span>
</span><span id="EventArray.save_ocular-895"><a href="#EventArray.save_ocular-895"><span class="linenos">895</span></a>        <span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;clust&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
</span><span id="EventArray.save_ocular-896"><a href="#EventArray.save_ocular-896"><span class="linenos">896</span></a>            <span class="o">**</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">avg_cols</span><span class="p">},</span>
</span><span id="EventArray.save_ocular-897"><a href="#EventArray.save_ocular-897"><span class="linenos">897</span></a>            <span class="n">count</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;clust&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">),</span>  <span class="c1"># count rows in each cluster</span>
</span><span id="EventArray.save_ocular-898"><a href="#EventArray.save_ocular-898"><span class="linenos">898</span></a>            <span class="n">example_cells</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;example_cell_id&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
</span><span id="EventArray.save_ocular-899"><a href="#EventArray.save_ocular-899"><span class="linenos">899</span></a>            <span class="n">hcpc</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;hcpc&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="EventArray.save_ocular-900"><a href="#EventArray.save_ocular-900"><span class="linenos">900</span></a>        <span class="p">)</span>
</span><span id="EventArray.save_ocular-901"><a href="#EventArray.save_ocular-901"><span class="linenos">901</span></a>        <span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>  <span class="c1"># Do NOT drop, index is &quot;clust&quot;</span>
</span><span id="EventArray.save_ocular-902"><a href="#EventArray.save_ocular-902"><span class="linenos">902</span></a>        <span class="c1"># Create new columns</span>
</span><span id="EventArray.save_ocular-903"><a href="#EventArray.save_ocular-903"><span class="linenos">903</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="EventArray.save_ocular-904"><a href="#EventArray.save_ocular-904"><span class="linenos">904</span></a>            <span class="p">{</span>
</span><span id="EventArray.save_ocular-905"><a href="#EventArray.save_ocular-905"><span class="linenos">905</span></a>                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">],</span>
</span><span id="EventArray.save_ocular-906"><a href="#EventArray.save_ocular-906"><span class="linenos">906</span></a>                <span class="s2">&quot;example_cells&quot;</span><span class="p">:</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;example_cells&quot;</span><span class="p">],</span>
</span><span id="EventArray.save_ocular-907"><a href="#EventArray.save_ocular-907"><span class="linenos">907</span></a>                <span class="s2">&quot;clust&quot;</span><span class="p">:</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;clust&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
</span><span id="EventArray.save_ocular-908"><a href="#EventArray.save_ocular-908"><span class="linenos">908</span></a>                <span class="s2">&quot;hcpc&quot;</span><span class="p">:</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;hcpc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
</span><span id="EventArray.save_ocular-909"><a href="#EventArray.save_ocular-909"><span class="linenos">909</span></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;clust&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span>
</span><span id="EventArray.save_ocular-910"><a href="#EventArray.save_ocular-910"><span class="linenos">910</span></a>                <span class="s2">&quot;cccluster&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>  <span class="c1"># Dummy value</span>
</span><span id="EventArray.save_ocular-911"><a href="#EventArray.save_ocular-911"><span class="linenos">911</span></a>                <span class="s2">&quot;ccdistance&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># Dummy value</span>
</span><span id="EventArray.save_ocular-912"><a href="#EventArray.save_ocular-912"><span class="linenos">912</span></a>                <span class="s2">&quot;rownum&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_df</span><span class="p">))),</span>
</span><span id="EventArray.save_ocular-913"><a href="#EventArray.save_ocular-913"><span class="linenos">913</span></a>                <span class="s2">&quot;framegroup&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Dummy value</span>
</span><span id="EventArray.save_ocular-914"><a href="#EventArray.save_ocular-914"><span class="linenos">914</span></a>            <span class="p">}</span>
</span><span id="EventArray.save_ocular-915"><a href="#EventArray.save_ocular-915"><span class="linenos">915</span></a>        <span class="p">)</span>
</span><span id="EventArray.save_ocular-916"><a href="#EventArray.save_ocular-916"><span class="linenos">916</span></a>        <span class="c1"># Need to pad the features to 761 columns, as per OCULAR report needs</span>
</span><span id="EventArray.save_ocular-917"><a href="#EventArray.save_ocular-917"><span class="linenos">917</span></a>        <span class="n">additional_columns</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avg_cols</span><span class="p">),</span> <span class="mi">761</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-918"><a href="#EventArray.save_ocular-918"><span class="linenos">918</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">additional_columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray.save_ocular-919"><a href="#EventArray.save_ocular-919"><span class="linenos">919</span></a>            <span class="n">padding</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="EventArray.save_ocular-920"><a href="#EventArray.save_ocular-920"><span class="linenos">920</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data_df</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">additional_columns</span><span class="p">))),</span>
</span><span id="EventArray.save_ocular-921"><a href="#EventArray.save_ocular-921"><span class="linenos">921</span></a>                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;pad</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">additional_columns</span><span class="p">],</span>
</span><span id="EventArray.save_ocular-922"><a href="#EventArray.save_ocular-922"><span class="linenos">922</span></a>            <span class="p">)</span>
</span><span id="EventArray.save_ocular-923"><a href="#EventArray.save_ocular-923"><span class="linenos">923</span></a>            <span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data_df</span><span class="p">[</span><span class="n">avg_cols</span><span class="p">],</span> <span class="n">padding</span><span class="p">,</span> <span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-924"><a href="#EventArray.save_ocular-924"><span class="linenos">924</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.save_ocular-925"><a href="#EventArray.save_ocular-925"><span class="linenos">925</span></a>            <span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data_df</span><span class="p">[</span><span class="n">avg_cols</span><span class="p">],</span> <span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-926"><a href="#EventArray.save_ocular-926"><span class="linenos">926</span></a>
</span><span id="EventArray.save_ocular-927"><a href="#EventArray.save_ocular-927"><span class="linenos">927</span></a>        <span class="c1"># Save the cluster data</span>
</span><span id="EventArray.save_ocular-928"><a href="#EventArray.save_ocular-928"><span class="linenos">928</span></a>        <span class="n">data_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_stub</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">))</span>
</span><span id="EventArray.save_ocular-929"><a href="#EventArray.save_ocular-929"><span class="linenos">929</span></a>        <span class="c1"># Suppress pandas FutureWarning</span>
</span><span id="EventArray.save_ocular-930"><a href="#EventArray.save_ocular-930"><span class="linenos">930</span></a>        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
</span><span id="EventArray.save_ocular-931"><a href="#EventArray.save_ocular-931"><span class="linenos">931</span></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
</span><span id="EventArray.save_ocular-932"><a href="#EventArray.save_ocular-932"><span class="linenos">932</span></a>            <span class="n">pyreadr</span><span class="o">.</span><span class="n">write_rds</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_stub</span><span class="si">}</span><span class="s2">.rds&quot;</span><span class="p">),</span> <span class="n">data_df</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save the events to an OCULAR file. Relies on the dataframe originating
from an OCULAR file (same columns; duplicate metadata/info).</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>output_path</strong>: </li>
<li><strong>event_type</strong>: </li>
</ul>

<h6 id="returns">Returns</h6>
</div>


                            </div>
                            <div id="EventArray.load_ocular" class="classattr">
                                        <input id="EventArray.load_ocular-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">load_ocular</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">cls</span>,</span><span class="param">	<span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">event_type</span><span class="o">=</span><span class="s1">&#39;cells&#39;</span>,</span><span class="param">	<span class="n">cell_data_files</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;rc-final1.rds&#39;</span><span class="p">,</span> <span class="s1">&#39;rc-final2.rds&#39;</span><span class="p">,</span> <span class="s1">&#39;rc-final3.rds&#39;</span><span class="p">,</span> <span class="s1">&#39;rc-final4.rds&#39;</span><span class="p">,</span> <span class="s1">&#39;ocular_interesting.rds&#39;</span><span class="p">)</span>,</span><span class="param">	<span class="n">others_data_files</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;others-final1.rds&#39;</span><span class="p">,</span> <span class="s1">&#39;others-final2.rds&#39;</span><span class="p">,</span> <span class="s1">&#39;others-final3.rds&#39;</span><span class="p">,</span> <span class="s1">&#39;others-final4.rds&#39;</span><span class="p">)</span>,</span><span class="param">	<span class="n">atlas_data_files</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ocular_interesting.rds&#39;</span><span class="p">,</span> <span class="s1">&#39;ocular_not_interesting.rds&#39;</span><span class="p">)</span>,</span><span class="param">	<span class="n">drop_common_events</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">log</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Self</span>:</span></span>

                <label class="view-source-button" for="EventArray.load_ocular-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.load_ocular"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.load_ocular-934"><a href="#EventArray.load_ocular-934"><span class="linenos"> 934</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray.load_ocular-935"><a href="#EventArray.load_ocular-935"><span class="linenos"> 935</span></a>    <span class="k">def</span> <span class="nf">load_ocular</span><span class="p">(</span>
</span><span id="EventArray.load_ocular-936"><a href="#EventArray.load_ocular-936"><span class="linenos"> 936</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="EventArray.load_ocular-937"><a href="#EventArray.load_ocular-937"><span class="linenos"> 937</span></a>        <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="EventArray.load_ocular-938"><a href="#EventArray.load_ocular-938"><span class="linenos"> 938</span></a>        <span class="n">event_type</span><span class="o">=</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span>
</span><span id="EventArray.load_ocular-939"><a href="#EventArray.load_ocular-939"><span class="linenos"> 939</span></a>        <span class="n">cell_data_files</span><span class="o">=</span><span class="p">(</span>
</span><span id="EventArray.load_ocular-940"><a href="#EventArray.load_ocular-940"><span class="linenos"> 940</span></a>            <span class="s2">&quot;rc-final1.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray.load_ocular-941"><a href="#EventArray.load_ocular-941"><span class="linenos"> 941</span></a>            <span class="s2">&quot;rc-final2.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray.load_ocular-942"><a href="#EventArray.load_ocular-942"><span class="linenos"> 942</span></a>            <span class="s2">&quot;rc-final3.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray.load_ocular-943"><a href="#EventArray.load_ocular-943"><span class="linenos"> 943</span></a>            <span class="s2">&quot;rc-final4.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray.load_ocular-944"><a href="#EventArray.load_ocular-944"><span class="linenos"> 944</span></a>            <span class="s2">&quot;ocular_interesting.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray.load_ocular-945"><a href="#EventArray.load_ocular-945"><span class="linenos"> 945</span></a>        <span class="p">),</span>
</span><span id="EventArray.load_ocular-946"><a href="#EventArray.load_ocular-946"><span class="linenos"> 946</span></a>        <span class="n">others_data_files</span><span class="o">=</span><span class="p">(</span>
</span><span id="EventArray.load_ocular-947"><a href="#EventArray.load_ocular-947"><span class="linenos"> 947</span></a>            <span class="s2">&quot;others-final1.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray.load_ocular-948"><a href="#EventArray.load_ocular-948"><span class="linenos"> 948</span></a>            <span class="s2">&quot;others-final2.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray.load_ocular-949"><a href="#EventArray.load_ocular-949"><span class="linenos"> 949</span></a>            <span class="s2">&quot;others-final3.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray.load_ocular-950"><a href="#EventArray.load_ocular-950"><span class="linenos"> 950</span></a>            <span class="s2">&quot;others-final4.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray.load_ocular-951"><a href="#EventArray.load_ocular-951"><span class="linenos"> 951</span></a>        <span class="p">),</span>
</span><span id="EventArray.load_ocular-952"><a href="#EventArray.load_ocular-952"><span class="linenos"> 952</span></a>        <span class="n">atlas_data_files</span><span class="o">=</span><span class="p">(</span>
</span><span id="EventArray.load_ocular-953"><a href="#EventArray.load_ocular-953"><span class="linenos"> 953</span></a>            <span class="s2">&quot;ocular_interesting.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray.load_ocular-954"><a href="#EventArray.load_ocular-954"><span class="linenos"> 954</span></a>            <span class="s2">&quot;ocular_not_interesting.rds&quot;</span><span class="p">,</span>
</span><span id="EventArray.load_ocular-955"><a href="#EventArray.load_ocular-955"><span class="linenos"> 955</span></a>        <span class="p">),</span>
</span><span id="EventArray.load_ocular-956"><a href="#EventArray.load_ocular-956"><span class="linenos"> 956</span></a>        <span class="n">drop_common_events</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="EventArray.load_ocular-957"><a href="#EventArray.load_ocular-957"><span class="linenos"> 957</span></a>        <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="EventArray.load_ocular-958"><a href="#EventArray.load_ocular-958"><span class="linenos"> 958</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-959"><a href="#EventArray.load_ocular-959"><span class="linenos"> 959</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.load_ocular-960"><a href="#EventArray.load_ocular-960"><span class="linenos"> 960</span></a>
</span><span id="EventArray.load_ocular-961"><a href="#EventArray.load_ocular-961"><span class="linenos"> 961</span></a><span class="sd">        :param input_path:</span>
</span><span id="EventArray.load_ocular-962"><a href="#EventArray.load_ocular-962"><span class="linenos"> 962</span></a><span class="sd">        :param event_type:</span>
</span><span id="EventArray.load_ocular-963"><a href="#EventArray.load_ocular-963"><span class="linenos"> 963</span></a><span class="sd">        :param cell_data_files:</span>
</span><span id="EventArray.load_ocular-964"><a href="#EventArray.load_ocular-964"><span class="linenos"> 964</span></a><span class="sd">        :param others_data_files:</span>
</span><span id="EventArray.load_ocular-965"><a href="#EventArray.load_ocular-965"><span class="linenos"> 965</span></a><span class="sd">        :param atlas_data_files:</span>
</span><span id="EventArray.load_ocular-966"><a href="#EventArray.load_ocular-966"><span class="linenos"> 966</span></a><span class="sd">        :param drop_common_events:</span>
</span><span id="EventArray.load_ocular-967"><a href="#EventArray.load_ocular-967"><span class="linenos"> 967</span></a><span class="sd">        :param log:</span>
</span><span id="EventArray.load_ocular-968"><a href="#EventArray.load_ocular-968"><span class="linenos"> 968</span></a><span class="sd">        :return:</span>
</span><span id="EventArray.load_ocular-969"><a href="#EventArray.load_ocular-969"><span class="linenos"> 969</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.load_ocular-970"><a href="#EventArray.load_ocular-970"><span class="linenos"> 970</span></a>        <span class="k">if</span> <span class="n">pyreadr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-971"><a href="#EventArray.load_ocular-971"><span class="linenos"> 971</span></a>            <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span>
</span><span id="EventArray.load_ocular-972"><a href="#EventArray.load_ocular-972"><span class="linenos"> 972</span></a>                <span class="s2">&quot;pyreadr not installed. Install pyreadr directly &quot;</span>
</span><span id="EventArray.load_ocular-973"><a href="#EventArray.load_ocular-973"><span class="linenos"> 973</span></a>                <span class="s2">&quot;or install csi-images with [rds] option to resolve.&quot;</span>
</span><span id="EventArray.load_ocular-974"><a href="#EventArray.load_ocular-974"><span class="linenos"> 974</span></a>            <span class="p">)</span>
</span><span id="EventArray.load_ocular-975"><a href="#EventArray.load_ocular-975"><span class="linenos"> 975</span></a>        <span class="c1"># Check if the input path is a directory or a file</span>
</span><span id="EventArray.load_ocular-976"><a href="#EventArray.load_ocular-976"><span class="linenos"> 976</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">input_path</span><span class="p">):</span>
</span><span id="EventArray.load_ocular-977"><a href="#EventArray.load_ocular-977"><span class="linenos"> 977</span></a>            <span class="n">data_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">input_path</span><span class="p">)]</span>
</span><span id="EventArray.load_ocular-978"><a href="#EventArray.load_ocular-978"><span class="linenos"> 978</span></a>            <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-979"><a href="#EventArray.load_ocular-979"><span class="linenos"> 979</span></a>        <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;cells&quot;</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-980"><a href="#EventArray.load_ocular-980"><span class="linenos"> 980</span></a>            <span class="n">data_files</span> <span class="o">=</span> <span class="n">cell_data_files</span>
</span><span id="EventArray.load_ocular-981"><a href="#EventArray.load_ocular-981"><span class="linenos"> 981</span></a>        <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;others&quot;</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-982"><a href="#EventArray.load_ocular-982"><span class="linenos"> 982</span></a>            <span class="n">data_files</span> <span class="o">=</span> <span class="n">others_data_files</span>
</span><span id="EventArray.load_ocular-983"><a href="#EventArray.load_ocular-983"><span class="linenos"> 983</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-984"><a href="#EventArray.load_ocular-984"><span class="linenos"> 984</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid event type.&quot;</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-985"><a href="#EventArray.load_ocular-985"><span class="linenos"> 985</span></a>
</span><span id="EventArray.load_ocular-986"><a href="#EventArray.load_ocular-986"><span class="linenos"> 986</span></a>        <span class="c1"># Load the data from the OCULAR files</span>
</span><span id="EventArray.load_ocular-987"><a href="#EventArray.load_ocular-987"><span class="linenos"> 987</span></a>        <span class="n">file_data</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="EventArray.load_ocular-988"><a href="#EventArray.load_ocular-988"><span class="linenos"> 988</span></a>        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-989"><a href="#EventArray.load_ocular-989"><span class="linenos"> 989</span></a>            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-990"><a href="#EventArray.load_ocular-990"><span class="linenos"> 990</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
</span><span id="EventArray.load_ocular-991"><a href="#EventArray.load_ocular-991"><span class="linenos"> 991</span></a>                <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-992"><a href="#EventArray.load_ocular-992"><span class="linenos"> 992</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> not found for in </span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-993"><a href="#EventArray.load_ocular-993"><span class="linenos"> 993</span></a>                <span class="k">continue</span>
</span><span id="EventArray.load_ocular-994"><a href="#EventArray.load_ocular-994"><span class="linenos"> 994</span></a>            <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyreadr</span><span class="o">.</span><span class="n">read_r</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-995"><a href="#EventArray.load_ocular-995"><span class="linenos"> 995</span></a>            <span class="c1"># Get the DataFrame associated with None (pyreadr dict quirk)</span>
</span><span id="EventArray.load_ocular-996"><a href="#EventArray.load_ocular-996"><span class="linenos"> 996</span></a>            <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="kc">None</span><span class="p">]</span>
</span><span id="EventArray.load_ocular-997"><a href="#EventArray.load_ocular-997"><span class="linenos"> 997</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-998"><a href="#EventArray.load_ocular-998"><span class="linenos"> 998</span></a>                <span class="c1"># File gets dropped from the dict</span>
</span><span id="EventArray.load_ocular-999"><a href="#EventArray.load_ocular-999"><span class="linenos"> 999</span></a>                <span class="n">file_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-1000"><a href="#EventArray.load_ocular-1000"><span class="linenos">1000</span></a>                <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-1001"><a href="#EventArray.load_ocular-1001"><span class="linenos">1001</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> has no cells&quot;</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-1002"><a href="#EventArray.load_ocular-1002"><span class="linenos">1002</span></a>                <span class="k">continue</span>
</span><span id="EventArray.load_ocular-1003"><a href="#EventArray.load_ocular-1003"><span class="linenos">1003</span></a>
</span><span id="EventArray.load_ocular-1004"><a href="#EventArray.load_ocular-1004"><span class="linenos">1004</span></a>            <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-1005"><a href="#EventArray.load_ocular-1005"><span class="linenos">1005</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">])</span><span class="si">}</span><span class="s2"> cells&quot;</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-1006"><a href="#EventArray.load_ocular-1006"><span class="linenos">1006</span></a>
</span><span id="EventArray.load_ocular-1007"><a href="#EventArray.load_ocular-1007"><span class="linenos">1007</span></a>            <span class="c1"># Drop common cells if requested and in this file</span>
</span><span id="EventArray.load_ocular-1008"><a href="#EventArray.load_ocular-1008"><span class="linenos">1008</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="EventArray.load_ocular-1009"><a href="#EventArray.load_ocular-1009"><span class="linenos">1009</span></a>                <span class="n">file</span> <span class="ow">in</span> <span class="n">atlas_data_files</span>
</span><span id="EventArray.load_ocular-1010"><a href="#EventArray.load_ocular-1010"><span class="linenos">1010</span></a>                <span class="ow">and</span> <span class="n">drop_common_events</span>
</span><span id="EventArray.load_ocular-1011"><a href="#EventArray.load_ocular-1011"><span class="linenos">1011</span></a>                <span class="ow">and</span> <span class="s2">&quot;catalogue_classification&quot;</span> <span class="ow">in</span> <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span>
</span><span id="EventArray.load_ocular-1012"><a href="#EventArray.load_ocular-1012"><span class="linenos">1012</span></a>            <span class="p">):</span>
</span><span id="EventArray.load_ocular-1013"><a href="#EventArray.load_ocular-1013"><span class="linenos">1013</span></a>                <span class="n">common_cell_indices</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="EventArray.load_ocular-1014"><a href="#EventArray.load_ocular-1014"><span class="linenos">1014</span></a>                    <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="s2">&quot;catalogue_classification&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;common_cell&quot;</span>
</span><span id="EventArray.load_ocular-1015"><a href="#EventArray.load_ocular-1015"><span class="linenos">1015</span></a>                <span class="p">)</span>
</span><span id="EventArray.load_ocular-1016"><a href="#EventArray.load_ocular-1016"><span class="linenos">1016</span></a>                <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-1017"><a href="#EventArray.load_ocular-1017"><span class="linenos">1017</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="EventArray.load_ocular-1018"><a href="#EventArray.load_ocular-1018"><span class="linenos">1018</span></a>                        <span class="sa">f</span><span class="s2">&quot;Dropping </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">common_cell_indices</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="EventArray.load_ocular-1019"><a href="#EventArray.load_ocular-1019"><span class="linenos">1019</span></a>                        <span class="sa">f</span><span class="s2">&quot;common cells from </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="EventArray.load_ocular-1020"><a href="#EventArray.load_ocular-1020"><span class="linenos">1020</span></a>                    <span class="p">)</span>
</span><span id="EventArray.load_ocular-1021"><a href="#EventArray.load_ocular-1021"><span class="linenos">1021</span></a>                <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="n">common_cell_indices</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
</span><span id="EventArray.load_ocular-1022"><a href="#EventArray.load_ocular-1022"><span class="linenos">1022</span></a>
</span><span id="EventArray.load_ocular-1023"><a href="#EventArray.load_ocular-1023"><span class="linenos">1023</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-1024"><a href="#EventArray.load_ocular-1024"><span class="linenos">1024</span></a>                <span class="c1"># File gets dropped from the dict</span>
</span><span id="EventArray.load_ocular-1025"><a href="#EventArray.load_ocular-1025"><span class="linenos">1025</span></a>                <span class="n">file_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-1026"><a href="#EventArray.load_ocular-1026"><span class="linenos">1026</span></a>                <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-1027"><a href="#EventArray.load_ocular-1027"><span class="linenos">1027</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> has no cells after dropping common cells&quot;</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-1028"><a href="#EventArray.load_ocular-1028"><span class="linenos">1028</span></a>                <span class="k">continue</span>
</span><span id="EventArray.load_ocular-1029"><a href="#EventArray.load_ocular-1029"><span class="linenos">1029</span></a>
</span><span id="EventArray.load_ocular-1030"><a href="#EventArray.load_ocular-1030"><span class="linenos">1030</span></a>            <span class="c1"># Extract frame_id and cell_id</span>
</span><span id="EventArray.load_ocular-1031"><a href="#EventArray.load_ocular-1031"><span class="linenos">1031</span></a>            <span class="c1"># DAPI- events already have frame_id cell_id outside rowname</span>
</span><span id="EventArray.load_ocular-1032"><a href="#EventArray.load_ocular-1032"><span class="linenos">1032</span></a>            <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">and</span> <span class="s2">&quot;frame_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-1033"><a href="#EventArray.load_ocular-1033"><span class="linenos">1033</span></a>                <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="s2">&quot;rowname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="s2">&quot;rowname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-1034"><a href="#EventArray.load_ocular-1034"><span class="linenos">1034</span></a>                <span class="c1"># get frame_id cell_id from rownames column and split into two columns</span>
</span><span id="EventArray.load_ocular-1035"><a href="#EventArray.load_ocular-1035"><span class="linenos">1035</span></a>                <span class="n">split_res</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="s2">&quot;rowname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-1036"><a href="#EventArray.load_ocular-1036"><span class="linenos">1036</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_res</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-1037"><a href="#EventArray.load_ocular-1037"><span class="linenos">1037</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="EventArray.load_ocular-1038"><a href="#EventArray.load_ocular-1038"><span class="linenos">1038</span></a>                        <span class="sa">f</span><span class="s1">&#39;Expected &quot;frame_id cell_id&quot; but got </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="s2">&quot;rowname&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="EventArray.load_ocular-1039"><a href="#EventArray.load_ocular-1039"><span class="linenos">1039</span></a>                    <span class="p">)</span>
</span><span id="EventArray.load_ocular-1040"><a href="#EventArray.load_ocular-1040"><span class="linenos">1040</span></a>                <span class="c1"># then assign it back to the dataframe</span>
</span><span id="EventArray.load_ocular-1041"><a href="#EventArray.load_ocular-1041"><span class="linenos">1041</span></a>                <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">][[</span><span class="s2">&quot;frame_id&quot;</span><span class="p">,</span> <span class="s2">&quot;cell_id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">split_res</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-1042"><a href="#EventArray.load_ocular-1042"><span class="linenos">1042</span></a>            <span class="c1"># reset indexes since they can cause NaN values in concat</span>
</span><span id="EventArray.load_ocular-1043"><a href="#EventArray.load_ocular-1043"><span class="linenos">1043</span></a>            <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-1044"><a href="#EventArray.load_ocular-1044"><span class="linenos">1044</span></a>
</span><span id="EventArray.load_ocular-1045"><a href="#EventArray.load_ocular-1045"><span class="linenos">1045</span></a>        <span class="c1"># Merge the data from all files</span>
</span><span id="EventArray.load_ocular-1046"><a href="#EventArray.load_ocular-1046"><span class="linenos">1046</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-1047"><a href="#EventArray.load_ocular-1047"><span class="linenos">1047</span></a>            <span class="k">return</span> <span class="n">EventArray</span><span class="p">()</span>
</span><span id="EventArray.load_ocular-1048"><a href="#EventArray.load_ocular-1048"><span class="linenos">1048</span></a>        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-1049"><a href="#EventArray.load_ocular-1049"><span class="linenos">1049</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">file_data</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="EventArray.load_ocular-1050"><a href="#EventArray.load_ocular-1050"><span class="linenos">1050</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-1051"><a href="#EventArray.load_ocular-1051"><span class="linenos">1051</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="EventArray.load_ocular-1052"><a href="#EventArray.load_ocular-1052"><span class="linenos">1052</span></a>
</span><span id="EventArray.load_ocular-1053"><a href="#EventArray.load_ocular-1053"><span class="linenos">1053</span></a>        <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-1054"><a href="#EventArray.load_ocular-1054"><span class="linenos">1054</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gathered a total of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> events&quot;</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-1055"><a href="#EventArray.load_ocular-1055"><span class="linenos">1055</span></a>
</span><span id="EventArray.load_ocular-1056"><a href="#EventArray.load_ocular-1056"><span class="linenos">1056</span></a>        <span class="c1"># Others is missing the &quot;slide_id&quot;. Insert it right before &quot;frame_id&quot; column</span>
</span><span id="EventArray.load_ocular-1057"><a href="#EventArray.load_ocular-1057"><span class="linenos">1057</span></a>        <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;others&quot;</span> <span class="ow">and</span> <span class="s2">&quot;slide_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-1058"><a href="#EventArray.load_ocular-1058"><span class="linenos">1058</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ocular&quot;</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-1059"><a href="#EventArray.load_ocular-1059"><span class="linenos">1059</span></a>                <span class="n">slide_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">input_path</span><span class="p">))</span>
</span><span id="EventArray.load_ocular-1060"><a href="#EventArray.load_ocular-1060"><span class="linenos">1060</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-1061"><a href="#EventArray.load_ocular-1061"><span class="linenos">1061</span></a>                <span class="n">slide_id</span> <span class="o">=</span> <span class="s2">&quot;UNKNOWN&quot;</span>
</span><span id="EventArray.load_ocular-1062"><a href="#EventArray.load_ocular-1062"><span class="linenos">1062</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s2">&quot;frame_id&quot;</span><span class="p">),</span> <span class="s2">&quot;slide_id&quot;</span><span class="p">,</span> <span class="n">slide_id</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-1063"><a href="#EventArray.load_ocular-1063"><span class="linenos">1063</span></a>
</span><span id="EventArray.load_ocular-1064"><a href="#EventArray.load_ocular-1064"><span class="linenos">1064</span></a>        <span class="c1"># Sort according to ascending cell_id to keep the original, which is in manual_df</span>
</span><span id="EventArray.load_ocular-1065"><a href="#EventArray.load_ocular-1065"><span class="linenos">1065</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-1066"><a href="#EventArray.load_ocular-1066"><span class="linenos">1066</span></a>        <span class="c1"># Filter out duplicates by x &amp; y</span>
</span><span id="EventArray.load_ocular-1067"><a href="#EventArray.load_ocular-1067"><span class="linenos">1067</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="EventArray.load_ocular-1068"><a href="#EventArray.load_ocular-1068"><span class="linenos">1068</span></a>            <span class="n">unique_id</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">]</span>
</span><span id="EventArray.load_ocular-1069"><a href="#EventArray.load_ocular-1069"><span class="linenos">1069</span></a>            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
</span><span id="EventArray.load_ocular-1070"><a href="#EventArray.load_ocular-1070"><span class="linenos">1070</span></a>            <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;frame_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-1071"><a href="#EventArray.load_ocular-1071"><span class="linenos">1071</span></a>            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
</span><span id="EventArray.load_ocular-1072"><a href="#EventArray.load_ocular-1072"><span class="linenos">1072</span></a>            <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cellx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-1073"><a href="#EventArray.load_ocular-1073"><span class="linenos">1073</span></a>            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
</span><span id="EventArray.load_ocular-1074"><a href="#EventArray.load_ocular-1074"><span class="linenos">1074</span></a>            <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;celly&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-1075"><a href="#EventArray.load_ocular-1075"><span class="linenos">1075</span></a>        <span class="p">)</span>
</span><span id="EventArray.load_ocular-1076"><a href="#EventArray.load_ocular-1076"><span class="linenos">1076</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;unique_id&quot;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-1077"><a href="#EventArray.load_ocular-1077"><span class="linenos">1077</span></a>        <span class="c1"># Normal unique_id is with cell_id</span>
</span><span id="EventArray.load_ocular-1078"><a href="#EventArray.load_ocular-1078"><span class="linenos">1078</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="EventArray.load_ocular-1079"><a href="#EventArray.load_ocular-1079"><span class="linenos">1079</span></a>            <span class="n">unique_id</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">]</span>
</span><span id="EventArray.load_ocular-1080"><a href="#EventArray.load_ocular-1080"><span class="linenos">1080</span></a>            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
</span><span id="EventArray.load_ocular-1081"><a href="#EventArray.load_ocular-1081"><span class="linenos">1081</span></a>            <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;frame_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-1082"><a href="#EventArray.load_ocular-1082"><span class="linenos">1082</span></a>            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
</span><span id="EventArray.load_ocular-1083"><a href="#EventArray.load_ocular-1083"><span class="linenos">1083</span></a>            <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-1084"><a href="#EventArray.load_ocular-1084"><span class="linenos">1084</span></a>        <span class="p">)</span>
</span><span id="EventArray.load_ocular-1085"><a href="#EventArray.load_ocular-1085"><span class="linenos">1085</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-1086"><a href="#EventArray.load_ocular-1086"><span class="linenos">1086</span></a>        <span class="c1"># All columns up to &quot;slide_id&quot; are features; drop the &quot;slide_id&quot;</span>
</span><span id="EventArray.load_ocular-1087"><a href="#EventArray.load_ocular-1087"><span class="linenos">1087</span></a>        <span class="n">features</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">:</span><span class="s2">&quot;slide_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="EventArray.load_ocular-1088"><a href="#EventArray.load_ocular-1088"><span class="linenos">1088</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;slide_id&quot;</span><span class="p">:]</span>
</span><span id="EventArray.load_ocular-1089"><a href="#EventArray.load_ocular-1089"><span class="linenos">1089</span></a>        <span class="c1"># Grab the info columns</span>
</span><span id="EventArray.load_ocular-1090"><a href="#EventArray.load_ocular-1090"><span class="linenos">1090</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">,</span> <span class="s2">&quot;frame_id&quot;</span><span class="p">,</span> <span class="s2">&quot;cellx&quot;</span><span class="p">,</span> <span class="s2">&quot;celly&quot;</span><span class="p">]]</span>
</span><span id="EventArray.load_ocular-1091"><a href="#EventArray.load_ocular-1091"><span class="linenos">1091</span></a>        <span class="n">info</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">,</span> <span class="s2">&quot;tile&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]</span>
</span><span id="EventArray.load_ocular-1092"><a href="#EventArray.load_ocular-1092"><span class="linenos">1092</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="EventArray.load_ocular-1093"><a href="#EventArray.load_ocular-1093"><span class="linenos">1093</span></a>            <span class="n">roi</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># OCULAR only works on 1 ROI, as far as known</span>
</span><span id="EventArray.load_ocular-1094"><a href="#EventArray.load_ocular-1094"><span class="linenos">1094</span></a>            <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>  <span class="c1"># Static, for later montaging</span>
</span><span id="EventArray.load_ocular-1095"><a href="#EventArray.load_ocular-1095"><span class="linenos">1095</span></a>        <span class="p">)</span>
</span><span id="EventArray.load_ocular-1096"><a href="#EventArray.load_ocular-1096"><span class="linenos">1096</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">[[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">,</span> <span class="s2">&quot;tile&quot;</span><span class="p">,</span> <span class="s2">&quot;roi&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">]]</span>
</span><span id="EventArray.load_ocular-1097"><a href="#EventArray.load_ocular-1097"><span class="linenos">1097</span></a>        <span class="c1"># Metadata has duplicate columns for later convenience</span>
</span><span id="EventArray.load_ocular-1098"><a href="#EventArray.load_ocular-1098"><span class="linenos">1098</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="EventArray.load_ocular-1099"><a href="#EventArray.load_ocular-1099"><span class="linenos">1099</span></a>        <span class="c1"># Certain columns tend to be problematic with mixed data formats...</span>
</span><span id="EventArray.load_ocular-1100"><a href="#EventArray.load_ocular-1100"><span class="linenos">1100</span></a>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TRITC&quot;</span><span class="p">,</span> <span class="s2">&quot;CY5&quot;</span><span class="p">,</span> <span class="s2">&quot;FITC&quot;</span><span class="p">]:</span>
</span><span id="EventArray.load_ocular-1101"><a href="#EventArray.load_ocular-1101"><span class="linenos">1101</span></a>            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-1102"><a href="#EventArray.load_ocular-1102"><span class="linenos">1102</span></a>                <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="EventArray.load_ocular-1103"><a href="#EventArray.load_ocular-1103"><span class="linenos">1103</span></a>                    <span class="s2">&quot;False&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="EventArray.load_ocular-1104"><a href="#EventArray.load_ocular-1104"><span class="linenos">1104</span></a>                    <span class="s2">&quot;True&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="EventArray.load_ocular-1105"><a href="#EventArray.load_ocular-1105"><span class="linenos">1105</span></a>                    <span class="s2">&quot;FALSE&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="EventArray.load_ocular-1106"><a href="#EventArray.load_ocular-1106"><span class="linenos">1106</span></a>                    <span class="s2">&quot;TRUE&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="EventArray.load_ocular-1107"><a href="#EventArray.load_ocular-1107"><span class="linenos">1107</span></a>                <span class="p">}</span>
</span><span id="EventArray.load_ocular-1108"><a href="#EventArray.load_ocular-1108"><span class="linenos">1108</span></a>                <span class="n">metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-1109"><a href="#EventArray.load_ocular-1109"><span class="linenos">1109</span></a>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;catalogue_id&quot;</span><span class="p">,</span> <span class="s2">&quot;catalogue_distance&quot;</span><span class="p">,</span> <span class="s2">&quot;clust&quot;</span><span class="p">,</span> <span class="s2">&quot;hcpc&quot;</span><span class="p">]:</span>
</span><span id="EventArray.load_ocular-1110"><a href="#EventArray.load_ocular-1110"><span class="linenos">1110</span></a>            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
</span><span id="EventArray.load_ocular-1111"><a href="#EventArray.load_ocular-1111"><span class="linenos">1111</span></a>                <span class="n">metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="EventArray.load_ocular-1112"><a href="#EventArray.load_ocular-1112"><span class="linenos">1112</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><h6 id="parameters">Parameters</h6>

<ul>
<li><strong>input_path</strong>: </li>
<li><strong>event_type</strong>: </li>
<li><strong>cell_data_files</strong>: </li>
<li><strong>others_data_files</strong>: </li>
<li><strong>atlas_data_files</strong>: </li>
<li><strong>drop_common_events</strong>: </li>
<li><strong>log</strong>: </li>
</ul>

<h6 id="returns">Returns</h6>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>