<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.0"/>
    <title>csi_images.csi_events API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#49483e}.pdoc-code{background:#272822; color:#f8f8f2}.pdoc-code .c{color:#75715e}.pdoc-code .err{color:#960050; background-color:#1e0010}.pdoc-code .esc{color:#f8f8f2}.pdoc-code .g{color:#f8f8f2}.pdoc-code .k{color:#66d9ef}.pdoc-code .l{color:#ae81ff}.pdoc-code .n{color:#f8f8f2}.pdoc-code .o{color:#f92672}.pdoc-code .x{color:#f8f8f2}.pdoc-code .p{color:#f8f8f2}.pdoc-code .ch{color:#75715e}.pdoc-code .cm{color:#75715e}.pdoc-code .cp{color:#75715e}.pdoc-code .cpf{color:#75715e}.pdoc-code .c1{color:#75715e}.pdoc-code .cs{color:#75715e}.pdoc-code .gd{color:#f92672}.pdoc-code .ge{color:#f8f8f2; font-style:italic}.pdoc-code .gr{color:#f8f8f2}.pdoc-code .gh{color:#f8f8f2}.pdoc-code .gi{color:#a6e22e}.pdoc-code .go{color:#66d9ef}.pdoc-code .gp{color:#f92672; font-weight:bold}.pdoc-code .gs{color:#f8f8f2; font-weight:bold}.pdoc-code .gu{color:#75715e}.pdoc-code .gt{color:#f8f8f2}.pdoc-code .kc{color:#66d9ef}.pdoc-code .kd{color:#66d9ef}.pdoc-code .kn{color:#f92672}.pdoc-code .kp{color:#66d9ef}.pdoc-code .kr{color:#66d9ef}.pdoc-code .kt{color:#66d9ef}.pdoc-code .ld{color:#e6db74}.pdoc-code .m{color:#ae81ff}.pdoc-code .s{color:#e6db74}.pdoc-code .na{color:#a6e22e}.pdoc-code .nb{color:#f8f8f2}.pdoc-code .nc{color:#a6e22e}.pdoc-code .no{color:#66d9ef}.pdoc-code .nd{color:#a6e22e}.pdoc-code .ni{color:#f8f8f2}.pdoc-code .ne{color:#a6e22e}.pdoc-code .nf{color:#a6e22e}.pdoc-code .nl{color:#f8f8f2}.pdoc-code .nn{color:#f8f8f2}.pdoc-code .nx{color:#a6e22e}.pdoc-code .py{color:#f8f8f2}.pdoc-code .nt{color:#f92672}.pdoc-code .nv{color:#f8f8f2}.pdoc-code .ow{color:#f92672}.pdoc-code .w{color:#f8f8f2}.pdoc-code .mb{color:#ae81ff}.pdoc-code .mf{color:#ae81ff}.pdoc-code .mh{color:#ae81ff}.pdoc-code .mi{color:#ae81ff}.pdoc-code .mo{color:#ae81ff}.pdoc-code .sa{color:#e6db74}.pdoc-code .sb{color:#e6db74}.pdoc-code .sc{color:#e6db74}.pdoc-code .dl{color:#e6db74}.pdoc-code .sd{color:#e6db74}.pdoc-code .s2{color:#e6db74}.pdoc-code .se{color:#ae81ff}.pdoc-code .sh{color:#e6db74}.pdoc-code .si{color:#e6db74}.pdoc-code .sx{color:#e6db74}.pdoc-code .sr{color:#e6db74}.pdoc-code .s1{color:#e6db74}.pdoc-code .ss{color:#e6db74}.pdoc-code .bp{color:#f8f8f2}.pdoc-code .fm{color:#a6e22e}.pdoc-code .vc{color:#f8f8f2}.pdoc-code .vg{color:#f8f8f2}.pdoc-code .vi{color:#f8f8f2}.pdoc-code .vm{color:#f8f8f2}</style>
    <style>/*! theme.css */:root{--pdoc-background:#212529;}.pdoc{--text:#f7f7f7;--muted:#9d9d9d;--link:#58a6ff;--link-hover:#3989ff;--code:#333;--active:#555;--accent:#343434;--accent2:#555;--nav-hover:rgba(0, 0, 0, 0.1);--name:#77C1FF;--def:#0cdd0c;--annotation:#00c037;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../csi_images.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;csi_images</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Event">Event</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Event.__init__">Event</a>
                        </li>
                        <li>
                                <a class="variable" href="#Event.SCAN_TO_SLIDE_TRANSFORM">SCAN_TO_SLIDE_TRANSFORM</a>
                        </li>
                        <li>
                                <a class="variable" href="#Event.scan">scan</a>
                        </li>
                        <li>
                                <a class="variable" href="#Event.tile">tile</a>
                        </li>
                        <li>
                                <a class="variable" href="#Event.x">x</a>
                        </li>
                        <li>
                                <a class="variable" href="#Event.y">y</a>
                        </li>
                        <li>
                                <a class="variable" href="#Event.size">size</a>
                        </li>
                        <li>
                                <a class="variable" href="#Event.metadata">metadata</a>
                        </li>
                        <li>
                                <a class="variable" href="#Event.features">features</a>
                        </li>
                        <li>
                                <a class="function" href="#Event.get_scan_position">get_scan_position</a>
                        </li>
                        <li>
                                <a class="function" href="#Event.get_slide_position">get_slide_position</a>
                        </li>
                        <li>
                                <a class="function" href="#Event.extract_images">extract_images</a>
                        </li>
                        <li>
                                <a class="function" href="#Event.crop_images">crop_images</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#EventArray">EventArray</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#EventArray.__init__">EventArray</a>
                        </li>
                        <li>
                                <a class="variable" href="#EventArray.INFO_COLUMNS">INFO_COLUMNS</a>
                        </li>
                        <li>
                                <a class="variable" href="#EventArray.info">info</a>
                        </li>
                        <li>
                                <a class="variable" href="#EventArray.metadata">metadata</a>
                        </li>
                        <li>
                                <a class="variable" href="#EventArray.features">features</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.add_metadata">add_metadata</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.add_features">add_features</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.from_list">from_list</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.from_events">from_events</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.to_events">to_events</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.to_dataframe">to_dataframe</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.from_dataframe">from_dataframe</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.save_csv">save_csv</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.load_csv">load_csv</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.save_hdf5">save_hdf5</a>
                        </li>
                        <li>
                                <a class="function" href="#EventArray.load_hdf5">load_hdf5</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#extract_all_event_images">extract_all_event_images</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../csi_images.html">csi_images</a><wbr>.csi_events    </h1>

                        <div class="docstring"><p>Contains the Event class, which represents a single event in a scan.
The Event class optionally holds metadata and features. Lists of events with
similar metadata or features can be combined into DataFrames for analysis.</p>

<p>The Event class holds the position of the event in the frame, which can be converted
to the position in the scanner or slide coordinate positions. See the
csi_utils.csi_scans documentation page for more information on the coordinate systems.</p>
</div>

                        <input id="mod-csi_events-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-csi_events-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="sd">Contains the Event class, which represents a single event in a scan.</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">The Event class optionally holds metadata and features. Lists of events with</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="sd">similar metadata or features can be combined into DataFrames for analysis.</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="sd">The Event class holds the position of the event in the frame, which can be converted</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="sd">to the position in the scanner or slide coordinate positions. See the</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="sd">csi_utils.csi_scans documentation page for more information on the coordinate systems.</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">import</span> <span class="nn">math</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">import</span> <span class="nn">os.path</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">import</span> <span class="nn">typing</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="kn">from</span> <span class="nn">csi_images</span> <span class="kn">import</span> <span class="n">csi_frames</span><span class="p">,</span> <span class="n">csi_tiles</span><span class="p">,</span> <span class="n">csi_scans</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="k">class</span> <span class="nc">Event</span><span class="p">:</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">    A class that represents a single event in a scan, making it easy to evaluate</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">    singular events. Required metadata is exposed as attributes, and optional</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">    metadata and features are stored as DataFrames.</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>    <span class="c1"># 2D homogenous transformation matrices</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>    <span class="c1"># Translations (final column) are in micrometers (um)</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>    <span class="n">SCAN_TO_SLIDE_TRANSFORM</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>        <span class="n">csi_scans</span><span class="o">.</span><span class="n">Scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>            <span class="p">[</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">75000</span><span class="p">],</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>            <span class="p">]</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>        <span class="p">),</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>        <span class="c1"># BZScanner coordinates are a special kind of messed up:</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>        <span class="c1"># - The slide is upside-down.</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>        <span class="c1"># - The slide is oriented vertically, with the barcode at the bottom.</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>        <span class="c1"># - Tiles are numbered from the top-right</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>        <span class="n">csi_scans</span><span class="o">.</span><span class="n">Scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>            <span class="p">[</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">75000</span><span class="p">],</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>                <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">25000</span><span class="p">],</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>            <span class="p">]</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>        <span class="p">),</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>    <span class="p">}</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">    Homogeneous transformation matrices for converting between scanner and slide</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">    coordinates. The matrices are 3x3, with the final column representing the</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">    translation in micrometers (um). For more information, see </span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">    [affine transformations](https://en.wikipedia.org/wiki/Transformation_matrix#Affine_transformations).</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">    </span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="sd">    Transformations are nominal, and accuracy is not guaranteed; this is due to </span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">    imperfections in slides and alignment in the scanners. </span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>        <span class="n">scan</span><span class="p">:</span> <span class="n">csi_scans</span><span class="o">.</span><span class="n">Scan</span><span class="p">,</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>        <span class="n">tile</span><span class="p">:</span> <span class="n">csi_tiles</span><span class="o">.</span><span class="n">Tile</span><span class="p">,</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>        <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>        <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>        <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>  <span class="c1"># End-to-end size in pixels</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>        <span class="n">features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>    <span class="p">):</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scan</span> <span class="o">=</span> <span class="n">scan</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile</span> <span class="o">=</span> <span class="n">tile</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>    <span class="k">def</span> <span class="nf">get_scan_position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="sd">        Get the position of the event in the scanner&#39;s coordinate frame.</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="sd">        :return: the scan position of the event in micrometers (um).</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>        <span class="c1"># Get overall pixel position</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>        <span class="n">pixel_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>        <span class="n">pixel_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>        <span class="c1"># Convert to micrometers</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>        <span class="n">x_um</span> <span class="o">=</span> <span class="n">pixel_x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>        <span class="n">y_um</span> <span class="o">=</span> <span class="n">pixel_y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>        <span class="c1"># Add the scan&#39;s origin in the scanner frame</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>        <span class="n">x_um</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n_roi</span><span class="p">]</span><span class="o">.</span><span class="n">origin_x_um</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>        <span class="n">y_um</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n_roi</span><span class="p">]</span><span class="o">.</span><span class="n">origin_y_um</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>        <span class="k">return</span> <span class="n">x_um</span><span class="p">,</span> <span class="n">y_um</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>    <span class="k">def</span> <span class="nf">get_slide_position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a><span class="sd">        Get the slide position of the event in micrometers (um).</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">        :return: the slide position of the event.</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>        <span class="c1"># Turn scan_position into a 3x1 vector</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>        <span class="n">scan_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scan_position</span><span class="p">()</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>        <span class="n">scan_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">scan_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">scan_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>        <span class="c1"># Multiply by the appropriate homogeneous matrix</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>            <span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SCAN_TO_SLIDE_TRANSFORM</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">]</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>            <span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SCAN_TO_SLIDE_TRANSFORM</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">]</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scanner type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span><span class="si">}</span><span class="s2"> not supported.&quot;</span><span class="p">)</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>        <span class="n">slide_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">scan_position</span><span class="p">)</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">slide_position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">slide_position</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>    <span class="k">def</span> <span class="nf">extract_images</span><span class="p">(</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">        Extract the images from the scan and tile, reading from the file. Called</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="sd">        &quot;extract&quot; because it must read and extract the images from file, which is slow.</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="sd">        Use this if you&#39;re interested in only a few events, as it is inefficient when</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a><span class="sd">        reading multiple events from the same tile.</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="sd">        :param crop_size: the square size of the image crop to get for this event. Defaults to 10um.</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="sd">        :param in_pixels: whether the crop size is in pixels or micrometers. Defaults to um.</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="sd">        :return: a list of cropped images from the scan in the order of the channels.</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>        <span class="n">frames</span> <span class="o">=</span> <span class="n">csi_frames</span><span class="o">.</span><span class="n">Frame</span><span class="o">.</span><span class="n">get_frames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="p">)</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>        <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">get_image</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">]</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_images</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="n">in_pixels</span><span class="p">)</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>    <span class="k">def</span> <span class="nf">crop_images</span><span class="p">(</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">crop_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="sd">        Get the event crops from the frame images. Called &quot;get&quot; because it does not</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a><span class="sd">        need to extract anything; it is very quick for extracting multiple events from</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="sd">        the same tile.</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="sd">        Use this if you&#39;re interested in many events.</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="sd">        :param images: the frame images.</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="sd">        :param crop_size: the square size of the image crop to get for this event. Defaults to 10um.</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="sd">        :param in_pixels: whether the crop size is in pixels or micrometers. Defaults to um.</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="sd">        :return: image_size x image_size crops of the event in the provided frames. If</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">        the event is too close to the edge, the crop will be smaller and not centered.</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>        <span class="c1"># Convert a crop size in micrometers to pixels</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_pixels</span><span class="p">:</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>            <span class="n">crop_size</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">crop_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span><span class="p">)</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>        <span class="c1"># Find the crop bounds</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">crop_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">crop_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>        <span class="p">]</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>        <span class="c1"># Determine how much the bounds violate the image size</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>        <span class="n">displacements</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>        <span class="p">]</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>        <span class="c1"># Cap off the bounds</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>            <span class="nb">min</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>            <span class="nb">min</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>        <span class="p">]</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)):</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>            <span class="c1"># Create a blank image of the right size</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>            <span class="n">cropped_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">crop_size</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>            <span class="c1"># Insert the cropped image into the blank image, leaving a black buffer</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>            <span class="c1"># around the edges if the crop would go beyond the original image bounds</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>            <span class="n">cropped_image</span><span class="p">[</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>                <span class="n">displacements</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">crop_size</span> <span class="o">-</span> <span class="n">displacements</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>                <span class="n">displacements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">crop_size</span> <span class="o">-</span> <span class="n">displacements</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>            <span class="p">]</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>            <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cropped_image</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>        <span class="k">return</span> <span class="n">images</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a><span class="k">class</span> <span class="nc">EventArray</span><span class="p">:</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a><span class="sd">    A class that holds a large number of events&#39; data, making it easy to analyze and</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a><span class="sd">    manipulate many events at once. A more separated version of the Event class.</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>    <span class="n">INFO_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">,</span> <span class="s2">&quot;tile&quot;</span><span class="p">,</span> <span class="s2">&quot;roi&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">]</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>        <span class="n">info</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>        <span class="n">features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>    <span class="p">):</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>        <span class="c1"># Info must be a DataFrame with columns &quot;slide_id&quot;, &quot;tile&quot;, &quot;roi&quot;, &quot;x&quot;, &quot;y&quot;, &quot;size&quot;</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>        <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>            <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">INFO_COLUMNS</span><span class="p">)</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>            <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>        <span class="p">):</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>                <span class="s2">&quot;EventArray.info must have columns &#39;slide_id&#39;, &#39;tile&#39;, &#39;roi&#39;, &#39;x&#39;, &#39;y&#39;, &#39;size&#39;&quot;</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>            <span class="p">)</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>        <span class="c1"># All DataFrames must all have the same number of rows</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="p">)):</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>                <span class="s2">&quot;If EventArray.metadata is not None, it should match rows with .info&quot;</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>            <span class="p">)</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>        <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)):</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>                <span class="s2">&quot;If EventArray.features is not None, it should match rows with .info&quot;</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>            <span class="p">)</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>        <span class="c1"># Convenience method to get the number of events</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>            <span class="k">return</span> <span class="mi">0</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>        <span class="n">is_equal</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>        <span class="c1"># Parse all possibilities for info</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>                <span class="n">is_equal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_equal</span><span class="p">:</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>        <span class="c1"># Parse all possibilities for metadata</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>                <span class="n">is_equal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_equal</span><span class="p">:</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>        <span class="c1"># Parse all possibilities for features</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>                <span class="n">is_equal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_equal</span><span class="p">:</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>        <span class="k">return</span> <span class="n">is_equal</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>    <span class="k">def</span> <span class="nf">add_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="sd">        Add metadata to the EventArray.</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a><span class="sd">        :param new_metadata: the metadata to add.</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_metadata</span><span class="p">):</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;New metadata does not match length of existing info&quot;</span><span class="p">)</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">new_metadata</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>            <span class="c1"># Add the new metadata columns to the existing metadata</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">new_metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>    <span class="k">def</span> <span class="nf">add_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a><span class="sd">        Add features to the EventArray.</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a><span class="sd">        :param new_features: the metadata to add.</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_features</span><span class="p">):</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;New metadata does not match length of existing info&quot;</span><span class="p">)</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">new_features</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>            <span class="c1"># Add the new metadata columns to the existing metadata</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">new_features</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>    <span class="k">def</span> <span class="nf">from_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Self</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Self</span><span class="p">:</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a><span class="sd">        Combine EventArrays in a list into a single EventArray.</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a><span class="sd">        :param events: the new list of events.</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>        <span class="n">all_info</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>        <span class="n">all_metadata</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>        <span class="n">all_features</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>        <span class="k">for</span> <span class="n">event_array</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>            <span class="c1"># Skip empty EventArrays</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>            <span class="k">if</span> <span class="n">event_array</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>                <span class="n">all_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_array</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>            <span class="k">if</span> <span class="n">event_array</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>                <span class="n">all_metadata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_array</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>            <span class="k">if</span> <span class="n">event_array</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>                <span class="n">all_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_array</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>            <span class="k">return</span> <span class="n">EventArray</span><span class="p">()</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>            <span class="n">all_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_info</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_metadata</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>            <span class="n">all_metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>            <span class="n">all_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_metadata</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_features</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>            <span class="n">all_features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>            <span class="n">all_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_features</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">all_info</span><span class="p">,</span> <span class="n">all_metadata</span><span class="p">,</span> <span class="n">all_features</span><span class="p">)</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>    <span class="k">def</span> <span class="nf">from_events</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Event</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Self</span><span class="p">:</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a><span class="sd">        Set the events in the EventArray to a new list of events.</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a><span class="sd">        :param events: the new list of events.</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>        <span class="c1"># Return an empty array if we were passed nothing</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>        <span class="k">if</span> <span class="n">events</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>            <span class="k">return</span> <span class="n">EventArray</span><span class="p">()</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>        <span class="c1"># Otherwise, grab the info</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>            <span class="p">{</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>                <span class="s2">&quot;slide_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>                <span class="s2">&quot;tile&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>                <span class="s2">&quot;roi&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n_roi</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>                <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>            <span class="p">}</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>        <span class="p">)</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>        <span class="n">metadata_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">metadata</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>        <span class="c1"># Iterate through and ensure that all metadata is the same shape</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>        <span class="k">for</span> <span class="n">metadata</span> <span class="ow">in</span> <span class="n">metadata_list</span><span class="p">:</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">metadata_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All metadata must be the same type.&quot;</span><span class="p">)</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>            <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">metadata</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">metadata_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All metadata must be the same shape.&quot;</span><span class="p">)</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>        <span class="k">if</span> <span class="n">metadata_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metadata_list</span><span class="p">)</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>        <span class="n">features_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">features</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>        <span class="c1"># Iterate through and ensure that all features are the same shape</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>        <span class="k">for</span> <span class="n">features</span> <span class="ow">in</span> <span class="n">features_list</span><span class="p">:</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">features_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All features must be the same type.&quot;</span><span class="p">)</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>            <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">features</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">features_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All features must be the same shape.&quot;</span><span class="p">)</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>        <span class="k">if</span> <span class="n">features_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">features_list</span><span class="p">)</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>    <span class="k">def</span> <span class="nf">to_events</span><span class="p">(</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">scans</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">csi_scans</span><span class="o">.</span><span class="n">Scan</span><span class="p">],</span> <span class="n">ignore_missing_scans</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Event</span><span class="p">]:</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a><span class="sd">        Get the events in the EventArray as a list of events.</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a><span class="sd">        :param scans: the scans that the events belong to.</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a><span class="sd">        :param ignore_missing_scans: whether to create blank scans for events without scans.</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a><span class="sd">        :return:</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>        <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)):</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>            <span class="c1"># Determine the associated scan</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>            <span class="n">scan</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">slide_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>                    <span class="n">scan</span> <span class="o">=</span> <span class="n">s</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>                    <span class="k">break</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>            <span class="k">if</span> <span class="n">scan</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>                <span class="k">if</span> <span class="n">ignore_missing_scans</span><span class="p">:</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>                    <span class="c1"># Create a placeholder scan if the scan is missing</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>                    <span class="n">scan</span> <span class="o">=</span> <span class="n">csi_scans</span><span class="o">.</span><span class="n">Scan</span><span class="o">.</span><span class="n">make_placeholder</span><span class="p">(</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>                    <span class="p">)</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>                        <span class="sa">f</span><span class="s2">&quot;Scan </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;slide_id&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found for event </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>                    <span class="p">)</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>            <span class="c1"># Add to the list</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>                <span class="n">Event</span><span class="p">(</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>                    <span class="n">scan</span><span class="p">,</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>                    <span class="n">csi_tiles</span><span class="o">.</span><span class="n">Tile</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>                    <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>                    <span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>                    <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>                <span class="p">)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>            <span class="p">)</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>        <span class="k">return</span> <span class="n">events</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>    <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a><span class="sd">        Convert all the data in the EventArray to a single DataFrame.</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a><span class="sd">        :return: a DataFrame with all the data in the EventArray.</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>        <span class="c1"># Make a copy of the info DataFrame and prepend &quot;info_&quot; to the column names</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;info_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>        <span class="c1"># Combine with the metadata and prepend &quot;metadata_&quot; to the column names</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>            <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;metadata_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">output</span><span class="p">,</span> <span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>        <span class="c1"># Combine with the features and prepend &quot;features_&quot; to the column names</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>            <span class="n">features</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;features_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">output</span><span class="p">,</span> <span class="n">features</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>        <span class="k">return</span> <span class="n">output</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>    <span class="k">def</span> <span class="nf">from_dataframe</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Self</span><span class="p">:</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a><span class="sd">        From a single, special DataFrame, create an EventArray.</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a><span class="sd">        :return: a DataFrame with all the data in the EventArray.</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>        <span class="c1"># Split the columns into info, metadata, and features and strip prefix</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;info_&quot;</span><span class="p">)]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>        <span class="n">info</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;info_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;metadata_&quot;</span><span class="p">)]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>        <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;metadata_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>        <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>        <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;features_&quot;</span><span class="p">)]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>        <span class="n">features</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;features_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>        <span class="k">if</span> <span class="n">features</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>    <span class="k">def</span> <span class="nf">save_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a><span class="sd">        Save the events to an CSV file, including metadata and features.</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a><span class="sd">        :param output_path:</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a><span class="sd">        :return:</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>    <span class="k">def</span> <span class="nf">load_csv</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Self</span><span class="p">:</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a><span class="sd">        Load the events from an CSV file, including metadata and features.</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a><span class="sd">        :param input_path:</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a><span class="sd">        :return:</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>        <span class="c1"># Load the CSV file</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>    <span class="k">def</span> <span class="nf">save_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a><span class="sd">        Save the events to an HDF5 file, including metadata and features.</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a><span class="sd">        Uses the pandas-provided HDF5 functions for ease, and external compatibility,</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a><span class="sd">        though these files are slightly harder to view in HDFView or similar.</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a><span class="sd">        :param output_path:</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a><span class="sd">        :return:</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>        <span class="c1"># Open the output_path as an HDF5 file</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>        <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">store</span><span class="p">:</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>            <span class="c1"># Store the dataframes in the HDF5 file</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>                <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>                <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>                <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>    <span class="k">def</span> <span class="nf">load_hdf5</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Self</span><span class="p">:</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a><span class="sd">        Load the events from an HDF5 file, including metadata and features.</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a><span class="sd">        :param input_path:</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a><span class="sd">        :return:</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>        <span class="c1"># Open the input_path as an HDF5 file</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>        <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">store</span><span class="p">:</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>            <span class="c1"># Load the dataframes from the HDF5 file</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;info&quot;</span> <span class="ow">in</span> <span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;features&quot;</span> <span class="ow">in</span> <span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a><span class="k">def</span> <span class="nf">extract_all_event_images</span><span class="p">(</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>    <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Event</span><span class="p">],</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>    <span class="n">crop_size</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>    <span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a><span class="sd">    Get the images for a list of events, ensuring that there is no wasteful reading</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a><span class="sd">    of the same tile multiple times. This function is more efficient than calling</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a><span class="sd">    extract_event_images for each event.</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a><span class="sd">    TODO: test this function</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a><span class="sd">    :param events: the events to extract images for.</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a><span class="sd">    :param crop_size: the square size of the image crop to get for this event.</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a><span class="sd">                      Defaults to twice the size of the event.</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a><span class="sd">    :param in_pixels: whether the crop size is in pixels or micrometers.</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a><span class="sd">                      Defaults to um.</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a><span class="sd">    :return: a list of lists of cropped images for each event.</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>    <span class="c1"># Sort the events by tile; use a shallow copy to avoid modifying the original</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>    <span class="n">events</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">events</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()))</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>    <span class="k">if</span> <span class="n">crop_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>        <span class="n">crop_size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">event</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>        <span class="n">in_pixels</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>    <span class="c1"># Allocate the list to size</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>    <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>    <span class="n">last_tile</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>    <span class="n">frame_images</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Holds large numpy arrays, so expensive to compare</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)):</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>        <span class="k">if</span> <span class="n">last_tile</span> <span class="o">!=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tile</span><span class="p">:</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>            <span class="c1"># Gather the frame images, preserving them for the next event</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>            <span class="n">frames</span> <span class="o">=</span> <span class="n">csi_frames</span><span class="o">.</span><span class="n">Frame</span><span class="o">.</span><span class="n">get_frames</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tile</span><span class="p">)</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>            <span class="n">frame_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">get_image</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">]</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>            <span class="n">last_tile</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tile</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>        <span class="c1"># Use the frame images to crop the event images</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>        <span class="c1"># Preserve the original order using order[i]</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>        <span class="n">images</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">crop_images_to_event</span><span class="p">(</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>            <span class="n">frame_images</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">in_pixels</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>        <span class="p">)</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>    <span class="k">return</span> <span class="n">images</span>
</span></pre></div>


            </section>
                <section id="Event">
                            <input id="Event-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Event</span>:

                <label class="view-source-button" for="Event-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Event"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Event-22"><a href="#Event-22"><span class="linenos"> 22</span></a><span class="k">class</span> <span class="nc">Event</span><span class="p">:</span>
</span><span id="Event-23"><a href="#Event-23"><span class="linenos"> 23</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event-24"><a href="#Event-24"><span class="linenos"> 24</span></a><span class="sd">    A class that represents a single event in a scan, making it easy to evaluate</span>
</span><span id="Event-25"><a href="#Event-25"><span class="linenos"> 25</span></a><span class="sd">    singular events. Required metadata is exposed as attributes, and optional</span>
</span><span id="Event-26"><a href="#Event-26"><span class="linenos"> 26</span></a><span class="sd">    metadata and features are stored as DataFrames.</span>
</span><span id="Event-27"><a href="#Event-27"><span class="linenos"> 27</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Event-28"><a href="#Event-28"><span class="linenos"> 28</span></a>
</span><span id="Event-29"><a href="#Event-29"><span class="linenos"> 29</span></a>    <span class="c1"># 2D homogenous transformation matrices</span>
</span><span id="Event-30"><a href="#Event-30"><span class="linenos"> 30</span></a>    <span class="c1"># Translations (final column) are in micrometers (um)</span>
</span><span id="Event-31"><a href="#Event-31"><span class="linenos"> 31</span></a>    <span class="n">SCAN_TO_SLIDE_TRANSFORM</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Event-32"><a href="#Event-32"><span class="linenos"> 32</span></a>        <span class="n">csi_scans</span><span class="o">.</span><span class="n">Scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="Event-33"><a href="#Event-33"><span class="linenos"> 33</span></a>            <span class="p">[</span>
</span><span id="Event-34"><a href="#Event-34"><span class="linenos"> 34</span></a>                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">75000</span><span class="p">],</span>
</span><span id="Event-35"><a href="#Event-35"><span class="linenos"> 35</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="Event-36"><a href="#Event-36"><span class="linenos"> 36</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="Event-37"><a href="#Event-37"><span class="linenos"> 37</span></a>            <span class="p">]</span>
</span><span id="Event-38"><a href="#Event-38"><span class="linenos"> 38</span></a>        <span class="p">),</span>
</span><span id="Event-39"><a href="#Event-39"><span class="linenos"> 39</span></a>        <span class="c1"># BZScanner coordinates are a special kind of messed up:</span>
</span><span id="Event-40"><a href="#Event-40"><span class="linenos"> 40</span></a>        <span class="c1"># - The slide is upside-down.</span>
</span><span id="Event-41"><a href="#Event-41"><span class="linenos"> 41</span></a>        <span class="c1"># - The slide is oriented vertically, with the barcode at the bottom.</span>
</span><span id="Event-42"><a href="#Event-42"><span class="linenos"> 42</span></a>        <span class="c1"># - Tiles are numbered from the top-right</span>
</span><span id="Event-43"><a href="#Event-43"><span class="linenos"> 43</span></a>        <span class="n">csi_scans</span><span class="o">.</span><span class="n">Scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="Event-44"><a href="#Event-44"><span class="linenos"> 44</span></a>            <span class="p">[</span>
</span><span id="Event-45"><a href="#Event-45"><span class="linenos"> 45</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">75000</span><span class="p">],</span>
</span><span id="Event-46"><a href="#Event-46"><span class="linenos"> 46</span></a>                <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">25000</span><span class="p">],</span>
</span><span id="Event-47"><a href="#Event-47"><span class="linenos"> 47</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="Event-48"><a href="#Event-48"><span class="linenos"> 48</span></a>            <span class="p">]</span>
</span><span id="Event-49"><a href="#Event-49"><span class="linenos"> 49</span></a>        <span class="p">),</span>
</span><span id="Event-50"><a href="#Event-50"><span class="linenos"> 50</span></a>    <span class="p">}</span>
</span><span id="Event-51"><a href="#Event-51"><span class="linenos"> 51</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event-52"><a href="#Event-52"><span class="linenos"> 52</span></a><span class="sd">    Homogeneous transformation matrices for converting between scanner and slide</span>
</span><span id="Event-53"><a href="#Event-53"><span class="linenos"> 53</span></a><span class="sd">    coordinates. The matrices are 3x3, with the final column representing the</span>
</span><span id="Event-54"><a href="#Event-54"><span class="linenos"> 54</span></a><span class="sd">    translation in micrometers (um). For more information, see </span>
</span><span id="Event-55"><a href="#Event-55"><span class="linenos"> 55</span></a><span class="sd">    [affine transformations](https://en.wikipedia.org/wiki/Transformation_matrix#Affine_transformations).</span>
</span><span id="Event-56"><a href="#Event-56"><span class="linenos"> 56</span></a><span class="sd">    </span>
</span><span id="Event-57"><a href="#Event-57"><span class="linenos"> 57</span></a><span class="sd">    Transformations are nominal, and accuracy is not guaranteed; this is due to </span>
</span><span id="Event-58"><a href="#Event-58"><span class="linenos"> 58</span></a><span class="sd">    imperfections in slides and alignment in the scanners. </span>
</span><span id="Event-59"><a href="#Event-59"><span class="linenos"> 59</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Event-60"><a href="#Event-60"><span class="linenos"> 60</span></a>
</span><span id="Event-61"><a href="#Event-61"><span class="linenos"> 61</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Event-62"><a href="#Event-62"><span class="linenos"> 62</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Event-63"><a href="#Event-63"><span class="linenos"> 63</span></a>        <span class="n">scan</span><span class="p">:</span> <span class="n">csi_scans</span><span class="o">.</span><span class="n">Scan</span><span class="p">,</span>
</span><span id="Event-64"><a href="#Event-64"><span class="linenos"> 64</span></a>        <span class="n">tile</span><span class="p">:</span> <span class="n">csi_tiles</span><span class="o">.</span><span class="n">Tile</span><span class="p">,</span>
</span><span id="Event-65"><a href="#Event-65"><span class="linenos"> 65</span></a>        <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="Event-66"><a href="#Event-66"><span class="linenos"> 66</span></a>        <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="Event-67"><a href="#Event-67"><span class="linenos"> 67</span></a>        <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>  <span class="c1"># End-to-end size in pixels</span>
</span><span id="Event-68"><a href="#Event-68"><span class="linenos"> 68</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Event-69"><a href="#Event-69"><span class="linenos"> 69</span></a>        <span class="n">features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Event-70"><a href="#Event-70"><span class="linenos"> 70</span></a>    <span class="p">):</span>
</span><span id="Event-71"><a href="#Event-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scan</span> <span class="o">=</span> <span class="n">scan</span>
</span><span id="Event-72"><a href="#Event-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile</span> <span class="o">=</span> <span class="n">tile</span>
</span><span id="Event-73"><a href="#Event-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="Event-74"><a href="#Event-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
</span><span id="Event-75"><a href="#Event-75"><span class="linenos"> 75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
</span><span id="Event-76"><a href="#Event-76"><span class="linenos"> 76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
</span><span id="Event-77"><a href="#Event-77"><span class="linenos"> 77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
</span><span id="Event-78"><a href="#Event-78"><span class="linenos"> 78</span></a>
</span><span id="Event-79"><a href="#Event-79"><span class="linenos"> 79</span></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Event-80"><a href="#Event-80"><span class="linenos"> 80</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Event-81"><a href="#Event-81"><span class="linenos"> 81</span></a>
</span><span id="Event-82"><a href="#Event-82"><span class="linenos"> 82</span></a>    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Event-83"><a href="#Event-83"><span class="linenos"> 83</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
</span><span id="Event-84"><a href="#Event-84"><span class="linenos"> 84</span></a>
</span><span id="Event-85"><a href="#Event-85"><span class="linenos"> 85</span></a>    <span class="k">def</span> <span class="nf">get_scan_position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Event-86"><a href="#Event-86"><span class="linenos"> 86</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event-87"><a href="#Event-87"><span class="linenos"> 87</span></a><span class="sd">        Get the position of the event in the scanner&#39;s coordinate frame.</span>
</span><span id="Event-88"><a href="#Event-88"><span class="linenos"> 88</span></a><span class="sd">        :return: the scan position of the event in micrometers (um).</span>
</span><span id="Event-89"><a href="#Event-89"><span class="linenos"> 89</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Event-90"><a href="#Event-90"><span class="linenos"> 90</span></a>        <span class="c1"># Get overall pixel position</span>
</span><span id="Event-91"><a href="#Event-91"><span class="linenos"> 91</span></a>        <span class="n">pixel_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</span><span id="Event-92"><a href="#Event-92"><span class="linenos"> 92</span></a>        <span class="n">pixel_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="Event-93"><a href="#Event-93"><span class="linenos"> 93</span></a>        <span class="c1"># Convert to micrometers</span>
</span><span id="Event-94"><a href="#Event-94"><span class="linenos"> 94</span></a>        <span class="n">x_um</span> <span class="o">=</span> <span class="n">pixel_x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span>
</span><span id="Event-95"><a href="#Event-95"><span class="linenos"> 95</span></a>        <span class="n">y_um</span> <span class="o">=</span> <span class="n">pixel_y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span>
</span><span id="Event-96"><a href="#Event-96"><span class="linenos"> 96</span></a>        <span class="c1"># Add the scan&#39;s origin in the scanner frame</span>
</span><span id="Event-97"><a href="#Event-97"><span class="linenos"> 97</span></a>        <span class="n">x_um</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n_roi</span><span class="p">]</span><span class="o">.</span><span class="n">origin_x_um</span>
</span><span id="Event-98"><a href="#Event-98"><span class="linenos"> 98</span></a>        <span class="n">y_um</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n_roi</span><span class="p">]</span><span class="o">.</span><span class="n">origin_y_um</span>
</span><span id="Event-99"><a href="#Event-99"><span class="linenos"> 99</span></a>        <span class="k">return</span> <span class="n">x_um</span><span class="p">,</span> <span class="n">y_um</span>
</span><span id="Event-100"><a href="#Event-100"><span class="linenos">100</span></a>
</span><span id="Event-101"><a href="#Event-101"><span class="linenos">101</span></a>    <span class="k">def</span> <span class="nf">get_slide_position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Event-102"><a href="#Event-102"><span class="linenos">102</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event-103"><a href="#Event-103"><span class="linenos">103</span></a><span class="sd">        Get the slide position of the event in micrometers (um).</span>
</span><span id="Event-104"><a href="#Event-104"><span class="linenos">104</span></a><span class="sd">        :return: the slide position of the event.</span>
</span><span id="Event-105"><a href="#Event-105"><span class="linenos">105</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Event-106"><a href="#Event-106"><span class="linenos">106</span></a>        <span class="c1"># Turn scan_position into a 3x1 vector</span>
</span><span id="Event-107"><a href="#Event-107"><span class="linenos">107</span></a>        <span class="n">scan_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scan_position</span><span class="p">()</span>
</span><span id="Event-108"><a href="#Event-108"><span class="linenos">108</span></a>        <span class="n">scan_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">scan_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">scan_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
</span><span id="Event-109"><a href="#Event-109"><span class="linenos">109</span></a>
</span><span id="Event-110"><a href="#Event-110"><span class="linenos">110</span></a>        <span class="c1"># Multiply by the appropriate homogeneous matrix</span>
</span><span id="Event-111"><a href="#Event-111"><span class="linenos">111</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
</span><span id="Event-112"><a href="#Event-112"><span class="linenos">112</span></a>            <span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SCAN_TO_SLIDE_TRANSFORM</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">]</span>
</span><span id="Event-113"><a href="#Event-113"><span class="linenos">113</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
</span><span id="Event-114"><a href="#Event-114"><span class="linenos">114</span></a>            <span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SCAN_TO_SLIDE_TRANSFORM</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">]</span>
</span><span id="Event-115"><a href="#Event-115"><span class="linenos">115</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Event-116"><a href="#Event-116"><span class="linenos">116</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scanner type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span><span class="si">}</span><span class="s2"> not supported.&quot;</span><span class="p">)</span>
</span><span id="Event-117"><a href="#Event-117"><span class="linenos">117</span></a>        <span class="n">slide_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">scan_position</span><span class="p">)</span>
</span><span id="Event-118"><a href="#Event-118"><span class="linenos">118</span></a>        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">slide_position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">slide_position</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Event-119"><a href="#Event-119"><span class="linenos">119</span></a>
</span><span id="Event-120"><a href="#Event-120"><span class="linenos">120</span></a>    <span class="k">def</span> <span class="nf">extract_images</span><span class="p">(</span>
</span><span id="Event-121"><a href="#Event-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Event-122"><a href="#Event-122"><span class="linenos">122</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="Event-123"><a href="#Event-123"><span class="linenos">123</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event-124"><a href="#Event-124"><span class="linenos">124</span></a><span class="sd">        Extract the images from the scan and tile, reading from the file. Called</span>
</span><span id="Event-125"><a href="#Event-125"><span class="linenos">125</span></a><span class="sd">        &quot;extract&quot; because it must read and extract the images from file, which is slow.</span>
</span><span id="Event-126"><a href="#Event-126"><span class="linenos">126</span></a><span class="sd">        Use this if you&#39;re interested in only a few events, as it is inefficient when</span>
</span><span id="Event-127"><a href="#Event-127"><span class="linenos">127</span></a><span class="sd">        reading multiple events from the same tile.</span>
</span><span id="Event-128"><a href="#Event-128"><span class="linenos">128</span></a><span class="sd">        :param crop_size: the square size of the image crop to get for this event. Defaults to 10um.</span>
</span><span id="Event-129"><a href="#Event-129"><span class="linenos">129</span></a><span class="sd">        :param in_pixels: whether the crop size is in pixels or micrometers. Defaults to um.</span>
</span><span id="Event-130"><a href="#Event-130"><span class="linenos">130</span></a><span class="sd">        :return: a list of cropped images from the scan in the order of the channels.</span>
</span><span id="Event-131"><a href="#Event-131"><span class="linenos">131</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Event-132"><a href="#Event-132"><span class="linenos">132</span></a>        <span class="n">frames</span> <span class="o">=</span> <span class="n">csi_frames</span><span class="o">.</span><span class="n">Frame</span><span class="o">.</span><span class="n">get_frames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="p">)</span>
</span><span id="Event-133"><a href="#Event-133"><span class="linenos">133</span></a>        <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">get_image</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">]</span>
</span><span id="Event-134"><a href="#Event-134"><span class="linenos">134</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_images</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="n">in_pixels</span><span class="p">)</span>
</span><span id="Event-135"><a href="#Event-135"><span class="linenos">135</span></a>
</span><span id="Event-136"><a href="#Event-136"><span class="linenos">136</span></a>    <span class="k">def</span> <span class="nf">crop_images</span><span class="p">(</span>
</span><span id="Event-137"><a href="#Event-137"><span class="linenos">137</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">crop_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Event-138"><a href="#Event-138"><span class="linenos">138</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="Event-139"><a href="#Event-139"><span class="linenos">139</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event-140"><a href="#Event-140"><span class="linenos">140</span></a><span class="sd">        Get the event crops from the frame images. Called &quot;get&quot; because it does not</span>
</span><span id="Event-141"><a href="#Event-141"><span class="linenos">141</span></a><span class="sd">        need to extract anything; it is very quick for extracting multiple events from</span>
</span><span id="Event-142"><a href="#Event-142"><span class="linenos">142</span></a><span class="sd">        the same tile.</span>
</span><span id="Event-143"><a href="#Event-143"><span class="linenos">143</span></a><span class="sd">        Use this if you&#39;re interested in many events.</span>
</span><span id="Event-144"><a href="#Event-144"><span class="linenos">144</span></a><span class="sd">        :param images: the frame images.</span>
</span><span id="Event-145"><a href="#Event-145"><span class="linenos">145</span></a><span class="sd">        :param crop_size: the square size of the image crop to get for this event. Defaults to 10um.</span>
</span><span id="Event-146"><a href="#Event-146"><span class="linenos">146</span></a><span class="sd">        :param in_pixels: whether the crop size is in pixels or micrometers. Defaults to um.</span>
</span><span id="Event-147"><a href="#Event-147"><span class="linenos">147</span></a><span class="sd">        :return: image_size x image_size crops of the event in the provided frames. If</span>
</span><span id="Event-148"><a href="#Event-148"><span class="linenos">148</span></a><span class="sd">        the event is too close to the edge, the crop will be smaller and not centered.</span>
</span><span id="Event-149"><a href="#Event-149"><span class="linenos">149</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Event-150"><a href="#Event-150"><span class="linenos">150</span></a>        <span class="c1"># Convert a crop size in micrometers to pixels</span>
</span><span id="Event-151"><a href="#Event-151"><span class="linenos">151</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_pixels</span><span class="p">:</span>
</span><span id="Event-152"><a href="#Event-152"><span class="linenos">152</span></a>            <span class="n">crop_size</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">crop_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span><span class="p">)</span>
</span><span id="Event-153"><a href="#Event-153"><span class="linenos">153</span></a>        <span class="c1"># Find the crop bounds</span>
</span><span id="Event-154"><a href="#Event-154"><span class="linenos">154</span></a>        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Event-155"><a href="#Event-155"><span class="linenos">155</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="Event-156"><a href="#Event-156"><span class="linenos">156</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="Event-157"><a href="#Event-157"><span class="linenos">157</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">crop_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Event-158"><a href="#Event-158"><span class="linenos">158</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">crop_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Event-159"><a href="#Event-159"><span class="linenos">159</span></a>        <span class="p">]</span>
</span><span id="Event-160"><a href="#Event-160"><span class="linenos">160</span></a>        <span class="c1"># Determine how much the bounds violate the image size</span>
</span><span id="Event-161"><a href="#Event-161"><span class="linenos">161</span></a>        <span class="n">displacements</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Event-162"><a href="#Event-162"><span class="linenos">162</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="Event-163"><a href="#Event-163"><span class="linenos">163</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="Event-164"><a href="#Event-164"><span class="linenos">164</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="Event-165"><a href="#Event-165"><span class="linenos">165</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="Event-166"><a href="#Event-166"><span class="linenos">166</span></a>        <span class="p">]</span>
</span><span id="Event-167"><a href="#Event-167"><span class="linenos">167</span></a>        <span class="c1"># Cap off the bounds</span>
</span><span id="Event-168"><a href="#Event-168"><span class="linenos">168</span></a>        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Event-169"><a href="#Event-169"><span class="linenos">169</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="Event-170"><a href="#Event-170"><span class="linenos">170</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="Event-171"><a href="#Event-171"><span class="linenos">171</span></a>            <span class="nb">min</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="Event-172"><a href="#Event-172"><span class="linenos">172</span></a>            <span class="nb">min</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="Event-173"><a href="#Event-173"><span class="linenos">173</span></a>        <span class="p">]</span>
</span><span id="Event-174"><a href="#Event-174"><span class="linenos">174</span></a>
</span><span id="Event-175"><a href="#Event-175"><span class="linenos">175</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)):</span>
</span><span id="Event-176"><a href="#Event-176"><span class="linenos">176</span></a>            <span class="c1"># Create a blank image of the right size</span>
</span><span id="Event-177"><a href="#Event-177"><span class="linenos">177</span></a>            <span class="n">cropped_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">crop_size</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="Event-178"><a href="#Event-178"><span class="linenos">178</span></a>
</span><span id="Event-179"><a href="#Event-179"><span class="linenos">179</span></a>            <span class="c1"># Insert the cropped image into the blank image, leaving a black buffer</span>
</span><span id="Event-180"><a href="#Event-180"><span class="linenos">180</span></a>            <span class="c1"># around the edges if the crop would go beyond the original image bounds</span>
</span><span id="Event-181"><a href="#Event-181"><span class="linenos">181</span></a>            <span class="n">cropped_image</span><span class="p">[</span>
</span><span id="Event-182"><a href="#Event-182"><span class="linenos">182</span></a>                <span class="n">displacements</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">crop_size</span> <span class="o">-</span> <span class="n">displacements</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span id="Event-183"><a href="#Event-183"><span class="linenos">183</span></a>                <span class="n">displacements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">crop_size</span> <span class="o">-</span> <span class="n">displacements</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="Event-184"><a href="#Event-184"><span class="linenos">184</span></a>            <span class="p">]</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
</span><span id="Event-185"><a href="#Event-185"><span class="linenos">185</span></a>            <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cropped_image</span>
</span><span id="Event-186"><a href="#Event-186"><span class="linenos">186</span></a>        <span class="k">return</span> <span class="n">images</span>
</span></pre></div>


            <div class="docstring"><p>A class that represents a single event in a scan, making it easy to evaluate
singular events. Required metadata is exposed as attributes, and optional
metadata and features are stored as DataFrames.</p>
</div>


                            <div id="Event.__init__" class="classattr">
                                        <input id="Event.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Event</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">scan</span><span class="p">:</span> <span class="n"><a href="csi_scans.html#Scan">csi_images.csi_scans.Scan</a></span>,</span><span class="param">	<span class="n">tile</span><span class="p">:</span> <span class="n"><a href="csi_tiles.html#Tile">csi_images.csi_tiles.Tile</a></span>,</span><span class="param">	<span class="n">x</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">y</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">metadata</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">features</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="Event.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Event.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Event.__init__-61"><a href="#Event.__init__-61"><span class="linenos">61</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Event.__init__-62"><a href="#Event.__init__-62"><span class="linenos">62</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Event.__init__-63"><a href="#Event.__init__-63"><span class="linenos">63</span></a>        <span class="n">scan</span><span class="p">:</span> <span class="n">csi_scans</span><span class="o">.</span><span class="n">Scan</span><span class="p">,</span>
</span><span id="Event.__init__-64"><a href="#Event.__init__-64"><span class="linenos">64</span></a>        <span class="n">tile</span><span class="p">:</span> <span class="n">csi_tiles</span><span class="o">.</span><span class="n">Tile</span><span class="p">,</span>
</span><span id="Event.__init__-65"><a href="#Event.__init__-65"><span class="linenos">65</span></a>        <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="Event.__init__-66"><a href="#Event.__init__-66"><span class="linenos">66</span></a>        <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="Event.__init__-67"><a href="#Event.__init__-67"><span class="linenos">67</span></a>        <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>  <span class="c1"># End-to-end size in pixels</span>
</span><span id="Event.__init__-68"><a href="#Event.__init__-68"><span class="linenos">68</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Event.__init__-69"><a href="#Event.__init__-69"><span class="linenos">69</span></a>        <span class="n">features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Event.__init__-70"><a href="#Event.__init__-70"><span class="linenos">70</span></a>    <span class="p">):</span>
</span><span id="Event.__init__-71"><a href="#Event.__init__-71"><span class="linenos">71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scan</span> <span class="o">=</span> <span class="n">scan</span>
</span><span id="Event.__init__-72"><a href="#Event.__init__-72"><span class="linenos">72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile</span> <span class="o">=</span> <span class="n">tile</span>
</span><span id="Event.__init__-73"><a href="#Event.__init__-73"><span class="linenos">73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="Event.__init__-74"><a href="#Event.__init__-74"><span class="linenos">74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
</span><span id="Event.__init__-75"><a href="#Event.__init__-75"><span class="linenos">75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
</span><span id="Event.__init__-76"><a href="#Event.__init__-76"><span class="linenos">76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
</span><span id="Event.__init__-77"><a href="#Event.__init__-77"><span class="linenos">77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
</span></pre></div>


    

                            </div>
                            <div id="Event.SCAN_TO_SLIDE_TRANSFORM" class="classattr">
                                <div class="attr variable">
            <span class="name">SCAN_TO_SLIDE_TRANSFORM</span>        =
<input id="Event.SCAN_TO_SLIDE_TRANSFORM-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="Event.SCAN_TO_SLIDE_TRANSFORM-view-value"></label><span class="default_value">{&lt;Type.AXIOSCAN7: &#39;axioscan7&#39;&gt;: array([[    1,     0, 75000],
       [    0,     1,     0],
       [    0,     0,     1]]), &lt;Type.BZSCANNER: &#39;bzscanner&#39;&gt;: array([[    0,    -1, 75000],
       [   -1,     0, 25000],
       [    0,     0,     1]])}</span>

        
    </div>
    <a class="headerlink" href="#Event.SCAN_TO_SLIDE_TRANSFORM"></a>
    
            <div class="docstring"><p>Homogeneous transformation matrices for converting between scanner and slide
coordinates. The matrices are 3x3, with the final column representing the
translation in micrometers (um). For more information, see 
<a href="https://en.wikipedia.org/wiki/Transformation_matrix#Affine_transformations">affine transformations</a>.</p>

<p>Transformations are nominal, and accuracy is not guaranteed; this is due to 
imperfections in slides and alignment in the scanners.</p>
</div>


                            </div>
                            <div id="Event.scan" class="classattr">
                                <div class="attr variable">
            <span class="name">scan</span>

        
    </div>
    <a class="headerlink" href="#Event.scan"></a>
    
    

                            </div>
                            <div id="Event.tile" class="classattr">
                                <div class="attr variable">
            <span class="name">tile</span>

        
    </div>
    <a class="headerlink" href="#Event.tile"></a>
    
    

                            </div>
                            <div id="Event.x" class="classattr">
                                <div class="attr variable">
            <span class="name">x</span>

        
    </div>
    <a class="headerlink" href="#Event.x"></a>
    
    

                            </div>
                            <div id="Event.y" class="classattr">
                                <div class="attr variable">
            <span class="name">y</span>

        
    </div>
    <a class="headerlink" href="#Event.y"></a>
    
    

                            </div>
                            <div id="Event.size" class="classattr">
                                <div class="attr variable">
            <span class="name">size</span>

        
    </div>
    <a class="headerlink" href="#Event.size"></a>
    
    

                            </div>
                            <div id="Event.metadata" class="classattr">
                                <div class="attr variable">
            <span class="name">metadata</span>

        
    </div>
    <a class="headerlink" href="#Event.metadata"></a>
    
    

                            </div>
                            <div id="Event.features" class="classattr">
                                <div class="attr variable">
            <span class="name">features</span>

        
    </div>
    <a class="headerlink" href="#Event.features"></a>
    
    

                            </div>
                            <div id="Event.get_scan_position" class="classattr">
                                        <input id="Event.get_scan_position-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_scan_position</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Event.get_scan_position-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Event.get_scan_position"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Event.get_scan_position-85"><a href="#Event.get_scan_position-85"><span class="linenos">85</span></a>    <span class="k">def</span> <span class="nf">get_scan_position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Event.get_scan_position-86"><a href="#Event.get_scan_position-86"><span class="linenos">86</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event.get_scan_position-87"><a href="#Event.get_scan_position-87"><span class="linenos">87</span></a><span class="sd">        Get the position of the event in the scanner&#39;s coordinate frame.</span>
</span><span id="Event.get_scan_position-88"><a href="#Event.get_scan_position-88"><span class="linenos">88</span></a><span class="sd">        :return: the scan position of the event in micrometers (um).</span>
</span><span id="Event.get_scan_position-89"><a href="#Event.get_scan_position-89"><span class="linenos">89</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Event.get_scan_position-90"><a href="#Event.get_scan_position-90"><span class="linenos">90</span></a>        <span class="c1"># Get overall pixel position</span>
</span><span id="Event.get_scan_position-91"><a href="#Event.get_scan_position-91"><span class="linenos">91</span></a>        <span class="n">pixel_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</span><span id="Event.get_scan_position-92"><a href="#Event.get_scan_position-92"><span class="linenos">92</span></a>        <span class="n">pixel_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="Event.get_scan_position-93"><a href="#Event.get_scan_position-93"><span class="linenos">93</span></a>        <span class="c1"># Convert to micrometers</span>
</span><span id="Event.get_scan_position-94"><a href="#Event.get_scan_position-94"><span class="linenos">94</span></a>        <span class="n">x_um</span> <span class="o">=</span> <span class="n">pixel_x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span>
</span><span id="Event.get_scan_position-95"><a href="#Event.get_scan_position-95"><span class="linenos">95</span></a>        <span class="n">y_um</span> <span class="o">=</span> <span class="n">pixel_y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span>
</span><span id="Event.get_scan_position-96"><a href="#Event.get_scan_position-96"><span class="linenos">96</span></a>        <span class="c1"># Add the scan&#39;s origin in the scanner frame</span>
</span><span id="Event.get_scan_position-97"><a href="#Event.get_scan_position-97"><span class="linenos">97</span></a>        <span class="n">x_um</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n_roi</span><span class="p">]</span><span class="o">.</span><span class="n">origin_x_um</span>
</span><span id="Event.get_scan_position-98"><a href="#Event.get_scan_position-98"><span class="linenos">98</span></a>        <span class="n">y_um</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n_roi</span><span class="p">]</span><span class="o">.</span><span class="n">origin_y_um</span>
</span><span id="Event.get_scan_position-99"><a href="#Event.get_scan_position-99"><span class="linenos">99</span></a>        <span class="k">return</span> <span class="n">x_um</span><span class="p">,</span> <span class="n">y_um</span>
</span></pre></div>


            <div class="docstring"><p>Get the position of the event in the scanner's coordinate frame.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>the scan position of the event in micrometers (um).</p>
</blockquote>
</div>


                            </div>
                            <div id="Event.get_slide_position" class="classattr">
                                        <input id="Event.get_slide_position-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_slide_position</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Event.get_slide_position-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Event.get_slide_position"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Event.get_slide_position-101"><a href="#Event.get_slide_position-101"><span class="linenos">101</span></a>    <span class="k">def</span> <span class="nf">get_slide_position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Event.get_slide_position-102"><a href="#Event.get_slide_position-102"><span class="linenos">102</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event.get_slide_position-103"><a href="#Event.get_slide_position-103"><span class="linenos">103</span></a><span class="sd">        Get the slide position of the event in micrometers (um).</span>
</span><span id="Event.get_slide_position-104"><a href="#Event.get_slide_position-104"><span class="linenos">104</span></a><span class="sd">        :return: the slide position of the event.</span>
</span><span id="Event.get_slide_position-105"><a href="#Event.get_slide_position-105"><span class="linenos">105</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Event.get_slide_position-106"><a href="#Event.get_slide_position-106"><span class="linenos">106</span></a>        <span class="c1"># Turn scan_position into a 3x1 vector</span>
</span><span id="Event.get_slide_position-107"><a href="#Event.get_slide_position-107"><span class="linenos">107</span></a>        <span class="n">scan_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scan_position</span><span class="p">()</span>
</span><span id="Event.get_slide_position-108"><a href="#Event.get_slide_position-108"><span class="linenos">108</span></a>        <span class="n">scan_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">scan_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">scan_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
</span><span id="Event.get_slide_position-109"><a href="#Event.get_slide_position-109"><span class="linenos">109</span></a>
</span><span id="Event.get_slide_position-110"><a href="#Event.get_slide_position-110"><span class="linenos">110</span></a>        <span class="c1"># Multiply by the appropriate homogeneous matrix</span>
</span><span id="Event.get_slide_position-111"><a href="#Event.get_slide_position-111"><span class="linenos">111</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
</span><span id="Event.get_slide_position-112"><a href="#Event.get_slide_position-112"><span class="linenos">112</span></a>            <span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SCAN_TO_SLIDE_TRANSFORM</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">]</span>
</span><span id="Event.get_slide_position-113"><a href="#Event.get_slide_position-113"><span class="linenos">113</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
</span><span id="Event.get_slide_position-114"><a href="#Event.get_slide_position-114"><span class="linenos">114</span></a>            <span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SCAN_TO_SLIDE_TRANSFORM</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">]</span>
</span><span id="Event.get_slide_position-115"><a href="#Event.get_slide_position-115"><span class="linenos">115</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Event.get_slide_position-116"><a href="#Event.get_slide_position-116"><span class="linenos">116</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scanner type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span><span class="si">}</span><span class="s2"> not supported.&quot;</span><span class="p">)</span>
</span><span id="Event.get_slide_position-117"><a href="#Event.get_slide_position-117"><span class="linenos">117</span></a>        <span class="n">slide_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">scan_position</span><span class="p">)</span>
</span><span id="Event.get_slide_position-118"><a href="#Event.get_slide_position-118"><span class="linenos">118</span></a>        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">slide_position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">slide_position</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Get the slide position of the event in micrometers (um).</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>the slide position of the event.</p>
</blockquote>
</div>


                            </div>
                            <div id="Event.extract_images" class="classattr">
                                        <input id="Event.extract_images-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">extract_images</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">crop_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Event.extract_images-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Event.extract_images"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Event.extract_images-120"><a href="#Event.extract_images-120"><span class="linenos">120</span></a>    <span class="k">def</span> <span class="nf">extract_images</span><span class="p">(</span>
</span><span id="Event.extract_images-121"><a href="#Event.extract_images-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Event.extract_images-122"><a href="#Event.extract_images-122"><span class="linenos">122</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="Event.extract_images-123"><a href="#Event.extract_images-123"><span class="linenos">123</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event.extract_images-124"><a href="#Event.extract_images-124"><span class="linenos">124</span></a><span class="sd">        Extract the images from the scan and tile, reading from the file. Called</span>
</span><span id="Event.extract_images-125"><a href="#Event.extract_images-125"><span class="linenos">125</span></a><span class="sd">        &quot;extract&quot; because it must read and extract the images from file, which is slow.</span>
</span><span id="Event.extract_images-126"><a href="#Event.extract_images-126"><span class="linenos">126</span></a><span class="sd">        Use this if you&#39;re interested in only a few events, as it is inefficient when</span>
</span><span id="Event.extract_images-127"><a href="#Event.extract_images-127"><span class="linenos">127</span></a><span class="sd">        reading multiple events from the same tile.</span>
</span><span id="Event.extract_images-128"><a href="#Event.extract_images-128"><span class="linenos">128</span></a><span class="sd">        :param crop_size: the square size of the image crop to get for this event. Defaults to 10um.</span>
</span><span id="Event.extract_images-129"><a href="#Event.extract_images-129"><span class="linenos">129</span></a><span class="sd">        :param in_pixels: whether the crop size is in pixels or micrometers. Defaults to um.</span>
</span><span id="Event.extract_images-130"><a href="#Event.extract_images-130"><span class="linenos">130</span></a><span class="sd">        :return: a list of cropped images from the scan in the order of the channels.</span>
</span><span id="Event.extract_images-131"><a href="#Event.extract_images-131"><span class="linenos">131</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Event.extract_images-132"><a href="#Event.extract_images-132"><span class="linenos">132</span></a>        <span class="n">frames</span> <span class="o">=</span> <span class="n">csi_frames</span><span class="o">.</span><span class="n">Frame</span><span class="o">.</span><span class="n">get_frames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile</span><span class="p">)</span>
</span><span id="Event.extract_images-133"><a href="#Event.extract_images-133"><span class="linenos">133</span></a>        <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">get_image</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">]</span>
</span><span id="Event.extract_images-134"><a href="#Event.extract_images-134"><span class="linenos">134</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_images</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="n">in_pixels</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Extract the images from the scan and tile, reading from the file. Called
"extract" because it must read and extract the images from file, which is slow.
Use this if you're interested in only a few events, as it is inefficient when
reading multiple events from the same tile.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>crop_size</strong>:  the square size of the image crop to get for this event. Defaults to 10um.</li>
<li><strong>in_pixels</strong>:  whether the crop size is in pixels or micrometers. Defaults to um.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a list of cropped images from the scan in the order of the channels.</p>
</blockquote>
</div>


                            </div>
                            <div id="Event.crop_images" class="classattr">
                                        <input id="Event.crop_images-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">crop_images</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">images</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>,</span><span class="param">	<span class="n">crop_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Event.crop_images-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Event.crop_images"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Event.crop_images-136"><a href="#Event.crop_images-136"><span class="linenos">136</span></a>    <span class="k">def</span> <span class="nf">crop_images</span><span class="p">(</span>
</span><span id="Event.crop_images-137"><a href="#Event.crop_images-137"><span class="linenos">137</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">crop_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Event.crop_images-138"><a href="#Event.crop_images-138"><span class="linenos">138</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="Event.crop_images-139"><a href="#Event.crop_images-139"><span class="linenos">139</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Event.crop_images-140"><a href="#Event.crop_images-140"><span class="linenos">140</span></a><span class="sd">        Get the event crops from the frame images. Called &quot;get&quot; because it does not</span>
</span><span id="Event.crop_images-141"><a href="#Event.crop_images-141"><span class="linenos">141</span></a><span class="sd">        need to extract anything; it is very quick for extracting multiple events from</span>
</span><span id="Event.crop_images-142"><a href="#Event.crop_images-142"><span class="linenos">142</span></a><span class="sd">        the same tile.</span>
</span><span id="Event.crop_images-143"><a href="#Event.crop_images-143"><span class="linenos">143</span></a><span class="sd">        Use this if you&#39;re interested in many events.</span>
</span><span id="Event.crop_images-144"><a href="#Event.crop_images-144"><span class="linenos">144</span></a><span class="sd">        :param images: the frame images.</span>
</span><span id="Event.crop_images-145"><a href="#Event.crop_images-145"><span class="linenos">145</span></a><span class="sd">        :param crop_size: the square size of the image crop to get for this event. Defaults to 10um.</span>
</span><span id="Event.crop_images-146"><a href="#Event.crop_images-146"><span class="linenos">146</span></a><span class="sd">        :param in_pixels: whether the crop size is in pixels or micrometers. Defaults to um.</span>
</span><span id="Event.crop_images-147"><a href="#Event.crop_images-147"><span class="linenos">147</span></a><span class="sd">        :return: image_size x image_size crops of the event in the provided frames. If</span>
</span><span id="Event.crop_images-148"><a href="#Event.crop_images-148"><span class="linenos">148</span></a><span class="sd">        the event is too close to the edge, the crop will be smaller and not centered.</span>
</span><span id="Event.crop_images-149"><a href="#Event.crop_images-149"><span class="linenos">149</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Event.crop_images-150"><a href="#Event.crop_images-150"><span class="linenos">150</span></a>        <span class="c1"># Convert a crop size in micrometers to pixels</span>
</span><span id="Event.crop_images-151"><a href="#Event.crop_images-151"><span class="linenos">151</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_pixels</span><span class="p">:</span>
</span><span id="Event.crop_images-152"><a href="#Event.crop_images-152"><span class="linenos">152</span></a>            <span class="n">crop_size</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">crop_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span><span class="p">)</span>
</span><span id="Event.crop_images-153"><a href="#Event.crop_images-153"><span class="linenos">153</span></a>        <span class="c1"># Find the crop bounds</span>
</span><span id="Event.crop_images-154"><a href="#Event.crop_images-154"><span class="linenos">154</span></a>        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Event.crop_images-155"><a href="#Event.crop_images-155"><span class="linenos">155</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="Event.crop_images-156"><a href="#Event.crop_images-156"><span class="linenos">156</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="Event.crop_images-157"><a href="#Event.crop_images-157"><span class="linenos">157</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">crop_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Event.crop_images-158"><a href="#Event.crop_images-158"><span class="linenos">158</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">crop_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Event.crop_images-159"><a href="#Event.crop_images-159"><span class="linenos">159</span></a>        <span class="p">]</span>
</span><span id="Event.crop_images-160"><a href="#Event.crop_images-160"><span class="linenos">160</span></a>        <span class="c1"># Determine how much the bounds violate the image size</span>
</span><span id="Event.crop_images-161"><a href="#Event.crop_images-161"><span class="linenos">161</span></a>        <span class="n">displacements</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Event.crop_images-162"><a href="#Event.crop_images-162"><span class="linenos">162</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="Event.crop_images-163"><a href="#Event.crop_images-163"><span class="linenos">163</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="Event.crop_images-164"><a href="#Event.crop_images-164"><span class="linenos">164</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="Event.crop_images-165"><a href="#Event.crop_images-165"><span class="linenos">165</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="Event.crop_images-166"><a href="#Event.crop_images-166"><span class="linenos">166</span></a>        <span class="p">]</span>
</span><span id="Event.crop_images-167"><a href="#Event.crop_images-167"><span class="linenos">167</span></a>        <span class="c1"># Cap off the bounds</span>
</span><span id="Event.crop_images-168"><a href="#Event.crop_images-168"><span class="linenos">168</span></a>        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Event.crop_images-169"><a href="#Event.crop_images-169"><span class="linenos">169</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="Event.crop_images-170"><a href="#Event.crop_images-170"><span class="linenos">170</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="Event.crop_images-171"><a href="#Event.crop_images-171"><span class="linenos">171</span></a>            <span class="nb">min</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="Event.crop_images-172"><a href="#Event.crop_images-172"><span class="linenos">172</span></a>            <span class="nb">min</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="Event.crop_images-173"><a href="#Event.crop_images-173"><span class="linenos">173</span></a>        <span class="p">]</span>
</span><span id="Event.crop_images-174"><a href="#Event.crop_images-174"><span class="linenos">174</span></a>
</span><span id="Event.crop_images-175"><a href="#Event.crop_images-175"><span class="linenos">175</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)):</span>
</span><span id="Event.crop_images-176"><a href="#Event.crop_images-176"><span class="linenos">176</span></a>            <span class="c1"># Create a blank image of the right size</span>
</span><span id="Event.crop_images-177"><a href="#Event.crop_images-177"><span class="linenos">177</span></a>            <span class="n">cropped_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">crop_size</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="Event.crop_images-178"><a href="#Event.crop_images-178"><span class="linenos">178</span></a>
</span><span id="Event.crop_images-179"><a href="#Event.crop_images-179"><span class="linenos">179</span></a>            <span class="c1"># Insert the cropped image into the blank image, leaving a black buffer</span>
</span><span id="Event.crop_images-180"><a href="#Event.crop_images-180"><span class="linenos">180</span></a>            <span class="c1"># around the edges if the crop would go beyond the original image bounds</span>
</span><span id="Event.crop_images-181"><a href="#Event.crop_images-181"><span class="linenos">181</span></a>            <span class="n">cropped_image</span><span class="p">[</span>
</span><span id="Event.crop_images-182"><a href="#Event.crop_images-182"><span class="linenos">182</span></a>                <span class="n">displacements</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">crop_size</span> <span class="o">-</span> <span class="n">displacements</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span id="Event.crop_images-183"><a href="#Event.crop_images-183"><span class="linenos">183</span></a>                <span class="n">displacements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">crop_size</span> <span class="o">-</span> <span class="n">displacements</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="Event.crop_images-184"><a href="#Event.crop_images-184"><span class="linenos">184</span></a>            <span class="p">]</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
</span><span id="Event.crop_images-185"><a href="#Event.crop_images-185"><span class="linenos">185</span></a>            <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cropped_image</span>
</span><span id="Event.crop_images-186"><a href="#Event.crop_images-186"><span class="linenos">186</span></a>        <span class="k">return</span> <span class="n">images</span>
</span></pre></div>


            <div class="docstring"><p>Get the event crops from the frame images. Called "get" because it does not
need to extract anything; it is very quick for extracting multiple events from
the same tile.
Use this if you're interested in many events.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>images</strong>:  the frame images.</li>
<li><strong>crop_size</strong>:  the square size of the image crop to get for this event. Defaults to 10um.</li>
<li><strong>in_pixels</strong>:  whether the crop size is in pixels or micrometers. Defaults to um.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>image_size x image_size crops of the event in the provided frames. If
  the event is too close to the edge, the crop will be smaller and not centered.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="EventArray">
                            <input id="EventArray-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">EventArray</span>:

                <label class="view-source-button" for="EventArray-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray-189"><a href="#EventArray-189"><span class="linenos">189</span></a><span class="k">class</span> <span class="nc">EventArray</span><span class="p">:</span>
</span><span id="EventArray-190"><a href="#EventArray-190"><span class="linenos">190</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-191"><a href="#EventArray-191"><span class="linenos">191</span></a><span class="sd">    A class that holds a large number of events&#39; data, making it easy to analyze and</span>
</span><span id="EventArray-192"><a href="#EventArray-192"><span class="linenos">192</span></a><span class="sd">    manipulate many events at once. A more separated version of the Event class.</span>
</span><span id="EventArray-193"><a href="#EventArray-193"><span class="linenos">193</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="EventArray-194"><a href="#EventArray-194"><span class="linenos">194</span></a>
</span><span id="EventArray-195"><a href="#EventArray-195"><span class="linenos">195</span></a>    <span class="n">INFO_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">,</span> <span class="s2">&quot;tile&quot;</span><span class="p">,</span> <span class="s2">&quot;roi&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">]</span>
</span><span id="EventArray-196"><a href="#EventArray-196"><span class="linenos">196</span></a>
</span><span id="EventArray-197"><a href="#EventArray-197"><span class="linenos">197</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="EventArray-198"><a href="#EventArray-198"><span class="linenos">198</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="EventArray-199"><a href="#EventArray-199"><span class="linenos">199</span></a>        <span class="n">info</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EventArray-200"><a href="#EventArray-200"><span class="linenos">200</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EventArray-201"><a href="#EventArray-201"><span class="linenos">201</span></a>        <span class="n">features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EventArray-202"><a href="#EventArray-202"><span class="linenos">202</span></a>    <span class="p">):</span>
</span><span id="EventArray-203"><a href="#EventArray-203"><span class="linenos">203</span></a>        <span class="c1"># Info must be a DataFrame with columns &quot;slide_id&quot;, &quot;tile&quot;, &quot;roi&quot;, &quot;x&quot;, &quot;y&quot;, &quot;size&quot;</span>
</span><span id="EventArray-204"><a href="#EventArray-204"><span class="linenos">204</span></a>        <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="EventArray-205"><a href="#EventArray-205"><span class="linenos">205</span></a>            <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">INFO_COLUMNS</span><span class="p">)</span>
</span><span id="EventArray-206"><a href="#EventArray-206"><span class="linenos">206</span></a>            <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span>
</span><span id="EventArray-207"><a href="#EventArray-207"><span class="linenos">207</span></a>        <span class="p">):</span>
</span><span id="EventArray-208"><a href="#EventArray-208"><span class="linenos">208</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="EventArray-209"><a href="#EventArray-209"><span class="linenos">209</span></a>                <span class="s2">&quot;EventArray.info must have columns &#39;slide_id&#39;, &#39;tile&#39;, &#39;roi&#39;, &#39;x&#39;, &#39;y&#39;, &#39;size&#39;&quot;</span>
</span><span id="EventArray-210"><a href="#EventArray-210"><span class="linenos">210</span></a>            <span class="p">)</span>
</span><span id="EventArray-211"><a href="#EventArray-211"><span class="linenos">211</span></a>        <span class="c1"># All DataFrames must all have the same number of rows</span>
</span><span id="EventArray-212"><a href="#EventArray-212"><span class="linenos">212</span></a>        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="p">)):</span>
</span><span id="EventArray-213"><a href="#EventArray-213"><span class="linenos">213</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="EventArray-214"><a href="#EventArray-214"><span class="linenos">214</span></a>                <span class="s2">&quot;If EventArray.metadata is not None, it should match rows with .info&quot;</span>
</span><span id="EventArray-215"><a href="#EventArray-215"><span class="linenos">215</span></a>            <span class="p">)</span>
</span><span id="EventArray-216"><a href="#EventArray-216"><span class="linenos">216</span></a>        <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)):</span>
</span><span id="EventArray-217"><a href="#EventArray-217"><span class="linenos">217</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="EventArray-218"><a href="#EventArray-218"><span class="linenos">218</span></a>                <span class="s2">&quot;If EventArray.features is not None, it should match rows with .info&quot;</span>
</span><span id="EventArray-219"><a href="#EventArray-219"><span class="linenos">219</span></a>            <span class="p">)</span>
</span><span id="EventArray-220"><a href="#EventArray-220"><span class="linenos">220</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
</span><span id="EventArray-221"><a href="#EventArray-221"><span class="linenos">221</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
</span><span id="EventArray-222"><a href="#EventArray-222"><span class="linenos">222</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
</span><span id="EventArray-223"><a href="#EventArray-223"><span class="linenos">223</span></a>
</span><span id="EventArray-224"><a href="#EventArray-224"><span class="linenos">224</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="EventArray-225"><a href="#EventArray-225"><span class="linenos">225</span></a>        <span class="c1"># Convenience method to get the number of events</span>
</span><span id="EventArray-226"><a href="#EventArray-226"><span class="linenos">226</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-227"><a href="#EventArray-227"><span class="linenos">227</span></a>            <span class="k">return</span> <span class="mi">0</span>
</span><span id="EventArray-228"><a href="#EventArray-228"><span class="linenos">228</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-229"><a href="#EventArray-229"><span class="linenos">229</span></a>            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
</span><span id="EventArray-230"><a href="#EventArray-230"><span class="linenos">230</span></a>
</span><span id="EventArray-231"><a href="#EventArray-231"><span class="linenos">231</span></a>    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="EventArray-232"><a href="#EventArray-232"><span class="linenos">232</span></a>        <span class="n">is_equal</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="EventArray-233"><a href="#EventArray-233"><span class="linenos">233</span></a>        <span class="c1"># Parse all possibilities for info</span>
</span><span id="EventArray-234"><a href="#EventArray-234"><span class="linenos">234</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="EventArray-235"><a href="#EventArray-235"><span class="linenos">235</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="EventArray-236"><a href="#EventArray-236"><span class="linenos">236</span></a>                <span class="n">is_equal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
</span><span id="EventArray-237"><a href="#EventArray-237"><span class="linenos">237</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_equal</span><span class="p">:</span>
</span><span id="EventArray-238"><a href="#EventArray-238"><span class="linenos">238</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="EventArray-239"><a href="#EventArray-239"><span class="linenos">239</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-240"><a href="#EventArray-240"><span class="linenos">240</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="EventArray-241"><a href="#EventArray-241"><span class="linenos">241</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-242"><a href="#EventArray-242"><span class="linenos">242</span></a>            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-243"><a href="#EventArray-243"><span class="linenos">243</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="EventArray-244"><a href="#EventArray-244"><span class="linenos">244</span></a>
</span><span id="EventArray-245"><a href="#EventArray-245"><span class="linenos">245</span></a>        <span class="c1"># Parse all possibilities for metadata</span>
</span><span id="EventArray-246"><a href="#EventArray-246"><span class="linenos">246</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="EventArray-247"><a href="#EventArray-247"><span class="linenos">247</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="EventArray-248"><a href="#EventArray-248"><span class="linenos">248</span></a>                <span class="n">is_equal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
</span><span id="EventArray-249"><a href="#EventArray-249"><span class="linenos">249</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_equal</span><span class="p">:</span>
</span><span id="EventArray-250"><a href="#EventArray-250"><span class="linenos">250</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="EventArray-251"><a href="#EventArray-251"><span class="linenos">251</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-252"><a href="#EventArray-252"><span class="linenos">252</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="EventArray-253"><a href="#EventArray-253"><span class="linenos">253</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-254"><a href="#EventArray-254"><span class="linenos">254</span></a>            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-255"><a href="#EventArray-255"><span class="linenos">255</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="EventArray-256"><a href="#EventArray-256"><span class="linenos">256</span></a>
</span><span id="EventArray-257"><a href="#EventArray-257"><span class="linenos">257</span></a>        <span class="c1"># Parse all possibilities for features</span>
</span><span id="EventArray-258"><a href="#EventArray-258"><span class="linenos">258</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="EventArray-259"><a href="#EventArray-259"><span class="linenos">259</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="EventArray-260"><a href="#EventArray-260"><span class="linenos">260</span></a>                <span class="n">is_equal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
</span><span id="EventArray-261"><a href="#EventArray-261"><span class="linenos">261</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_equal</span><span class="p">:</span>
</span><span id="EventArray-262"><a href="#EventArray-262"><span class="linenos">262</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="EventArray-263"><a href="#EventArray-263"><span class="linenos">263</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-264"><a href="#EventArray-264"><span class="linenos">264</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="EventArray-265"><a href="#EventArray-265"><span class="linenos">265</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-266"><a href="#EventArray-266"><span class="linenos">266</span></a>            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-267"><a href="#EventArray-267"><span class="linenos">267</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="EventArray-268"><a href="#EventArray-268"><span class="linenos">268</span></a>
</span><span id="EventArray-269"><a href="#EventArray-269"><span class="linenos">269</span></a>        <span class="k">return</span> <span class="n">is_equal</span>
</span><span id="EventArray-270"><a href="#EventArray-270"><span class="linenos">270</span></a>
</span><span id="EventArray-271"><a href="#EventArray-271"><span class="linenos">271</span></a>    <span class="k">def</span> <span class="nf">add_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-272"><a href="#EventArray-272"><span class="linenos">272</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-273"><a href="#EventArray-273"><span class="linenos">273</span></a><span class="sd">        Add metadata to the EventArray.</span>
</span><span id="EventArray-274"><a href="#EventArray-274"><span class="linenos">274</span></a><span class="sd">        :param new_metadata: the metadata to add.</span>
</span><span id="EventArray-275"><a href="#EventArray-275"><span class="linenos">275</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-276"><a href="#EventArray-276"><span class="linenos">276</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-277"><a href="#EventArray-277"><span class="linenos">277</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_metadata</span><span class="p">):</span>
</span><span id="EventArray-278"><a href="#EventArray-278"><span class="linenos">278</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;New metadata does not match length of existing info&quot;</span><span class="p">)</span>
</span><span id="EventArray-279"><a href="#EventArray-279"><span class="linenos">279</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">new_metadata</span>
</span><span id="EventArray-280"><a href="#EventArray-280"><span class="linenos">280</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-281"><a href="#EventArray-281"><span class="linenos">281</span></a>            <span class="c1"># Add the new metadata columns to the existing metadata</span>
</span><span id="EventArray-282"><a href="#EventArray-282"><span class="linenos">282</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">new_metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventArray-283"><a href="#EventArray-283"><span class="linenos">283</span></a>
</span><span id="EventArray-284"><a href="#EventArray-284"><span class="linenos">284</span></a>    <span class="k">def</span> <span class="nf">add_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-285"><a href="#EventArray-285"><span class="linenos">285</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-286"><a href="#EventArray-286"><span class="linenos">286</span></a><span class="sd">        Add features to the EventArray.</span>
</span><span id="EventArray-287"><a href="#EventArray-287"><span class="linenos">287</span></a><span class="sd">        :param new_features: the metadata to add.</span>
</span><span id="EventArray-288"><a href="#EventArray-288"><span class="linenos">288</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-289"><a href="#EventArray-289"><span class="linenos">289</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-290"><a href="#EventArray-290"><span class="linenos">290</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_features</span><span class="p">):</span>
</span><span id="EventArray-291"><a href="#EventArray-291"><span class="linenos">291</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;New metadata does not match length of existing info&quot;</span><span class="p">)</span>
</span><span id="EventArray-292"><a href="#EventArray-292"><span class="linenos">292</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">new_features</span>
</span><span id="EventArray-293"><a href="#EventArray-293"><span class="linenos">293</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-294"><a href="#EventArray-294"><span class="linenos">294</span></a>            <span class="c1"># Add the new metadata columns to the existing metadata</span>
</span><span id="EventArray-295"><a href="#EventArray-295"><span class="linenos">295</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">new_features</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventArray-296"><a href="#EventArray-296"><span class="linenos">296</span></a>
</span><span id="EventArray-297"><a href="#EventArray-297"><span class="linenos">297</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray-298"><a href="#EventArray-298"><span class="linenos">298</span></a>    <span class="k">def</span> <span class="nf">from_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Self</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray-299"><a href="#EventArray-299"><span class="linenos">299</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-300"><a href="#EventArray-300"><span class="linenos">300</span></a><span class="sd">        Combine EventArrays in a list into a single EventArray.</span>
</span><span id="EventArray-301"><a href="#EventArray-301"><span class="linenos">301</span></a><span class="sd">        :param events: the new list of events.</span>
</span><span id="EventArray-302"><a href="#EventArray-302"><span class="linenos">302</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-303"><a href="#EventArray-303"><span class="linenos">303</span></a>        <span class="n">all_info</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray-304"><a href="#EventArray-304"><span class="linenos">304</span></a>        <span class="n">all_metadata</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray-305"><a href="#EventArray-305"><span class="linenos">305</span></a>        <span class="n">all_features</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray-306"><a href="#EventArray-306"><span class="linenos">306</span></a>        <span class="k">for</span> <span class="n">event_array</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="EventArray-307"><a href="#EventArray-307"><span class="linenos">307</span></a>            <span class="c1"># Skip empty EventArrays</span>
</span><span id="EventArray-308"><a href="#EventArray-308"><span class="linenos">308</span></a>            <span class="k">if</span> <span class="n">event_array</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-309"><a href="#EventArray-309"><span class="linenos">309</span></a>                <span class="n">all_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_array</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
</span><span id="EventArray-310"><a href="#EventArray-310"><span class="linenos">310</span></a>            <span class="k">if</span> <span class="n">event_array</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-311"><a href="#EventArray-311"><span class="linenos">311</span></a>                <span class="n">all_metadata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_array</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
</span><span id="EventArray-312"><a href="#EventArray-312"><span class="linenos">312</span></a>            <span class="k">if</span> <span class="n">event_array</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-313"><a href="#EventArray-313"><span class="linenos">313</span></a>                <span class="n">all_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_array</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
</span><span id="EventArray-314"><a href="#EventArray-314"><span class="linenos">314</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray-315"><a href="#EventArray-315"><span class="linenos">315</span></a>            <span class="k">return</span> <span class="n">EventArray</span><span class="p">()</span>
</span><span id="EventArray-316"><a href="#EventArray-316"><span class="linenos">316</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-317"><a href="#EventArray-317"><span class="linenos">317</span></a>            <span class="n">all_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_info</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray-318"><a href="#EventArray-318"><span class="linenos">318</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_metadata</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray-319"><a href="#EventArray-319"><span class="linenos">319</span></a>            <span class="n">all_metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-320"><a href="#EventArray-320"><span class="linenos">320</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-321"><a href="#EventArray-321"><span class="linenos">321</span></a>            <span class="n">all_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_metadata</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray-322"><a href="#EventArray-322"><span class="linenos">322</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_features</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray-323"><a href="#EventArray-323"><span class="linenos">323</span></a>            <span class="n">all_features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-324"><a href="#EventArray-324"><span class="linenos">324</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-325"><a href="#EventArray-325"><span class="linenos">325</span></a>            <span class="n">all_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_features</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray-326"><a href="#EventArray-326"><span class="linenos">326</span></a>
</span><span id="EventArray-327"><a href="#EventArray-327"><span class="linenos">327</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">all_info</span><span class="p">,</span> <span class="n">all_metadata</span><span class="p">,</span> <span class="n">all_features</span><span class="p">)</span>
</span><span id="EventArray-328"><a href="#EventArray-328"><span class="linenos">328</span></a>
</span><span id="EventArray-329"><a href="#EventArray-329"><span class="linenos">329</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray-330"><a href="#EventArray-330"><span class="linenos">330</span></a>    <span class="k">def</span> <span class="nf">from_events</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Event</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray-331"><a href="#EventArray-331"><span class="linenos">331</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-332"><a href="#EventArray-332"><span class="linenos">332</span></a><span class="sd">        Set the events in the EventArray to a new list of events.</span>
</span><span id="EventArray-333"><a href="#EventArray-333"><span class="linenos">333</span></a><span class="sd">        :param events: the new list of events.</span>
</span><span id="EventArray-334"><a href="#EventArray-334"><span class="linenos">334</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-335"><a href="#EventArray-335"><span class="linenos">335</span></a>        <span class="c1"># Return an empty array if we were passed nothing</span>
</span><span id="EventArray-336"><a href="#EventArray-336"><span class="linenos">336</span></a>        <span class="k">if</span> <span class="n">events</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray-337"><a href="#EventArray-337"><span class="linenos">337</span></a>            <span class="k">return</span> <span class="n">EventArray</span><span class="p">()</span>
</span><span id="EventArray-338"><a href="#EventArray-338"><span class="linenos">338</span></a>        <span class="c1"># Otherwise, grab the info</span>
</span><span id="EventArray-339"><a href="#EventArray-339"><span class="linenos">339</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="EventArray-340"><a href="#EventArray-340"><span class="linenos">340</span></a>            <span class="p">{</span>
</span><span id="EventArray-341"><a href="#EventArray-341"><span class="linenos">341</span></a>                <span class="s2">&quot;slide_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray-342"><a href="#EventArray-342"><span class="linenos">342</span></a>                <span class="s2">&quot;tile&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray-343"><a href="#EventArray-343"><span class="linenos">343</span></a>                <span class="s2">&quot;roi&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n_roi</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray-344"><a href="#EventArray-344"><span class="linenos">344</span></a>                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray-345"><a href="#EventArray-345"><span class="linenos">345</span></a>                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray-346"><a href="#EventArray-346"><span class="linenos">346</span></a>                <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray-347"><a href="#EventArray-347"><span class="linenos">347</span></a>            <span class="p">}</span>
</span><span id="EventArray-348"><a href="#EventArray-348"><span class="linenos">348</span></a>        <span class="p">)</span>
</span><span id="EventArray-349"><a href="#EventArray-349"><span class="linenos">349</span></a>        <span class="n">metadata_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">metadata</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
</span><span id="EventArray-350"><a href="#EventArray-350"><span class="linenos">350</span></a>        <span class="c1"># Iterate through and ensure that all metadata is the same shape</span>
</span><span id="EventArray-351"><a href="#EventArray-351"><span class="linenos">351</span></a>        <span class="k">for</span> <span class="n">metadata</span> <span class="ow">in</span> <span class="n">metadata_list</span><span class="p">:</span>
</span><span id="EventArray-352"><a href="#EventArray-352"><span class="linenos">352</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">metadata_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="EventArray-353"><a href="#EventArray-353"><span class="linenos">353</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All metadata must be the same type.&quot;</span><span class="p">)</span>
</span><span id="EventArray-354"><a href="#EventArray-354"><span class="linenos">354</span></a>            <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">metadata</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">metadata_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="EventArray-355"><a href="#EventArray-355"><span class="linenos">355</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All metadata must be the same shape.&quot;</span><span class="p">)</span>
</span><span id="EventArray-356"><a href="#EventArray-356"><span class="linenos">356</span></a>        <span class="k">if</span> <span class="n">metadata_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-357"><a href="#EventArray-357"><span class="linenos">357</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-358"><a href="#EventArray-358"><span class="linenos">358</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-359"><a href="#EventArray-359"><span class="linenos">359</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metadata_list</span><span class="p">)</span>
</span><span id="EventArray-360"><a href="#EventArray-360"><span class="linenos">360</span></a>        <span class="n">features_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">features</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
</span><span id="EventArray-361"><a href="#EventArray-361"><span class="linenos">361</span></a>        <span class="c1"># Iterate through and ensure that all features are the same shape</span>
</span><span id="EventArray-362"><a href="#EventArray-362"><span class="linenos">362</span></a>        <span class="k">for</span> <span class="n">features</span> <span class="ow">in</span> <span class="n">features_list</span><span class="p">:</span>
</span><span id="EventArray-363"><a href="#EventArray-363"><span class="linenos">363</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">features_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="EventArray-364"><a href="#EventArray-364"><span class="linenos">364</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All features must be the same type.&quot;</span><span class="p">)</span>
</span><span id="EventArray-365"><a href="#EventArray-365"><span class="linenos">365</span></a>            <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">features</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">features_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="EventArray-366"><a href="#EventArray-366"><span class="linenos">366</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All features must be the same shape.&quot;</span><span class="p">)</span>
</span><span id="EventArray-367"><a href="#EventArray-367"><span class="linenos">367</span></a>        <span class="k">if</span> <span class="n">features_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-368"><a href="#EventArray-368"><span class="linenos">368</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-369"><a href="#EventArray-369"><span class="linenos">369</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-370"><a href="#EventArray-370"><span class="linenos">370</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">features_list</span><span class="p">)</span>
</span><span id="EventArray-371"><a href="#EventArray-371"><span class="linenos">371</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
</span><span id="EventArray-372"><a href="#EventArray-372"><span class="linenos">372</span></a>
</span><span id="EventArray-373"><a href="#EventArray-373"><span class="linenos">373</span></a>    <span class="k">def</span> <span class="nf">to_events</span><span class="p">(</span>
</span><span id="EventArray-374"><a href="#EventArray-374"><span class="linenos">374</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">scans</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">csi_scans</span><span class="o">.</span><span class="n">Scan</span><span class="p">],</span> <span class="n">ignore_missing_scans</span><span class="o">=</span><span class="kc">True</span>
</span><span id="EventArray-375"><a href="#EventArray-375"><span class="linenos">375</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Event</span><span class="p">]:</span>
</span><span id="EventArray-376"><a href="#EventArray-376"><span class="linenos">376</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-377"><a href="#EventArray-377"><span class="linenos">377</span></a><span class="sd">        Get the events in the EventArray as a list of events.</span>
</span><span id="EventArray-378"><a href="#EventArray-378"><span class="linenos">378</span></a><span class="sd">        :param scans: the scans that the events belong to.</span>
</span><span id="EventArray-379"><a href="#EventArray-379"><span class="linenos">379</span></a><span class="sd">        :param ignore_missing_scans: whether to create blank scans for events without scans.</span>
</span><span id="EventArray-380"><a href="#EventArray-380"><span class="linenos">380</span></a><span class="sd">        :return:</span>
</span><span id="EventArray-381"><a href="#EventArray-381"><span class="linenos">381</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-382"><a href="#EventArray-382"><span class="linenos">382</span></a>        <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray-383"><a href="#EventArray-383"><span class="linenos">383</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)):</span>
</span><span id="EventArray-384"><a href="#EventArray-384"><span class="linenos">384</span></a>            <span class="c1"># Determine the associated scan</span>
</span><span id="EventArray-385"><a href="#EventArray-385"><span class="linenos">385</span></a>            <span class="n">scan</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-386"><a href="#EventArray-386"><span class="linenos">386</span></a>            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
</span><span id="EventArray-387"><a href="#EventArray-387"><span class="linenos">387</span></a>                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">slide_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
</span><span id="EventArray-388"><a href="#EventArray-388"><span class="linenos">388</span></a>                    <span class="n">scan</span> <span class="o">=</span> <span class="n">s</span>
</span><span id="EventArray-389"><a href="#EventArray-389"><span class="linenos">389</span></a>                    <span class="k">break</span>
</span><span id="EventArray-390"><a href="#EventArray-390"><span class="linenos">390</span></a>            <span class="k">if</span> <span class="n">scan</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-391"><a href="#EventArray-391"><span class="linenos">391</span></a>                <span class="k">if</span> <span class="n">ignore_missing_scans</span><span class="p">:</span>
</span><span id="EventArray-392"><a href="#EventArray-392"><span class="linenos">392</span></a>                    <span class="c1"># Create a placeholder scan if the scan is missing</span>
</span><span id="EventArray-393"><a href="#EventArray-393"><span class="linenos">393</span></a>                    <span class="n">scan</span> <span class="o">=</span> <span class="n">csi_scans</span><span class="o">.</span><span class="n">Scan</span><span class="o">.</span><span class="n">make_placeholder</span><span class="p">(</span>
</span><span id="EventArray-394"><a href="#EventArray-394"><span class="linenos">394</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray-395"><a href="#EventArray-395"><span class="linenos">395</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray-396"><a href="#EventArray-396"><span class="linenos">396</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray-397"><a href="#EventArray-397"><span class="linenos">397</span></a>                    <span class="p">)</span>
</span><span id="EventArray-398"><a href="#EventArray-398"><span class="linenos">398</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray-399"><a href="#EventArray-399"><span class="linenos">399</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="EventArray-400"><a href="#EventArray-400"><span class="linenos">400</span></a>                        <span class="sa">f</span><span class="s2">&quot;Scan </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;slide_id&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found for event </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="EventArray-401"><a href="#EventArray-401"><span class="linenos">401</span></a>                    <span class="p">)</span>
</span><span id="EventArray-402"><a href="#EventArray-402"><span class="linenos">402</span></a>            <span class="c1"># Add to the list</span>
</span><span id="EventArray-403"><a href="#EventArray-403"><span class="linenos">403</span></a>            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="EventArray-404"><a href="#EventArray-404"><span class="linenos">404</span></a>                <span class="n">Event</span><span class="p">(</span>
</span><span id="EventArray-405"><a href="#EventArray-405"><span class="linenos">405</span></a>                    <span class="n">scan</span><span class="p">,</span>
</span><span id="EventArray-406"><a href="#EventArray-406"><span class="linenos">406</span></a>                    <span class="n">csi_tiles</span><span class="o">.</span><span class="n">Tile</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
</span><span id="EventArray-407"><a href="#EventArray-407"><span class="linenos">407</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray-408"><a href="#EventArray-408"><span class="linenos">408</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray-409"><a href="#EventArray-409"><span class="linenos">409</span></a>                    <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray-410"><a href="#EventArray-410"><span class="linenos">410</span></a>                    <span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray-411"><a href="#EventArray-411"><span class="linenos">411</span></a>                    <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray-412"><a href="#EventArray-412"><span class="linenos">412</span></a>                <span class="p">)</span>
</span><span id="EventArray-413"><a href="#EventArray-413"><span class="linenos">413</span></a>            <span class="p">)</span>
</span><span id="EventArray-414"><a href="#EventArray-414"><span class="linenos">414</span></a>        <span class="k">return</span> <span class="n">events</span>
</span><span id="EventArray-415"><a href="#EventArray-415"><span class="linenos">415</span></a>
</span><span id="EventArray-416"><a href="#EventArray-416"><span class="linenos">416</span></a>    <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="EventArray-417"><a href="#EventArray-417"><span class="linenos">417</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-418"><a href="#EventArray-418"><span class="linenos">418</span></a><span class="sd">        Convert all the data in the EventArray to a single DataFrame.</span>
</span><span id="EventArray-419"><a href="#EventArray-419"><span class="linenos">419</span></a><span class="sd">        :return: a DataFrame with all the data in the EventArray.</span>
</span><span id="EventArray-420"><a href="#EventArray-420"><span class="linenos">420</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-421"><a href="#EventArray-421"><span class="linenos">421</span></a>        <span class="c1"># Make a copy of the info DataFrame and prepend &quot;info_&quot; to the column names</span>
</span><span id="EventArray-422"><a href="#EventArray-422"><span class="linenos">422</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray-423"><a href="#EventArray-423"><span class="linenos">423</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;info_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray-424"><a href="#EventArray-424"><span class="linenos">424</span></a>        <span class="c1"># Combine with the metadata and prepend &quot;metadata_&quot; to the column names</span>
</span><span id="EventArray-425"><a href="#EventArray-425"><span class="linenos">425</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-426"><a href="#EventArray-426"><span class="linenos">426</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray-427"><a href="#EventArray-427"><span class="linenos">427</span></a>            <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;metadata_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray-428"><a href="#EventArray-428"><span class="linenos">428</span></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">output</span><span class="p">,</span> <span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventArray-429"><a href="#EventArray-429"><span class="linenos">429</span></a>        <span class="c1"># Combine with the features and prepend &quot;features_&quot; to the column names</span>
</span><span id="EventArray-430"><a href="#EventArray-430"><span class="linenos">430</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-431"><a href="#EventArray-431"><span class="linenos">431</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray-432"><a href="#EventArray-432"><span class="linenos">432</span></a>            <span class="n">features</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;features_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray-433"><a href="#EventArray-433"><span class="linenos">433</span></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">output</span><span class="p">,</span> <span class="n">features</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventArray-434"><a href="#EventArray-434"><span class="linenos">434</span></a>        <span class="k">return</span> <span class="n">output</span>
</span><span id="EventArray-435"><a href="#EventArray-435"><span class="linenos">435</span></a>
</span><span id="EventArray-436"><a href="#EventArray-436"><span class="linenos">436</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray-437"><a href="#EventArray-437"><span class="linenos">437</span></a>    <span class="k">def</span> <span class="nf">from_dataframe</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray-438"><a href="#EventArray-438"><span class="linenos">438</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-439"><a href="#EventArray-439"><span class="linenos">439</span></a><span class="sd">        From a single, special DataFrame, create an EventArray.</span>
</span><span id="EventArray-440"><a href="#EventArray-440"><span class="linenos">440</span></a><span class="sd">        :return: a DataFrame with all the data in the EventArray.</span>
</span><span id="EventArray-441"><a href="#EventArray-441"><span class="linenos">441</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-442"><a href="#EventArray-442"><span class="linenos">442</span></a>        <span class="c1"># Split the columns into info, metadata, and features and strip prefix</span>
</span><span id="EventArray-443"><a href="#EventArray-443"><span class="linenos">443</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;info_&quot;</span><span class="p">)]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray-444"><a href="#EventArray-444"><span class="linenos">444</span></a>        <span class="n">info</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;info_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray-445"><a href="#EventArray-445"><span class="linenos">445</span></a>        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray-446"><a href="#EventArray-446"><span class="linenos">446</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-447"><a href="#EventArray-447"><span class="linenos">447</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;metadata_&quot;</span><span class="p">)]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray-448"><a href="#EventArray-448"><span class="linenos">448</span></a>        <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;metadata_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray-449"><a href="#EventArray-449"><span class="linenos">449</span></a>        <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray-450"><a href="#EventArray-450"><span class="linenos">450</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-451"><a href="#EventArray-451"><span class="linenos">451</span></a>        <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;features_&quot;</span><span class="p">)]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray-452"><a href="#EventArray-452"><span class="linenos">452</span></a>        <span class="n">features</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;features_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray-453"><a href="#EventArray-453"><span class="linenos">453</span></a>        <span class="k">if</span> <span class="n">features</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray-454"><a href="#EventArray-454"><span class="linenos">454</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray-455"><a href="#EventArray-455"><span class="linenos">455</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
</span><span id="EventArray-456"><a href="#EventArray-456"><span class="linenos">456</span></a>
</span><span id="EventArray-457"><a href="#EventArray-457"><span class="linenos">457</span></a>    <span class="k">def</span> <span class="nf">save_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="EventArray-458"><a href="#EventArray-458"><span class="linenos">458</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-459"><a href="#EventArray-459"><span class="linenos">459</span></a><span class="sd">        Save the events to an CSV file, including metadata and features.</span>
</span><span id="EventArray-460"><a href="#EventArray-460"><span class="linenos">460</span></a><span class="sd">        :param output_path:</span>
</span><span id="EventArray-461"><a href="#EventArray-461"><span class="linenos">461</span></a><span class="sd">        :return:</span>
</span><span id="EventArray-462"><a href="#EventArray-462"><span class="linenos">462</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-463"><a href="#EventArray-463"><span class="linenos">463</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="EventArray-464"><a href="#EventArray-464"><span class="linenos">464</span></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</span><span id="EventArray-465"><a href="#EventArray-465"><span class="linenos">465</span></a>
</span><span id="EventArray-466"><a href="#EventArray-466"><span class="linenos">466</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray-467"><a href="#EventArray-467"><span class="linenos">467</span></a>    <span class="k">def</span> <span class="nf">load_csv</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray-468"><a href="#EventArray-468"><span class="linenos">468</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-469"><a href="#EventArray-469"><span class="linenos">469</span></a><span class="sd">        Load the events from an CSV file, including metadata and features.</span>
</span><span id="EventArray-470"><a href="#EventArray-470"><span class="linenos">470</span></a><span class="sd">        :param input_path:</span>
</span><span id="EventArray-471"><a href="#EventArray-471"><span class="linenos">471</span></a><span class="sd">        :return:</span>
</span><span id="EventArray-472"><a href="#EventArray-472"><span class="linenos">472</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-473"><a href="#EventArray-473"><span class="linenos">473</span></a>        <span class="c1"># Load the CSV file</span>
</span><span id="EventArray-474"><a href="#EventArray-474"><span class="linenos">474</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="EventArray-475"><a href="#EventArray-475"><span class="linenos">475</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="EventArray-476"><a href="#EventArray-476"><span class="linenos">476</span></a>
</span><span id="EventArray-477"><a href="#EventArray-477"><span class="linenos">477</span></a>    <span class="k">def</span> <span class="nf">save_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="EventArray-478"><a href="#EventArray-478"><span class="linenos">478</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-479"><a href="#EventArray-479"><span class="linenos">479</span></a><span class="sd">        Save the events to an HDF5 file, including metadata and features.</span>
</span><span id="EventArray-480"><a href="#EventArray-480"><span class="linenos">480</span></a><span class="sd">        Uses the pandas-provided HDF5 functions for ease, and external compatibility,</span>
</span><span id="EventArray-481"><a href="#EventArray-481"><span class="linenos">481</span></a><span class="sd">        though these files are slightly harder to view in HDFView or similar.</span>
</span><span id="EventArray-482"><a href="#EventArray-482"><span class="linenos">482</span></a><span class="sd">        :param output_path:</span>
</span><span id="EventArray-483"><a href="#EventArray-483"><span class="linenos">483</span></a><span class="sd">        :return:</span>
</span><span id="EventArray-484"><a href="#EventArray-484"><span class="linenos">484</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-485"><a href="#EventArray-485"><span class="linenos">485</span></a>        <span class="c1"># Open the output_path as an HDF5 file</span>
</span><span id="EventArray-486"><a href="#EventArray-486"><span class="linenos">486</span></a>        <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">store</span><span class="p">:</span>
</span><span id="EventArray-487"><a href="#EventArray-487"><span class="linenos">487</span></a>            <span class="c1"># Store the dataframes in the HDF5 file</span>
</span><span id="EventArray-488"><a href="#EventArray-488"><span class="linenos">488</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-489"><a href="#EventArray-489"><span class="linenos">489</span></a>                <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="EventArray-490"><a href="#EventArray-490"><span class="linenos">490</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-491"><a href="#EventArray-491"><span class="linenos">491</span></a>                <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="EventArray-492"><a href="#EventArray-492"><span class="linenos">492</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray-493"><a href="#EventArray-493"><span class="linenos">493</span></a>                <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="EventArray-494"><a href="#EventArray-494"><span class="linenos">494</span></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</span><span id="EventArray-495"><a href="#EventArray-495"><span class="linenos">495</span></a>
</span><span id="EventArray-496"><a href="#EventArray-496"><span class="linenos">496</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray-497"><a href="#EventArray-497"><span class="linenos">497</span></a>    <span class="k">def</span> <span class="nf">load_hdf5</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray-498"><a href="#EventArray-498"><span class="linenos">498</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray-499"><a href="#EventArray-499"><span class="linenos">499</span></a><span class="sd">        Load the events from an HDF5 file, including metadata and features.</span>
</span><span id="EventArray-500"><a href="#EventArray-500"><span class="linenos">500</span></a><span class="sd">        :param input_path:</span>
</span><span id="EventArray-501"><a href="#EventArray-501"><span class="linenos">501</span></a><span class="sd">        :return:</span>
</span><span id="EventArray-502"><a href="#EventArray-502"><span class="linenos">502</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray-503"><a href="#EventArray-503"><span class="linenos">503</span></a>        <span class="c1"># Open the input_path as an HDF5 file</span>
</span><span id="EventArray-504"><a href="#EventArray-504"><span class="linenos">504</span></a>        <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">store</span><span class="p">:</span>
</span><span id="EventArray-505"><a href="#EventArray-505"><span class="linenos">505</span></a>            <span class="c1"># Load the dataframes from the HDF5 file</span>
</span><span id="EventArray-506"><a href="#EventArray-506"><span class="linenos">506</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;info&quot;</span> <span class="ow">in</span> <span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="EventArray-507"><a href="#EventArray-507"><span class="linenos">507</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="EventArray-508"><a href="#EventArray-508"><span class="linenos">508</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;features&quot;</span> <span class="ow">in</span> <span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="EventArray-509"><a href="#EventArray-509"><span class="linenos">509</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>A class that holds a large number of events' data, making it easy to analyze and
manipulate many events at once. A more separated version of the Event class.</p>
</div>


                            <div id="EventArray.__init__" class="classattr">
                                        <input id="EventArray.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">EventArray</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">info</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">metadata</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">features</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="EventArray.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.__init__-197"><a href="#EventArray.__init__-197"><span class="linenos">197</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="EventArray.__init__-198"><a href="#EventArray.__init__-198"><span class="linenos">198</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="EventArray.__init__-199"><a href="#EventArray.__init__-199"><span class="linenos">199</span></a>        <span class="n">info</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EventArray.__init__-200"><a href="#EventArray.__init__-200"><span class="linenos">200</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EventArray.__init__-201"><a href="#EventArray.__init__-201"><span class="linenos">201</span></a>        <span class="n">features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EventArray.__init__-202"><a href="#EventArray.__init__-202"><span class="linenos">202</span></a>    <span class="p">):</span>
</span><span id="EventArray.__init__-203"><a href="#EventArray.__init__-203"><span class="linenos">203</span></a>        <span class="c1"># Info must be a DataFrame with columns &quot;slide_id&quot;, &quot;tile&quot;, &quot;roi&quot;, &quot;x&quot;, &quot;y&quot;, &quot;size&quot;</span>
</span><span id="EventArray.__init__-204"><a href="#EventArray.__init__-204"><span class="linenos">204</span></a>        <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="EventArray.__init__-205"><a href="#EventArray.__init__-205"><span class="linenos">205</span></a>            <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">INFO_COLUMNS</span><span class="p">)</span>
</span><span id="EventArray.__init__-206"><a href="#EventArray.__init__-206"><span class="linenos">206</span></a>            <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span>
</span><span id="EventArray.__init__-207"><a href="#EventArray.__init__-207"><span class="linenos">207</span></a>        <span class="p">):</span>
</span><span id="EventArray.__init__-208"><a href="#EventArray.__init__-208"><span class="linenos">208</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="EventArray.__init__-209"><a href="#EventArray.__init__-209"><span class="linenos">209</span></a>                <span class="s2">&quot;EventArray.info must have columns &#39;slide_id&#39;, &#39;tile&#39;, &#39;roi&#39;, &#39;x&#39;, &#39;y&#39;, &#39;size&#39;&quot;</span>
</span><span id="EventArray.__init__-210"><a href="#EventArray.__init__-210"><span class="linenos">210</span></a>            <span class="p">)</span>
</span><span id="EventArray.__init__-211"><a href="#EventArray.__init__-211"><span class="linenos">211</span></a>        <span class="c1"># All DataFrames must all have the same number of rows</span>
</span><span id="EventArray.__init__-212"><a href="#EventArray.__init__-212"><span class="linenos">212</span></a>        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="p">)):</span>
</span><span id="EventArray.__init__-213"><a href="#EventArray.__init__-213"><span class="linenos">213</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="EventArray.__init__-214"><a href="#EventArray.__init__-214"><span class="linenos">214</span></a>                <span class="s2">&quot;If EventArray.metadata is not None, it should match rows with .info&quot;</span>
</span><span id="EventArray.__init__-215"><a href="#EventArray.__init__-215"><span class="linenos">215</span></a>            <span class="p">)</span>
</span><span id="EventArray.__init__-216"><a href="#EventArray.__init__-216"><span class="linenos">216</span></a>        <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)):</span>
</span><span id="EventArray.__init__-217"><a href="#EventArray.__init__-217"><span class="linenos">217</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="EventArray.__init__-218"><a href="#EventArray.__init__-218"><span class="linenos">218</span></a>                <span class="s2">&quot;If EventArray.features is not None, it should match rows with .info&quot;</span>
</span><span id="EventArray.__init__-219"><a href="#EventArray.__init__-219"><span class="linenos">219</span></a>            <span class="p">)</span>
</span><span id="EventArray.__init__-220"><a href="#EventArray.__init__-220"><span class="linenos">220</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
</span><span id="EventArray.__init__-221"><a href="#EventArray.__init__-221"><span class="linenos">221</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
</span><span id="EventArray.__init__-222"><a href="#EventArray.__init__-222"><span class="linenos">222</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
</span></pre></div>


    

                            </div>
                            <div id="EventArray.INFO_COLUMNS" class="classattr">
                                <div class="attr variable">
            <span class="name">INFO_COLUMNS</span>        =
<span class="default_value">[&#39;slide_id&#39;, &#39;tile&#39;, &#39;roi&#39;, &#39;x&#39;, &#39;y&#39;, &#39;size&#39;]</span>

        
    </div>
    <a class="headerlink" href="#EventArray.INFO_COLUMNS"></a>
    
    

                            </div>
                            <div id="EventArray.info" class="classattr">
                                <div class="attr variable">
            <span class="name">info</span>

        
    </div>
    <a class="headerlink" href="#EventArray.info"></a>
    
    

                            </div>
                            <div id="EventArray.metadata" class="classattr">
                                <div class="attr variable">
            <span class="name">metadata</span>

        
    </div>
    <a class="headerlink" href="#EventArray.metadata"></a>
    
    

                            </div>
                            <div id="EventArray.features" class="classattr">
                                <div class="attr variable">
            <span class="name">features</span>

        
    </div>
    <a class="headerlink" href="#EventArray.features"></a>
    
    

                            </div>
                            <div id="EventArray.add_metadata" class="classattr">
                                        <input id="EventArray.add_metadata-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_metadata</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">new_metadata</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="EventArray.add_metadata-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.add_metadata"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.add_metadata-271"><a href="#EventArray.add_metadata-271"><span class="linenos">271</span></a>    <span class="k">def</span> <span class="nf">add_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.add_metadata-272"><a href="#EventArray.add_metadata-272"><span class="linenos">272</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.add_metadata-273"><a href="#EventArray.add_metadata-273"><span class="linenos">273</span></a><span class="sd">        Add metadata to the EventArray.</span>
</span><span id="EventArray.add_metadata-274"><a href="#EventArray.add_metadata-274"><span class="linenos">274</span></a><span class="sd">        :param new_metadata: the metadata to add.</span>
</span><span id="EventArray.add_metadata-275"><a href="#EventArray.add_metadata-275"><span class="linenos">275</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.add_metadata-276"><a href="#EventArray.add_metadata-276"><span class="linenos">276</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.add_metadata-277"><a href="#EventArray.add_metadata-277"><span class="linenos">277</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_metadata</span><span class="p">):</span>
</span><span id="EventArray.add_metadata-278"><a href="#EventArray.add_metadata-278"><span class="linenos">278</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;New metadata does not match length of existing info&quot;</span><span class="p">)</span>
</span><span id="EventArray.add_metadata-279"><a href="#EventArray.add_metadata-279"><span class="linenos">279</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">new_metadata</span>
</span><span id="EventArray.add_metadata-280"><a href="#EventArray.add_metadata-280"><span class="linenos">280</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.add_metadata-281"><a href="#EventArray.add_metadata-281"><span class="linenos">281</span></a>            <span class="c1"># Add the new metadata columns to the existing metadata</span>
</span><span id="EventArray.add_metadata-282"><a href="#EventArray.add_metadata-282"><span class="linenos">282</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">new_metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Add metadata to the EventArray.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>new_metadata</strong>:  the metadata to add.</li>
</ul>
</div>


                            </div>
                            <div id="EventArray.add_features" class="classattr">
                                        <input id="EventArray.add_features-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_features</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">new_features</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="EventArray.add_features-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.add_features"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.add_features-284"><a href="#EventArray.add_features-284"><span class="linenos">284</span></a>    <span class="k">def</span> <span class="nf">add_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.add_features-285"><a href="#EventArray.add_features-285"><span class="linenos">285</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.add_features-286"><a href="#EventArray.add_features-286"><span class="linenos">286</span></a><span class="sd">        Add features to the EventArray.</span>
</span><span id="EventArray.add_features-287"><a href="#EventArray.add_features-287"><span class="linenos">287</span></a><span class="sd">        :param new_features: the metadata to add.</span>
</span><span id="EventArray.add_features-288"><a href="#EventArray.add_features-288"><span class="linenos">288</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.add_features-289"><a href="#EventArray.add_features-289"><span class="linenos">289</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.add_features-290"><a href="#EventArray.add_features-290"><span class="linenos">290</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_features</span><span class="p">):</span>
</span><span id="EventArray.add_features-291"><a href="#EventArray.add_features-291"><span class="linenos">291</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;New metadata does not match length of existing info&quot;</span><span class="p">)</span>
</span><span id="EventArray.add_features-292"><a href="#EventArray.add_features-292"><span class="linenos">292</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">new_features</span>
</span><span id="EventArray.add_features-293"><a href="#EventArray.add_features-293"><span class="linenos">293</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.add_features-294"><a href="#EventArray.add_features-294"><span class="linenos">294</span></a>            <span class="c1"># Add the new metadata columns to the existing metadata</span>
</span><span id="EventArray.add_features-295"><a href="#EventArray.add_features-295"><span class="linenos">295</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">new_features</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Add features to the EventArray.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>new_features</strong>:  the metadata to add.</li>
</ul>
</div>


                            </div>
                            <div id="EventArray.from_list" class="classattr">
                                        <input id="EventArray.from_list-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">from_list</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Self</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">Self</span>:</span></span>

                <label class="view-source-button" for="EventArray.from_list-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.from_list"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.from_list-297"><a href="#EventArray.from_list-297"><span class="linenos">297</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray.from_list-298"><a href="#EventArray.from_list-298"><span class="linenos">298</span></a>    <span class="k">def</span> <span class="nf">from_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Self</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray.from_list-299"><a href="#EventArray.from_list-299"><span class="linenos">299</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.from_list-300"><a href="#EventArray.from_list-300"><span class="linenos">300</span></a><span class="sd">        Combine EventArrays in a list into a single EventArray.</span>
</span><span id="EventArray.from_list-301"><a href="#EventArray.from_list-301"><span class="linenos">301</span></a><span class="sd">        :param events: the new list of events.</span>
</span><span id="EventArray.from_list-302"><a href="#EventArray.from_list-302"><span class="linenos">302</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.from_list-303"><a href="#EventArray.from_list-303"><span class="linenos">303</span></a>        <span class="n">all_info</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray.from_list-304"><a href="#EventArray.from_list-304"><span class="linenos">304</span></a>        <span class="n">all_metadata</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray.from_list-305"><a href="#EventArray.from_list-305"><span class="linenos">305</span></a>        <span class="n">all_features</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray.from_list-306"><a href="#EventArray.from_list-306"><span class="linenos">306</span></a>        <span class="k">for</span> <span class="n">event_array</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="EventArray.from_list-307"><a href="#EventArray.from_list-307"><span class="linenos">307</span></a>            <span class="c1"># Skip empty EventArrays</span>
</span><span id="EventArray.from_list-308"><a href="#EventArray.from_list-308"><span class="linenos">308</span></a>            <span class="k">if</span> <span class="n">event_array</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.from_list-309"><a href="#EventArray.from_list-309"><span class="linenos">309</span></a>                <span class="n">all_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_array</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
</span><span id="EventArray.from_list-310"><a href="#EventArray.from_list-310"><span class="linenos">310</span></a>            <span class="k">if</span> <span class="n">event_array</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.from_list-311"><a href="#EventArray.from_list-311"><span class="linenos">311</span></a>                <span class="n">all_metadata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_array</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
</span><span id="EventArray.from_list-312"><a href="#EventArray.from_list-312"><span class="linenos">312</span></a>            <span class="k">if</span> <span class="n">event_array</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.from_list-313"><a href="#EventArray.from_list-313"><span class="linenos">313</span></a>                <span class="n">all_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_array</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
</span><span id="EventArray.from_list-314"><a href="#EventArray.from_list-314"><span class="linenos">314</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray.from_list-315"><a href="#EventArray.from_list-315"><span class="linenos">315</span></a>            <span class="k">return</span> <span class="n">EventArray</span><span class="p">()</span>
</span><span id="EventArray.from_list-316"><a href="#EventArray.from_list-316"><span class="linenos">316</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.from_list-317"><a href="#EventArray.from_list-317"><span class="linenos">317</span></a>            <span class="n">all_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_info</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray.from_list-318"><a href="#EventArray.from_list-318"><span class="linenos">318</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_metadata</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray.from_list-319"><a href="#EventArray.from_list-319"><span class="linenos">319</span></a>            <span class="n">all_metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.from_list-320"><a href="#EventArray.from_list-320"><span class="linenos">320</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.from_list-321"><a href="#EventArray.from_list-321"><span class="linenos">321</span></a>            <span class="n">all_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_metadata</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray.from_list-322"><a href="#EventArray.from_list-322"><span class="linenos">322</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_features</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray.from_list-323"><a href="#EventArray.from_list-323"><span class="linenos">323</span></a>            <span class="n">all_features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.from_list-324"><a href="#EventArray.from_list-324"><span class="linenos">324</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.from_list-325"><a href="#EventArray.from_list-325"><span class="linenos">325</span></a>            <span class="n">all_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_features</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EventArray.from_list-326"><a href="#EventArray.from_list-326"><span class="linenos">326</span></a>
</span><span id="EventArray.from_list-327"><a href="#EventArray.from_list-327"><span class="linenos">327</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">all_info</span><span class="p">,</span> <span class="n">all_metadata</span><span class="p">,</span> <span class="n">all_features</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Combine EventArrays in a list into a single EventArray.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>events</strong>:  the new list of events.</li>
</ul>
</div>


                            </div>
                            <div id="EventArray.from_events" class="classattr">
                                        <input id="EventArray.from_events-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">from_events</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="#Event">Event</a></span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">Self</span>:</span></span>

                <label class="view-source-button" for="EventArray.from_events-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.from_events"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.from_events-329"><a href="#EventArray.from_events-329"><span class="linenos">329</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray.from_events-330"><a href="#EventArray.from_events-330"><span class="linenos">330</span></a>    <span class="k">def</span> <span class="nf">from_events</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Event</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray.from_events-331"><a href="#EventArray.from_events-331"><span class="linenos">331</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.from_events-332"><a href="#EventArray.from_events-332"><span class="linenos">332</span></a><span class="sd">        Set the events in the EventArray to a new list of events.</span>
</span><span id="EventArray.from_events-333"><a href="#EventArray.from_events-333"><span class="linenos">333</span></a><span class="sd">        :param events: the new list of events.</span>
</span><span id="EventArray.from_events-334"><a href="#EventArray.from_events-334"><span class="linenos">334</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.from_events-335"><a href="#EventArray.from_events-335"><span class="linenos">335</span></a>        <span class="c1"># Return an empty array if we were passed nothing</span>
</span><span id="EventArray.from_events-336"><a href="#EventArray.from_events-336"><span class="linenos">336</span></a>        <span class="k">if</span> <span class="n">events</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray.from_events-337"><a href="#EventArray.from_events-337"><span class="linenos">337</span></a>            <span class="k">return</span> <span class="n">EventArray</span><span class="p">()</span>
</span><span id="EventArray.from_events-338"><a href="#EventArray.from_events-338"><span class="linenos">338</span></a>        <span class="c1"># Otherwise, grab the info</span>
</span><span id="EventArray.from_events-339"><a href="#EventArray.from_events-339"><span class="linenos">339</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="EventArray.from_events-340"><a href="#EventArray.from_events-340"><span class="linenos">340</span></a>            <span class="p">{</span>
</span><span id="EventArray.from_events-341"><a href="#EventArray.from_events-341"><span class="linenos">341</span></a>                <span class="s2">&quot;slide_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray.from_events-342"><a href="#EventArray.from_events-342"><span class="linenos">342</span></a>                <span class="s2">&quot;tile&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray.from_events-343"><a href="#EventArray.from_events-343"><span class="linenos">343</span></a>                <span class="s2">&quot;roi&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">n_roi</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray.from_events-344"><a href="#EventArray.from_events-344"><span class="linenos">344</span></a>                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray.from_events-345"><a href="#EventArray.from_events-345"><span class="linenos">345</span></a>                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray.from_events-346"><a href="#EventArray.from_events-346"><span class="linenos">346</span></a>                <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
</span><span id="EventArray.from_events-347"><a href="#EventArray.from_events-347"><span class="linenos">347</span></a>            <span class="p">}</span>
</span><span id="EventArray.from_events-348"><a href="#EventArray.from_events-348"><span class="linenos">348</span></a>        <span class="p">)</span>
</span><span id="EventArray.from_events-349"><a href="#EventArray.from_events-349"><span class="linenos">349</span></a>        <span class="n">metadata_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">metadata</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
</span><span id="EventArray.from_events-350"><a href="#EventArray.from_events-350"><span class="linenos">350</span></a>        <span class="c1"># Iterate through and ensure that all metadata is the same shape</span>
</span><span id="EventArray.from_events-351"><a href="#EventArray.from_events-351"><span class="linenos">351</span></a>        <span class="k">for</span> <span class="n">metadata</span> <span class="ow">in</span> <span class="n">metadata_list</span><span class="p">:</span>
</span><span id="EventArray.from_events-352"><a href="#EventArray.from_events-352"><span class="linenos">352</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">metadata_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="EventArray.from_events-353"><a href="#EventArray.from_events-353"><span class="linenos">353</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All metadata must be the same type.&quot;</span><span class="p">)</span>
</span><span id="EventArray.from_events-354"><a href="#EventArray.from_events-354"><span class="linenos">354</span></a>            <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">metadata</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">metadata_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="EventArray.from_events-355"><a href="#EventArray.from_events-355"><span class="linenos">355</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All metadata must be the same shape.&quot;</span><span class="p">)</span>
</span><span id="EventArray.from_events-356"><a href="#EventArray.from_events-356"><span class="linenos">356</span></a>        <span class="k">if</span> <span class="n">metadata_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.from_events-357"><a href="#EventArray.from_events-357"><span class="linenos">357</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.from_events-358"><a href="#EventArray.from_events-358"><span class="linenos">358</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.from_events-359"><a href="#EventArray.from_events-359"><span class="linenos">359</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metadata_list</span><span class="p">)</span>
</span><span id="EventArray.from_events-360"><a href="#EventArray.from_events-360"><span class="linenos">360</span></a>        <span class="n">features_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">features</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
</span><span id="EventArray.from_events-361"><a href="#EventArray.from_events-361"><span class="linenos">361</span></a>        <span class="c1"># Iterate through and ensure that all features are the same shape</span>
</span><span id="EventArray.from_events-362"><a href="#EventArray.from_events-362"><span class="linenos">362</span></a>        <span class="k">for</span> <span class="n">features</span> <span class="ow">in</span> <span class="n">features_list</span><span class="p">:</span>
</span><span id="EventArray.from_events-363"><a href="#EventArray.from_events-363"><span class="linenos">363</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">features_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="EventArray.from_events-364"><a href="#EventArray.from_events-364"><span class="linenos">364</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All features must be the same type.&quot;</span><span class="p">)</span>
</span><span id="EventArray.from_events-365"><a href="#EventArray.from_events-365"><span class="linenos">365</span></a>            <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">features</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">features_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="EventArray.from_events-366"><a href="#EventArray.from_events-366"><span class="linenos">366</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All features must be the same shape.&quot;</span><span class="p">)</span>
</span><span id="EventArray.from_events-367"><a href="#EventArray.from_events-367"><span class="linenos">367</span></a>        <span class="k">if</span> <span class="n">features_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.from_events-368"><a href="#EventArray.from_events-368"><span class="linenos">368</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.from_events-369"><a href="#EventArray.from_events-369"><span class="linenos">369</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.from_events-370"><a href="#EventArray.from_events-370"><span class="linenos">370</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">features_list</span><span class="p">)</span>
</span><span id="EventArray.from_events-371"><a href="#EventArray.from_events-371"><span class="linenos">371</span></a>        <span class="k">return</span> <span class="n">EventArray</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Set the events in the EventArray to a new list of events.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>events</strong>:  the new list of events.</li>
</ul>
</div>


                            </div>
                            <div id="EventArray.to_events" class="classattr">
                                        <input id="EventArray.to_events-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">to_events</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">scans</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="csi_scans.html#Scan">csi_images.csi_scans.Scan</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">ignore_missing_scans</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="#Event">Event</a></span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="EventArray.to_events-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.to_events"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.to_events-373"><a href="#EventArray.to_events-373"><span class="linenos">373</span></a>    <span class="k">def</span> <span class="nf">to_events</span><span class="p">(</span>
</span><span id="EventArray.to_events-374"><a href="#EventArray.to_events-374"><span class="linenos">374</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">scans</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">csi_scans</span><span class="o">.</span><span class="n">Scan</span><span class="p">],</span> <span class="n">ignore_missing_scans</span><span class="o">=</span><span class="kc">True</span>
</span><span id="EventArray.to_events-375"><a href="#EventArray.to_events-375"><span class="linenos">375</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Event</span><span class="p">]:</span>
</span><span id="EventArray.to_events-376"><a href="#EventArray.to_events-376"><span class="linenos">376</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.to_events-377"><a href="#EventArray.to_events-377"><span class="linenos">377</span></a><span class="sd">        Get the events in the EventArray as a list of events.</span>
</span><span id="EventArray.to_events-378"><a href="#EventArray.to_events-378"><span class="linenos">378</span></a><span class="sd">        :param scans: the scans that the events belong to.</span>
</span><span id="EventArray.to_events-379"><a href="#EventArray.to_events-379"><span class="linenos">379</span></a><span class="sd">        :param ignore_missing_scans: whether to create blank scans for events without scans.</span>
</span><span id="EventArray.to_events-380"><a href="#EventArray.to_events-380"><span class="linenos">380</span></a><span class="sd">        :return:</span>
</span><span id="EventArray.to_events-381"><a href="#EventArray.to_events-381"><span class="linenos">381</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.to_events-382"><a href="#EventArray.to_events-382"><span class="linenos">382</span></a>        <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EventArray.to_events-383"><a href="#EventArray.to_events-383"><span class="linenos">383</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)):</span>
</span><span id="EventArray.to_events-384"><a href="#EventArray.to_events-384"><span class="linenos">384</span></a>            <span class="c1"># Determine the associated scan</span>
</span><span id="EventArray.to_events-385"><a href="#EventArray.to_events-385"><span class="linenos">385</span></a>            <span class="n">scan</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.to_events-386"><a href="#EventArray.to_events-386"><span class="linenos">386</span></a>            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
</span><span id="EventArray.to_events-387"><a href="#EventArray.to_events-387"><span class="linenos">387</span></a>                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">slide_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
</span><span id="EventArray.to_events-388"><a href="#EventArray.to_events-388"><span class="linenos">388</span></a>                    <span class="n">scan</span> <span class="o">=</span> <span class="n">s</span>
</span><span id="EventArray.to_events-389"><a href="#EventArray.to_events-389"><span class="linenos">389</span></a>                    <span class="k">break</span>
</span><span id="EventArray.to_events-390"><a href="#EventArray.to_events-390"><span class="linenos">390</span></a>            <span class="k">if</span> <span class="n">scan</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.to_events-391"><a href="#EventArray.to_events-391"><span class="linenos">391</span></a>                <span class="k">if</span> <span class="n">ignore_missing_scans</span><span class="p">:</span>
</span><span id="EventArray.to_events-392"><a href="#EventArray.to_events-392"><span class="linenos">392</span></a>                    <span class="c1"># Create a placeholder scan if the scan is missing</span>
</span><span id="EventArray.to_events-393"><a href="#EventArray.to_events-393"><span class="linenos">393</span></a>                    <span class="n">scan</span> <span class="o">=</span> <span class="n">csi_scans</span><span class="o">.</span><span class="n">Scan</span><span class="o">.</span><span class="n">make_placeholder</span><span class="p">(</span>
</span><span id="EventArray.to_events-394"><a href="#EventArray.to_events-394"><span class="linenos">394</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray.to_events-395"><a href="#EventArray.to_events-395"><span class="linenos">395</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray.to_events-396"><a href="#EventArray.to_events-396"><span class="linenos">396</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray.to_events-397"><a href="#EventArray.to_events-397"><span class="linenos">397</span></a>                    <span class="p">)</span>
</span><span id="EventArray.to_events-398"><a href="#EventArray.to_events-398"><span class="linenos">398</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="EventArray.to_events-399"><a href="#EventArray.to_events-399"><span class="linenos">399</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="EventArray.to_events-400"><a href="#EventArray.to_events-400"><span class="linenos">400</span></a>                        <span class="sa">f</span><span class="s2">&quot;Scan </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;slide_id&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found for event </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="EventArray.to_events-401"><a href="#EventArray.to_events-401"><span class="linenos">401</span></a>                    <span class="p">)</span>
</span><span id="EventArray.to_events-402"><a href="#EventArray.to_events-402"><span class="linenos">402</span></a>            <span class="c1"># Add to the list</span>
</span><span id="EventArray.to_events-403"><a href="#EventArray.to_events-403"><span class="linenos">403</span></a>            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="EventArray.to_events-404"><a href="#EventArray.to_events-404"><span class="linenos">404</span></a>                <span class="n">Event</span><span class="p">(</span>
</span><span id="EventArray.to_events-405"><a href="#EventArray.to_events-405"><span class="linenos">405</span></a>                    <span class="n">scan</span><span class="p">,</span>
</span><span id="EventArray.to_events-406"><a href="#EventArray.to_events-406"><span class="linenos">406</span></a>                    <span class="n">csi_tiles</span><span class="o">.</span><span class="n">Tile</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
</span><span id="EventArray.to_events-407"><a href="#EventArray.to_events-407"><span class="linenos">407</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray.to_events-408"><a href="#EventArray.to_events-408"><span class="linenos">408</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray.to_events-409"><a href="#EventArray.to_events-409"><span class="linenos">409</span></a>                    <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray.to_events-410"><a href="#EventArray.to_events-410"><span class="linenos">410</span></a>                    <span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray.to_events-411"><a href="#EventArray.to_events-411"><span class="linenos">411</span></a>                    <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="EventArray.to_events-412"><a href="#EventArray.to_events-412"><span class="linenos">412</span></a>                <span class="p">)</span>
</span><span id="EventArray.to_events-413"><a href="#EventArray.to_events-413"><span class="linenos">413</span></a>            <span class="p">)</span>
</span><span id="EventArray.to_events-414"><a href="#EventArray.to_events-414"><span class="linenos">414</span></a>        <span class="k">return</span> <span class="n">events</span>
</span></pre></div>


            <div class="docstring"><p>Get the events in the EventArray as a list of events.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>scans</strong>:  the scans that the events belong to.</li>
<li><strong>ignore_missing_scans</strong>:  whether to create blank scans for events without scans.</li>
</ul>

<h6 id="returns">Returns</h6>
</div>


                            </div>
                            <div id="EventArray.to_dataframe" class="classattr">
                                        <input id="EventArray.to_dataframe-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">to_dataframe</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>:</span></span>

                <label class="view-source-button" for="EventArray.to_dataframe-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.to_dataframe"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.to_dataframe-416"><a href="#EventArray.to_dataframe-416"><span class="linenos">416</span></a>    <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="EventArray.to_dataframe-417"><a href="#EventArray.to_dataframe-417"><span class="linenos">417</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.to_dataframe-418"><a href="#EventArray.to_dataframe-418"><span class="linenos">418</span></a><span class="sd">        Convert all the data in the EventArray to a single DataFrame.</span>
</span><span id="EventArray.to_dataframe-419"><a href="#EventArray.to_dataframe-419"><span class="linenos">419</span></a><span class="sd">        :return: a DataFrame with all the data in the EventArray.</span>
</span><span id="EventArray.to_dataframe-420"><a href="#EventArray.to_dataframe-420"><span class="linenos">420</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.to_dataframe-421"><a href="#EventArray.to_dataframe-421"><span class="linenos">421</span></a>        <span class="c1"># Make a copy of the info DataFrame and prepend &quot;info_&quot; to the column names</span>
</span><span id="EventArray.to_dataframe-422"><a href="#EventArray.to_dataframe-422"><span class="linenos">422</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray.to_dataframe-423"><a href="#EventArray.to_dataframe-423"><span class="linenos">423</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;info_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray.to_dataframe-424"><a href="#EventArray.to_dataframe-424"><span class="linenos">424</span></a>        <span class="c1"># Combine with the metadata and prepend &quot;metadata_&quot; to the column names</span>
</span><span id="EventArray.to_dataframe-425"><a href="#EventArray.to_dataframe-425"><span class="linenos">425</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.to_dataframe-426"><a href="#EventArray.to_dataframe-426"><span class="linenos">426</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray.to_dataframe-427"><a href="#EventArray.to_dataframe-427"><span class="linenos">427</span></a>            <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;metadata_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray.to_dataframe-428"><a href="#EventArray.to_dataframe-428"><span class="linenos">428</span></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">output</span><span class="p">,</span> <span class="n">metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventArray.to_dataframe-429"><a href="#EventArray.to_dataframe-429"><span class="linenos">429</span></a>        <span class="c1"># Combine with the features and prepend &quot;features_&quot; to the column names</span>
</span><span id="EventArray.to_dataframe-430"><a href="#EventArray.to_dataframe-430"><span class="linenos">430</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.to_dataframe-431"><a href="#EventArray.to_dataframe-431"><span class="linenos">431</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray.to_dataframe-432"><a href="#EventArray.to_dataframe-432"><span class="linenos">432</span></a>            <span class="n">features</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;features_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray.to_dataframe-433"><a href="#EventArray.to_dataframe-433"><span class="linenos">433</span></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">output</span><span class="p">,</span> <span class="n">features</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventArray.to_dataframe-434"><a href="#EventArray.to_dataframe-434"><span class="linenos">434</span></a>        <span class="k">return</span> <span class="n">output</span>
</span></pre></div>


            <div class="docstring"><p>Convert all the data in the EventArray to a single DataFrame.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a DataFrame with all the data in the EventArray.</p>
</blockquote>
</div>


                            </div>
                            <div id="EventArray.from_dataframe" class="classattr">
                                        <input id="EventArray.from_dataframe-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">from_dataframe</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">df</span></span><span class="return-annotation">) -> <span class="n">Self</span>:</span></span>

                <label class="view-source-button" for="EventArray.from_dataframe-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.from_dataframe"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.from_dataframe-436"><a href="#EventArray.from_dataframe-436"><span class="linenos">436</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray.from_dataframe-437"><a href="#EventArray.from_dataframe-437"><span class="linenos">437</span></a>    <span class="k">def</span> <span class="nf">from_dataframe</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray.from_dataframe-438"><a href="#EventArray.from_dataframe-438"><span class="linenos">438</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.from_dataframe-439"><a href="#EventArray.from_dataframe-439"><span class="linenos">439</span></a><span class="sd">        From a single, special DataFrame, create an EventArray.</span>
</span><span id="EventArray.from_dataframe-440"><a href="#EventArray.from_dataframe-440"><span class="linenos">440</span></a><span class="sd">        :return: a DataFrame with all the data in the EventArray.</span>
</span><span id="EventArray.from_dataframe-441"><a href="#EventArray.from_dataframe-441"><span class="linenos">441</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.from_dataframe-442"><a href="#EventArray.from_dataframe-442"><span class="linenos">442</span></a>        <span class="c1"># Split the columns into info, metadata, and features and strip prefix</span>
</span><span id="EventArray.from_dataframe-443"><a href="#EventArray.from_dataframe-443"><span class="linenos">443</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;info_&quot;</span><span class="p">)]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray.from_dataframe-444"><a href="#EventArray.from_dataframe-444"><span class="linenos">444</span></a>        <span class="n">info</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;info_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray.from_dataframe-445"><a href="#EventArray.from_dataframe-445"><span class="linenos">445</span></a>        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray.from_dataframe-446"><a href="#EventArray.from_dataframe-446"><span class="linenos">446</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.from_dataframe-447"><a href="#EventArray.from_dataframe-447"><span class="linenos">447</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;metadata_&quot;</span><span class="p">)]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray.from_dataframe-448"><a href="#EventArray.from_dataframe-448"><span class="linenos">448</span></a>        <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;metadata_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray.from_dataframe-449"><a href="#EventArray.from_dataframe-449"><span class="linenos">449</span></a>        <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray.from_dataframe-450"><a href="#EventArray.from_dataframe-450"><span class="linenos">450</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.from_dataframe-451"><a href="#EventArray.from_dataframe-451"><span class="linenos">451</span></a>        <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;features_&quot;</span><span class="p">)]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="EventArray.from_dataframe-452"><a href="#EventArray.from_dataframe-452"><span class="linenos">452</span></a>        <span class="n">features</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;features_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="EventArray.from_dataframe-453"><a href="#EventArray.from_dataframe-453"><span class="linenos">453</span></a>        <span class="k">if</span> <span class="n">features</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EventArray.from_dataframe-454"><a href="#EventArray.from_dataframe-454"><span class="linenos">454</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EventArray.from_dataframe-455"><a href="#EventArray.from_dataframe-455"><span class="linenos">455</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>From a single, special DataFrame, create an EventArray.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a DataFrame with all the data in the EventArray.</p>
</blockquote>
</div>


                            </div>
                            <div id="EventArray.save_csv" class="classattr">
                                        <input id="EventArray.save_csv-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_csv</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="EventArray.save_csv-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.save_csv"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.save_csv-457"><a href="#EventArray.save_csv-457"><span class="linenos">457</span></a>    <span class="k">def</span> <span class="nf">save_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="EventArray.save_csv-458"><a href="#EventArray.save_csv-458"><span class="linenos">458</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.save_csv-459"><a href="#EventArray.save_csv-459"><span class="linenos">459</span></a><span class="sd">        Save the events to an CSV file, including metadata and features.</span>
</span><span id="EventArray.save_csv-460"><a href="#EventArray.save_csv-460"><span class="linenos">460</span></a><span class="sd">        :param output_path:</span>
</span><span id="EventArray.save_csv-461"><a href="#EventArray.save_csv-461"><span class="linenos">461</span></a><span class="sd">        :return:</span>
</span><span id="EventArray.save_csv-462"><a href="#EventArray.save_csv-462"><span class="linenos">462</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.save_csv-463"><a href="#EventArray.save_csv-463"><span class="linenos">463</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="EventArray.save_csv-464"><a href="#EventArray.save_csv-464"><span class="linenos">464</span></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save the events to an CSV file, including metadata and features.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>output_path</strong>: </li>
</ul>

<h6 id="returns">Returns</h6>
</div>


                            </div>
                            <div id="EventArray.load_csv" class="classattr">
                                        <input id="EventArray.load_csv-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">load_csv</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Self</span>:</span></span>

                <label class="view-source-button" for="EventArray.load_csv-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.load_csv"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.load_csv-466"><a href="#EventArray.load_csv-466"><span class="linenos">466</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray.load_csv-467"><a href="#EventArray.load_csv-467"><span class="linenos">467</span></a>    <span class="k">def</span> <span class="nf">load_csv</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray.load_csv-468"><a href="#EventArray.load_csv-468"><span class="linenos">468</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.load_csv-469"><a href="#EventArray.load_csv-469"><span class="linenos">469</span></a><span class="sd">        Load the events from an CSV file, including metadata and features.</span>
</span><span id="EventArray.load_csv-470"><a href="#EventArray.load_csv-470"><span class="linenos">470</span></a><span class="sd">        :param input_path:</span>
</span><span id="EventArray.load_csv-471"><a href="#EventArray.load_csv-471"><span class="linenos">471</span></a><span class="sd">        :return:</span>
</span><span id="EventArray.load_csv-472"><a href="#EventArray.load_csv-472"><span class="linenos">472</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.load_csv-473"><a href="#EventArray.load_csv-473"><span class="linenos">473</span></a>        <span class="c1"># Load the CSV file</span>
</span><span id="EventArray.load_csv-474"><a href="#EventArray.load_csv-474"><span class="linenos">474</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="EventArray.load_csv-475"><a href="#EventArray.load_csv-475"><span class="linenos">475</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Load the events from an CSV file, including metadata and features.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>input_path</strong>: </li>
</ul>

<h6 id="returns">Returns</h6>
</div>


                            </div>
                            <div id="EventArray.save_hdf5" class="classattr">
                                        <input id="EventArray.save_hdf5-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_hdf5</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="EventArray.save_hdf5-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.save_hdf5"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.save_hdf5-477"><a href="#EventArray.save_hdf5-477"><span class="linenos">477</span></a>    <span class="k">def</span> <span class="nf">save_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="EventArray.save_hdf5-478"><a href="#EventArray.save_hdf5-478"><span class="linenos">478</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.save_hdf5-479"><a href="#EventArray.save_hdf5-479"><span class="linenos">479</span></a><span class="sd">        Save the events to an HDF5 file, including metadata and features.</span>
</span><span id="EventArray.save_hdf5-480"><a href="#EventArray.save_hdf5-480"><span class="linenos">480</span></a><span class="sd">        Uses the pandas-provided HDF5 functions for ease, and external compatibility,</span>
</span><span id="EventArray.save_hdf5-481"><a href="#EventArray.save_hdf5-481"><span class="linenos">481</span></a><span class="sd">        though these files are slightly harder to view in HDFView or similar.</span>
</span><span id="EventArray.save_hdf5-482"><a href="#EventArray.save_hdf5-482"><span class="linenos">482</span></a><span class="sd">        :param output_path:</span>
</span><span id="EventArray.save_hdf5-483"><a href="#EventArray.save_hdf5-483"><span class="linenos">483</span></a><span class="sd">        :return:</span>
</span><span id="EventArray.save_hdf5-484"><a href="#EventArray.save_hdf5-484"><span class="linenos">484</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.save_hdf5-485"><a href="#EventArray.save_hdf5-485"><span class="linenos">485</span></a>        <span class="c1"># Open the output_path as an HDF5 file</span>
</span><span id="EventArray.save_hdf5-486"><a href="#EventArray.save_hdf5-486"><span class="linenos">486</span></a>        <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">store</span><span class="p">:</span>
</span><span id="EventArray.save_hdf5-487"><a href="#EventArray.save_hdf5-487"><span class="linenos">487</span></a>            <span class="c1"># Store the dataframes in the HDF5 file</span>
</span><span id="EventArray.save_hdf5-488"><a href="#EventArray.save_hdf5-488"><span class="linenos">488</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.save_hdf5-489"><a href="#EventArray.save_hdf5-489"><span class="linenos">489</span></a>                <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="EventArray.save_hdf5-490"><a href="#EventArray.save_hdf5-490"><span class="linenos">490</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.save_hdf5-491"><a href="#EventArray.save_hdf5-491"><span class="linenos">491</span></a>                <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="EventArray.save_hdf5-492"><a href="#EventArray.save_hdf5-492"><span class="linenos">492</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EventArray.save_hdf5-493"><a href="#EventArray.save_hdf5-493"><span class="linenos">493</span></a>                <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="EventArray.save_hdf5-494"><a href="#EventArray.save_hdf5-494"><span class="linenos">494</span></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save the events to an HDF5 file, including metadata and features.
Uses the pandas-provided HDF5 functions for ease, and external compatibility,
though these files are slightly harder to view in HDFView or similar.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>output_path</strong>: </li>
</ul>

<h6 id="returns">Returns</h6>
</div>


                            </div>
                            <div id="EventArray.load_hdf5" class="classattr">
                                        <input id="EventArray.load_hdf5-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">load_hdf5</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Self</span>:</span></span>

                <label class="view-source-button" for="EventArray.load_hdf5-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventArray.load_hdf5"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventArray.load_hdf5-496"><a href="#EventArray.load_hdf5-496"><span class="linenos">496</span></a>    <span class="nd">@classmethod</span>
</span><span id="EventArray.load_hdf5-497"><a href="#EventArray.load_hdf5-497"><span class="linenos">497</span></a>    <span class="k">def</span> <span class="nf">load_hdf5</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Self</span><span class="p">:</span>
</span><span id="EventArray.load_hdf5-498"><a href="#EventArray.load_hdf5-498"><span class="linenos">498</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventArray.load_hdf5-499"><a href="#EventArray.load_hdf5-499"><span class="linenos">499</span></a><span class="sd">        Load the events from an HDF5 file, including metadata and features.</span>
</span><span id="EventArray.load_hdf5-500"><a href="#EventArray.load_hdf5-500"><span class="linenos">500</span></a><span class="sd">        :param input_path:</span>
</span><span id="EventArray.load_hdf5-501"><a href="#EventArray.load_hdf5-501"><span class="linenos">501</span></a><span class="sd">        :return:</span>
</span><span id="EventArray.load_hdf5-502"><a href="#EventArray.load_hdf5-502"><span class="linenos">502</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventArray.load_hdf5-503"><a href="#EventArray.load_hdf5-503"><span class="linenos">503</span></a>        <span class="c1"># Open the input_path as an HDF5 file</span>
</span><span id="EventArray.load_hdf5-504"><a href="#EventArray.load_hdf5-504"><span class="linenos">504</span></a>        <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">store</span><span class="p">:</span>
</span><span id="EventArray.load_hdf5-505"><a href="#EventArray.load_hdf5-505"><span class="linenos">505</span></a>            <span class="c1"># Load the dataframes from the HDF5 file</span>
</span><span id="EventArray.load_hdf5-506"><a href="#EventArray.load_hdf5-506"><span class="linenos">506</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;info&quot;</span> <span class="ow">in</span> <span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="EventArray.load_hdf5-507"><a href="#EventArray.load_hdf5-507"><span class="linenos">507</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="EventArray.load_hdf5-508"><a href="#EventArray.load_hdf5-508"><span class="linenos">508</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;features&quot;</span> <span class="ow">in</span> <span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="EventArray.load_hdf5-509"><a href="#EventArray.load_hdf5-509"><span class="linenos">509</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Load the events from an HDF5 file, including metadata and features.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>input_path</strong>: </li>
</ul>

<h6 id="returns">Returns</h6>
</div>


                            </div>
                </section>
                <section id="extract_all_event_images">
                            <input id="extract_all_event_images-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">extract_all_event_images</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="#Event">Event</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">crop_size</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="extract_all_event_images-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#extract_all_event_images"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="extract_all_event_images-512"><a href="#extract_all_event_images-512"><span class="linenos">512</span></a><span class="k">def</span> <span class="nf">extract_all_event_images</span><span class="p">(</span>
</span><span id="extract_all_event_images-513"><a href="#extract_all_event_images-513"><span class="linenos">513</span></a>    <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Event</span><span class="p">],</span>
</span><span id="extract_all_event_images-514"><a href="#extract_all_event_images-514"><span class="linenos">514</span></a>    <span class="n">crop_size</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="extract_all_event_images-515"><a href="#extract_all_event_images-515"><span class="linenos">515</span></a>    <span class="n">in_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="extract_all_event_images-516"><a href="#extract_all_event_images-516"><span class="linenos">516</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
</span><span id="extract_all_event_images-517"><a href="#extract_all_event_images-517"><span class="linenos">517</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="extract_all_event_images-518"><a href="#extract_all_event_images-518"><span class="linenos">518</span></a><span class="sd">    Get the images for a list of events, ensuring that there is no wasteful reading</span>
</span><span id="extract_all_event_images-519"><a href="#extract_all_event_images-519"><span class="linenos">519</span></a><span class="sd">    of the same tile multiple times. This function is more efficient than calling</span>
</span><span id="extract_all_event_images-520"><a href="#extract_all_event_images-520"><span class="linenos">520</span></a><span class="sd">    extract_event_images for each event.</span>
</span><span id="extract_all_event_images-521"><a href="#extract_all_event_images-521"><span class="linenos">521</span></a><span class="sd">    TODO: test this function</span>
</span><span id="extract_all_event_images-522"><a href="#extract_all_event_images-522"><span class="linenos">522</span></a><span class="sd">    :param events: the events to extract images for.</span>
</span><span id="extract_all_event_images-523"><a href="#extract_all_event_images-523"><span class="linenos">523</span></a><span class="sd">    :param crop_size: the square size of the image crop to get for this event.</span>
</span><span id="extract_all_event_images-524"><a href="#extract_all_event_images-524"><span class="linenos">524</span></a><span class="sd">                      Defaults to twice the size of the event.</span>
</span><span id="extract_all_event_images-525"><a href="#extract_all_event_images-525"><span class="linenos">525</span></a><span class="sd">    :param in_pixels: whether the crop size is in pixels or micrometers.</span>
</span><span id="extract_all_event_images-526"><a href="#extract_all_event_images-526"><span class="linenos">526</span></a><span class="sd">                      Defaults to um.</span>
</span><span id="extract_all_event_images-527"><a href="#extract_all_event_images-527"><span class="linenos">527</span></a><span class="sd">    :return: a list of lists of cropped images for each event.</span>
</span><span id="extract_all_event_images-528"><a href="#extract_all_event_images-528"><span class="linenos">528</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="extract_all_event_images-529"><a href="#extract_all_event_images-529"><span class="linenos">529</span></a>
</span><span id="extract_all_event_images-530"><a href="#extract_all_event_images-530"><span class="linenos">530</span></a>    <span class="c1"># Sort the events by tile; use a shallow copy to avoid modifying the original</span>
</span><span id="extract_all_event_images-531"><a href="#extract_all_event_images-531"><span class="linenos">531</span></a>    <span class="n">events</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">events</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()))</span>
</span><span id="extract_all_event_images-532"><a href="#extract_all_event_images-532"><span class="linenos">532</span></a>
</span><span id="extract_all_event_images-533"><a href="#extract_all_event_images-533"><span class="linenos">533</span></a>    <span class="k">if</span> <span class="n">crop_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="extract_all_event_images-534"><a href="#extract_all_event_images-534"><span class="linenos">534</span></a>        <span class="n">crop_size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">event</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
</span><span id="extract_all_event_images-535"><a href="#extract_all_event_images-535"><span class="linenos">535</span></a>        <span class="n">in_pixels</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="extract_all_event_images-536"><a href="#extract_all_event_images-536"><span class="linenos">536</span></a>
</span><span id="extract_all_event_images-537"><a href="#extract_all_event_images-537"><span class="linenos">537</span></a>    <span class="c1"># Allocate the list to size</span>
</span><span id="extract_all_event_images-538"><a href="#extract_all_event_images-538"><span class="linenos">538</span></a>    <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</span><span id="extract_all_event_images-539"><a href="#extract_all_event_images-539"><span class="linenos">539</span></a>    <span class="n">last_tile</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="extract_all_event_images-540"><a href="#extract_all_event_images-540"><span class="linenos">540</span></a>    <span class="n">frame_images</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Holds large numpy arrays, so expensive to compare</span>
</span><span id="extract_all_event_images-541"><a href="#extract_all_event_images-541"><span class="linenos">541</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)):</span>
</span><span id="extract_all_event_images-542"><a href="#extract_all_event_images-542"><span class="linenos">542</span></a>        <span class="k">if</span> <span class="n">last_tile</span> <span class="o">!=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tile</span><span class="p">:</span>
</span><span id="extract_all_event_images-543"><a href="#extract_all_event_images-543"><span class="linenos">543</span></a>            <span class="c1"># Gather the frame images, preserving them for the next event</span>
</span><span id="extract_all_event_images-544"><a href="#extract_all_event_images-544"><span class="linenos">544</span></a>            <span class="n">frames</span> <span class="o">=</span> <span class="n">csi_frames</span><span class="o">.</span><span class="n">Frame</span><span class="o">.</span><span class="n">get_frames</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tile</span><span class="p">)</span>
</span><span id="extract_all_event_images-545"><a href="#extract_all_event_images-545"><span class="linenos">545</span></a>            <span class="n">frame_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">get_image</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">]</span>
</span><span id="extract_all_event_images-546"><a href="#extract_all_event_images-546"><span class="linenos">546</span></a>
</span><span id="extract_all_event_images-547"><a href="#extract_all_event_images-547"><span class="linenos">547</span></a>            <span class="n">last_tile</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tile</span>
</span><span id="extract_all_event_images-548"><a href="#extract_all_event_images-548"><span class="linenos">548</span></a>        <span class="c1"># Use the frame images to crop the event images</span>
</span><span id="extract_all_event_images-549"><a href="#extract_all_event_images-549"><span class="linenos">549</span></a>        <span class="c1"># Preserve the original order using order[i]</span>
</span><span id="extract_all_event_images-550"><a href="#extract_all_event_images-550"><span class="linenos">550</span></a>        <span class="n">images</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">crop_images_to_event</span><span class="p">(</span>
</span><span id="extract_all_event_images-551"><a href="#extract_all_event_images-551"><span class="linenos">551</span></a>            <span class="n">frame_images</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">in_pixels</span>
</span><span id="extract_all_event_images-552"><a href="#extract_all_event_images-552"><span class="linenos">552</span></a>        <span class="p">)</span>
</span><span id="extract_all_event_images-553"><a href="#extract_all_event_images-553"><span class="linenos">553</span></a>    <span class="k">return</span> <span class="n">images</span>
</span></pre></div>


            <div class="docstring"><p>Get the images for a list of events, ensuring that there is no wasteful reading
of the same tile multiple times. This function is more efficient than calling
extract_event_images for each event.
TODO: test this function</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>events</strong>:  the events to extract images for.</li>
<li><strong>crop_size</strong>:  the square size of the image crop to get for this event.
Defaults to twice the size of the event.</li>
<li><strong>in_pixels</strong>:  whether the crop size is in pixels or micrometers.
Defaults to um.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a list of lists of cropped images for each event.</p>
</blockquote>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>