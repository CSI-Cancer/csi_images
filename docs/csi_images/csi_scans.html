<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.1"/>
    <title>csi_images.csi_scans API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#49483e}.pdoc-code{background:#272822; color:#f8f8f2}.pdoc-code .c{color:#75715e}.pdoc-code .err{color:#960050; background-color:#1e0010}.pdoc-code .esc{color:#f8f8f2}.pdoc-code .g{color:#f8f8f2}.pdoc-code .k{color:#66d9ef}.pdoc-code .l{color:#ae81ff}.pdoc-code .n{color:#f8f8f2}.pdoc-code .o{color:#f92672}.pdoc-code .x{color:#f8f8f2}.pdoc-code .p{color:#f8f8f2}.pdoc-code .ch{color:#75715e}.pdoc-code .cm{color:#75715e}.pdoc-code .cp{color:#75715e}.pdoc-code .cpf{color:#75715e}.pdoc-code .c1{color:#75715e}.pdoc-code .cs{color:#75715e}.pdoc-code .gd{color:#f92672}.pdoc-code .ge{color:#f8f8f2; font-style:italic}.pdoc-code .gr{color:#f8f8f2}.pdoc-code .gh{color:#f8f8f2}.pdoc-code .gi{color:#a6e22e}.pdoc-code .go{color:#66d9ef}.pdoc-code .gp{color:#f92672; font-weight:bold}.pdoc-code .gs{color:#f8f8f2; font-weight:bold}.pdoc-code .gu{color:#75715e}.pdoc-code .gt{color:#f8f8f2}.pdoc-code .kc{color:#66d9ef}.pdoc-code .kd{color:#66d9ef}.pdoc-code .kn{color:#f92672}.pdoc-code .kp{color:#66d9ef}.pdoc-code .kr{color:#66d9ef}.pdoc-code .kt{color:#66d9ef}.pdoc-code .ld{color:#e6db74}.pdoc-code .m{color:#ae81ff}.pdoc-code .s{color:#e6db74}.pdoc-code .na{color:#a6e22e}.pdoc-code .nb{color:#f8f8f2}.pdoc-code .nc{color:#a6e22e}.pdoc-code .no{color:#66d9ef}.pdoc-code .nd{color:#a6e22e}.pdoc-code .ni{color:#f8f8f2}.pdoc-code .ne{color:#a6e22e}.pdoc-code .nf{color:#a6e22e}.pdoc-code .nl{color:#f8f8f2}.pdoc-code .nn{color:#f8f8f2}.pdoc-code .nx{color:#a6e22e}.pdoc-code .py{color:#f8f8f2}.pdoc-code .nt{color:#f92672}.pdoc-code .nv{color:#f8f8f2}.pdoc-code .ow{color:#f92672}.pdoc-code .w{color:#f8f8f2}.pdoc-code .mb{color:#ae81ff}.pdoc-code .mf{color:#ae81ff}.pdoc-code .mh{color:#ae81ff}.pdoc-code .mi{color:#ae81ff}.pdoc-code .mo{color:#ae81ff}.pdoc-code .sa{color:#e6db74}.pdoc-code .sb{color:#e6db74}.pdoc-code .sc{color:#e6db74}.pdoc-code .dl{color:#e6db74}.pdoc-code .sd{color:#e6db74}.pdoc-code .s2{color:#e6db74}.pdoc-code .se{color:#ae81ff}.pdoc-code .sh{color:#e6db74}.pdoc-code .si{color:#e6db74}.pdoc-code .sx{color:#e6db74}.pdoc-code .sr{color:#e6db74}.pdoc-code .s1{color:#e6db74}.pdoc-code .ss{color:#e6db74}.pdoc-code .bp{color:#f8f8f2}.pdoc-code .fm{color:#a6e22e}.pdoc-code .vc{color:#f8f8f2}.pdoc-code .vg{color:#f8f8f2}.pdoc-code .vi{color:#f8f8f2}.pdoc-code .vm{color:#f8f8f2}</style>
    <style>/*! theme.css */:root{--pdoc-background:#212529;}.pdoc{--text:#f7f7f7;--muted:#9d9d9d;--link:#58a6ff;--link-hover:#3989ff;--code:#333;--active:#555;--accent:#343434;--accent2:#555;--nav-hover:rgba(0, 0, 0, 0.1);--name:#77C1FF;--def:#0cdd0c;--annotation:#00c037;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../csi_images.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;csi_images</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Scan">Scan</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Scan.__init__">Scan</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.yaml_tag">yaml_tag</a>
                        </li>
                        <li>
                                <a class="class" href="#Scan.Type">Scan.Type</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="variable" href="#Scan.Type.BZSCANNER">BZSCANNER</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Scan.Type.AXIOSCAN7">AXIOSCAN7</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="variable" href="#Scan.SCANNER_IDS">SCANNER_IDS</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.METADATA_FILE_NAME">METADATA_FILE_NAME</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.STANDARD_DATETIME_FORMAT">STANDARD_DATETIME_FORMAT</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.DATETIME_FORMAT">DATETIME_FORMAT</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.BZSCANNER_CHANNEL_MAP">BZSCANNER_CHANNEL_MAP</a>
                        </li>
                        <li>
                                <a class="class" href="#Scan.Channel">Scan.Channel</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Scan.Channel.__init__">Channel</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Scan.Channel.yaml_tag">yaml_tag</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Scan.Channel.name">name</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Scan.Channel.exposure_ms">exposure_ms</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Scan.Channel.intensity">intensity</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Scan.Channel.gain_applied">gain_applied</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Scan.ROI">Scan.ROI</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Scan.ROI.__init__">ROI</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Scan.ROI.yaml_tag">yaml_tag</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Scan.ROI.origin_x_um">origin_x_um</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Scan.ROI.origin_y_um">origin_y_um</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Scan.ROI.width_um">width_um</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Scan.ROI.height_um">height_um</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Scan.ROI.tile_rows">tile_rows</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Scan.ROI.tile_cols">tile_cols</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Scan.ROI.focus_points">focus_points</a>
                                    </li>
                                    <li>
                                            <a class="function" href="#Scan.ROI.similar">similar</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="variable" href="#Scan.slide_id">slide_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.scanner_id">scanner_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.path">path</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.exists">exists</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.start_datetime">start_datetime</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.end_datetime">end_datetime</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.scan_time_s">scan_time_s</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.tray_pos">tray_pos</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.slide_pos">slide_pos</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.camera">camera</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.objective">objective</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.pixel_size_um">pixel_size_um</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.tile_width_px">tile_width_px</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.tile_height_px">tile_height_px</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.tile_x_offset_px">tile_x_offset_px</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.tile_y_offset_px">tile_y_offset_px</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.tile_overlap_proportion">tile_overlap_proportion</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.channels">channels</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scan.roi">roi</a>
                        </li>
                        <li>
                                <a class="function" href="#Scan.has_same_profile">has_same_profile</a>
                        </li>
                        <li>
                                <a class="function" href="#Scan.get_channel_names">get_channel_names</a>
                        </li>
                        <li>
                                <a class="function" href="#Scan.get_channel_indices">get_channel_indices</a>
                        </li>
                        <li>
                                <a class="function" href="#Scan.get_image_size">get_image_size</a>
                        </li>
                        <li>
                                <a class="function" href="#Scan.save_yaml">save_yaml</a>
                        </li>
                        <li>
                                <a class="function" href="#Scan.load_yaml">load_yaml</a>
                        </li>
                        <li>
                                <a class="function" href="#Scan.to_dict">to_dict</a>
                        </li>
                        <li>
                                <a class="function" href="#Scan.from_dict">from_dict</a>
                        </li>
                        <li>
                                <a class="function" href="#Scan.load_czi">load_czi</a>
                        </li>
                        <li>
                                <a class="function" href="#Scan.load_txt">load_txt</a>
                        </li>
                        <li>
                                <a class="function" href="#Scan.load_from_folder">load_from_folder</a>
                        </li>
                        <li>
                                <a class="function" href="#Scan.make_placeholder">make_placeholder</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../csi_images.html">csi_images</a><wbr>.csi_scans    </h1>

                        <div class="docstring"><p>Contains the Scan class, which holds important metadata from a scan. This metadata
can be exported to a .yaml file, which can be loaded back into a Scan object. The Scan
object can also be loaded from a .czi file or a .txt file.</p>
</div>

                        <input id="mod-csi_scans-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-csi_scans-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="sd">Contains the Scan class, which holds important metadata from a scan. This metadata</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">can be exported to a .yaml file, which can be loaded back into a Scan object. The Scan</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="sd">object can also be loaded from a .czi file or a .txt file.</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">zoneinfo</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Self</span><span class="p">,</span> <span class="n">Iterable</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="k">try</span><span class="p">:</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">aicspylibczi</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>    <span class="n">aicspylibczi</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Scan</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">YAMLObject</span><span class="p">):</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">    Class that composes a whole scan&#39;s metadata. Contains some universal data,</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">    plus lists for channels and ROIs.</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">    .. include:: ../docs/coordinate_systems.md</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>    <span class="n">yaml_tag</span> <span class="o">=</span> <span class="s2">&quot;csi_images.csi_scans.Scan&quot;</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Type</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>        <span class="n">BZSCANNER</span> <span class="o">=</span> <span class="s2">&quot;bzscanner&quot;</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>        <span class="n">AXIOSCAN7</span> <span class="o">=</span> <span class="s2">&quot;axioscan7&quot;</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>    <span class="n">SCANNER_IDS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;4661000426&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">_0&quot;</span><span class="p">}</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Axioscan 7 scanner IDs (service number), mapped to our scanner IDs&quot;&quot;&quot;</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>    <span class="n">METADATA_FILE_NAME</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>        <span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">:</span> <span class="s2">&quot;scan.yaml&quot;</span><span class="p">,</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>        <span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">:</span> <span class="s2">&quot;slideinfo.txt&quot;</span><span class="p">,</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>    <span class="p">}</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>    <span class="n">STANDARD_DATETIME_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S%z&quot;</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>    <span class="n">DATETIME_FORMAT</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>        <span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">:</span> <span class="n">STANDARD_DATETIME_FORMAT</span><span class="p">,</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>        <span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%a</span><span class="s2"> %b </span><span class="si">%d</span><span class="s2"> %H:%M:%S %Y&quot;</span><span class="p">,</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>    <span class="p">}</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>    <span class="c1"># Actual channel names, from the BZScanner&#39;s default order</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>    <span class="n">BZSCANNER_CHANNEL_MAP</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>        <span class="s2">&quot;DAPI&quot;</span><span class="p">:</span> <span class="s2">&quot;DAPI&quot;</span><span class="p">,</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>        <span class="s2">&quot;TRITC&quot;</span><span class="p">:</span> <span class="s2">&quot;AF555&quot;</span><span class="p">,</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>        <span class="s2">&quot;CY5&quot;</span><span class="p">:</span> <span class="s2">&quot;AF647&quot;</span><span class="p">,</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>        <span class="s2">&quot;BF&quot;</span><span class="p">:</span> <span class="s2">&quot;BRIGHT&quot;</span><span class="p">,</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>        <span class="s2">&quot;FITC&quot;</span><span class="p">:</span> <span class="s2">&quot;AF488&quot;</span><span class="p">,</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>    <span class="p">}</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Channel</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">YAMLObject</span><span class="p">):</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">        Class that comprises a channel; we usually have multiple (2-5) per scan.</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">        Contains three fields:</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="sd">        - name: the name of the channel (e.g. DAPI, AF647, AF555, AF488, BRIGHTFIELD)</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">        - exposure_ms: the exposure time to capture a frame in milliseconds</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">        - intensity: the light intensity used OR the gain applied to the channel</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>        <span class="n">yaml_tag</span> <span class="o">=</span> <span class="s2">&quot;csi_images.csi_scans.Scan.Channel&quot;</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>            <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>            <span class="n">exposure_ms</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>            <span class="n">intensity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>            <span class="n">gain_applied</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>        <span class="p">):</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">exposure_ms</span> <span class="o">=</span> <span class="n">exposure_ms</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="n">intensity</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gain_applied</span> <span class="o">=</span> <span class="n">gain_applied</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>            <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ROI</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">YAMLObject</span><span class="p">):</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="sd">        Class that comprises an ROI; we usually have 1, but may have more in a scan.</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>        <span class="n">yaml_tag</span> <span class="o">=</span> <span class="s2">&quot;csi_images.csi_scans.Scan.ROI&quot;</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>            <span class="n">origin_x_um</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>            <span class="n">origin_y_um</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>            <span class="n">width_um</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>            <span class="n">height_um</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>            <span class="n">tile_rows</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>            <span class="n">tile_cols</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>            <span class="n">focus_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>        <span class="p">):</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>            <span class="k">if</span> <span class="n">focus_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>                <span class="n">focus_points</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">origin_x_um</span> <span class="o">=</span> <span class="n">origin_x_um</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">origin_y_um</span> <span class="o">=</span> <span class="n">origin_y_um</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">width_um</span> <span class="o">=</span> <span class="n">width_um</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">height_um</span> <span class="o">=</span> <span class="n">height_um</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tile_rows</span> <span class="o">=</span> <span class="n">tile_rows</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tile_cols</span> <span class="o">=</span> <span class="n">tile_cols</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">focus_points</span> <span class="o">=</span> <span class="n">focus_points</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>            <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">similar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>            <span class="k">return</span> <span class="p">(</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">origin_y_um</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">origin_y_um</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_x_um</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">origin_x_um</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">width_um</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">width_um</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">height_um</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">height_um</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_rows</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_rows</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_cols</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_cols</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>            <span class="p">)</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>        <span class="n">slide_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>        <span class="n">scanner_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>        <span class="n">exists</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>        <span class="n">start_datetime</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>        <span class="n">end_datetime</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>        <span class="n">scan_time_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>        <span class="n">tray_pos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>        <span class="n">slide_pos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>        <span class="n">camera</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>        <span class="n">objective</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>        <span class="n">pixel_size_um</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>        <span class="n">tile_width_px</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>        <span class="n">tile_height_px</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>        <span class="n">tile_x_offset_px</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>        <span class="n">tile_y_offset_px</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>        <span class="n">tile_overlap_proportion</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="n">channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Channel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>        <span class="n">roi</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ROI</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>    <span class="p">):</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>        <span class="k">if</span> <span class="n">roi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>            <span class="n">roi</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>        <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>            <span class="n">channels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slide_id</span> <span class="o">=</span> <span class="n">slide_id</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scanner_id</span> <span class="o">=</span> <span class="n">scanner_id</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exists</span> <span class="o">=</span> <span class="n">exists</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start_datetime</span> <span class="o">=</span> <span class="n">start_datetime</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">end_datetime</span> <span class="o">=</span> <span class="n">end_datetime</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scan_time_s</span> <span class="o">=</span> <span class="n">scan_time_s</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tray_pos</span> <span class="o">=</span> <span class="n">tray_pos</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slide_pos</span> <span class="o">=</span> <span class="n">slide_pos</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="n">camera</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">objective</span> <span class="o">=</span> <span class="n">objective</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size_um</span> <span class="o">=</span> <span class="n">pixel_size_um</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">=</span> <span class="n">tile_width_px</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">=</span> <span class="n">tile_height_px</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_x_offset_px</span> <span class="o">=</span> <span class="n">tile_x_offset_px</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_y_offset_px</span> <span class="o">=</span> <span class="n">tile_y_offset_px</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_overlap_proportion</span> <span class="o">=</span> <span class="n">tile_overlap_proportion</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="n">roi</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slide_id</span><span class="p">,</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scanner_id</span><span class="p">,</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">,</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">start_datetime</span><span class="p">,</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">end_datetime</span><span class="p">,</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scan_time_s</span><span class="p">,</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tray_pos</span><span class="p">,</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slide_pos</span><span class="p">,</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">camera</span><span class="p">,</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">,</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size_um</span><span class="p">,</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tile_width_px</span><span class="p">,</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tile_height_px</span><span class="p">,</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tile_overlap_proportion</span><span class="p">,</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>            <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">),</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>            <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">),</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>        <span class="p">)</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__key</span><span class="p">())</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>        <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">has_same_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">camera</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">camera</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">objective</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size_um</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">pixel_size_um</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_width_px</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_height_px</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_x_offset_px</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_x_offset_px</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_y_offset_px</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_y_offset_px</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_overlap_proportion</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_overlap_proportion</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">channels</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>            <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">similar</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">roi</span><span class="p">))</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>        <span class="p">)</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_channel_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a><span class="sd">        Get the channel names in the scan&#39;s channel order.</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a><span class="sd">        :return: a list of channel names.</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">]</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_channel_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a><span class="sd">        Given a list of channel names, return the corresponding indices in the scan&#39;s</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a><span class="sd">        channel order. Will convert BZScanner channel names (TRITC, CY5, FITC) to the</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a><span class="sd">        actual AlexaFluor names (AF555, AF647, AF488).</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a><span class="sd">        If a list entry is not found or None, it will return -1 for that entry.</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a><span class="sd">        :param channel_names: a list of channel names.</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a><span class="sd">        :return: a list of channel indices.</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>        <span class="c1"># Get the scan&#39;s channel name list</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>        <span class="n">scan_channel_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_channel_names</span><span class="p">()</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>        <span class="n">channel_indices</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">channel_names</span><span class="p">:</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>            <span class="c1"># Convert any BZScanner channel names to the actual channel names</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BZSCANNER_CHANNEL_MAP</span><span class="p">:</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BZSCANNER_CHANNEL_MAP</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>            <span class="c1"># Append the corresponding index if possible</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">scan_channel_names</span><span class="p">:</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>                <span class="n">channel_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan_channel_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>                <span class="n">channel_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>        <span class="k">return</span> <span class="n">channel_indices</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_image_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a><span class="sd">        Get the real size of the image in pixels after subtracting overlap.</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a><span class="sd">        :return: a tuple of (real_height, real_width) for easy comparison to arrays</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>        <span class="n">width_overlap</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_overlap_proportion</span><span class="p">)</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>        <span class="n">height_overlap</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_overlap_proportion</span><span class="p">)</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">-</span> <span class="n">height_overlap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">-</span> <span class="n">width_overlap</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a><span class="sd">        Write the Scan object to a .yaml file.</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a><span class="sd">        :param output_path: /path/to/file.yaml or /path/to/folder to put scan.yaml</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a><span class="sd">        :return: nothing; will raise an error on failure</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>        <span class="c1"># Create necessary folders</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">output_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.yaml&quot;</span><span class="p">:</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>            <span class="c1"># Add the standard metadata file name to the path if needed</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>            <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>                <span class="n">output_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">METADATA_FILE_NAME</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">]</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>            <span class="p">)</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>        <span class="c1"># Populate the file</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>            <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_yaml</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a><span class="sd">        Load a Scan object from a .yaml file.</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a><span class="sd">        :param input_path: /path/to/file.yaml or /path/to/folder with scan.yaml</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a><span class="sd">        :return: a Scan object</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>        <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">input_path</span><span class="p">):</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>            <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>                <span class="n">input_path</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">METADATA_FILE_NAME</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">]</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>            <span class="p">)</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>            <span class="n">metadata_obj</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">Loader</span><span class="p">)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>        <span class="k">return</span> <span class="n">metadata_obj</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a><span class="sd">        Convert the Scan object to a dictionary with keys matching database columns</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a><span class="sd">        and values matching database entries</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a><span class="sd">        :return: a dictionary</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>        <span class="c1"># Dump to json; then add indents and a top-level key</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>        <span class="n">channels_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>        <span class="p">)</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>        <span class="n">channels_json</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">channels_json</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>        <span class="n">channels_json</span> <span class="o">=</span> <span class="s2">&quot;{</span><span class="se">\n</span><span class="s2">  &quot;</span> <span class="o">+</span> <span class="s1">&#39;&quot;data&quot;: &#39;</span> <span class="o">+</span> <span class="n">channels_json</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">}&quot;</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>        <span class="n">roi_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>        <span class="n">roi_json</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_json</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>        <span class="n">roi_json</span> <span class="o">=</span> <span class="s2">&quot;{</span><span class="se">\n</span><span class="s2">  &quot;</span> <span class="o">+</span> <span class="s1">&#39;&quot;data&quot;: &#39;</span> <span class="o">+</span> <span class="n">roi_json</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">}&quot;</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>        <span class="c1"># Keys are named the same as database columns</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>            <span class="s2">&quot;scanner_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanner_id</span><span class="p">,</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>            <span class="s2">&quot;slide_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_id</span><span class="p">,</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>            <span class="s2">&quot;exists&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">,</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>            <span class="s2">&quot;start_datetime&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_datetime</span><span class="p">,</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>            <span class="s2">&quot;end_datetime&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_datetime</span><span class="p">,</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>            <span class="s2">&quot;scan_time_s&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_time_s</span><span class="p">,</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>            <span class="s2">&quot;tray_pos&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tray_pos</span><span class="p">,</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>            <span class="s2">&quot;slide_pos&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_pos</span><span class="p">,</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>            <span class="s2">&quot;tile_width&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_width_px</span><span class="p">,</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>            <span class="s2">&quot;tile_height&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_height_px</span><span class="p">,</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>            <span class="s2">&quot;tile_x_offset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_x_offset_px</span><span class="p">,</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>            <span class="s2">&quot;tile_y_offset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_y_offset_px</span><span class="p">,</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>            <span class="s2">&quot;tile_overlap&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_overlap_proportion</span><span class="p">,</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>            <span class="s2">&quot;camera&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera</span><span class="p">,</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>            <span class="s2">&quot;objective&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">,</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>            <span class="s2">&quot;pixel_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size_um</span><span class="p">,</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>            <span class="s2">&quot;channels&quot;</span><span class="p">:</span> <span class="n">channels_json</span><span class="p">,</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>            <span class="s2">&quot;roi&quot;</span><span class="p">:</span> <span class="n">roi_json</span><span class="p">,</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>        <span class="p">}</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">scan_dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a><span class="sd">        Convert a dictionary from to_dict() or the database to a Scan object</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a><span class="sd">        :param scan_dict: a dictionary</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a><span class="sd">        :return: a Scan object</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>            <span class="n">scanner_id</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;scanner_id&quot;</span><span class="p">],</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>            <span class="n">slide_id</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">],</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>            <span class="n">path</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>            <span class="n">exists</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;exists&quot;</span><span class="p">],</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>            <span class="n">start_datetime</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;start_datetime&quot;</span><span class="p">],</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>            <span class="n">end_datetime</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;end_datetime&quot;</span><span class="p">],</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>            <span class="n">scan_time_s</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;scan_time_s&quot;</span><span class="p">],</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>            <span class="n">tray_pos</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;tray_pos&quot;</span><span class="p">],</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>            <span class="n">slide_pos</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;slide_pos&quot;</span><span class="p">],</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>            <span class="n">camera</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;camera&quot;</span><span class="p">],</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>            <span class="n">objective</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;objective&quot;</span><span class="p">],</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>            <span class="n">pixel_size_um</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;pixel_size&quot;</span><span class="p">],</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>            <span class="n">tile_width_px</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;tile_width&quot;</span><span class="p">],</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>            <span class="n">tile_height_px</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;tile_height&quot;</span><span class="p">],</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>            <span class="n">tile_x_offset_px</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;tile_x_offset&quot;</span><span class="p">],</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>            <span class="n">tile_y_offset_px</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;tile_y_offset&quot;</span><span class="p">],</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>            <span class="n">tile_overlap_proportion</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;tile_overlap&quot;</span><span class="p">],</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>        <span class="p">)</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>        <span class="c1"># Handle JSON and dictionaries</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>            <span class="n">channels_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">])[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>            <span class="n">channels_dict</span> <span class="o">=</span> <span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels_dict</span><span class="p">:</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>            <span class="n">result</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>                <span class="bp">cls</span><span class="o">.</span><span class="n">Channel</span><span class="p">(</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>                    <span class="n">name</span><span class="o">=</span><span class="n">channel</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>                    <span class="n">exposure_ms</span><span class="o">=</span><span class="n">channel</span><span class="p">[</span><span class="s2">&quot;exposure_ms&quot;</span><span class="p">],</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>                    <span class="n">intensity</span><span class="o">=</span><span class="n">channel</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">],</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>                    <span class="n">gain_applied</span><span class="o">=</span><span class="n">channel</span><span class="p">[</span><span class="s2">&quot;gain_applied&quot;</span><span class="p">],</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>                <span class="p">)</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>            <span class="p">)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>        <span class="c1"># Handle JSON and dictionaries</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>            <span class="n">roi_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">])[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>            <span class="n">roi_dict</span> <span class="o">=</span> <span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>        <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">roi_dict</span><span class="p">:</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>            <span class="n">result</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>                <span class="bp">cls</span><span class="o">.</span><span class="n">ROI</span><span class="p">(</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>                    <span class="n">origin_x_um</span><span class="o">=</span><span class="n">roi</span><span class="p">[</span><span class="s2">&quot;origin_x_um&quot;</span><span class="p">],</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>                    <span class="n">origin_y_um</span><span class="o">=</span><span class="n">roi</span><span class="p">[</span><span class="s2">&quot;origin_y_um&quot;</span><span class="p">],</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>                    <span class="n">width_um</span><span class="o">=</span><span class="n">roi</span><span class="p">[</span><span class="s2">&quot;width_um&quot;</span><span class="p">],</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>                    <span class="n">height_um</span><span class="o">=</span><span class="n">roi</span><span class="p">[</span><span class="s2">&quot;height_um&quot;</span><span class="p">],</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>                    <span class="n">tile_rows</span><span class="o">=</span><span class="n">roi</span><span class="p">[</span><span class="s2">&quot;tile_rows&quot;</span><span class="p">],</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>                    <span class="n">tile_cols</span><span class="o">=</span><span class="n">roi</span><span class="p">[</span><span class="s2">&quot;tile_cols&quot;</span><span class="p">],</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>                    <span class="n">focus_points</span><span class="o">=</span><span class="n">roi</span><span class="p">[</span><span class="s2">&quot;focus_points&quot;</span><span class="p">],</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>                <span class="p">)</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>            <span class="p">)</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_czi</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="sd">        Extracts metadata from a .czi file, which is the output of the Axioscan</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a><span class="sd">        :param input_path: the path to the .czi file</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a><span class="sd">        :return: a Scan object</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>        <span class="k">if</span> <span class="n">aicspylibczi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>            <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>                <span class="s2">&quot;aicspylibczi library not installed. &quot;</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>                <span class="s2">&quot;Install csi-images with [imageio] option to resolve.&quot;</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>            <span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>        <span class="c1"># Normalize paths</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>        <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>            <span class="c1"># Read in metadata as XML elements</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>            <span class="n">metadata_xml</span> <span class="o">=</span> <span class="n">aicspylibczi</span><span class="o">.</span><span class="n">CziFile</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">meta</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>            <span class="c1"># Read in shape metadata from binary</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>            <span class="n">rois_shape</span> <span class="o">=</span> <span class="n">aicspylibczi</span><span class="o">.</span><span class="n">CziFile</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">get_dims_shape</span><span class="p">()</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>        <span class="c1"># Populate metadata</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>        <span class="n">scan</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Label/Barcodes/Barcode/Content&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>        <span class="k">if</span> <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>            <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>        <span class="c1"># Map the raw scanner ID (service ID) to our IDs</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SCANNER_IDS</span><span class="p">[</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>            <span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Microscope/UserDefinedName&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>        <span class="p">]</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>        <span class="c1"># Extract start and finish datetimes</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>        <span class="n">date</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Document/CreationDate&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>        <span class="c1"># Strip out sub-second precision</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>        <span class="n">date</span> <span class="o">=</span> <span class="n">date</span><span class="p">[:</span> <span class="n">date</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)]</span> <span class="o">+</span> <span class="n">date</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">date</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">))</span> <span class="p">:]</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>        <span class="n">date_as_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>            <span class="n">date</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DATETIME_FORMAT</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">]</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>        <span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">start_datetime</span> <span class="o">=</span> <span class="n">date_as_datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">STANDARD_DATETIME_FORMAT</span><span class="p">)</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">scan_time_s</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>            <span class="nb">float</span><span class="p">(</span><span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Image/AcquisitionDuration&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>        <span class="p">)</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>        <span class="n">date_as_datetime</span> <span class="o">+=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">scan</span><span class="o">.</span><span class="n">scan_time_s</span><span class="p">)</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">end_datetime</span> <span class="o">=</span> <span class="n">date_as_datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">STANDARD_DATETIME_FORMAT</span><span class="p">)</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tray_pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//SlotNumberOfLoadedTray&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">slide_pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//SlideScannerPosition&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>        <span class="c1"># Get camera and magnifying info</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>            <span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Information/Instrument/Detectors/Detector&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">attrib</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>        <span class="p">)[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>        <span class="n">magnification</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>            <span class="s2">&quot;.//Objectives/Objective/NominalMagnification&quot;</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>        <span class="p">)</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>        <span class="n">aperture</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Objectives/Objective/LensNA&quot;</span><span class="p">)</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">objective</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">magnification</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">x-</span><span class="si">{</span><span class="n">aperture</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>            <span class="nb">float</span><span class="p">(</span><span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Scaling/Items/Distance/Value&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>        <span class="p">)</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>        <span class="c1"># Round off the pixel size to nanometers; might not be optimal, but this</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>        <span class="c1"># gets rounded when we send it to the database anyways (to 7 places)</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>        <span class="c1"># Get tile information</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>        <span class="c1"># Note: X Y is untested, could be flipped. I always forget. Just don&#39;t use</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>        <span class="c1"># non-square frames and we&#39;re all good.</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>        <span class="n">selected_detector</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//SelectedDetector&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>        <span class="n">detectors</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//Detectors/Detector&quot;</span><span class="p">)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>        <span class="k">for</span> <span class="n">detector</span> <span class="ow">in</span> <span class="n">detectors</span><span class="p">:</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>            <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">selected_detector</span><span class="p">:</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>                <span class="n">tile_info</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Frame&quot;</span><span class="p">)</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>                <span class="k">break</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>        <span class="c1"># Convert to integers</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>        <span class="n">tile_info</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">coordinate</span><span class="p">)</span> <span class="k">for</span> <span class="n">coordinate</span> <span class="ow">in</span> <span class="n">tile_info</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_x_offset_px</span> <span class="o">=</span> <span class="n">tile_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_y_offset_px</span> <span class="o">=</span> <span class="n">tile_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">=</span> <span class="n">tile_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">=</span> <span class="n">tile_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_overlap_proportion</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Overlap&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>        <span class="c1"># Extract channels and create Channel objects from them</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>        <span class="n">channel_indices</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//Image/Dimensions/Channels/Channel&quot;</span><span class="p">):</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>            <span class="n">channel_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>            <span class="n">intensity_xml</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Intensity&quot;</span><span class="p">)</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>            <span class="k">if</span> <span class="n">intensity_xml</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>                <span class="n">intensity</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>                <span class="n">intensity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">intensity_xml</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-2</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>            <span class="n">scan</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>                <span class="bp">cls</span><span class="o">.</span><span class="n">Channel</span><span class="p">(</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>                    <span class="n">name</span><span class="o">=</span><span class="n">channel</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>                    <span class="n">exposure_ms</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./ExposureTime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>                    <span class="n">intensity</span><span class="o">=</span><span class="n">intensity</span><span class="p">,</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>                    <span class="n">gain_applied</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># In Axioscan, we will always use gain = 1</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>                <span class="p">)</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>            <span class="p">)</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>        <span class="c1"># Make sure the channels are sorted</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>            <span class="n">channel</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">channel_indices</span><span class="p">,</span> <span class="n">scan</span><span class="o">.</span><span class="n">channels</span><span class="p">))</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>        <span class="p">]</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>        <span class="c1"># Verify that the shape corresponds to the channels</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>        <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois_shape</span><span class="p">:</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>            <span class="k">if</span> <span class="n">roi</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">channels</span><span class="p">):</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>                    <span class="sa">f</span><span class="s2">&quot;Number of channels </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>                    <span class="sa">f</span><span class="s2">&quot;is not the same as the number of channels in an ROI: &quot;</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">roi</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>                <span class="p">)</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>        <span class="c1"># Get the real ROI limits; the metadata is not always correct</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>        <span class="n">limits_xml</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//AllowedScanArea&quot;</span><span class="p">)</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>        <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>            <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">limits_xml</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Center&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])),</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>            <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">limits_xml</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Center&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])),</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>            <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">limits_xml</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Size&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])),</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>            <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">limits_xml</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Size&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])),</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>        <span class="p">]</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>        <span class="c1"># Convert to top-left and bottom-right</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>        <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>            <span class="nb">round</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>            <span class="nb">round</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>            <span class="nb">round</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>            <span class="nb">round</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>        <span class="p">]</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>        <span class="c1"># Extract ROIs and create ROI objects from them</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>        <span class="n">rois_xml_metadata</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//TileRegions/TileRegion&quot;</span><span class="p">)</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>        <span class="n">scenes_xml_metadata</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//S/Scenes/Scene&quot;</span><span class="p">)</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rois_xml_metadata</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rois_shape</span><span class="p">):</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>                <span class="sa">f</span><span class="s2">&quot;Metadata and binary data from </span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>                <span class="sa">f</span><span class="s2">&quot;do not match in number of ROIs&quot;</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>            <span class="p">)</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>        <span class="c1"># We need both to determine the number of rows/columns because the XML lies</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>        <span class="n">roi_indices</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>        <span class="k">for</span> <span class="n">roi_xml</span><span class="p">,</span> <span class="n">roi_shape</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rois_xml_metadata</span><span class="p">,</span> <span class="n">rois_shape</span><span class="p">):</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>            <span class="n">name</span> <span class="o">=</span> <span class="n">roi_xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>            <span class="c1"># Determine the index of this scene</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>            <span class="n">scene_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>            <span class="k">for</span> <span class="n">scene</span> <span class="ow">in</span> <span class="n">scenes_xml_metadata</span><span class="p">:</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>                <span class="k">if</span> <span class="n">scene</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>                    <span class="n">scene_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;Index&quot;</span><span class="p">])</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>                    <span class="k">break</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>            <span class="k">if</span> <span class="n">scene_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ROI </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not correspond to any scenes&quot;</span><span class="p">)</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>                <span class="n">roi_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scene_index</span><span class="p">)</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>            <span class="c1"># Extract other metadata</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>            <span class="n">roi_limits</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>                <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">roi_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;CenterPosition&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])),</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>                <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">roi_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;CenterPosition&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])),</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>                <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">roi_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ContourSize&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])),</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>                <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">roi_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ContourSize&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])),</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>            <span class="p">]</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>            <span class="c1"># Convert to top-left and bottom-right</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>            <span class="n">roi_limits</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>                <span class="nb">round</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">roi_limits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>                <span class="nb">round</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">roi_limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>                <span class="nb">round</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">roi_limits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>                <span class="nb">round</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">roi_limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>            <span class="p">]</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>            <span class="c1"># Bound the ROI to the actual scan limits</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>            <span class="n">roi_limits</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>                <span class="nb">max</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>                <span class="nb">max</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>                <span class="nb">min</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>                <span class="nb">min</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>            <span class="p">]</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>            <span class="n">tile_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">roi_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Rows&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>            <span class="c1"># Current best way of reliably extracting; &lt;Columns&gt; entry can be wrong</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">roi_shape</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="n">tile_rows</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>                    <span class="sa">f</span><span class="s2">&quot;The number of tiles </span><span class="si">{</span><span class="n">roi_shape</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not &quot;</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>                    <span class="sa">f</span><span class="s2">&quot;divisible by the tile rows </span><span class="si">{</span><span class="n">tile_rows</span><span class="si">}</span><span class="s2">; metadata &quot;</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>                    <span class="sa">f</span><span class="s2">&quot;must be messed up. Thanks Zeiss&quot;</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>                <span class="p">)</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>                <span class="n">tile_cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">roi_shape</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">tile_rows</span><span class="p">)</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>            <span class="c1"># Support points are actually the relevant focus points for this ROI</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>            <span class="n">focus_points</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>            <span class="k">for</span> <span class="n">focus_point</span> <span class="ow">in</span> <span class="n">roi_xml</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;SupportPoints/SupportPoint&quot;</span><span class="p">):</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>                <span class="n">focus_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>                    <span class="p">[</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>                        <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">focus_point</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)),</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>                        <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">focus_point</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)),</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>                        <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">focus_point</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)),</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>                    <span class="p">]</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>                <span class="p">)</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>            <span class="c1"># Strip all sub-micron precision, it does not matter</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>            <span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>                <span class="bp">cls</span><span class="o">.</span><span class="n">ROI</span><span class="p">(</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>                    <span class="n">origin_x_um</span><span class="o">=</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>                    <span class="n">origin_y_um</span><span class="o">=</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>                    <span class="n">width_um</span><span class="o">=</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">roi_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>                    <span class="n">height_um</span><span class="o">=</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">roi_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>                    <span class="n">tile_rows</span><span class="o">=</span><span class="n">tile_rows</span><span class="p">,</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>                    <span class="n">tile_cols</span><span class="o">=</span><span class="n">tile_cols</span><span class="p">,</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>                    <span class="n">focus_points</span><span class="o">=</span><span class="n">focus_points</span><span class="p">,</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>                <span class="p">)</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>            <span class="p">)</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>        <span class="c1"># Sort based on the scene indices</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="p">[</span><span class="n">roi</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">roi</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">roi_indices</span><span class="p">,</span> <span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="p">))]</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>        <span class="k">return</span> <span class="n">scan</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_txt</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a><span class="sd">        Loads a Scan object from a .txt file, usually slideinfo.txt, which originates</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a><span class="sd">        from the BZScanner. Some metadata is filled in or adjusted to fit</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a><span class="sd">        :param input_path: /path/to/file.txt or /path/to/folder containing slideinfo.txt</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a><span class="sd">        :return: a Scan object</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>        <span class="c1"># Set paths</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>        <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">input_path</span><span class="p">):</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>            <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>                <span class="n">input_path</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">METADATA_FILE_NAME</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">]</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>            <span class="p">)</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>        <span class="c1"># Read in metadata as a dict</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>            <span class="n">metadata_contents</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>            <span class="c1"># Read each line, splitting on the = sign</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>            <span class="n">metadata_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">metadata_contents</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>                <span class="n">metadata_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>        <span class="c1"># Populate metadata</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>        <span class="n">scan</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;SLIDEID&quot;</span><span class="p">]</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;SLIDEDIR&quot;</span><span class="p">]</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>        <span class="c1"># Extract start and finish datetimes</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>        <span class="n">date</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>        <span class="n">date_as_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>            <span class="n">date</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DATETIME_FORMAT</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">]</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>        <span class="p">)</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>        <span class="n">date_as_datetime</span> <span class="o">=</span> <span class="n">date_as_datetime</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>            <span class="n">zoneinfo</span><span class="o">.</span><span class="n">ZoneInfo</span><span class="p">(</span><span class="s2">&quot;America/Los_Angeles&quot;</span><span class="p">)</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>        <span class="p">)</span>  <span class="c1"># Hardcoded because BZScanners are here</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">start_datetime</span> <span class="o">=</span> <span class="n">date_as_datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">STANDARD_DATETIME_FORMAT</span><span class="p">)</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">scan_time_s</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">*</span> <span class="mi">60</span>  <span class="c1"># estimated 90 minutes per scan</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>        <span class="n">date_as_datetime</span> <span class="o">+=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">scan</span><span class="o">.</span><span class="n">scan_time_s</span><span class="p">)</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">end_datetime</span> <span class="o">=</span> <span class="n">date_as_datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">STANDARD_DATETIME_FORMAT</span><span class="p">)</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>        <span class="c1"># Map the raw scanner ID (service ID) to our IDs</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;INSTRUMENT&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tray_pos</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># only one tray_pos in a BZScanner</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">slide_pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;SLIDEPOS&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># 1-indexed</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>        <span class="c1"># Get camera and magnifying info</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>        <span class="n">magnification</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>        <span class="n">aperture</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># TODO: find the actual aperture</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">objective</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">magnification</span><span class="si">}</span><span class="s2">x-</span><span class="si">{</span><span class="n">aperture</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span> <span class="o">=</span> <span class="mf">0.591</span>  <span class="c1"># Estimated from image metadata</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>        <span class="c1"># Get tile information</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">=</span> <span class="mi">1362</span>  <span class="c1"># Known from image metadata</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">=</span> <span class="mi">1004</span>  <span class="c1"># Known from image metadata</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_x_offset_px</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Already removed</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_y_offset_px</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Already removed</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_overlap_proportion</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Already removed</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>        <span class="c1"># Extract channels and create Channel objects from them</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>        <span class="k">if</span> <span class="s2">&quot;gain_applied&quot;</span> <span class="ow">in</span> <span class="n">metadata_dict</span><span class="p">:</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>            <span class="n">gain_applied</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;gain_applied&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="k">else</span> <span class="kc">False</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>            <span class="n">gain_applied</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Previous policy was always to apply gains</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">BZSCANNER_CHANNEL_MAP</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>            <span class="n">channel_settings</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>            <span class="k">if</span> <span class="n">channel_settings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>                <span class="k">continue</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>            <span class="n">scan</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>                <span class="bp">cls</span><span class="o">.</span><span class="n">Channel</span><span class="p">(</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>                    <span class="n">name</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">BZSCANNER_CHANNEL_MAP</span><span class="p">[</span><span class="n">channel</span><span class="p">],</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>                    <span class="n">exposure_ms</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">channel_settings</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>                    <span class="n">intensity</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">channel_settings</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>                    <span class="n">gain_applied</span><span class="o">=</span><span class="n">gain_applied</span><span class="p">,</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>                <span class="p">)</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>            <span class="p">)</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>        <span class="c1"># Get focus points</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>        <span class="n">focus_points</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">33</span><span class="p">):</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a>            <span class="n">focus_point</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;FOCUSPOS&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>            <span class="k">if</span> <span class="n">focus_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>                <span class="k">break</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a>            <span class="n">focus_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a>                <span class="p">[</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a>                    <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">focus_point</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>                    <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">focus_point</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>                    <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">focus_point</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a>                <span class="p">]</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>            <span class="p">)</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>        <span class="c1"># In the BZScanner, the slide is vertical instead of horizontal</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>        <span class="c1"># We put in nominal values for the ROI, which is oriented vertically as well</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>        <span class="n">tile_rows</span> <span class="o">=</span> <span class="mi">96</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>        <span class="n">tile_cols</span> <span class="o">=</span> <span class="mi">24</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>        <span class="n">roi_width</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span> <span class="o">*</span> <span class="n">scan</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">*</span> <span class="n">tile_cols</span><span class="p">)</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>        <span class="n">roi_height</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span> <span class="o">*</span> <span class="n">scan</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">*</span> <span class="n">tile_rows</span><span class="p">)</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a>        <span class="n">origin_x_um</span> <span class="o">=</span> <span class="mi">2500</span> <span class="o">+</span> <span class="nb">round</span><span class="p">((</span><span class="mi">20000</span> <span class="o">-</span> <span class="n">roi_width</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>        <span class="n">origin_y_um</span> <span class="o">=</span> <span class="mi">2500</span> <span class="o">+</span> <span class="nb">round</span><span class="p">((</span><span class="mi">58000</span> <span class="o">-</span> <span class="n">roi_height</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a>            <span class="bp">cls</span><span class="o">.</span><span class="n">ROI</span><span class="p">(</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a>                <span class="n">origin_x_um</span><span class="o">=</span><span class="n">origin_x_um</span><span class="p">,</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>                <span class="n">origin_y_um</span><span class="o">=</span><span class="n">origin_y_um</span><span class="p">,</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a>                <span class="n">width_um</span><span class="o">=</span><span class="n">roi_width</span><span class="p">,</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a>                <span class="n">height_um</span><span class="o">=</span><span class="n">roi_height</span><span class="p">,</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a>                <span class="n">tile_rows</span><span class="o">=</span><span class="n">tile_rows</span><span class="p">,</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a>                <span class="n">tile_cols</span><span class="o">=</span><span class="n">tile_cols</span><span class="p">,</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a>                <span class="n">focus_points</span><span class="o">=</span><span class="n">focus_points</span><span class="p">,</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>            <span class="p">)</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>        <span class="p">)</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a>        <span class="k">return</span> <span class="n">scan</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_from_folder</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a><span class="sd">        Load a Scan object from a folder that contains defaultly-named metadata files,</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a><span class="sd">        scan.yaml or slideinfo.txt. Prefers scan.yaml if both exist</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a><span class="sd">        :param input_path: /path/to/folder</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a><span class="sd">        :return: a Scan object</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a>        <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">METADATA_FILE_NAME</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">])</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a>        <span class="p">):</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a>            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">load_yaml</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a>        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">METADATA_FILE_NAME</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">])</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a>        <span class="p">):</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a>            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">load_txt</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a>                <span class="sa">f</span><span class="s2">&quot;No scan metadata files &quot;</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a>                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">METADATA_FILE_NAME</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">METADATA_FILE_NAME</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">]</span><span class="si">}</span><span class="s2">) found in folder &quot;</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a>            <span class="p">)</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a>        <span class="k">pass</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">make_placeholder</span><span class="p">(</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a>        <span class="n">slide_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a>        <span class="n">n_tile</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2303</span><span class="p">,</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a>        <span class="n">n_roi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a>        <span class="n">scanner_type</span><span class="p">:</span> <span class="n">Type</span> <span class="o">=</span> <span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">,</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a><span class="sd">        Make a placeholder Scan object with only basic required information filled in.</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a><span class="sd">        :param slide_id: the slide ID</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a><span class="sd">        :param n_tile: the number of this tile, which will become the number of</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a><span class="sd">                       tiles in the scan</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a><span class="sd">        :param n_roi: the number of ROIs in the scan</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a><span class="sd">        :return: a Scan object</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a>        <span class="c1"># Sanitize inputs here</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a>        <span class="n">slide_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">slide_id</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a>        <span class="n">n_tile</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_tile</span><span class="p">)</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a>        <span class="n">n_roi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_roi</span><span class="p">)</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a>        <span class="c1"># Generate the object</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a>        <span class="n">scan</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="o">=</span> <span class="n">slide_id</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a>        <span class="k">if</span> <span class="n">scanner_type</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">:</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a>            <span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">_placeholder&quot;</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a>        <span class="k">elif</span> <span class="n">scanner_type</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">:</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a>            <span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">_placeholder&quot;</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">ROI</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_roi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tile_rows</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos">781</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tile_cols</span> <span class="o">=</span> <span class="n">n_tile</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos">782</span></a>        <span class="k">return</span> <span class="n">scan</span>
</span></pre></div>


            </section>
                <section id="Scan">
                            <input id="Scan-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Scan</span><wbr>(<span class="base">yaml.YAMLObject</span>):

                <label class="view-source-button" for="Scan-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scan"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scan-24"><a href="#Scan-24"><span class="linenos"> 24</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Scan</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">YAMLObject</span><span class="p">):</span>
</span><span id="Scan-25"><a href="#Scan-25"><span class="linenos"> 25</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan-26"><a href="#Scan-26"><span class="linenos"> 26</span></a><span class="sd">    Class that composes a whole scan&#39;s metadata. Contains some universal data,</span>
</span><span id="Scan-27"><a href="#Scan-27"><span class="linenos"> 27</span></a><span class="sd">    plus lists for channels and ROIs.</span>
</span><span id="Scan-28"><a href="#Scan-28"><span class="linenos"> 28</span></a>
</span><span id="Scan-29"><a href="#Scan-29"><span class="linenos"> 29</span></a><span class="sd">    .. include:: ../docs/coordinate_systems.md</span>
</span><span id="Scan-30"><a href="#Scan-30"><span class="linenos"> 30</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Scan-31"><a href="#Scan-31"><span class="linenos"> 31</span></a>
</span><span id="Scan-32"><a href="#Scan-32"><span class="linenos"> 32</span></a>    <span class="n">yaml_tag</span> <span class="o">=</span> <span class="s2">&quot;csi_images.csi_scans.Scan&quot;</span>
</span><span id="Scan-33"><a href="#Scan-33"><span class="linenos"> 33</span></a>
</span><span id="Scan-34"><a href="#Scan-34"><span class="linenos"> 34</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Type</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
</span><span id="Scan-35"><a href="#Scan-35"><span class="linenos"> 35</span></a>        <span class="n">BZSCANNER</span> <span class="o">=</span> <span class="s2">&quot;bzscanner&quot;</span>
</span><span id="Scan-36"><a href="#Scan-36"><span class="linenos"> 36</span></a>        <span class="n">AXIOSCAN7</span> <span class="o">=</span> <span class="s2">&quot;axioscan7&quot;</span>
</span><span id="Scan-37"><a href="#Scan-37"><span class="linenos"> 37</span></a>
</span><span id="Scan-38"><a href="#Scan-38"><span class="linenos"> 38</span></a>    <span class="n">SCANNER_IDS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;4661000426&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">_0&quot;</span><span class="p">}</span>
</span><span id="Scan-39"><a href="#Scan-39"><span class="linenos"> 39</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Axioscan 7 scanner IDs (service number), mapped to our scanner IDs&quot;&quot;&quot;</span>
</span><span id="Scan-40"><a href="#Scan-40"><span class="linenos"> 40</span></a>
</span><span id="Scan-41"><a href="#Scan-41"><span class="linenos"> 41</span></a>    <span class="n">METADATA_FILE_NAME</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Scan-42"><a href="#Scan-42"><span class="linenos"> 42</span></a>        <span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">:</span> <span class="s2">&quot;scan.yaml&quot;</span><span class="p">,</span>
</span><span id="Scan-43"><a href="#Scan-43"><span class="linenos"> 43</span></a>        <span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">:</span> <span class="s2">&quot;slideinfo.txt&quot;</span><span class="p">,</span>
</span><span id="Scan-44"><a href="#Scan-44"><span class="linenos"> 44</span></a>    <span class="p">}</span>
</span><span id="Scan-45"><a href="#Scan-45"><span class="linenos"> 45</span></a>    <span class="n">STANDARD_DATETIME_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S%z&quot;</span>
</span><span id="Scan-46"><a href="#Scan-46"><span class="linenos"> 46</span></a>    <span class="n">DATETIME_FORMAT</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Scan-47"><a href="#Scan-47"><span class="linenos"> 47</span></a>        <span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">:</span> <span class="n">STANDARD_DATETIME_FORMAT</span><span class="p">,</span>
</span><span id="Scan-48"><a href="#Scan-48"><span class="linenos"> 48</span></a>        <span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%a</span><span class="s2"> %b </span><span class="si">%d</span><span class="s2"> %H:%M:%S %Y&quot;</span><span class="p">,</span>
</span><span id="Scan-49"><a href="#Scan-49"><span class="linenos"> 49</span></a>    <span class="p">}</span>
</span><span id="Scan-50"><a href="#Scan-50"><span class="linenos"> 50</span></a>
</span><span id="Scan-51"><a href="#Scan-51"><span class="linenos"> 51</span></a>    <span class="c1"># Actual channel names, from the BZScanner&#39;s default order</span>
</span><span id="Scan-52"><a href="#Scan-52"><span class="linenos"> 52</span></a>    <span class="n">BZSCANNER_CHANNEL_MAP</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Scan-53"><a href="#Scan-53"><span class="linenos"> 53</span></a>        <span class="s2">&quot;DAPI&quot;</span><span class="p">:</span> <span class="s2">&quot;DAPI&quot;</span><span class="p">,</span>
</span><span id="Scan-54"><a href="#Scan-54"><span class="linenos"> 54</span></a>        <span class="s2">&quot;TRITC&quot;</span><span class="p">:</span> <span class="s2">&quot;AF555&quot;</span><span class="p">,</span>
</span><span id="Scan-55"><a href="#Scan-55"><span class="linenos"> 55</span></a>        <span class="s2">&quot;CY5&quot;</span><span class="p">:</span> <span class="s2">&quot;AF647&quot;</span><span class="p">,</span>
</span><span id="Scan-56"><a href="#Scan-56"><span class="linenos"> 56</span></a>        <span class="s2">&quot;BF&quot;</span><span class="p">:</span> <span class="s2">&quot;BRIGHT&quot;</span><span class="p">,</span>
</span><span id="Scan-57"><a href="#Scan-57"><span class="linenos"> 57</span></a>        <span class="s2">&quot;FITC&quot;</span><span class="p">:</span> <span class="s2">&quot;AF488&quot;</span><span class="p">,</span>
</span><span id="Scan-58"><a href="#Scan-58"><span class="linenos"> 58</span></a>    <span class="p">}</span>
</span><span id="Scan-59"><a href="#Scan-59"><span class="linenos"> 59</span></a>
</span><span id="Scan-60"><a href="#Scan-60"><span class="linenos"> 60</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Channel</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">YAMLObject</span><span class="p">):</span>
</span><span id="Scan-61"><a href="#Scan-61"><span class="linenos"> 61</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan-62"><a href="#Scan-62"><span class="linenos"> 62</span></a><span class="sd">        Class that comprises a channel; we usually have multiple (2-5) per scan.</span>
</span><span id="Scan-63"><a href="#Scan-63"><span class="linenos"> 63</span></a><span class="sd">        Contains three fields:</span>
</span><span id="Scan-64"><a href="#Scan-64"><span class="linenos"> 64</span></a><span class="sd">        - name: the name of the channel (e.g. DAPI, AF647, AF555, AF488, BRIGHTFIELD)</span>
</span><span id="Scan-65"><a href="#Scan-65"><span class="linenos"> 65</span></a><span class="sd">        - exposure_ms: the exposure time to capture a frame in milliseconds</span>
</span><span id="Scan-66"><a href="#Scan-66"><span class="linenos"> 66</span></a><span class="sd">        - intensity: the light intensity used OR the gain applied to the channel</span>
</span><span id="Scan-67"><a href="#Scan-67"><span class="linenos"> 67</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan-68"><a href="#Scan-68"><span class="linenos"> 68</span></a>
</span><span id="Scan-69"><a href="#Scan-69"><span class="linenos"> 69</span></a>        <span class="n">yaml_tag</span> <span class="o">=</span> <span class="s2">&quot;csi_images.csi_scans.Scan.Channel&quot;</span>
</span><span id="Scan-70"><a href="#Scan-70"><span class="linenos"> 70</span></a>
</span><span id="Scan-71"><a href="#Scan-71"><span class="linenos"> 71</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="Scan-72"><a href="#Scan-72"><span class="linenos"> 72</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="Scan-73"><a href="#Scan-73"><span class="linenos"> 73</span></a>            <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Scan-74"><a href="#Scan-74"><span class="linenos"> 74</span></a>            <span class="n">exposure_ms</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="Scan-75"><a href="#Scan-75"><span class="linenos"> 75</span></a>            <span class="n">intensity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="Scan-76"><a href="#Scan-76"><span class="linenos"> 76</span></a>            <span class="n">gain_applied</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Scan-77"><a href="#Scan-77"><span class="linenos"> 77</span></a>        <span class="p">):</span>
</span><span id="Scan-78"><a href="#Scan-78"><span class="linenos"> 78</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span><span id="Scan-79"><a href="#Scan-79"><span class="linenos"> 79</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">exposure_ms</span> <span class="o">=</span> <span class="n">exposure_ms</span>
</span><span id="Scan-80"><a href="#Scan-80"><span class="linenos"> 80</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="n">intensity</span>
</span><span id="Scan-81"><a href="#Scan-81"><span class="linenos"> 81</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gain_applied</span> <span class="o">=</span> <span class="n">gain_applied</span>
</span><span id="Scan-82"><a href="#Scan-82"><span class="linenos"> 82</span></a>
</span><span id="Scan-83"><a href="#Scan-83"><span class="linenos"> 83</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Scan-84"><a href="#Scan-84"><span class="linenos"> 84</span></a>            <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Scan-85"><a href="#Scan-85"><span class="linenos"> 85</span></a>
</span><span id="Scan-86"><a href="#Scan-86"><span class="linenos"> 86</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="Scan-87"><a href="#Scan-87"><span class="linenos"> 87</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
</span><span id="Scan-88"><a href="#Scan-88"><span class="linenos"> 88</span></a>
</span><span id="Scan-89"><a href="#Scan-89"><span class="linenos"> 89</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ROI</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">YAMLObject</span><span class="p">):</span>
</span><span id="Scan-90"><a href="#Scan-90"><span class="linenos"> 90</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan-91"><a href="#Scan-91"><span class="linenos"> 91</span></a><span class="sd">        Class that comprises an ROI; we usually have 1, but may have more in a scan.</span>
</span><span id="Scan-92"><a href="#Scan-92"><span class="linenos"> 92</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan-93"><a href="#Scan-93"><span class="linenos"> 93</span></a>
</span><span id="Scan-94"><a href="#Scan-94"><span class="linenos"> 94</span></a>        <span class="n">yaml_tag</span> <span class="o">=</span> <span class="s2">&quot;csi_images.csi_scans.Scan.ROI&quot;</span>
</span><span id="Scan-95"><a href="#Scan-95"><span class="linenos"> 95</span></a>
</span><span id="Scan-96"><a href="#Scan-96"><span class="linenos"> 96</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="Scan-97"><a href="#Scan-97"><span class="linenos"> 97</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="Scan-98"><a href="#Scan-98"><span class="linenos"> 98</span></a>            <span class="n">origin_x_um</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan-99"><a href="#Scan-99"><span class="linenos"> 99</span></a>            <span class="n">origin_y_um</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan-100"><a href="#Scan-100"><span class="linenos">100</span></a>            <span class="n">width_um</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan-101"><a href="#Scan-101"><span class="linenos">101</span></a>            <span class="n">height_um</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan-102"><a href="#Scan-102"><span class="linenos">102</span></a>            <span class="n">tile_rows</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan-103"><a href="#Scan-103"><span class="linenos">103</span></a>            <span class="n">tile_cols</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan-104"><a href="#Scan-104"><span class="linenos">104</span></a>            <span class="n">focus_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Scan-105"><a href="#Scan-105"><span class="linenos">105</span></a>        <span class="p">):</span>
</span><span id="Scan-106"><a href="#Scan-106"><span class="linenos">106</span></a>            <span class="k">if</span> <span class="n">focus_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scan-107"><a href="#Scan-107"><span class="linenos">107</span></a>                <span class="n">focus_points</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scan-108"><a href="#Scan-108"><span class="linenos">108</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">origin_x_um</span> <span class="o">=</span> <span class="n">origin_x_um</span>
</span><span id="Scan-109"><a href="#Scan-109"><span class="linenos">109</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">origin_y_um</span> <span class="o">=</span> <span class="n">origin_y_um</span>
</span><span id="Scan-110"><a href="#Scan-110"><span class="linenos">110</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">width_um</span> <span class="o">=</span> <span class="n">width_um</span>
</span><span id="Scan-111"><a href="#Scan-111"><span class="linenos">111</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">height_um</span> <span class="o">=</span> <span class="n">height_um</span>
</span><span id="Scan-112"><a href="#Scan-112"><span class="linenos">112</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tile_rows</span> <span class="o">=</span> <span class="n">tile_rows</span>
</span><span id="Scan-113"><a href="#Scan-113"><span class="linenos">113</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tile_cols</span> <span class="o">=</span> <span class="n">tile_cols</span>
</span><span id="Scan-114"><a href="#Scan-114"><span class="linenos">114</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">focus_points</span> <span class="o">=</span> <span class="n">focus_points</span>
</span><span id="Scan-115"><a href="#Scan-115"><span class="linenos">115</span></a>
</span><span id="Scan-116"><a href="#Scan-116"><span class="linenos">116</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Scan-117"><a href="#Scan-117"><span class="linenos">117</span></a>            <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Scan-118"><a href="#Scan-118"><span class="linenos">118</span></a>
</span><span id="Scan-119"><a href="#Scan-119"><span class="linenos">119</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="Scan-120"><a href="#Scan-120"><span class="linenos">120</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
</span><span id="Scan-121"><a href="#Scan-121"><span class="linenos">121</span></a>
</span><span id="Scan-122"><a href="#Scan-122"><span class="linenos">122</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">similar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="Scan-123"><a href="#Scan-123"><span class="linenos">123</span></a>            <span class="k">return</span> <span class="p">(</span>
</span><span id="Scan-124"><a href="#Scan-124"><span class="linenos">124</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">origin_y_um</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">origin_y_um</span>
</span><span id="Scan-125"><a href="#Scan-125"><span class="linenos">125</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_x_um</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">origin_x_um</span>
</span><span id="Scan-126"><a href="#Scan-126"><span class="linenos">126</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">width_um</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">width_um</span>
</span><span id="Scan-127"><a href="#Scan-127"><span class="linenos">127</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">height_um</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">height_um</span>
</span><span id="Scan-128"><a href="#Scan-128"><span class="linenos">128</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_rows</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_rows</span>
</span><span id="Scan-129"><a href="#Scan-129"><span class="linenos">129</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_cols</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_cols</span>
</span><span id="Scan-130"><a href="#Scan-130"><span class="linenos">130</span></a>            <span class="p">)</span>
</span><span id="Scan-131"><a href="#Scan-131"><span class="linenos">131</span></a>
</span><span id="Scan-132"><a href="#Scan-132"><span class="linenos">132</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="Scan-133"><a href="#Scan-133"><span class="linenos">133</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Scan-134"><a href="#Scan-134"><span class="linenos">134</span></a>        <span class="n">slide_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Scan-135"><a href="#Scan-135"><span class="linenos">135</span></a>        <span class="n">scanner_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Scan-136"><a href="#Scan-136"><span class="linenos">136</span></a>        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Scan-137"><a href="#Scan-137"><span class="linenos">137</span></a>        <span class="n">exists</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Scan-138"><a href="#Scan-138"><span class="linenos">138</span></a>        <span class="n">start_datetime</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Scan-139"><a href="#Scan-139"><span class="linenos">139</span></a>        <span class="n">end_datetime</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Scan-140"><a href="#Scan-140"><span class="linenos">140</span></a>        <span class="n">scan_time_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan-141"><a href="#Scan-141"><span class="linenos">141</span></a>        <span class="n">tray_pos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan-142"><a href="#Scan-142"><span class="linenos">142</span></a>        <span class="n">slide_pos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan-143"><a href="#Scan-143"><span class="linenos">143</span></a>        <span class="n">camera</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Scan-144"><a href="#Scan-144"><span class="linenos">144</span></a>        <span class="n">objective</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Scan-145"><a href="#Scan-145"><span class="linenos">145</span></a>        <span class="n">pixel_size_um</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="Scan-146"><a href="#Scan-146"><span class="linenos">146</span></a>        <span class="n">tile_width_px</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan-147"><a href="#Scan-147"><span class="linenos">147</span></a>        <span class="n">tile_height_px</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan-148"><a href="#Scan-148"><span class="linenos">148</span></a>        <span class="n">tile_x_offset_px</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan-149"><a href="#Scan-149"><span class="linenos">149</span></a>        <span class="n">tile_y_offset_px</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan-150"><a href="#Scan-150"><span class="linenos">150</span></a>        <span class="n">tile_overlap_proportion</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan-151"><a href="#Scan-151"><span class="linenos">151</span></a>        <span class="n">channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Channel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Scan-152"><a href="#Scan-152"><span class="linenos">152</span></a>        <span class="n">roi</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ROI</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Scan-153"><a href="#Scan-153"><span class="linenos">153</span></a>    <span class="p">):</span>
</span><span id="Scan-154"><a href="#Scan-154"><span class="linenos">154</span></a>        <span class="k">if</span> <span class="n">roi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scan-155"><a href="#Scan-155"><span class="linenos">155</span></a>            <span class="n">roi</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scan-156"><a href="#Scan-156"><span class="linenos">156</span></a>        <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scan-157"><a href="#Scan-157"><span class="linenos">157</span></a>            <span class="n">channels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scan-158"><a href="#Scan-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slide_id</span> <span class="o">=</span> <span class="n">slide_id</span>
</span><span id="Scan-159"><a href="#Scan-159"><span class="linenos">159</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scanner_id</span> <span class="o">=</span> <span class="n">scanner_id</span>
</span><span id="Scan-160"><a href="#Scan-160"><span class="linenos">160</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
</span><span id="Scan-161"><a href="#Scan-161"><span class="linenos">161</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exists</span> <span class="o">=</span> <span class="n">exists</span>
</span><span id="Scan-162"><a href="#Scan-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start_datetime</span> <span class="o">=</span> <span class="n">start_datetime</span>
</span><span id="Scan-163"><a href="#Scan-163"><span class="linenos">163</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">end_datetime</span> <span class="o">=</span> <span class="n">end_datetime</span>
</span><span id="Scan-164"><a href="#Scan-164"><span class="linenos">164</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scan_time_s</span> <span class="o">=</span> <span class="n">scan_time_s</span>
</span><span id="Scan-165"><a href="#Scan-165"><span class="linenos">165</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tray_pos</span> <span class="o">=</span> <span class="n">tray_pos</span>
</span><span id="Scan-166"><a href="#Scan-166"><span class="linenos">166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slide_pos</span> <span class="o">=</span> <span class="n">slide_pos</span>
</span><span id="Scan-167"><a href="#Scan-167"><span class="linenos">167</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="n">camera</span>
</span><span id="Scan-168"><a href="#Scan-168"><span class="linenos">168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">objective</span> <span class="o">=</span> <span class="n">objective</span>
</span><span id="Scan-169"><a href="#Scan-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size_um</span> <span class="o">=</span> <span class="n">pixel_size_um</span>
</span><span id="Scan-170"><a href="#Scan-170"><span class="linenos">170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">=</span> <span class="n">tile_width_px</span>
</span><span id="Scan-171"><a href="#Scan-171"><span class="linenos">171</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">=</span> <span class="n">tile_height_px</span>
</span><span id="Scan-172"><a href="#Scan-172"><span class="linenos">172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_x_offset_px</span> <span class="o">=</span> <span class="n">tile_x_offset_px</span>
</span><span id="Scan-173"><a href="#Scan-173"><span class="linenos">173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_y_offset_px</span> <span class="o">=</span> <span class="n">tile_y_offset_px</span>
</span><span id="Scan-174"><a href="#Scan-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_overlap_proportion</span> <span class="o">=</span> <span class="n">tile_overlap_proportion</span>
</span><span id="Scan-175"><a href="#Scan-175"><span class="linenos">175</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span>
</span><span id="Scan-176"><a href="#Scan-176"><span class="linenos">176</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="n">roi</span>
</span><span id="Scan-177"><a href="#Scan-177"><span class="linenos">177</span></a>
</span><span id="Scan-178"><a href="#Scan-178"><span class="linenos">178</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Scan-179"><a href="#Scan-179"><span class="linenos">179</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="Scan-180"><a href="#Scan-180"><span class="linenos">180</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slide_id</span><span class="p">,</span>
</span><span id="Scan-181"><a href="#Scan-181"><span class="linenos">181</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scanner_id</span><span class="p">,</span>
</span><span id="Scan-182"><a href="#Scan-182"><span class="linenos">182</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="Scan-183"><a href="#Scan-183"><span class="linenos">183</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">,</span>
</span><span id="Scan-184"><a href="#Scan-184"><span class="linenos">184</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">start_datetime</span><span class="p">,</span>
</span><span id="Scan-185"><a href="#Scan-185"><span class="linenos">185</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">end_datetime</span><span class="p">,</span>
</span><span id="Scan-186"><a href="#Scan-186"><span class="linenos">186</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scan_time_s</span><span class="p">,</span>
</span><span id="Scan-187"><a href="#Scan-187"><span class="linenos">187</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tray_pos</span><span class="p">,</span>
</span><span id="Scan-188"><a href="#Scan-188"><span class="linenos">188</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slide_pos</span><span class="p">,</span>
</span><span id="Scan-189"><a href="#Scan-189"><span class="linenos">189</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">camera</span><span class="p">,</span>
</span><span id="Scan-190"><a href="#Scan-190"><span class="linenos">190</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">,</span>
</span><span id="Scan-191"><a href="#Scan-191"><span class="linenos">191</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size_um</span><span class="p">,</span>
</span><span id="Scan-192"><a href="#Scan-192"><span class="linenos">192</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tile_width_px</span><span class="p">,</span>
</span><span id="Scan-193"><a href="#Scan-193"><span class="linenos">193</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tile_height_px</span><span class="p">,</span>
</span><span id="Scan-194"><a href="#Scan-194"><span class="linenos">194</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tile_overlap_proportion</span><span class="p">,</span>
</span><span id="Scan-195"><a href="#Scan-195"><span class="linenos">195</span></a>            <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">),</span>
</span><span id="Scan-196"><a href="#Scan-196"><span class="linenos">196</span></a>            <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">),</span>
</span><span id="Scan-197"><a href="#Scan-197"><span class="linenos">197</span></a>        <span class="p">)</span>
</span><span id="Scan-198"><a href="#Scan-198"><span class="linenos">198</span></a>
</span><span id="Scan-199"><a href="#Scan-199"><span class="linenos">199</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Scan-200"><a href="#Scan-200"><span class="linenos">200</span></a>        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__key</span><span class="p">())</span>
</span><span id="Scan-201"><a href="#Scan-201"><span class="linenos">201</span></a>
</span><span id="Scan-202"><a href="#Scan-202"><span class="linenos">202</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Scan-203"><a href="#Scan-203"><span class="linenos">203</span></a>        <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Scan-204"><a href="#Scan-204"><span class="linenos">204</span></a>
</span><span id="Scan-205"><a href="#Scan-205"><span class="linenos">205</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="Scan-206"><a href="#Scan-206"><span class="linenos">206</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
</span><span id="Scan-207"><a href="#Scan-207"><span class="linenos">207</span></a>
</span><span id="Scan-208"><a href="#Scan-208"><span class="linenos">208</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">has_same_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="Scan-209"><a href="#Scan-209"><span class="linenos">209</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="Scan-210"><a href="#Scan-210"><span class="linenos">210</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">camera</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">camera</span>
</span><span id="Scan-211"><a href="#Scan-211"><span class="linenos">211</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">objective</span>
</span><span id="Scan-212"><a href="#Scan-212"><span class="linenos">212</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size_um</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">pixel_size_um</span>
</span><span id="Scan-213"><a href="#Scan-213"><span class="linenos">213</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_width_px</span>
</span><span id="Scan-214"><a href="#Scan-214"><span class="linenos">214</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_height_px</span>
</span><span id="Scan-215"><a href="#Scan-215"><span class="linenos">215</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_x_offset_px</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_x_offset_px</span>
</span><span id="Scan-216"><a href="#Scan-216"><span class="linenos">216</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_y_offset_px</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_y_offset_px</span>
</span><span id="Scan-217"><a href="#Scan-217"><span class="linenos">217</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_overlap_proportion</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_overlap_proportion</span>
</span><span id="Scan-218"><a href="#Scan-218"><span class="linenos">218</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">channels</span>
</span><span id="Scan-219"><a href="#Scan-219"><span class="linenos">219</span></a>            <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">similar</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">roi</span><span class="p">))</span>
</span><span id="Scan-220"><a href="#Scan-220"><span class="linenos">220</span></a>        <span class="p">)</span>
</span><span id="Scan-221"><a href="#Scan-221"><span class="linenos">221</span></a>
</span><span id="Scan-222"><a href="#Scan-222"><span class="linenos">222</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_channel_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="Scan-223"><a href="#Scan-223"><span class="linenos">223</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan-224"><a href="#Scan-224"><span class="linenos">224</span></a><span class="sd">        Get the channel names in the scan&#39;s channel order.</span>
</span><span id="Scan-225"><a href="#Scan-225"><span class="linenos">225</span></a><span class="sd">        :return: a list of channel names.</span>
</span><span id="Scan-226"><a href="#Scan-226"><span class="linenos">226</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan-227"><a href="#Scan-227"><span class="linenos">227</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">]</span>
</span><span id="Scan-228"><a href="#Scan-228"><span class="linenos">228</span></a>
</span><span id="Scan-229"><a href="#Scan-229"><span class="linenos">229</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_channel_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="Scan-230"><a href="#Scan-230"><span class="linenos">230</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan-231"><a href="#Scan-231"><span class="linenos">231</span></a><span class="sd">        Given a list of channel names, return the corresponding indices in the scan&#39;s</span>
</span><span id="Scan-232"><a href="#Scan-232"><span class="linenos">232</span></a><span class="sd">        channel order. Will convert BZScanner channel names (TRITC, CY5, FITC) to the</span>
</span><span id="Scan-233"><a href="#Scan-233"><span class="linenos">233</span></a><span class="sd">        actual AlexaFluor names (AF555, AF647, AF488).</span>
</span><span id="Scan-234"><a href="#Scan-234"><span class="linenos">234</span></a><span class="sd">        If a list entry is not found or None, it will return -1 for that entry.</span>
</span><span id="Scan-235"><a href="#Scan-235"><span class="linenos">235</span></a><span class="sd">        :param channel_names: a list of channel names.</span>
</span><span id="Scan-236"><a href="#Scan-236"><span class="linenos">236</span></a><span class="sd">        :return: a list of channel indices.</span>
</span><span id="Scan-237"><a href="#Scan-237"><span class="linenos">237</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan-238"><a href="#Scan-238"><span class="linenos">238</span></a>        <span class="c1"># Get the scan&#39;s channel name list</span>
</span><span id="Scan-239"><a href="#Scan-239"><span class="linenos">239</span></a>        <span class="n">scan_channel_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_channel_names</span><span class="p">()</span>
</span><span id="Scan-240"><a href="#Scan-240"><span class="linenos">240</span></a>
</span><span id="Scan-241"><a href="#Scan-241"><span class="linenos">241</span></a>        <span class="n">channel_indices</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scan-242"><a href="#Scan-242"><span class="linenos">242</span></a>        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">channel_names</span><span class="p">:</span>
</span><span id="Scan-243"><a href="#Scan-243"><span class="linenos">243</span></a>            <span class="c1"># Convert any BZScanner channel names to the actual channel names</span>
</span><span id="Scan-244"><a href="#Scan-244"><span class="linenos">244</span></a>            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BZSCANNER_CHANNEL_MAP</span><span class="p">:</span>
</span><span id="Scan-245"><a href="#Scan-245"><span class="linenos">245</span></a>                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BZSCANNER_CHANNEL_MAP</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span><span id="Scan-246"><a href="#Scan-246"><span class="linenos">246</span></a>
</span><span id="Scan-247"><a href="#Scan-247"><span class="linenos">247</span></a>            <span class="c1"># Append the corresponding index if possible</span>
</span><span id="Scan-248"><a href="#Scan-248"><span class="linenos">248</span></a>            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">scan_channel_names</span><span class="p">:</span>
</span><span id="Scan-249"><a href="#Scan-249"><span class="linenos">249</span></a>                <span class="n">channel_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan_channel_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
</span><span id="Scan-250"><a href="#Scan-250"><span class="linenos">250</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Scan-251"><a href="#Scan-251"><span class="linenos">251</span></a>                <span class="n">channel_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Scan-252"><a href="#Scan-252"><span class="linenos">252</span></a>        <span class="k">return</span> <span class="n">channel_indices</span>
</span><span id="Scan-253"><a href="#Scan-253"><span class="linenos">253</span></a>
</span><span id="Scan-254"><a href="#Scan-254"><span class="linenos">254</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_image_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
</span><span id="Scan-255"><a href="#Scan-255"><span class="linenos">255</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan-256"><a href="#Scan-256"><span class="linenos">256</span></a><span class="sd">        Get the real size of the image in pixels after subtracting overlap.</span>
</span><span id="Scan-257"><a href="#Scan-257"><span class="linenos">257</span></a><span class="sd">        :return: a tuple of (real_height, real_width) for easy comparison to arrays</span>
</span><span id="Scan-258"><a href="#Scan-258"><span class="linenos">258</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan-259"><a href="#Scan-259"><span class="linenos">259</span></a>        <span class="n">width_overlap</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_overlap_proportion</span><span class="p">)</span>
</span><span id="Scan-260"><a href="#Scan-260"><span class="linenos">260</span></a>        <span class="n">height_overlap</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_overlap_proportion</span><span class="p">)</span>
</span><span id="Scan-261"><a href="#Scan-261"><span class="linenos">261</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">-</span> <span class="n">height_overlap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">-</span> <span class="n">width_overlap</span>
</span><span id="Scan-262"><a href="#Scan-262"><span class="linenos">262</span></a>
</span><span id="Scan-263"><a href="#Scan-263"><span class="linenos">263</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Scan-264"><a href="#Scan-264"><span class="linenos">264</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan-265"><a href="#Scan-265"><span class="linenos">265</span></a><span class="sd">        Write the Scan object to a .yaml file.</span>
</span><span id="Scan-266"><a href="#Scan-266"><span class="linenos">266</span></a><span class="sd">        :param output_path: /path/to/file.yaml or /path/to/folder to put scan.yaml</span>
</span><span id="Scan-267"><a href="#Scan-267"><span class="linenos">267</span></a><span class="sd">        :return: nothing; will raise an error on failure</span>
</span><span id="Scan-268"><a href="#Scan-268"><span class="linenos">268</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan-269"><a href="#Scan-269"><span class="linenos">269</span></a>        <span class="c1"># Create necessary folders</span>
</span><span id="Scan-270"><a href="#Scan-270"><span class="linenos">270</span></a>        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</span><span id="Scan-271"><a href="#Scan-271"><span class="linenos">271</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">output_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.yaml&quot;</span><span class="p">:</span>
</span><span id="Scan-272"><a href="#Scan-272"><span class="linenos">272</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Scan-273"><a href="#Scan-273"><span class="linenos">273</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Scan-274"><a href="#Scan-274"><span class="linenos">274</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Scan-275"><a href="#Scan-275"><span class="linenos">275</span></a>            <span class="c1"># Add the standard metadata file name to the path if needed</span>
</span><span id="Scan-276"><a href="#Scan-276"><span class="linenos">276</span></a>            <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="Scan-277"><a href="#Scan-277"><span class="linenos">277</span></a>                <span class="n">output_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">METADATA_FILE_NAME</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">]</span>
</span><span id="Scan-278"><a href="#Scan-278"><span class="linenos">278</span></a>            <span class="p">)</span>
</span><span id="Scan-279"><a href="#Scan-279"><span class="linenos">279</span></a>
</span><span id="Scan-280"><a href="#Scan-280"><span class="linenos">280</span></a>        <span class="c1"># Populate the file</span>
</span><span id="Scan-281"><a href="#Scan-281"><span class="linenos">281</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="Scan-282"><a href="#Scan-282"><span class="linenos">282</span></a>            <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Scan-283"><a href="#Scan-283"><span class="linenos">283</span></a>
</span><span id="Scan-284"><a href="#Scan-284"><span class="linenos">284</span></a>    <span class="nd">@classmethod</span>
</span><span id="Scan-285"><a href="#Scan-285"><span class="linenos">285</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_yaml</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="Scan-286"><a href="#Scan-286"><span class="linenos">286</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan-287"><a href="#Scan-287"><span class="linenos">287</span></a><span class="sd">        Load a Scan object from a .yaml file.</span>
</span><span id="Scan-288"><a href="#Scan-288"><span class="linenos">288</span></a><span class="sd">        :param input_path: /path/to/file.yaml or /path/to/folder with scan.yaml</span>
</span><span id="Scan-289"><a href="#Scan-289"><span class="linenos">289</span></a><span class="sd">        :return: a Scan object</span>
</span><span id="Scan-290"><a href="#Scan-290"><span class="linenos">290</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan-291"><a href="#Scan-291"><span class="linenos">291</span></a>        <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="Scan-292"><a href="#Scan-292"><span class="linenos">292</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">input_path</span><span class="p">):</span>
</span><span id="Scan-293"><a href="#Scan-293"><span class="linenos">293</span></a>            <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="Scan-294"><a href="#Scan-294"><span class="linenos">294</span></a>                <span class="n">input_path</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">METADATA_FILE_NAME</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">]</span>
</span><span id="Scan-295"><a href="#Scan-295"><span class="linenos">295</span></a>            <span class="p">)</span>
</span><span id="Scan-296"><a href="#Scan-296"><span class="linenos">296</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="Scan-297"><a href="#Scan-297"><span class="linenos">297</span></a>            <span class="n">metadata_obj</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">Loader</span><span class="p">)</span>
</span><span id="Scan-298"><a href="#Scan-298"><span class="linenos">298</span></a>        <span class="k">return</span> <span class="n">metadata_obj</span>
</span><span id="Scan-299"><a href="#Scan-299"><span class="linenos">299</span></a>
</span><span id="Scan-300"><a href="#Scan-300"><span class="linenos">300</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="Scan-301"><a href="#Scan-301"><span class="linenos">301</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan-302"><a href="#Scan-302"><span class="linenos">302</span></a><span class="sd">        Convert the Scan object to a dictionary with keys matching database columns</span>
</span><span id="Scan-303"><a href="#Scan-303"><span class="linenos">303</span></a><span class="sd">        and values matching database entries</span>
</span><span id="Scan-304"><a href="#Scan-304"><span class="linenos">304</span></a><span class="sd">        :return: a dictionary</span>
</span><span id="Scan-305"><a href="#Scan-305"><span class="linenos">305</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan-306"><a href="#Scan-306"><span class="linenos">306</span></a>        <span class="c1"># Dump to json; then add indents and a top-level key</span>
</span><span id="Scan-307"><a href="#Scan-307"><span class="linenos">307</span></a>        <span class="n">channels_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
</span><span id="Scan-308"><a href="#Scan-308"><span class="linenos">308</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span>
</span><span id="Scan-309"><a href="#Scan-309"><span class="linenos">309</span></a>        <span class="p">)</span>
</span><span id="Scan-310"><a href="#Scan-310"><span class="linenos">310</span></a>        <span class="n">channels_json</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">channels_json</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
</span><span id="Scan-311"><a href="#Scan-311"><span class="linenos">311</span></a>        <span class="n">channels_json</span> <span class="o">=</span> <span class="s2">&quot;{</span><span class="se">\n</span><span class="s2">  &quot;</span> <span class="o">+</span> <span class="s1">&#39;&quot;data&quot;: &#39;</span> <span class="o">+</span> <span class="n">channels_json</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">}&quot;</span>
</span><span id="Scan-312"><a href="#Scan-312"><span class="linenos">312</span></a>
</span><span id="Scan-313"><a href="#Scan-313"><span class="linenos">313</span></a>        <span class="n">roi_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="Scan-314"><a href="#Scan-314"><span class="linenos">314</span></a>        <span class="n">roi_json</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_json</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
</span><span id="Scan-315"><a href="#Scan-315"><span class="linenos">315</span></a>        <span class="n">roi_json</span> <span class="o">=</span> <span class="s2">&quot;{</span><span class="se">\n</span><span class="s2">  &quot;</span> <span class="o">+</span> <span class="s1">&#39;&quot;data&quot;: &#39;</span> <span class="o">+</span> <span class="n">roi_json</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">}&quot;</span>
</span><span id="Scan-316"><a href="#Scan-316"><span class="linenos">316</span></a>
</span><span id="Scan-317"><a href="#Scan-317"><span class="linenos">317</span></a>        <span class="c1"># Keys are named the same as database columns</span>
</span><span id="Scan-318"><a href="#Scan-318"><span class="linenos">318</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="Scan-319"><a href="#Scan-319"><span class="linenos">319</span></a>            <span class="s2">&quot;scanner_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanner_id</span><span class="p">,</span>
</span><span id="Scan-320"><a href="#Scan-320"><span class="linenos">320</span></a>            <span class="s2">&quot;slide_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_id</span><span class="p">,</span>
</span><span id="Scan-321"><a href="#Scan-321"><span class="linenos">321</span></a>            <span class="s2">&quot;exists&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">,</span>
</span><span id="Scan-322"><a href="#Scan-322"><span class="linenos">322</span></a>            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="Scan-323"><a href="#Scan-323"><span class="linenos">323</span></a>            <span class="s2">&quot;start_datetime&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_datetime</span><span class="p">,</span>
</span><span id="Scan-324"><a href="#Scan-324"><span class="linenos">324</span></a>            <span class="s2">&quot;end_datetime&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_datetime</span><span class="p">,</span>
</span><span id="Scan-325"><a href="#Scan-325"><span class="linenos">325</span></a>            <span class="s2">&quot;scan_time_s&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_time_s</span><span class="p">,</span>
</span><span id="Scan-326"><a href="#Scan-326"><span class="linenos">326</span></a>            <span class="s2">&quot;tray_pos&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tray_pos</span><span class="p">,</span>
</span><span id="Scan-327"><a href="#Scan-327"><span class="linenos">327</span></a>            <span class="s2">&quot;slide_pos&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_pos</span><span class="p">,</span>
</span><span id="Scan-328"><a href="#Scan-328"><span class="linenos">328</span></a>            <span class="s2">&quot;tile_width&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_width_px</span><span class="p">,</span>
</span><span id="Scan-329"><a href="#Scan-329"><span class="linenos">329</span></a>            <span class="s2">&quot;tile_height&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_height_px</span><span class="p">,</span>
</span><span id="Scan-330"><a href="#Scan-330"><span class="linenos">330</span></a>            <span class="s2">&quot;tile_x_offset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_x_offset_px</span><span class="p">,</span>
</span><span id="Scan-331"><a href="#Scan-331"><span class="linenos">331</span></a>            <span class="s2">&quot;tile_y_offset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_y_offset_px</span><span class="p">,</span>
</span><span id="Scan-332"><a href="#Scan-332"><span class="linenos">332</span></a>            <span class="s2">&quot;tile_overlap&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_overlap_proportion</span><span class="p">,</span>
</span><span id="Scan-333"><a href="#Scan-333"><span class="linenos">333</span></a>            <span class="s2">&quot;camera&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera</span><span class="p">,</span>
</span><span id="Scan-334"><a href="#Scan-334"><span class="linenos">334</span></a>            <span class="s2">&quot;objective&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">,</span>
</span><span id="Scan-335"><a href="#Scan-335"><span class="linenos">335</span></a>            <span class="s2">&quot;pixel_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size_um</span><span class="p">,</span>
</span><span id="Scan-336"><a href="#Scan-336"><span class="linenos">336</span></a>            <span class="s2">&quot;channels&quot;</span><span class="p">:</span> <span class="n">channels_json</span><span class="p">,</span>
</span><span id="Scan-337"><a href="#Scan-337"><span class="linenos">337</span></a>            <span class="s2">&quot;roi&quot;</span><span class="p">:</span> <span class="n">roi_json</span><span class="p">,</span>
</span><span id="Scan-338"><a href="#Scan-338"><span class="linenos">338</span></a>        <span class="p">}</span>
</span><span id="Scan-339"><a href="#Scan-339"><span class="linenos">339</span></a>
</span><span id="Scan-340"><a href="#Scan-340"><span class="linenos">340</span></a>    <span class="nd">@classmethod</span>
</span><span id="Scan-341"><a href="#Scan-341"><span class="linenos">341</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">scan_dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="Scan-342"><a href="#Scan-342"><span class="linenos">342</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan-343"><a href="#Scan-343"><span class="linenos">343</span></a><span class="sd">        Convert a dictionary from to_dict() or the database to a Scan object</span>
</span><span id="Scan-344"><a href="#Scan-344"><span class="linenos">344</span></a><span class="sd">        :param scan_dict: a dictionary</span>
</span><span id="Scan-345"><a href="#Scan-345"><span class="linenos">345</span></a><span class="sd">        :return: a Scan object</span>
</span><span id="Scan-346"><a href="#Scan-346"><span class="linenos">346</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan-347"><a href="#Scan-347"><span class="linenos">347</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
</span><span id="Scan-348"><a href="#Scan-348"><span class="linenos">348</span></a>            <span class="n">scanner_id</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;scanner_id&quot;</span><span class="p">],</span>
</span><span id="Scan-349"><a href="#Scan-349"><span class="linenos">349</span></a>            <span class="n">slide_id</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">],</span>
</span><span id="Scan-350"><a href="#Scan-350"><span class="linenos">350</span></a>            <span class="n">path</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span>
</span><span id="Scan-351"><a href="#Scan-351"><span class="linenos">351</span></a>            <span class="n">exists</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;exists&quot;</span><span class="p">],</span>
</span><span id="Scan-352"><a href="#Scan-352"><span class="linenos">352</span></a>            <span class="n">start_datetime</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;start_datetime&quot;</span><span class="p">],</span>
</span><span id="Scan-353"><a href="#Scan-353"><span class="linenos">353</span></a>            <span class="n">end_datetime</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;end_datetime&quot;</span><span class="p">],</span>
</span><span id="Scan-354"><a href="#Scan-354"><span class="linenos">354</span></a>            <span class="n">scan_time_s</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;scan_time_s&quot;</span><span class="p">],</span>
</span><span id="Scan-355"><a href="#Scan-355"><span class="linenos">355</span></a>            <span class="n">tray_pos</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;tray_pos&quot;</span><span class="p">],</span>
</span><span id="Scan-356"><a href="#Scan-356"><span class="linenos">356</span></a>            <span class="n">slide_pos</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;slide_pos&quot;</span><span class="p">],</span>
</span><span id="Scan-357"><a href="#Scan-357"><span class="linenos">357</span></a>            <span class="n">camera</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;camera&quot;</span><span class="p">],</span>
</span><span id="Scan-358"><a href="#Scan-358"><span class="linenos">358</span></a>            <span class="n">objective</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;objective&quot;</span><span class="p">],</span>
</span><span id="Scan-359"><a href="#Scan-359"><span class="linenos">359</span></a>            <span class="n">pixel_size_um</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;pixel_size&quot;</span><span class="p">],</span>
</span><span id="Scan-360"><a href="#Scan-360"><span class="linenos">360</span></a>            <span class="n">tile_width_px</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;tile_width&quot;</span><span class="p">],</span>
</span><span id="Scan-361"><a href="#Scan-361"><span class="linenos">361</span></a>            <span class="n">tile_height_px</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;tile_height&quot;</span><span class="p">],</span>
</span><span id="Scan-362"><a href="#Scan-362"><span class="linenos">362</span></a>            <span class="n">tile_x_offset_px</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;tile_x_offset&quot;</span><span class="p">],</span>
</span><span id="Scan-363"><a href="#Scan-363"><span class="linenos">363</span></a>            <span class="n">tile_y_offset_px</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;tile_y_offset&quot;</span><span class="p">],</span>
</span><span id="Scan-364"><a href="#Scan-364"><span class="linenos">364</span></a>            <span class="n">tile_overlap_proportion</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;tile_overlap&quot;</span><span class="p">],</span>
</span><span id="Scan-365"><a href="#Scan-365"><span class="linenos">365</span></a>        <span class="p">)</span>
</span><span id="Scan-366"><a href="#Scan-366"><span class="linenos">366</span></a>        <span class="c1"># Handle JSON and dictionaries</span>
</span><span id="Scan-367"><a href="#Scan-367"><span class="linenos">367</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Scan-368"><a href="#Scan-368"><span class="linenos">368</span></a>            <span class="n">channels_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">])[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
</span><span id="Scan-369"><a href="#Scan-369"><span class="linenos">369</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Scan-370"><a href="#Scan-370"><span class="linenos">370</span></a>            <span class="n">channels_dict</span> <span class="o">=</span> <span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
</span><span id="Scan-371"><a href="#Scan-371"><span class="linenos">371</span></a>        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels_dict</span><span class="p">:</span>
</span><span id="Scan-372"><a href="#Scan-372"><span class="linenos">372</span></a>            <span class="n">result</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="Scan-373"><a href="#Scan-373"><span class="linenos">373</span></a>                <span class="bp">cls</span><span class="o">.</span><span class="n">Channel</span><span class="p">(</span>
</span><span id="Scan-374"><a href="#Scan-374"><span class="linenos">374</span></a>                    <span class="n">name</span><span class="o">=</span><span class="n">channel</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="Scan-375"><a href="#Scan-375"><span class="linenos">375</span></a>                    <span class="n">exposure_ms</span><span class="o">=</span><span class="n">channel</span><span class="p">[</span><span class="s2">&quot;exposure_ms&quot;</span><span class="p">],</span>
</span><span id="Scan-376"><a href="#Scan-376"><span class="linenos">376</span></a>                    <span class="n">intensity</span><span class="o">=</span><span class="n">channel</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">],</span>
</span><span id="Scan-377"><a href="#Scan-377"><span class="linenos">377</span></a>                    <span class="n">gain_applied</span><span class="o">=</span><span class="n">channel</span><span class="p">[</span><span class="s2">&quot;gain_applied&quot;</span><span class="p">],</span>
</span><span id="Scan-378"><a href="#Scan-378"><span class="linenos">378</span></a>                <span class="p">)</span>
</span><span id="Scan-379"><a href="#Scan-379"><span class="linenos">379</span></a>            <span class="p">)</span>
</span><span id="Scan-380"><a href="#Scan-380"><span class="linenos">380</span></a>        <span class="c1"># Handle JSON and dictionaries</span>
</span><span id="Scan-381"><a href="#Scan-381"><span class="linenos">381</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Scan-382"><a href="#Scan-382"><span class="linenos">382</span></a>            <span class="n">roi_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">])[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
</span><span id="Scan-383"><a href="#Scan-383"><span class="linenos">383</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Scan-384"><a href="#Scan-384"><span class="linenos">384</span></a>            <span class="n">roi_dict</span> <span class="o">=</span> <span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
</span><span id="Scan-385"><a href="#Scan-385"><span class="linenos">385</span></a>        <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">roi_dict</span><span class="p">:</span>
</span><span id="Scan-386"><a href="#Scan-386"><span class="linenos">386</span></a>            <span class="n">result</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="Scan-387"><a href="#Scan-387"><span class="linenos">387</span></a>                <span class="bp">cls</span><span class="o">.</span><span class="n">ROI</span><span class="p">(</span>
</span><span id="Scan-388"><a href="#Scan-388"><span class="linenos">388</span></a>                    <span class="n">origin_x_um</span><span class="o">=</span><span class="n">roi</span><span class="p">[</span><span class="s2">&quot;origin_x_um&quot;</span><span class="p">],</span>
</span><span id="Scan-389"><a href="#Scan-389"><span class="linenos">389</span></a>                    <span class="n">origin_y_um</span><span class="o">=</span><span class="n">roi</span><span class="p">[</span><span class="s2">&quot;origin_y_um&quot;</span><span class="p">],</span>
</span><span id="Scan-390"><a href="#Scan-390"><span class="linenos">390</span></a>                    <span class="n">width_um</span><span class="o">=</span><span class="n">roi</span><span class="p">[</span><span class="s2">&quot;width_um&quot;</span><span class="p">],</span>
</span><span id="Scan-391"><a href="#Scan-391"><span class="linenos">391</span></a>                    <span class="n">height_um</span><span class="o">=</span><span class="n">roi</span><span class="p">[</span><span class="s2">&quot;height_um&quot;</span><span class="p">],</span>
</span><span id="Scan-392"><a href="#Scan-392"><span class="linenos">392</span></a>                    <span class="n">tile_rows</span><span class="o">=</span><span class="n">roi</span><span class="p">[</span><span class="s2">&quot;tile_rows&quot;</span><span class="p">],</span>
</span><span id="Scan-393"><a href="#Scan-393"><span class="linenos">393</span></a>                    <span class="n">tile_cols</span><span class="o">=</span><span class="n">roi</span><span class="p">[</span><span class="s2">&quot;tile_cols&quot;</span><span class="p">],</span>
</span><span id="Scan-394"><a href="#Scan-394"><span class="linenos">394</span></a>                    <span class="n">focus_points</span><span class="o">=</span><span class="n">roi</span><span class="p">[</span><span class="s2">&quot;focus_points&quot;</span><span class="p">],</span>
</span><span id="Scan-395"><a href="#Scan-395"><span class="linenos">395</span></a>                <span class="p">)</span>
</span><span id="Scan-396"><a href="#Scan-396"><span class="linenos">396</span></a>            <span class="p">)</span>
</span><span id="Scan-397"><a href="#Scan-397"><span class="linenos">397</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="Scan-398"><a href="#Scan-398"><span class="linenos">398</span></a>
</span><span id="Scan-399"><a href="#Scan-399"><span class="linenos">399</span></a>    <span class="nd">@classmethod</span>
</span><span id="Scan-400"><a href="#Scan-400"><span class="linenos">400</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_czi</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="Scan-401"><a href="#Scan-401"><span class="linenos">401</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan-402"><a href="#Scan-402"><span class="linenos">402</span></a><span class="sd">        Extracts metadata from a .czi file, which is the output of the Axioscan</span>
</span><span id="Scan-403"><a href="#Scan-403"><span class="linenos">403</span></a><span class="sd">        :param input_path: the path to the .czi file</span>
</span><span id="Scan-404"><a href="#Scan-404"><span class="linenos">404</span></a><span class="sd">        :return: a Scan object</span>
</span><span id="Scan-405"><a href="#Scan-405"><span class="linenos">405</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan-406"><a href="#Scan-406"><span class="linenos">406</span></a>        <span class="k">if</span> <span class="n">aicspylibczi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scan-407"><a href="#Scan-407"><span class="linenos">407</span></a>            <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span>
</span><span id="Scan-408"><a href="#Scan-408"><span class="linenos">408</span></a>                <span class="s2">&quot;aicspylibczi library not installed. &quot;</span>
</span><span id="Scan-409"><a href="#Scan-409"><span class="linenos">409</span></a>                <span class="s2">&quot;Install csi-images with [imageio] option to resolve.&quot;</span>
</span><span id="Scan-410"><a href="#Scan-410"><span class="linenos">410</span></a>            <span class="p">)</span>
</span><span id="Scan-411"><a href="#Scan-411"><span class="linenos">411</span></a>
</span><span id="Scan-412"><a href="#Scan-412"><span class="linenos">412</span></a>        <span class="c1"># Normalize paths</span>
</span><span id="Scan-413"><a href="#Scan-413"><span class="linenos">413</span></a>        <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="Scan-414"><a href="#Scan-414"><span class="linenos">414</span></a>
</span><span id="Scan-415"><a href="#Scan-415"><span class="linenos">415</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="Scan-416"><a href="#Scan-416"><span class="linenos">416</span></a>            <span class="c1"># Read in metadata as XML elements</span>
</span><span id="Scan-417"><a href="#Scan-417"><span class="linenos">417</span></a>            <span class="n">metadata_xml</span> <span class="o">=</span> <span class="n">aicspylibczi</span><span class="o">.</span><span class="n">CziFile</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">meta</span>
</span><span id="Scan-418"><a href="#Scan-418"><span class="linenos">418</span></a>            <span class="c1"># Read in shape metadata from binary</span>
</span><span id="Scan-419"><a href="#Scan-419"><span class="linenos">419</span></a>            <span class="n">rois_shape</span> <span class="o">=</span> <span class="n">aicspylibczi</span><span class="o">.</span><span class="n">CziFile</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">get_dims_shape</span><span class="p">()</span>
</span><span id="Scan-420"><a href="#Scan-420"><span class="linenos">420</span></a>
</span><span id="Scan-421"><a href="#Scan-421"><span class="linenos">421</span></a>        <span class="c1"># Populate metadata</span>
</span><span id="Scan-422"><a href="#Scan-422"><span class="linenos">422</span></a>        <span class="n">scan</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
</span><span id="Scan-423"><a href="#Scan-423"><span class="linenos">423</span></a>
</span><span id="Scan-424"><a href="#Scan-424"><span class="linenos">424</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Label/Barcodes/Barcode/Content&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span><span id="Scan-425"><a href="#Scan-425"><span class="linenos">425</span></a>        <span class="k">if</span> <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scan-426"><a href="#Scan-426"><span class="linenos">426</span></a>            <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="Scan-427"><a href="#Scan-427"><span class="linenos">427</span></a>        <span class="c1"># Map the raw scanner ID (service ID) to our IDs</span>
</span><span id="Scan-428"><a href="#Scan-428"><span class="linenos">428</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SCANNER_IDS</span><span class="p">[</span>
</span><span id="Scan-429"><a href="#Scan-429"><span class="linenos">429</span></a>            <span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Microscope/UserDefinedName&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span><span id="Scan-430"><a href="#Scan-430"><span class="linenos">430</span></a>        <span class="p">]</span>
</span><span id="Scan-431"><a href="#Scan-431"><span class="linenos">431</span></a>
</span><span id="Scan-432"><a href="#Scan-432"><span class="linenos">432</span></a>        <span class="c1"># Extract start and finish datetimes</span>
</span><span id="Scan-433"><a href="#Scan-433"><span class="linenos">433</span></a>        <span class="n">date</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Document/CreationDate&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span><span id="Scan-434"><a href="#Scan-434"><span class="linenos">434</span></a>        <span class="c1"># Strip out sub-second precision</span>
</span><span id="Scan-435"><a href="#Scan-435"><span class="linenos">435</span></a>        <span class="n">date</span> <span class="o">=</span> <span class="n">date</span><span class="p">[:</span> <span class="n">date</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)]</span> <span class="o">+</span> <span class="n">date</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">date</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">))</span> <span class="p">:]</span>
</span><span id="Scan-436"><a href="#Scan-436"><span class="linenos">436</span></a>        <span class="n">date_as_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
</span><span id="Scan-437"><a href="#Scan-437"><span class="linenos">437</span></a>            <span class="n">date</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DATETIME_FORMAT</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">]</span>
</span><span id="Scan-438"><a href="#Scan-438"><span class="linenos">438</span></a>        <span class="p">)</span>
</span><span id="Scan-439"><a href="#Scan-439"><span class="linenos">439</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">start_datetime</span> <span class="o">=</span> <span class="n">date_as_datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">STANDARD_DATETIME_FORMAT</span><span class="p">)</span>
</span><span id="Scan-440"><a href="#Scan-440"><span class="linenos">440</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">scan_time_s</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
</span><span id="Scan-441"><a href="#Scan-441"><span class="linenos">441</span></a>            <span class="nb">float</span><span class="p">(</span><span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Image/AcquisitionDuration&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span>
</span><span id="Scan-442"><a href="#Scan-442"><span class="linenos">442</span></a>        <span class="p">)</span>
</span><span id="Scan-443"><a href="#Scan-443"><span class="linenos">443</span></a>        <span class="n">date_as_datetime</span> <span class="o">+=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">scan</span><span class="o">.</span><span class="n">scan_time_s</span><span class="p">)</span>
</span><span id="Scan-444"><a href="#Scan-444"><span class="linenos">444</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">end_datetime</span> <span class="o">=</span> <span class="n">date_as_datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">STANDARD_DATETIME_FORMAT</span><span class="p">)</span>
</span><span id="Scan-445"><a href="#Scan-445"><span class="linenos">445</span></a>
</span><span id="Scan-446"><a href="#Scan-446"><span class="linenos">446</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tray_pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//SlotNumberOfLoadedTray&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="Scan-447"><a href="#Scan-447"><span class="linenos">447</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">slide_pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//SlideScannerPosition&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Scan-448"><a href="#Scan-448"><span class="linenos">448</span></a>
</span><span id="Scan-449"><a href="#Scan-449"><span class="linenos">449</span></a>        <span class="c1"># Get camera and magnifying info</span>
</span><span id="Scan-450"><a href="#Scan-450"><span class="linenos">450</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Scan-451"><a href="#Scan-451"><span class="linenos">451</span></a>            <span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Information/Instrument/Detectors/Detector&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">attrib</span>
</span><span id="Scan-452"><a href="#Scan-452"><span class="linenos">452</span></a>        <span class="p">)[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span>
</span><span id="Scan-453"><a href="#Scan-453"><span class="linenos">453</span></a>        <span class="n">magnification</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
</span><span id="Scan-454"><a href="#Scan-454"><span class="linenos">454</span></a>            <span class="s2">&quot;.//Objectives/Objective/NominalMagnification&quot;</span>
</span><span id="Scan-455"><a href="#Scan-455"><span class="linenos">455</span></a>        <span class="p">)</span>
</span><span id="Scan-456"><a href="#Scan-456"><span class="linenos">456</span></a>        <span class="n">aperture</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Objectives/Objective/LensNA&quot;</span><span class="p">)</span>
</span><span id="Scan-457"><a href="#Scan-457"><span class="linenos">457</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">objective</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">magnification</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">x-</span><span class="si">{</span><span class="n">aperture</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Scan-458"><a href="#Scan-458"><span class="linenos">458</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Scan-459"><a href="#Scan-459"><span class="linenos">459</span></a>            <span class="nb">float</span><span class="p">(</span><span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Scaling/Items/Distance/Value&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span>
</span><span id="Scan-460"><a href="#Scan-460"><span class="linenos">460</span></a>        <span class="p">)</span>
</span><span id="Scan-461"><a href="#Scan-461"><span class="linenos">461</span></a>        <span class="c1"># Round off the pixel size to nanometers; might not be optimal, but this</span>
</span><span id="Scan-462"><a href="#Scan-462"><span class="linenos">462</span></a>        <span class="c1"># gets rounded when we send it to the database anyways (to 7 places)</span>
</span><span id="Scan-463"><a href="#Scan-463"><span class="linenos">463</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="Scan-464"><a href="#Scan-464"><span class="linenos">464</span></a>
</span><span id="Scan-465"><a href="#Scan-465"><span class="linenos">465</span></a>        <span class="c1"># Get tile information</span>
</span><span id="Scan-466"><a href="#Scan-466"><span class="linenos">466</span></a>        <span class="c1"># Note: X Y is untested, could be flipped. I always forget. Just don&#39;t use</span>
</span><span id="Scan-467"><a href="#Scan-467"><span class="linenos">467</span></a>        <span class="c1"># non-square frames and we&#39;re all good.</span>
</span><span id="Scan-468"><a href="#Scan-468"><span class="linenos">468</span></a>        <span class="n">selected_detector</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//SelectedDetector&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span><span id="Scan-469"><a href="#Scan-469"><span class="linenos">469</span></a>        <span class="n">detectors</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//Detectors/Detector&quot;</span><span class="p">)</span>
</span><span id="Scan-470"><a href="#Scan-470"><span class="linenos">470</span></a>        <span class="k">for</span> <span class="n">detector</span> <span class="ow">in</span> <span class="n">detectors</span><span class="p">:</span>
</span><span id="Scan-471"><a href="#Scan-471"><span class="linenos">471</span></a>            <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">selected_detector</span><span class="p">:</span>
</span><span id="Scan-472"><a href="#Scan-472"><span class="linenos">472</span></a>                <span class="n">tile_info</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Frame&quot;</span><span class="p">)</span>
</span><span id="Scan-473"><a href="#Scan-473"><span class="linenos">473</span></a>                <span class="k">break</span>
</span><span id="Scan-474"><a href="#Scan-474"><span class="linenos">474</span></a>        <span class="c1"># Convert to integers</span>
</span><span id="Scan-475"><a href="#Scan-475"><span class="linenos">475</span></a>        <span class="n">tile_info</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">coordinate</span><span class="p">)</span> <span class="k">for</span> <span class="n">coordinate</span> <span class="ow">in</span> <span class="n">tile_info</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
</span><span id="Scan-476"><a href="#Scan-476"><span class="linenos">476</span></a>
</span><span id="Scan-477"><a href="#Scan-477"><span class="linenos">477</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_x_offset_px</span> <span class="o">=</span> <span class="n">tile_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Scan-478"><a href="#Scan-478"><span class="linenos">478</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_y_offset_px</span> <span class="o">=</span> <span class="n">tile_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Scan-479"><a href="#Scan-479"><span class="linenos">479</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">=</span> <span class="n">tile_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Scan-480"><a href="#Scan-480"><span class="linenos">480</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">=</span> <span class="n">tile_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="Scan-481"><a href="#Scan-481"><span class="linenos">481</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_overlap_proportion</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Overlap&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="Scan-482"><a href="#Scan-482"><span class="linenos">482</span></a>
</span><span id="Scan-483"><a href="#Scan-483"><span class="linenos">483</span></a>        <span class="c1"># Extract channels and create Channel objects from them</span>
</span><span id="Scan-484"><a href="#Scan-484"><span class="linenos">484</span></a>        <span class="n">channel_indices</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scan-485"><a href="#Scan-485"><span class="linenos">485</span></a>        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//Image/Dimensions/Channels/Channel&quot;</span><span class="p">):</span>
</span><span id="Scan-486"><a href="#Scan-486"><span class="linenos">486</span></a>            <span class="n">channel_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="Scan-487"><a href="#Scan-487"><span class="linenos">487</span></a>            <span class="n">intensity_xml</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Intensity&quot;</span><span class="p">)</span>
</span><span id="Scan-488"><a href="#Scan-488"><span class="linenos">488</span></a>            <span class="k">if</span> <span class="n">intensity_xml</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scan-489"><a href="#Scan-489"><span class="linenos">489</span></a>                <span class="n">intensity</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Scan-490"><a href="#Scan-490"><span class="linenos">490</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Scan-491"><a href="#Scan-491"><span class="linenos">491</span></a>                <span class="n">intensity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">intensity_xml</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-2</span>
</span><span id="Scan-492"><a href="#Scan-492"><span class="linenos">492</span></a>            <span class="n">scan</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="Scan-493"><a href="#Scan-493"><span class="linenos">493</span></a>                <span class="bp">cls</span><span class="o">.</span><span class="n">Channel</span><span class="p">(</span>
</span><span id="Scan-494"><a href="#Scan-494"><span class="linenos">494</span></a>                    <span class="n">name</span><span class="o">=</span><span class="n">channel</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
</span><span id="Scan-495"><a href="#Scan-495"><span class="linenos">495</span></a>                    <span class="n">exposure_ms</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./ExposureTime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span>
</span><span id="Scan-496"><a href="#Scan-496"><span class="linenos">496</span></a>                    <span class="n">intensity</span><span class="o">=</span><span class="n">intensity</span><span class="p">,</span>
</span><span id="Scan-497"><a href="#Scan-497"><span class="linenos">497</span></a>                    <span class="n">gain_applied</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># In Axioscan, we will always use gain = 1</span>
</span><span id="Scan-498"><a href="#Scan-498"><span class="linenos">498</span></a>                <span class="p">)</span>
</span><span id="Scan-499"><a href="#Scan-499"><span class="linenos">499</span></a>            <span class="p">)</span>
</span><span id="Scan-500"><a href="#Scan-500"><span class="linenos">500</span></a>        <span class="c1"># Make sure the channels are sorted</span>
</span><span id="Scan-501"><a href="#Scan-501"><span class="linenos">501</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Scan-502"><a href="#Scan-502"><span class="linenos">502</span></a>            <span class="n">channel</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">channel_indices</span><span class="p">,</span> <span class="n">scan</span><span class="o">.</span><span class="n">channels</span><span class="p">))</span>
</span><span id="Scan-503"><a href="#Scan-503"><span class="linenos">503</span></a>        <span class="p">]</span>
</span><span id="Scan-504"><a href="#Scan-504"><span class="linenos">504</span></a>        <span class="c1"># Verify that the shape corresponds to the channels</span>
</span><span id="Scan-505"><a href="#Scan-505"><span class="linenos">505</span></a>        <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois_shape</span><span class="p">:</span>
</span><span id="Scan-506"><a href="#Scan-506"><span class="linenos">506</span></a>            <span class="k">if</span> <span class="n">roi</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">channels</span><span class="p">):</span>
</span><span id="Scan-507"><a href="#Scan-507"><span class="linenos">507</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Scan-508"><a href="#Scan-508"><span class="linenos">508</span></a>                    <span class="sa">f</span><span class="s2">&quot;Number of channels </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Scan-509"><a href="#Scan-509"><span class="linenos">509</span></a>                    <span class="sa">f</span><span class="s2">&quot;is not the same as the number of channels in an ROI: &quot;</span>
</span><span id="Scan-510"><a href="#Scan-510"><span class="linenos">510</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">roi</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Scan-511"><a href="#Scan-511"><span class="linenos">511</span></a>                <span class="p">)</span>
</span><span id="Scan-512"><a href="#Scan-512"><span class="linenos">512</span></a>
</span><span id="Scan-513"><a href="#Scan-513"><span class="linenos">513</span></a>        <span class="c1"># Get the real ROI limits; the metadata is not always correct</span>
</span><span id="Scan-514"><a href="#Scan-514"><span class="linenos">514</span></a>        <span class="n">limits_xml</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//AllowedScanArea&quot;</span><span class="p">)</span>
</span><span id="Scan-515"><a href="#Scan-515"><span class="linenos">515</span></a>        <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Scan-516"><a href="#Scan-516"><span class="linenos">516</span></a>            <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">limits_xml</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Center&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])),</span>
</span><span id="Scan-517"><a href="#Scan-517"><span class="linenos">517</span></a>            <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">limits_xml</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Center&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])),</span>
</span><span id="Scan-518"><a href="#Scan-518"><span class="linenos">518</span></a>            <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">limits_xml</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Size&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])),</span>
</span><span id="Scan-519"><a href="#Scan-519"><span class="linenos">519</span></a>            <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">limits_xml</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Size&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])),</span>
</span><span id="Scan-520"><a href="#Scan-520"><span class="linenos">520</span></a>        <span class="p">]</span>
</span><span id="Scan-521"><a href="#Scan-521"><span class="linenos">521</span></a>        <span class="c1"># Convert to top-left and bottom-right</span>
</span><span id="Scan-522"><a href="#Scan-522"><span class="linenos">522</span></a>        <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Scan-523"><a href="#Scan-523"><span class="linenos">523</span></a>            <span class="nb">round</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Scan-524"><a href="#Scan-524"><span class="linenos">524</span></a>            <span class="nb">round</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Scan-525"><a href="#Scan-525"><span class="linenos">525</span></a>            <span class="nb">round</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Scan-526"><a href="#Scan-526"><span class="linenos">526</span></a>            <span class="nb">round</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Scan-527"><a href="#Scan-527"><span class="linenos">527</span></a>        <span class="p">]</span>
</span><span id="Scan-528"><a href="#Scan-528"><span class="linenos">528</span></a>
</span><span id="Scan-529"><a href="#Scan-529"><span class="linenos">529</span></a>        <span class="c1"># Extract ROIs and create ROI objects from them</span>
</span><span id="Scan-530"><a href="#Scan-530"><span class="linenos">530</span></a>        <span class="n">rois_xml_metadata</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//TileRegions/TileRegion&quot;</span><span class="p">)</span>
</span><span id="Scan-531"><a href="#Scan-531"><span class="linenos">531</span></a>        <span class="n">scenes_xml_metadata</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//S/Scenes/Scene&quot;</span><span class="p">)</span>
</span><span id="Scan-532"><a href="#Scan-532"><span class="linenos">532</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rois_xml_metadata</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rois_shape</span><span class="p">):</span>
</span><span id="Scan-533"><a href="#Scan-533"><span class="linenos">533</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Scan-534"><a href="#Scan-534"><span class="linenos">534</span></a>                <span class="sa">f</span><span class="s2">&quot;Metadata and binary data from </span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Scan-535"><a href="#Scan-535"><span class="linenos">535</span></a>                <span class="sa">f</span><span class="s2">&quot;do not match in number of ROIs&quot;</span>
</span><span id="Scan-536"><a href="#Scan-536"><span class="linenos">536</span></a>            <span class="p">)</span>
</span><span id="Scan-537"><a href="#Scan-537"><span class="linenos">537</span></a>        <span class="c1"># We need both to determine the number of rows/columns because the XML lies</span>
</span><span id="Scan-538"><a href="#Scan-538"><span class="linenos">538</span></a>        <span class="n">roi_indices</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scan-539"><a href="#Scan-539"><span class="linenos">539</span></a>        <span class="k">for</span> <span class="n">roi_xml</span><span class="p">,</span> <span class="n">roi_shape</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rois_xml_metadata</span><span class="p">,</span> <span class="n">rois_shape</span><span class="p">):</span>
</span><span id="Scan-540"><a href="#Scan-540"><span class="linenos">540</span></a>            <span class="n">name</span> <span class="o">=</span> <span class="n">roi_xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span>
</span><span id="Scan-541"><a href="#Scan-541"><span class="linenos">541</span></a>            <span class="c1"># Determine the index of this scene</span>
</span><span id="Scan-542"><a href="#Scan-542"><span class="linenos">542</span></a>            <span class="n">scene_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="Scan-543"><a href="#Scan-543"><span class="linenos">543</span></a>            <span class="k">for</span> <span class="n">scene</span> <span class="ow">in</span> <span class="n">scenes_xml_metadata</span><span class="p">:</span>
</span><span id="Scan-544"><a href="#Scan-544"><span class="linenos">544</span></a>                <span class="k">if</span> <span class="n">scene</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
</span><span id="Scan-545"><a href="#Scan-545"><span class="linenos">545</span></a>                    <span class="n">scene_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;Index&quot;</span><span class="p">])</span>
</span><span id="Scan-546"><a href="#Scan-546"><span class="linenos">546</span></a>                    <span class="k">break</span>
</span><span id="Scan-547"><a href="#Scan-547"><span class="linenos">547</span></a>            <span class="k">if</span> <span class="n">scene_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Scan-548"><a href="#Scan-548"><span class="linenos">548</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ROI </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not correspond to any scenes&quot;</span><span class="p">)</span>
</span><span id="Scan-549"><a href="#Scan-549"><span class="linenos">549</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Scan-550"><a href="#Scan-550"><span class="linenos">550</span></a>                <span class="n">roi_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scene_index</span><span class="p">)</span>
</span><span id="Scan-551"><a href="#Scan-551"><span class="linenos">551</span></a>            <span class="c1"># Extract other metadata</span>
</span><span id="Scan-552"><a href="#Scan-552"><span class="linenos">552</span></a>            <span class="n">roi_limits</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Scan-553"><a href="#Scan-553"><span class="linenos">553</span></a>                <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">roi_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;CenterPosition&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])),</span>
</span><span id="Scan-554"><a href="#Scan-554"><span class="linenos">554</span></a>                <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">roi_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;CenterPosition&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])),</span>
</span><span id="Scan-555"><a href="#Scan-555"><span class="linenos">555</span></a>                <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">roi_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ContourSize&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])),</span>
</span><span id="Scan-556"><a href="#Scan-556"><span class="linenos">556</span></a>                <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">roi_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ContourSize&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])),</span>
</span><span id="Scan-557"><a href="#Scan-557"><span class="linenos">557</span></a>            <span class="p">]</span>
</span><span id="Scan-558"><a href="#Scan-558"><span class="linenos">558</span></a>            <span class="c1"># Convert to top-left and bottom-right</span>
</span><span id="Scan-559"><a href="#Scan-559"><span class="linenos">559</span></a>            <span class="n">roi_limits</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Scan-560"><a href="#Scan-560"><span class="linenos">560</span></a>                <span class="nb">round</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">roi_limits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Scan-561"><a href="#Scan-561"><span class="linenos">561</span></a>                <span class="nb">round</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">roi_limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Scan-562"><a href="#Scan-562"><span class="linenos">562</span></a>                <span class="nb">round</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">roi_limits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Scan-563"><a href="#Scan-563"><span class="linenos">563</span></a>                <span class="nb">round</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">roi_limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Scan-564"><a href="#Scan-564"><span class="linenos">564</span></a>            <span class="p">]</span>
</span><span id="Scan-565"><a href="#Scan-565"><span class="linenos">565</span></a>            <span class="c1"># Bound the ROI to the actual scan limits</span>
</span><span id="Scan-566"><a href="#Scan-566"><span class="linenos">566</span></a>            <span class="n">roi_limits</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Scan-567"><a href="#Scan-567"><span class="linenos">567</span></a>                <span class="nb">max</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="Scan-568"><a href="#Scan-568"><span class="linenos">568</span></a>                <span class="nb">max</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="Scan-569"><a href="#Scan-569"><span class="linenos">569</span></a>                <span class="nb">min</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="Scan-570"><a href="#Scan-570"><span class="linenos">570</span></a>                <span class="nb">min</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="Scan-571"><a href="#Scan-571"><span class="linenos">571</span></a>            <span class="p">]</span>
</span><span id="Scan-572"><a href="#Scan-572"><span class="linenos">572</span></a>
</span><span id="Scan-573"><a href="#Scan-573"><span class="linenos">573</span></a>            <span class="n">tile_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">roi_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Rows&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="Scan-574"><a href="#Scan-574"><span class="linenos">574</span></a>            <span class="c1"># Current best way of reliably extracting; &lt;Columns&gt; entry can be wrong</span>
</span><span id="Scan-575"><a href="#Scan-575"><span class="linenos">575</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">roi_shape</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="n">tile_rows</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Scan-576"><a href="#Scan-576"><span class="linenos">576</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Scan-577"><a href="#Scan-577"><span class="linenos">577</span></a>                    <span class="sa">f</span><span class="s2">&quot;The number of tiles </span><span class="si">{</span><span class="n">roi_shape</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not &quot;</span>
</span><span id="Scan-578"><a href="#Scan-578"><span class="linenos">578</span></a>                    <span class="sa">f</span><span class="s2">&quot;divisible by the tile rows </span><span class="si">{</span><span class="n">tile_rows</span><span class="si">}</span><span class="s2">; metadata &quot;</span>
</span><span id="Scan-579"><a href="#Scan-579"><span class="linenos">579</span></a>                    <span class="sa">f</span><span class="s2">&quot;must be messed up. Thanks Zeiss&quot;</span>
</span><span id="Scan-580"><a href="#Scan-580"><span class="linenos">580</span></a>                <span class="p">)</span>
</span><span id="Scan-581"><a href="#Scan-581"><span class="linenos">581</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Scan-582"><a href="#Scan-582"><span class="linenos">582</span></a>                <span class="n">tile_cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">roi_shape</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">tile_rows</span><span class="p">)</span>
</span><span id="Scan-583"><a href="#Scan-583"><span class="linenos">583</span></a>            <span class="c1"># Support points are actually the relevant focus points for this ROI</span>
</span><span id="Scan-584"><a href="#Scan-584"><span class="linenos">584</span></a>            <span class="n">focus_points</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scan-585"><a href="#Scan-585"><span class="linenos">585</span></a>            <span class="k">for</span> <span class="n">focus_point</span> <span class="ow">in</span> <span class="n">roi_xml</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;SupportPoints/SupportPoint&quot;</span><span class="p">):</span>
</span><span id="Scan-586"><a href="#Scan-586"><span class="linenos">586</span></a>                <span class="n">focus_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="Scan-587"><a href="#Scan-587"><span class="linenos">587</span></a>                    <span class="p">[</span>
</span><span id="Scan-588"><a href="#Scan-588"><span class="linenos">588</span></a>                        <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">focus_point</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)),</span>
</span><span id="Scan-589"><a href="#Scan-589"><span class="linenos">589</span></a>                        <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">focus_point</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)),</span>
</span><span id="Scan-590"><a href="#Scan-590"><span class="linenos">590</span></a>                        <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">focus_point</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)),</span>
</span><span id="Scan-591"><a href="#Scan-591"><span class="linenos">591</span></a>                    <span class="p">]</span>
</span><span id="Scan-592"><a href="#Scan-592"><span class="linenos">592</span></a>                <span class="p">)</span>
</span><span id="Scan-593"><a href="#Scan-593"><span class="linenos">593</span></a>            <span class="c1"># Strip all sub-micron precision, it does not matter</span>
</span><span id="Scan-594"><a href="#Scan-594"><span class="linenos">594</span></a>            <span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="Scan-595"><a href="#Scan-595"><span class="linenos">595</span></a>                <span class="bp">cls</span><span class="o">.</span><span class="n">ROI</span><span class="p">(</span>
</span><span id="Scan-596"><a href="#Scan-596"><span class="linenos">596</span></a>                    <span class="n">origin_x_um</span><span class="o">=</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Scan-597"><a href="#Scan-597"><span class="linenos">597</span></a>                    <span class="n">origin_y_um</span><span class="o">=</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="Scan-598"><a href="#Scan-598"><span class="linenos">598</span></a>                    <span class="n">width_um</span><span class="o">=</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">roi_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Scan-599"><a href="#Scan-599"><span class="linenos">599</span></a>                    <span class="n">height_um</span><span class="o">=</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">roi_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="Scan-600"><a href="#Scan-600"><span class="linenos">600</span></a>                    <span class="n">tile_rows</span><span class="o">=</span><span class="n">tile_rows</span><span class="p">,</span>
</span><span id="Scan-601"><a href="#Scan-601"><span class="linenos">601</span></a>                    <span class="n">tile_cols</span><span class="o">=</span><span class="n">tile_cols</span><span class="p">,</span>
</span><span id="Scan-602"><a href="#Scan-602"><span class="linenos">602</span></a>                    <span class="n">focus_points</span><span class="o">=</span><span class="n">focus_points</span><span class="p">,</span>
</span><span id="Scan-603"><a href="#Scan-603"><span class="linenos">603</span></a>                <span class="p">)</span>
</span><span id="Scan-604"><a href="#Scan-604"><span class="linenos">604</span></a>            <span class="p">)</span>
</span><span id="Scan-605"><a href="#Scan-605"><span class="linenos">605</span></a>        <span class="c1"># Sort based on the scene indices</span>
</span><span id="Scan-606"><a href="#Scan-606"><span class="linenos">606</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="p">[</span><span class="n">roi</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">roi</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">roi_indices</span><span class="p">,</span> <span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="p">))]</span>
</span><span id="Scan-607"><a href="#Scan-607"><span class="linenos">607</span></a>
</span><span id="Scan-608"><a href="#Scan-608"><span class="linenos">608</span></a>        <span class="k">return</span> <span class="n">scan</span>
</span><span id="Scan-609"><a href="#Scan-609"><span class="linenos">609</span></a>
</span><span id="Scan-610"><a href="#Scan-610"><span class="linenos">610</span></a>    <span class="nd">@classmethod</span>
</span><span id="Scan-611"><a href="#Scan-611"><span class="linenos">611</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_txt</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="Scan-612"><a href="#Scan-612"><span class="linenos">612</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan-613"><a href="#Scan-613"><span class="linenos">613</span></a><span class="sd">        Loads a Scan object from a .txt file, usually slideinfo.txt, which originates</span>
</span><span id="Scan-614"><a href="#Scan-614"><span class="linenos">614</span></a><span class="sd">        from the BZScanner. Some metadata is filled in or adjusted to fit</span>
</span><span id="Scan-615"><a href="#Scan-615"><span class="linenos">615</span></a><span class="sd">        :param input_path: /path/to/file.txt or /path/to/folder containing slideinfo.txt</span>
</span><span id="Scan-616"><a href="#Scan-616"><span class="linenos">616</span></a><span class="sd">        :return: a Scan object</span>
</span><span id="Scan-617"><a href="#Scan-617"><span class="linenos">617</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan-618"><a href="#Scan-618"><span class="linenos">618</span></a>        <span class="c1"># Set paths</span>
</span><span id="Scan-619"><a href="#Scan-619"><span class="linenos">619</span></a>        <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="Scan-620"><a href="#Scan-620"><span class="linenos">620</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">input_path</span><span class="p">):</span>
</span><span id="Scan-621"><a href="#Scan-621"><span class="linenos">621</span></a>            <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="Scan-622"><a href="#Scan-622"><span class="linenos">622</span></a>                <span class="n">input_path</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">METADATA_FILE_NAME</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">]</span>
</span><span id="Scan-623"><a href="#Scan-623"><span class="linenos">623</span></a>            <span class="p">)</span>
</span><span id="Scan-624"><a href="#Scan-624"><span class="linenos">624</span></a>
</span><span id="Scan-625"><a href="#Scan-625"><span class="linenos">625</span></a>        <span class="c1"># Read in metadata as a dict</span>
</span><span id="Scan-626"><a href="#Scan-626"><span class="linenos">626</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="Scan-627"><a href="#Scan-627"><span class="linenos">627</span></a>            <span class="n">metadata_contents</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="Scan-628"><a href="#Scan-628"><span class="linenos">628</span></a>            <span class="c1"># Read each line, splitting on the = sign</span>
</span><span id="Scan-629"><a href="#Scan-629"><span class="linenos">629</span></a>            <span class="n">metadata_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Scan-630"><a href="#Scan-630"><span class="linenos">630</span></a>            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">metadata_contents</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
</span><span id="Scan-631"><a href="#Scan-631"><span class="linenos">631</span></a>                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
</span><span id="Scan-632"><a href="#Scan-632"><span class="linenos">632</span></a>                <span class="n">metadata_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="Scan-633"><a href="#Scan-633"><span class="linenos">633</span></a>
</span><span id="Scan-634"><a href="#Scan-634"><span class="linenos">634</span></a>        <span class="c1"># Populate metadata</span>
</span><span id="Scan-635"><a href="#Scan-635"><span class="linenos">635</span></a>        <span class="n">scan</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
</span><span id="Scan-636"><a href="#Scan-636"><span class="linenos">636</span></a>
</span><span id="Scan-637"><a href="#Scan-637"><span class="linenos">637</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;SLIDEID&quot;</span><span class="p">]</span>
</span><span id="Scan-638"><a href="#Scan-638"><span class="linenos">638</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="Scan-639"><a href="#Scan-639"><span class="linenos">639</span></a>
</span><span id="Scan-640"><a href="#Scan-640"><span class="linenos">640</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;SLIDEDIR&quot;</span><span class="p">]</span>
</span><span id="Scan-641"><a href="#Scan-641"><span class="linenos">641</span></a>
</span><span id="Scan-642"><a href="#Scan-642"><span class="linenos">642</span></a>        <span class="c1"># Extract start and finish datetimes</span>
</span><span id="Scan-643"><a href="#Scan-643"><span class="linenos">643</span></a>        <span class="n">date</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span>
</span><span id="Scan-644"><a href="#Scan-644"><span class="linenos">644</span></a>        <span class="n">date_as_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
</span><span id="Scan-645"><a href="#Scan-645"><span class="linenos">645</span></a>            <span class="n">date</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DATETIME_FORMAT</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">]</span>
</span><span id="Scan-646"><a href="#Scan-646"><span class="linenos">646</span></a>        <span class="p">)</span>
</span><span id="Scan-647"><a href="#Scan-647"><span class="linenos">647</span></a>        <span class="n">date_as_datetime</span> <span class="o">=</span> <span class="n">date_as_datetime</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span>
</span><span id="Scan-648"><a href="#Scan-648"><span class="linenos">648</span></a>            <span class="n">zoneinfo</span><span class="o">.</span><span class="n">ZoneInfo</span><span class="p">(</span><span class="s2">&quot;America/Los_Angeles&quot;</span><span class="p">)</span>
</span><span id="Scan-649"><a href="#Scan-649"><span class="linenos">649</span></a>        <span class="p">)</span>  <span class="c1"># Hardcoded because BZScanners are here</span>
</span><span id="Scan-650"><a href="#Scan-650"><span class="linenos">650</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">start_datetime</span> <span class="o">=</span> <span class="n">date_as_datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">STANDARD_DATETIME_FORMAT</span><span class="p">)</span>
</span><span id="Scan-651"><a href="#Scan-651"><span class="linenos">651</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">scan_time_s</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">*</span> <span class="mi">60</span>  <span class="c1"># estimated 90 minutes per scan</span>
</span><span id="Scan-652"><a href="#Scan-652"><span class="linenos">652</span></a>        <span class="n">date_as_datetime</span> <span class="o">+=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">scan</span><span class="o">.</span><span class="n">scan_time_s</span><span class="p">)</span>
</span><span id="Scan-653"><a href="#Scan-653"><span class="linenos">653</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">end_datetime</span> <span class="o">=</span> <span class="n">date_as_datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">STANDARD_DATETIME_FORMAT</span><span class="p">)</span>
</span><span id="Scan-654"><a href="#Scan-654"><span class="linenos">654</span></a>
</span><span id="Scan-655"><a href="#Scan-655"><span class="linenos">655</span></a>        <span class="c1"># Map the raw scanner ID (service ID) to our IDs</span>
</span><span id="Scan-656"><a href="#Scan-656"><span class="linenos">656</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;INSTRUMENT&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Scan-657"><a href="#Scan-657"><span class="linenos">657</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tray_pos</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># only one tray_pos in a BZScanner</span>
</span><span id="Scan-658"><a href="#Scan-658"><span class="linenos">658</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">slide_pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;SLIDEPOS&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># 1-indexed</span>
</span><span id="Scan-659"><a href="#Scan-659"><span class="linenos">659</span></a>
</span><span id="Scan-660"><a href="#Scan-660"><span class="linenos">660</span></a>        <span class="c1"># Get camera and magnifying info</span>
</span><span id="Scan-661"><a href="#Scan-661"><span class="linenos">661</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="Scan-662"><a href="#Scan-662"><span class="linenos">662</span></a>        <span class="n">magnification</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="Scan-663"><a href="#Scan-663"><span class="linenos">663</span></a>        <span class="n">aperture</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># TODO: find the actual aperture</span>
</span><span id="Scan-664"><a href="#Scan-664"><span class="linenos">664</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">objective</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">magnification</span><span class="si">}</span><span class="s2">x-</span><span class="si">{</span><span class="n">aperture</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Scan-665"><a href="#Scan-665"><span class="linenos">665</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span> <span class="o">=</span> <span class="mf">0.591</span>  <span class="c1"># Estimated from image metadata</span>
</span><span id="Scan-666"><a href="#Scan-666"><span class="linenos">666</span></a>
</span><span id="Scan-667"><a href="#Scan-667"><span class="linenos">667</span></a>        <span class="c1"># Get tile information</span>
</span><span id="Scan-668"><a href="#Scan-668"><span class="linenos">668</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">=</span> <span class="mi">1362</span>  <span class="c1"># Known from image metadata</span>
</span><span id="Scan-669"><a href="#Scan-669"><span class="linenos">669</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">=</span> <span class="mi">1004</span>  <span class="c1"># Known from image metadata</span>
</span><span id="Scan-670"><a href="#Scan-670"><span class="linenos">670</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_x_offset_px</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Already removed</span>
</span><span id="Scan-671"><a href="#Scan-671"><span class="linenos">671</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_y_offset_px</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Already removed</span>
</span><span id="Scan-672"><a href="#Scan-672"><span class="linenos">672</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_overlap_proportion</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Already removed</span>
</span><span id="Scan-673"><a href="#Scan-673"><span class="linenos">673</span></a>
</span><span id="Scan-674"><a href="#Scan-674"><span class="linenos">674</span></a>        <span class="c1"># Extract channels and create Channel objects from them</span>
</span><span id="Scan-675"><a href="#Scan-675"><span class="linenos">675</span></a>        <span class="k">if</span> <span class="s2">&quot;gain_applied&quot;</span> <span class="ow">in</span> <span class="n">metadata_dict</span><span class="p">:</span>
</span><span id="Scan-676"><a href="#Scan-676"><span class="linenos">676</span></a>            <span class="n">gain_applied</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;gain_applied&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="k">else</span> <span class="kc">False</span>
</span><span id="Scan-677"><a href="#Scan-677"><span class="linenos">677</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Scan-678"><a href="#Scan-678"><span class="linenos">678</span></a>            <span class="n">gain_applied</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Previous policy was always to apply gains</span>
</span><span id="Scan-679"><a href="#Scan-679"><span class="linenos">679</span></a>        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">BZSCANNER_CHANNEL_MAP</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="Scan-680"><a href="#Scan-680"><span class="linenos">680</span></a>            <span class="n">channel_settings</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span><span id="Scan-681"><a href="#Scan-681"><span class="linenos">681</span></a>            <span class="k">if</span> <span class="n">channel_settings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
</span><span id="Scan-682"><a href="#Scan-682"><span class="linenos">682</span></a>                <span class="k">continue</span>
</span><span id="Scan-683"><a href="#Scan-683"><span class="linenos">683</span></a>            <span class="n">scan</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="Scan-684"><a href="#Scan-684"><span class="linenos">684</span></a>                <span class="bp">cls</span><span class="o">.</span><span class="n">Channel</span><span class="p">(</span>
</span><span id="Scan-685"><a href="#Scan-685"><span class="linenos">685</span></a>                    <span class="n">name</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">BZSCANNER_CHANNEL_MAP</span><span class="p">[</span><span class="n">channel</span><span class="p">],</span>
</span><span id="Scan-686"><a href="#Scan-686"><span class="linenos">686</span></a>                    <span class="n">exposure_ms</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">channel_settings</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="Scan-687"><a href="#Scan-687"><span class="linenos">687</span></a>                    <span class="n">intensity</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">channel_settings</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="Scan-688"><a href="#Scan-688"><span class="linenos">688</span></a>                    <span class="n">gain_applied</span><span class="o">=</span><span class="n">gain_applied</span><span class="p">,</span>
</span><span id="Scan-689"><a href="#Scan-689"><span class="linenos">689</span></a>                <span class="p">)</span>
</span><span id="Scan-690"><a href="#Scan-690"><span class="linenos">690</span></a>            <span class="p">)</span>
</span><span id="Scan-691"><a href="#Scan-691"><span class="linenos">691</span></a>
</span><span id="Scan-692"><a href="#Scan-692"><span class="linenos">692</span></a>        <span class="c1"># Get focus points</span>
</span><span id="Scan-693"><a href="#Scan-693"><span class="linenos">693</span></a>        <span class="n">focus_points</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scan-694"><a href="#Scan-694"><span class="linenos">694</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">33</span><span class="p">):</span>
</span><span id="Scan-695"><a href="#Scan-695"><span class="linenos">695</span></a>            <span class="n">focus_point</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;FOCUSPOS&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span><span id="Scan-696"><a href="#Scan-696"><span class="linenos">696</span></a>            <span class="k">if</span> <span class="n">focus_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
</span><span id="Scan-697"><a href="#Scan-697"><span class="linenos">697</span></a>                <span class="k">break</span>
</span><span id="Scan-698"><a href="#Scan-698"><span class="linenos">698</span></a>            <span class="n">focus_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="Scan-699"><a href="#Scan-699"><span class="linenos">699</span></a>                <span class="p">[</span>
</span><span id="Scan-700"><a href="#Scan-700"><span class="linenos">700</span></a>                    <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">focus_point</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
</span><span id="Scan-701"><a href="#Scan-701"><span class="linenos">701</span></a>                    <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">focus_point</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span>
</span><span id="Scan-702"><a href="#Scan-702"><span class="linenos">702</span></a>                    <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">focus_point</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
</span><span id="Scan-703"><a href="#Scan-703"><span class="linenos">703</span></a>                <span class="p">]</span>
</span><span id="Scan-704"><a href="#Scan-704"><span class="linenos">704</span></a>            <span class="p">)</span>
</span><span id="Scan-705"><a href="#Scan-705"><span class="linenos">705</span></a>
</span><span id="Scan-706"><a href="#Scan-706"><span class="linenos">706</span></a>        <span class="c1"># In the BZScanner, the slide is vertical instead of horizontal</span>
</span><span id="Scan-707"><a href="#Scan-707"><span class="linenos">707</span></a>        <span class="c1"># We put in nominal values for the ROI, which is oriented vertically as well</span>
</span><span id="Scan-708"><a href="#Scan-708"><span class="linenos">708</span></a>        <span class="n">tile_rows</span> <span class="o">=</span> <span class="mi">96</span>
</span><span id="Scan-709"><a href="#Scan-709"><span class="linenos">709</span></a>        <span class="n">tile_cols</span> <span class="o">=</span> <span class="mi">24</span>
</span><span id="Scan-710"><a href="#Scan-710"><span class="linenos">710</span></a>        <span class="n">roi_width</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span> <span class="o">*</span> <span class="n">scan</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">*</span> <span class="n">tile_cols</span><span class="p">)</span>
</span><span id="Scan-711"><a href="#Scan-711"><span class="linenos">711</span></a>        <span class="n">roi_height</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span> <span class="o">*</span> <span class="n">scan</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">*</span> <span class="n">tile_rows</span><span class="p">)</span>
</span><span id="Scan-712"><a href="#Scan-712"><span class="linenos">712</span></a>        <span class="n">origin_x_um</span> <span class="o">=</span> <span class="mi">2500</span> <span class="o">+</span> <span class="nb">round</span><span class="p">((</span><span class="mi">20000</span> <span class="o">-</span> <span class="n">roi_width</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="Scan-713"><a href="#Scan-713"><span class="linenos">713</span></a>        <span class="n">origin_y_um</span> <span class="o">=</span> <span class="mi">2500</span> <span class="o">+</span> <span class="nb">round</span><span class="p">((</span><span class="mi">58000</span> <span class="o">-</span> <span class="n">roi_height</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="Scan-714"><a href="#Scan-714"><span class="linenos">714</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="Scan-715"><a href="#Scan-715"><span class="linenos">715</span></a>            <span class="bp">cls</span><span class="o">.</span><span class="n">ROI</span><span class="p">(</span>
</span><span id="Scan-716"><a href="#Scan-716"><span class="linenos">716</span></a>                <span class="n">origin_x_um</span><span class="o">=</span><span class="n">origin_x_um</span><span class="p">,</span>
</span><span id="Scan-717"><a href="#Scan-717"><span class="linenos">717</span></a>                <span class="n">origin_y_um</span><span class="o">=</span><span class="n">origin_y_um</span><span class="p">,</span>
</span><span id="Scan-718"><a href="#Scan-718"><span class="linenos">718</span></a>                <span class="n">width_um</span><span class="o">=</span><span class="n">roi_width</span><span class="p">,</span>
</span><span id="Scan-719"><a href="#Scan-719"><span class="linenos">719</span></a>                <span class="n">height_um</span><span class="o">=</span><span class="n">roi_height</span><span class="p">,</span>
</span><span id="Scan-720"><a href="#Scan-720"><span class="linenos">720</span></a>                <span class="n">tile_rows</span><span class="o">=</span><span class="n">tile_rows</span><span class="p">,</span>
</span><span id="Scan-721"><a href="#Scan-721"><span class="linenos">721</span></a>                <span class="n">tile_cols</span><span class="o">=</span><span class="n">tile_cols</span><span class="p">,</span>
</span><span id="Scan-722"><a href="#Scan-722"><span class="linenos">722</span></a>                <span class="n">focus_points</span><span class="o">=</span><span class="n">focus_points</span><span class="p">,</span>
</span><span id="Scan-723"><a href="#Scan-723"><span class="linenos">723</span></a>            <span class="p">)</span>
</span><span id="Scan-724"><a href="#Scan-724"><span class="linenos">724</span></a>        <span class="p">)</span>
</span><span id="Scan-725"><a href="#Scan-725"><span class="linenos">725</span></a>        <span class="k">return</span> <span class="n">scan</span>
</span><span id="Scan-726"><a href="#Scan-726"><span class="linenos">726</span></a>
</span><span id="Scan-727"><a href="#Scan-727"><span class="linenos">727</span></a>    <span class="nd">@classmethod</span>
</span><span id="Scan-728"><a href="#Scan-728"><span class="linenos">728</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_from_folder</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="Scan-729"><a href="#Scan-729"><span class="linenos">729</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan-730"><a href="#Scan-730"><span class="linenos">730</span></a><span class="sd">        Load a Scan object from a folder that contains defaultly-named metadata files,</span>
</span><span id="Scan-731"><a href="#Scan-731"><span class="linenos">731</span></a><span class="sd">        scan.yaml or slideinfo.txt. Prefers scan.yaml if both exist</span>
</span><span id="Scan-732"><a href="#Scan-732"><span class="linenos">732</span></a><span class="sd">        :param input_path: /path/to/folder</span>
</span><span id="Scan-733"><a href="#Scan-733"><span class="linenos">733</span></a><span class="sd">        :return: a Scan object</span>
</span><span id="Scan-734"><a href="#Scan-734"><span class="linenos">734</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan-735"><a href="#Scan-735"><span class="linenos">735</span></a>        <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="Scan-736"><a href="#Scan-736"><span class="linenos">736</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span>
</span><span id="Scan-737"><a href="#Scan-737"><span class="linenos">737</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">METADATA_FILE_NAME</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">])</span>
</span><span id="Scan-738"><a href="#Scan-738"><span class="linenos">738</span></a>        <span class="p">):</span>
</span><span id="Scan-739"><a href="#Scan-739"><span class="linenos">739</span></a>            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">load_yaml</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="Scan-740"><a href="#Scan-740"><span class="linenos">740</span></a>        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span>
</span><span id="Scan-741"><a href="#Scan-741"><span class="linenos">741</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">METADATA_FILE_NAME</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">])</span>
</span><span id="Scan-742"><a href="#Scan-742"><span class="linenos">742</span></a>        <span class="p">):</span>
</span><span id="Scan-743"><a href="#Scan-743"><span class="linenos">743</span></a>            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">load_txt</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="Scan-744"><a href="#Scan-744"><span class="linenos">744</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Scan-745"><a href="#Scan-745"><span class="linenos">745</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Scan-746"><a href="#Scan-746"><span class="linenos">746</span></a>                <span class="sa">f</span><span class="s2">&quot;No scan metadata files &quot;</span>
</span><span id="Scan-747"><a href="#Scan-747"><span class="linenos">747</span></a>                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">METADATA_FILE_NAME</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="Scan-748"><a href="#Scan-748"><span class="linenos">748</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">METADATA_FILE_NAME</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">]</span><span class="si">}</span><span class="s2">) found in folder &quot;</span>
</span><span id="Scan-749"><a href="#Scan-749"><span class="linenos">749</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Scan-750"><a href="#Scan-750"><span class="linenos">750</span></a>            <span class="p">)</span>
</span><span id="Scan-751"><a href="#Scan-751"><span class="linenos">751</span></a>        <span class="k">pass</span>
</span><span id="Scan-752"><a href="#Scan-752"><span class="linenos">752</span></a>
</span><span id="Scan-753"><a href="#Scan-753"><span class="linenos">753</span></a>    <span class="nd">@classmethod</span>
</span><span id="Scan-754"><a href="#Scan-754"><span class="linenos">754</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">make_placeholder</span><span class="p">(</span>
</span><span id="Scan-755"><a href="#Scan-755"><span class="linenos">755</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="Scan-756"><a href="#Scan-756"><span class="linenos">756</span></a>        <span class="n">slide_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Scan-757"><a href="#Scan-757"><span class="linenos">757</span></a>        <span class="n">n_tile</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2303</span><span class="p">,</span>
</span><span id="Scan-758"><a href="#Scan-758"><span class="linenos">758</span></a>        <span class="n">n_roi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Scan-759"><a href="#Scan-759"><span class="linenos">759</span></a>        <span class="n">scanner_type</span><span class="p">:</span> <span class="n">Type</span> <span class="o">=</span> <span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">,</span>
</span><span id="Scan-760"><a href="#Scan-760"><span class="linenos">760</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="Scan-761"><a href="#Scan-761"><span class="linenos">761</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan-762"><a href="#Scan-762"><span class="linenos">762</span></a><span class="sd">        Make a placeholder Scan object with only basic required information filled in.</span>
</span><span id="Scan-763"><a href="#Scan-763"><span class="linenos">763</span></a><span class="sd">        :param slide_id: the slide ID</span>
</span><span id="Scan-764"><a href="#Scan-764"><span class="linenos">764</span></a><span class="sd">        :param n_tile: the number of this tile, which will become the number of</span>
</span><span id="Scan-765"><a href="#Scan-765"><span class="linenos">765</span></a><span class="sd">                       tiles in the scan</span>
</span><span id="Scan-766"><a href="#Scan-766"><span class="linenos">766</span></a><span class="sd">        :param n_roi: the number of ROIs in the scan</span>
</span><span id="Scan-767"><a href="#Scan-767"><span class="linenos">767</span></a><span class="sd">        :return: a Scan object</span>
</span><span id="Scan-768"><a href="#Scan-768"><span class="linenos">768</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan-769"><a href="#Scan-769"><span class="linenos">769</span></a>        <span class="c1"># Sanitize inputs here</span>
</span><span id="Scan-770"><a href="#Scan-770"><span class="linenos">770</span></a>        <span class="n">slide_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">slide_id</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="Scan-771"><a href="#Scan-771"><span class="linenos">771</span></a>        <span class="n">n_tile</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_tile</span><span class="p">)</span>
</span><span id="Scan-772"><a href="#Scan-772"><span class="linenos">772</span></a>        <span class="n">n_roi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_roi</span><span class="p">)</span>
</span><span id="Scan-773"><a href="#Scan-773"><span class="linenos">773</span></a>        <span class="c1"># Generate the object</span>
</span><span id="Scan-774"><a href="#Scan-774"><span class="linenos">774</span></a>        <span class="n">scan</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
</span><span id="Scan-775"><a href="#Scan-775"><span class="linenos">775</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="o">=</span> <span class="n">slide_id</span>
</span><span id="Scan-776"><a href="#Scan-776"><span class="linenos">776</span></a>        <span class="k">if</span> <span class="n">scanner_type</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">:</span>
</span><span id="Scan-777"><a href="#Scan-777"><span class="linenos">777</span></a>            <span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">_placeholder&quot;</span>
</span><span id="Scan-778"><a href="#Scan-778"><span class="linenos">778</span></a>        <span class="k">elif</span> <span class="n">scanner_type</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">:</span>
</span><span id="Scan-779"><a href="#Scan-779"><span class="linenos">779</span></a>            <span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">_placeholder&quot;</span>
</span><span id="Scan-780"><a href="#Scan-780"><span class="linenos">780</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">ROI</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_roi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
</span><span id="Scan-781"><a href="#Scan-781"><span class="linenos">781</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tile_rows</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Scan-782"><a href="#Scan-782"><span class="linenos">782</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tile_cols</span> <span class="o">=</span> <span class="n">n_tile</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="Scan-783"><a href="#Scan-783"><span class="linenos">783</span></a>        <span class="k">return</span> <span class="n">scan</span>
</span></pre></div>


            <div class="docstring"><p>Class that composes a whole scan's metadata. Contains some universal data,
plus lists for channels and ROIs.</p>

<h1 id="scans-scanners">Scans &amp; Scanners</h1>

<p>Scans are the highest-level data structure, indicating the key parameters of a scan such
as the area scanned, the dimensions of output images, and the channels used. Scans also
include metadata such as the scanner ID, slide ID, where the images should be, etc.</p>

<h2 id="coordinate-frames">Coordinate Frames</h2>

<p>There are three levels of coordinate frames in a scan. From inside-out, we have:</p>

<ul>
<li><strong>Tile</strong> coordinate frame. Events are provided with simple integer (x, y) pixel
coordinates, which makes it easy to crop and manipulate images. The origin is at the
top-left corner as with normal image axes.</li>
<li><strong>Scan</strong> coordinate frame. Each scanner has its own coordinate frame, which is
determined by the scanner's hardware. The scanner coordinate frame is used to convert
between in-frame pixel coordinates and micrometers. The origin varies by the scanner,
but generally resides in the top-left of the scanner's movable stage. In cases where
there are multiple slide slots, the origin is assumed to be at the top left of the
current slide. The slide may be oriented horizontally, vertically, or upside-down;
this all depends on the scanner.</li>
<li><strong>Slide</strong> coordinate frame. This is a set coordinate frame where:
<ul>
<li>Slide is active area <strong>up</strong>.</li>
<li>Slide is oriented <strong>horizontally</strong>.</li>
<li>Slide label area is on the <strong>left</strong>.</li>
<li>Origin is at the <strong>top-left</strong> corner.</li>
</ul></li>
</ul>

<p>Generally speaking, we should always compare scanners by converting them to the slide
coordinate frame. Events in the scan and slide coordinate frame are referred to in
micrometers ($\mu$m).</p>

<p><img src="bzscanner.png" alt="Diagram of the BZScanner coordinate system, which uses a vertical slide alignment with
the label at the bottom. The slide is active area down and tiles zigzag from the
top-left corner across and back. The x-axis points right, the y-axis points
down, and the origin is in the top-left corner. " title="BZScanner Coordinates" /></p>

<p><img src="axioscan.png" alt="Diagram of the Axioscan coordinate system, which uses a horizontal slide alignment
the label on the left. The slide is active area up and tiles go across in row-major
order from the top-left corner. The x-axis points right, and the y-axis points
down, but the origin is in the top-right corner." title="Axioscan Coordinates" /></p>

<p><img src="slide.png" alt="Diagram of the slide coordinate system, which uses a horizontal slide alignment
the label on the left. The slide is active area up. The x-axis points right, the y-axis
points down, and the origin is in the top-left corner." title="Slide Coordinates" /></p>
</div>


                            <div id="Scan.__init__" class="classattr">
                                        <input id="Scan.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Scan</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">slide_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">scanner_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">exists</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">start_datetime</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">end_datetime</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">scan_time_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>,</span><span class="param">	<span class="n">tray_pos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>,</span><span class="param">	<span class="n">slide_pos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>,</span><span class="param">	<span class="n">camera</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">objective</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">pixel_size_um</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>,</span><span class="param">	<span class="n">tile_width_px</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>,</span><span class="param">	<span class="n">tile_height_px</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>,</span><span class="param">	<span class="n">tile_x_offset_px</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>,</span><span class="param">	<span class="n">tile_y_offset_px</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>,</span><span class="param">	<span class="n">tile_overlap_proportion</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>,</span><span class="param">	<span class="n">channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="#Scan.Channel">Scan.Channel</a></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">roi</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="#Scan.ROI">Scan.ROI</a></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="Scan.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scan.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scan.__init__-132"><a href="#Scan.__init__-132"><span class="linenos">132</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="Scan.__init__-133"><a href="#Scan.__init__-133"><span class="linenos">133</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Scan.__init__-134"><a href="#Scan.__init__-134"><span class="linenos">134</span></a>        <span class="n">slide_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Scan.__init__-135"><a href="#Scan.__init__-135"><span class="linenos">135</span></a>        <span class="n">scanner_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Scan.__init__-136"><a href="#Scan.__init__-136"><span class="linenos">136</span></a>        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Scan.__init__-137"><a href="#Scan.__init__-137"><span class="linenos">137</span></a>        <span class="n">exists</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Scan.__init__-138"><a href="#Scan.__init__-138"><span class="linenos">138</span></a>        <span class="n">start_datetime</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Scan.__init__-139"><a href="#Scan.__init__-139"><span class="linenos">139</span></a>        <span class="n">end_datetime</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Scan.__init__-140"><a href="#Scan.__init__-140"><span class="linenos">140</span></a>        <span class="n">scan_time_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan.__init__-141"><a href="#Scan.__init__-141"><span class="linenos">141</span></a>        <span class="n">tray_pos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan.__init__-142"><a href="#Scan.__init__-142"><span class="linenos">142</span></a>        <span class="n">slide_pos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan.__init__-143"><a href="#Scan.__init__-143"><span class="linenos">143</span></a>        <span class="n">camera</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Scan.__init__-144"><a href="#Scan.__init__-144"><span class="linenos">144</span></a>        <span class="n">objective</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Scan.__init__-145"><a href="#Scan.__init__-145"><span class="linenos">145</span></a>        <span class="n">pixel_size_um</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="Scan.__init__-146"><a href="#Scan.__init__-146"><span class="linenos">146</span></a>        <span class="n">tile_width_px</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan.__init__-147"><a href="#Scan.__init__-147"><span class="linenos">147</span></a>        <span class="n">tile_height_px</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan.__init__-148"><a href="#Scan.__init__-148"><span class="linenos">148</span></a>        <span class="n">tile_x_offset_px</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan.__init__-149"><a href="#Scan.__init__-149"><span class="linenos">149</span></a>        <span class="n">tile_y_offset_px</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan.__init__-150"><a href="#Scan.__init__-150"><span class="linenos">150</span></a>        <span class="n">tile_overlap_proportion</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan.__init__-151"><a href="#Scan.__init__-151"><span class="linenos">151</span></a>        <span class="n">channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Channel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Scan.__init__-152"><a href="#Scan.__init__-152"><span class="linenos">152</span></a>        <span class="n">roi</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ROI</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Scan.__init__-153"><a href="#Scan.__init__-153"><span class="linenos">153</span></a>    <span class="p">):</span>
</span><span id="Scan.__init__-154"><a href="#Scan.__init__-154"><span class="linenos">154</span></a>        <span class="k">if</span> <span class="n">roi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scan.__init__-155"><a href="#Scan.__init__-155"><span class="linenos">155</span></a>            <span class="n">roi</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scan.__init__-156"><a href="#Scan.__init__-156"><span class="linenos">156</span></a>        <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scan.__init__-157"><a href="#Scan.__init__-157"><span class="linenos">157</span></a>            <span class="n">channels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scan.__init__-158"><a href="#Scan.__init__-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slide_id</span> <span class="o">=</span> <span class="n">slide_id</span>
</span><span id="Scan.__init__-159"><a href="#Scan.__init__-159"><span class="linenos">159</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scanner_id</span> <span class="o">=</span> <span class="n">scanner_id</span>
</span><span id="Scan.__init__-160"><a href="#Scan.__init__-160"><span class="linenos">160</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
</span><span id="Scan.__init__-161"><a href="#Scan.__init__-161"><span class="linenos">161</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exists</span> <span class="o">=</span> <span class="n">exists</span>
</span><span id="Scan.__init__-162"><a href="#Scan.__init__-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start_datetime</span> <span class="o">=</span> <span class="n">start_datetime</span>
</span><span id="Scan.__init__-163"><a href="#Scan.__init__-163"><span class="linenos">163</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">end_datetime</span> <span class="o">=</span> <span class="n">end_datetime</span>
</span><span id="Scan.__init__-164"><a href="#Scan.__init__-164"><span class="linenos">164</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scan_time_s</span> <span class="o">=</span> <span class="n">scan_time_s</span>
</span><span id="Scan.__init__-165"><a href="#Scan.__init__-165"><span class="linenos">165</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tray_pos</span> <span class="o">=</span> <span class="n">tray_pos</span>
</span><span id="Scan.__init__-166"><a href="#Scan.__init__-166"><span class="linenos">166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slide_pos</span> <span class="o">=</span> <span class="n">slide_pos</span>
</span><span id="Scan.__init__-167"><a href="#Scan.__init__-167"><span class="linenos">167</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="n">camera</span>
</span><span id="Scan.__init__-168"><a href="#Scan.__init__-168"><span class="linenos">168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">objective</span> <span class="o">=</span> <span class="n">objective</span>
</span><span id="Scan.__init__-169"><a href="#Scan.__init__-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size_um</span> <span class="o">=</span> <span class="n">pixel_size_um</span>
</span><span id="Scan.__init__-170"><a href="#Scan.__init__-170"><span class="linenos">170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">=</span> <span class="n">tile_width_px</span>
</span><span id="Scan.__init__-171"><a href="#Scan.__init__-171"><span class="linenos">171</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">=</span> <span class="n">tile_height_px</span>
</span><span id="Scan.__init__-172"><a href="#Scan.__init__-172"><span class="linenos">172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_x_offset_px</span> <span class="o">=</span> <span class="n">tile_x_offset_px</span>
</span><span id="Scan.__init__-173"><a href="#Scan.__init__-173"><span class="linenos">173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_y_offset_px</span> <span class="o">=</span> <span class="n">tile_y_offset_px</span>
</span><span id="Scan.__init__-174"><a href="#Scan.__init__-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_overlap_proportion</span> <span class="o">=</span> <span class="n">tile_overlap_proportion</span>
</span><span id="Scan.__init__-175"><a href="#Scan.__init__-175"><span class="linenos">175</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span>
</span><span id="Scan.__init__-176"><a href="#Scan.__init__-176"><span class="linenos">176</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="n">roi</span>
</span></pre></div>


    

                            </div>
                            <div id="Scan.yaml_tag" class="classattr">
                                <div class="attr variable">
            <span class="name">yaml_tag</span>        =
<span class="default_value">&#39;<a href="#Scan">Scan</a>&#39;</span>

        
    </div>
    <a class="headerlink" href="#Scan.yaml_tag"></a>
    
    

                            </div>
                            <div id="Scan.SCANNER_IDS" class="classattr">
                                <div class="attr variable">
            <span class="name">SCANNER_IDS</span>        =
<span class="default_value">{&#39;4661000426&#39;: &#39;axioscan7_0&#39;}</span>

        
    </div>
    <a class="headerlink" href="#Scan.SCANNER_IDS"></a>
    
            <div class="docstring"><p>Axioscan 7 scanner IDs (service number), mapped to our scanner IDs</p>
</div>


                            </div>
                            <div id="Scan.METADATA_FILE_NAME" class="classattr">
                                <div class="attr variable">
            <span class="name">METADATA_FILE_NAME</span>        =
<span class="default_value">{&lt;Type.AXIOSCAN7: &#39;axioscan7&#39;&gt;: &#39;scan.yaml&#39;, &lt;Type.BZSCANNER: &#39;bzscanner&#39;&gt;: &#39;slideinfo.txt&#39;}</span>

        
    </div>
    <a class="headerlink" href="#Scan.METADATA_FILE_NAME"></a>
    
    

                            </div>
                            <div id="Scan.STANDARD_DATETIME_FORMAT" class="classattr">
                                <div class="attr variable">
            <span class="name">STANDARD_DATETIME_FORMAT</span>        =
<span class="default_value">&#39;%Y-%m-%dT%H:%M:%S%z&#39;</span>

        
    </div>
    <a class="headerlink" href="#Scan.STANDARD_DATETIME_FORMAT"></a>
    
    

                            </div>
                            <div id="Scan.DATETIME_FORMAT" class="classattr">
                                <div class="attr variable">
            <span class="name">DATETIME_FORMAT</span>        =
<input id="Scan.DATETIME_FORMAT-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="Scan.DATETIME_FORMAT-view-value"></label><span class="default_value">{&lt;Type.AXIOSCAN7: &#39;axioscan7&#39;&gt;: &#39;%Y-%m-%dT%H:%M:%S%z&#39;, &lt;Type.BZSCANNER: &#39;bzscanner&#39;&gt;: &#39;%a %b %d %H:%M:%S %Y&#39;}</span>

        
    </div>
    <a class="headerlink" href="#Scan.DATETIME_FORMAT"></a>
    
    

                            </div>
                            <div id="Scan.BZSCANNER_CHANNEL_MAP" class="classattr">
                                <div class="attr variable">
            <span class="name">BZSCANNER_CHANNEL_MAP</span>        =
<span class="default_value">{&#39;DAPI&#39;: &#39;DAPI&#39;, &#39;TRITC&#39;: &#39;AF555&#39;, &#39;CY5&#39;: &#39;AF647&#39;, &#39;BF&#39;: &#39;BRIGHT&#39;, &#39;FITC&#39;: &#39;AF488&#39;}</span>

        
    </div>
    <a class="headerlink" href="#Scan.BZSCANNER_CHANNEL_MAP"></a>
    
    

                            </div>
                            <div id="Scan.slide_id" class="classattr">
                                <div class="attr variable">
            <span class="name">slide_id</span>

        
    </div>
    <a class="headerlink" href="#Scan.slide_id"></a>
    
    

                            </div>
                            <div id="Scan.scanner_id" class="classattr">
                                <div class="attr variable">
            <span class="name">scanner_id</span>

        
    </div>
    <a class="headerlink" href="#Scan.scanner_id"></a>
    
    

                            </div>
                            <div id="Scan.path" class="classattr">
                                <div class="attr variable">
            <span class="name">path</span>

        
    </div>
    <a class="headerlink" href="#Scan.path"></a>
    
    

                            </div>
                            <div id="Scan.exists" class="classattr">
                                <div class="attr variable">
            <span class="name">exists</span>

        
    </div>
    <a class="headerlink" href="#Scan.exists"></a>
    
    

                            </div>
                            <div id="Scan.start_datetime" class="classattr">
                                <div class="attr variable">
            <span class="name">start_datetime</span>

        
    </div>
    <a class="headerlink" href="#Scan.start_datetime"></a>
    
    

                            </div>
                            <div id="Scan.end_datetime" class="classattr">
                                <div class="attr variable">
            <span class="name">end_datetime</span>

        
    </div>
    <a class="headerlink" href="#Scan.end_datetime"></a>
    
    

                            </div>
                            <div id="Scan.scan_time_s" class="classattr">
                                <div class="attr variable">
            <span class="name">scan_time_s</span>

        
    </div>
    <a class="headerlink" href="#Scan.scan_time_s"></a>
    
    

                            </div>
                            <div id="Scan.tray_pos" class="classattr">
                                <div class="attr variable">
            <span class="name">tray_pos</span>

        
    </div>
    <a class="headerlink" href="#Scan.tray_pos"></a>
    
    

                            </div>
                            <div id="Scan.slide_pos" class="classattr">
                                <div class="attr variable">
            <span class="name">slide_pos</span>

        
    </div>
    <a class="headerlink" href="#Scan.slide_pos"></a>
    
    

                            </div>
                            <div id="Scan.camera" class="classattr">
                                <div class="attr variable">
            <span class="name">camera</span>

        
    </div>
    <a class="headerlink" href="#Scan.camera"></a>
    
    

                            </div>
                            <div id="Scan.objective" class="classattr">
                                <div class="attr variable">
            <span class="name">objective</span>

        
    </div>
    <a class="headerlink" href="#Scan.objective"></a>
    
    

                            </div>
                            <div id="Scan.pixel_size_um" class="classattr">
                                <div class="attr variable">
            <span class="name">pixel_size_um</span>

        
    </div>
    <a class="headerlink" href="#Scan.pixel_size_um"></a>
    
    

                            </div>
                            <div id="Scan.tile_width_px" class="classattr">
                                <div class="attr variable">
            <span class="name">tile_width_px</span>

        
    </div>
    <a class="headerlink" href="#Scan.tile_width_px"></a>
    
    

                            </div>
                            <div id="Scan.tile_height_px" class="classattr">
                                <div class="attr variable">
            <span class="name">tile_height_px</span>

        
    </div>
    <a class="headerlink" href="#Scan.tile_height_px"></a>
    
    

                            </div>
                            <div id="Scan.tile_x_offset_px" class="classattr">
                                <div class="attr variable">
            <span class="name">tile_x_offset_px</span>

        
    </div>
    <a class="headerlink" href="#Scan.tile_x_offset_px"></a>
    
    

                            </div>
                            <div id="Scan.tile_y_offset_px" class="classattr">
                                <div class="attr variable">
            <span class="name">tile_y_offset_px</span>

        
    </div>
    <a class="headerlink" href="#Scan.tile_y_offset_px"></a>
    
    

                            </div>
                            <div id="Scan.tile_overlap_proportion" class="classattr">
                                <div class="attr variable">
            <span class="name">tile_overlap_proportion</span>

        
    </div>
    <a class="headerlink" href="#Scan.tile_overlap_proportion"></a>
    
    

                            </div>
                            <div id="Scan.channels" class="classattr">
                                <div class="attr variable">
            <span class="name">channels</span>

        
    </div>
    <a class="headerlink" href="#Scan.channels"></a>
    
    

                            </div>
                            <div id="Scan.roi" class="classattr">
                                <div class="attr variable">
            <span class="name">roi</span>

        
    </div>
    <a class="headerlink" href="#Scan.roi"></a>
    
    

                            </div>
                            <div id="Scan.has_same_profile" class="classattr">
                                        <input id="Scan.has_same_profile-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">has_same_profile</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">other</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Scan.has_same_profile-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scan.has_same_profile"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scan.has_same_profile-208"><a href="#Scan.has_same_profile-208"><span class="linenos">208</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">has_same_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="Scan.has_same_profile-209"><a href="#Scan.has_same_profile-209"><span class="linenos">209</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="Scan.has_same_profile-210"><a href="#Scan.has_same_profile-210"><span class="linenos">210</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">camera</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">camera</span>
</span><span id="Scan.has_same_profile-211"><a href="#Scan.has_same_profile-211"><span class="linenos">211</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">objective</span>
</span><span id="Scan.has_same_profile-212"><a href="#Scan.has_same_profile-212"><span class="linenos">212</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size_um</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">pixel_size_um</span>
</span><span id="Scan.has_same_profile-213"><a href="#Scan.has_same_profile-213"><span class="linenos">213</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_width_px</span>
</span><span id="Scan.has_same_profile-214"><a href="#Scan.has_same_profile-214"><span class="linenos">214</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_height_px</span>
</span><span id="Scan.has_same_profile-215"><a href="#Scan.has_same_profile-215"><span class="linenos">215</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_x_offset_px</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_x_offset_px</span>
</span><span id="Scan.has_same_profile-216"><a href="#Scan.has_same_profile-216"><span class="linenos">216</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_y_offset_px</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_y_offset_px</span>
</span><span id="Scan.has_same_profile-217"><a href="#Scan.has_same_profile-217"><span class="linenos">217</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_overlap_proportion</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_overlap_proportion</span>
</span><span id="Scan.has_same_profile-218"><a href="#Scan.has_same_profile-218"><span class="linenos">218</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">channels</span>
</span><span id="Scan.has_same_profile-219"><a href="#Scan.has_same_profile-219"><span class="linenos">219</span></a>            <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">similar</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">roi</span><span class="p">))</span>
</span><span id="Scan.has_same_profile-220"><a href="#Scan.has_same_profile-220"><span class="linenos">220</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="Scan.get_channel_names" class="classattr">
                                        <input id="Scan.get_channel_names-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_channel_names</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Scan.get_channel_names-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scan.get_channel_names"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scan.get_channel_names-222"><a href="#Scan.get_channel_names-222"><span class="linenos">222</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_channel_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="Scan.get_channel_names-223"><a href="#Scan.get_channel_names-223"><span class="linenos">223</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan.get_channel_names-224"><a href="#Scan.get_channel_names-224"><span class="linenos">224</span></a><span class="sd">        Get the channel names in the scan&#39;s channel order.</span>
</span><span id="Scan.get_channel_names-225"><a href="#Scan.get_channel_names-225"><span class="linenos">225</span></a><span class="sd">        :return: a list of channel names.</span>
</span><span id="Scan.get_channel_names-226"><a href="#Scan.get_channel_names-226"><span class="linenos">226</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan.get_channel_names-227"><a href="#Scan.get_channel_names-227"><span class="linenos">227</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Get the channel names in the scan's channel order.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a list of channel names.</p>
</blockquote>
</div>


                            </div>
                            <div id="Scan.get_channel_indices" class="classattr">
                                        <input id="Scan.get_channel_indices-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_channel_indices</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">channel_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Scan.get_channel_indices-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scan.get_channel_indices"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scan.get_channel_indices-229"><a href="#Scan.get_channel_indices-229"><span class="linenos">229</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_channel_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="Scan.get_channel_indices-230"><a href="#Scan.get_channel_indices-230"><span class="linenos">230</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan.get_channel_indices-231"><a href="#Scan.get_channel_indices-231"><span class="linenos">231</span></a><span class="sd">        Given a list of channel names, return the corresponding indices in the scan&#39;s</span>
</span><span id="Scan.get_channel_indices-232"><a href="#Scan.get_channel_indices-232"><span class="linenos">232</span></a><span class="sd">        channel order. Will convert BZScanner channel names (TRITC, CY5, FITC) to the</span>
</span><span id="Scan.get_channel_indices-233"><a href="#Scan.get_channel_indices-233"><span class="linenos">233</span></a><span class="sd">        actual AlexaFluor names (AF555, AF647, AF488).</span>
</span><span id="Scan.get_channel_indices-234"><a href="#Scan.get_channel_indices-234"><span class="linenos">234</span></a><span class="sd">        If a list entry is not found or None, it will return -1 for that entry.</span>
</span><span id="Scan.get_channel_indices-235"><a href="#Scan.get_channel_indices-235"><span class="linenos">235</span></a><span class="sd">        :param channel_names: a list of channel names.</span>
</span><span id="Scan.get_channel_indices-236"><a href="#Scan.get_channel_indices-236"><span class="linenos">236</span></a><span class="sd">        :return: a list of channel indices.</span>
</span><span id="Scan.get_channel_indices-237"><a href="#Scan.get_channel_indices-237"><span class="linenos">237</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan.get_channel_indices-238"><a href="#Scan.get_channel_indices-238"><span class="linenos">238</span></a>        <span class="c1"># Get the scan&#39;s channel name list</span>
</span><span id="Scan.get_channel_indices-239"><a href="#Scan.get_channel_indices-239"><span class="linenos">239</span></a>        <span class="n">scan_channel_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_channel_names</span><span class="p">()</span>
</span><span id="Scan.get_channel_indices-240"><a href="#Scan.get_channel_indices-240"><span class="linenos">240</span></a>
</span><span id="Scan.get_channel_indices-241"><a href="#Scan.get_channel_indices-241"><span class="linenos">241</span></a>        <span class="n">channel_indices</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scan.get_channel_indices-242"><a href="#Scan.get_channel_indices-242"><span class="linenos">242</span></a>        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">channel_names</span><span class="p">:</span>
</span><span id="Scan.get_channel_indices-243"><a href="#Scan.get_channel_indices-243"><span class="linenos">243</span></a>            <span class="c1"># Convert any BZScanner channel names to the actual channel names</span>
</span><span id="Scan.get_channel_indices-244"><a href="#Scan.get_channel_indices-244"><span class="linenos">244</span></a>            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BZSCANNER_CHANNEL_MAP</span><span class="p">:</span>
</span><span id="Scan.get_channel_indices-245"><a href="#Scan.get_channel_indices-245"><span class="linenos">245</span></a>                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BZSCANNER_CHANNEL_MAP</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span><span id="Scan.get_channel_indices-246"><a href="#Scan.get_channel_indices-246"><span class="linenos">246</span></a>
</span><span id="Scan.get_channel_indices-247"><a href="#Scan.get_channel_indices-247"><span class="linenos">247</span></a>            <span class="c1"># Append the corresponding index if possible</span>
</span><span id="Scan.get_channel_indices-248"><a href="#Scan.get_channel_indices-248"><span class="linenos">248</span></a>            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">scan_channel_names</span><span class="p">:</span>
</span><span id="Scan.get_channel_indices-249"><a href="#Scan.get_channel_indices-249"><span class="linenos">249</span></a>                <span class="n">channel_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan_channel_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
</span><span id="Scan.get_channel_indices-250"><a href="#Scan.get_channel_indices-250"><span class="linenos">250</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Scan.get_channel_indices-251"><a href="#Scan.get_channel_indices-251"><span class="linenos">251</span></a>                <span class="n">channel_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Scan.get_channel_indices-252"><a href="#Scan.get_channel_indices-252"><span class="linenos">252</span></a>        <span class="k">return</span> <span class="n">channel_indices</span>
</span></pre></div>


            <div class="docstring"><p>Given a list of channel names, return the corresponding indices in the scan's
channel order. Will convert BZScanner channel names (TRITC, CY5, FITC) to the
actual AlexaFluor names (AF555, AF647, AF488).
If a list entry is not found or None, it will return -1 for that entry.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>channel_names</strong>:  a list of channel names.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a list of channel indices.</p>
</blockquote>
</div>


                            </div>
                            <div id="Scan.get_image_size" class="classattr">
                                        <input id="Scan.get_image_size-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_image_size</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Scan.get_image_size-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scan.get_image_size"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scan.get_image_size-254"><a href="#Scan.get_image_size-254"><span class="linenos">254</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_image_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
</span><span id="Scan.get_image_size-255"><a href="#Scan.get_image_size-255"><span class="linenos">255</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan.get_image_size-256"><a href="#Scan.get_image_size-256"><span class="linenos">256</span></a><span class="sd">        Get the real size of the image in pixels after subtracting overlap.</span>
</span><span id="Scan.get_image_size-257"><a href="#Scan.get_image_size-257"><span class="linenos">257</span></a><span class="sd">        :return: a tuple of (real_height, real_width) for easy comparison to arrays</span>
</span><span id="Scan.get_image_size-258"><a href="#Scan.get_image_size-258"><span class="linenos">258</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan.get_image_size-259"><a href="#Scan.get_image_size-259"><span class="linenos">259</span></a>        <span class="n">width_overlap</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_overlap_proportion</span><span class="p">)</span>
</span><span id="Scan.get_image_size-260"><a href="#Scan.get_image_size-260"><span class="linenos">260</span></a>        <span class="n">height_overlap</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_overlap_proportion</span><span class="p">)</span>
</span><span id="Scan.get_image_size-261"><a href="#Scan.get_image_size-261"><span class="linenos">261</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">-</span> <span class="n">height_overlap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">-</span> <span class="n">width_overlap</span>
</span></pre></div>


            <div class="docstring"><p>Get the real size of the image in pixels after subtracting overlap.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a tuple of (real_height, real_width) for easy comparison to arrays</p>
</blockquote>
</div>


                            </div>
                            <div id="Scan.save_yaml" class="classattr">
                                        <input id="Scan.save_yaml-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_yaml</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Scan.save_yaml-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scan.save_yaml"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scan.save_yaml-263"><a href="#Scan.save_yaml-263"><span class="linenos">263</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Scan.save_yaml-264"><a href="#Scan.save_yaml-264"><span class="linenos">264</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan.save_yaml-265"><a href="#Scan.save_yaml-265"><span class="linenos">265</span></a><span class="sd">        Write the Scan object to a .yaml file.</span>
</span><span id="Scan.save_yaml-266"><a href="#Scan.save_yaml-266"><span class="linenos">266</span></a><span class="sd">        :param output_path: /path/to/file.yaml or /path/to/folder to put scan.yaml</span>
</span><span id="Scan.save_yaml-267"><a href="#Scan.save_yaml-267"><span class="linenos">267</span></a><span class="sd">        :return: nothing; will raise an error on failure</span>
</span><span id="Scan.save_yaml-268"><a href="#Scan.save_yaml-268"><span class="linenos">268</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan.save_yaml-269"><a href="#Scan.save_yaml-269"><span class="linenos">269</span></a>        <span class="c1"># Create necessary folders</span>
</span><span id="Scan.save_yaml-270"><a href="#Scan.save_yaml-270"><span class="linenos">270</span></a>        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</span><span id="Scan.save_yaml-271"><a href="#Scan.save_yaml-271"><span class="linenos">271</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">output_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.yaml&quot;</span><span class="p">:</span>
</span><span id="Scan.save_yaml-272"><a href="#Scan.save_yaml-272"><span class="linenos">272</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Scan.save_yaml-273"><a href="#Scan.save_yaml-273"><span class="linenos">273</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Scan.save_yaml-274"><a href="#Scan.save_yaml-274"><span class="linenos">274</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Scan.save_yaml-275"><a href="#Scan.save_yaml-275"><span class="linenos">275</span></a>            <span class="c1"># Add the standard metadata file name to the path if needed</span>
</span><span id="Scan.save_yaml-276"><a href="#Scan.save_yaml-276"><span class="linenos">276</span></a>            <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="Scan.save_yaml-277"><a href="#Scan.save_yaml-277"><span class="linenos">277</span></a>                <span class="n">output_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">METADATA_FILE_NAME</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">]</span>
</span><span id="Scan.save_yaml-278"><a href="#Scan.save_yaml-278"><span class="linenos">278</span></a>            <span class="p">)</span>
</span><span id="Scan.save_yaml-279"><a href="#Scan.save_yaml-279"><span class="linenos">279</span></a>
</span><span id="Scan.save_yaml-280"><a href="#Scan.save_yaml-280"><span class="linenos">280</span></a>        <span class="c1"># Populate the file</span>
</span><span id="Scan.save_yaml-281"><a href="#Scan.save_yaml-281"><span class="linenos">281</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="Scan.save_yaml-282"><a href="#Scan.save_yaml-282"><span class="linenos">282</span></a>            <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Write the Scan object to a .yaml file.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>output_path</strong>:  /path/to/file.yaml or /path/to/folder to put scan.yaml</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>nothing; will raise an error on failure</p>
</blockquote>
</div>


                            </div>
                            <div id="Scan.load_yaml" class="classattr">
                                        <input id="Scan.load_yaml-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">load_yaml</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Self</span>:</span></span>

                <label class="view-source-button" for="Scan.load_yaml-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scan.load_yaml"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scan.load_yaml-284"><a href="#Scan.load_yaml-284"><span class="linenos">284</span></a>    <span class="nd">@classmethod</span>
</span><span id="Scan.load_yaml-285"><a href="#Scan.load_yaml-285"><span class="linenos">285</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_yaml</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="Scan.load_yaml-286"><a href="#Scan.load_yaml-286"><span class="linenos">286</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan.load_yaml-287"><a href="#Scan.load_yaml-287"><span class="linenos">287</span></a><span class="sd">        Load a Scan object from a .yaml file.</span>
</span><span id="Scan.load_yaml-288"><a href="#Scan.load_yaml-288"><span class="linenos">288</span></a><span class="sd">        :param input_path: /path/to/file.yaml or /path/to/folder with scan.yaml</span>
</span><span id="Scan.load_yaml-289"><a href="#Scan.load_yaml-289"><span class="linenos">289</span></a><span class="sd">        :return: a Scan object</span>
</span><span id="Scan.load_yaml-290"><a href="#Scan.load_yaml-290"><span class="linenos">290</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan.load_yaml-291"><a href="#Scan.load_yaml-291"><span class="linenos">291</span></a>        <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="Scan.load_yaml-292"><a href="#Scan.load_yaml-292"><span class="linenos">292</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">input_path</span><span class="p">):</span>
</span><span id="Scan.load_yaml-293"><a href="#Scan.load_yaml-293"><span class="linenos">293</span></a>            <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="Scan.load_yaml-294"><a href="#Scan.load_yaml-294"><span class="linenos">294</span></a>                <span class="n">input_path</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">METADATA_FILE_NAME</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">]</span>
</span><span id="Scan.load_yaml-295"><a href="#Scan.load_yaml-295"><span class="linenos">295</span></a>            <span class="p">)</span>
</span><span id="Scan.load_yaml-296"><a href="#Scan.load_yaml-296"><span class="linenos">296</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="Scan.load_yaml-297"><a href="#Scan.load_yaml-297"><span class="linenos">297</span></a>            <span class="n">metadata_obj</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">Loader</span><span class="p">)</span>
</span><span id="Scan.load_yaml-298"><a href="#Scan.load_yaml-298"><span class="linenos">298</span></a>        <span class="k">return</span> <span class="n">metadata_obj</span>
</span></pre></div>


            <div class="docstring"><p>Load a Scan object from a .yaml file.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>input_path</strong>:  /path/to/file.yaml or /path/to/folder with scan.yaml</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a Scan object</p>
</blockquote>
</div>


                            </div>
                            <div id="Scan.to_dict" class="classattr">
                                        <input id="Scan.to_dict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">to_dict</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="Scan.to_dict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scan.to_dict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scan.to_dict-300"><a href="#Scan.to_dict-300"><span class="linenos">300</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="Scan.to_dict-301"><a href="#Scan.to_dict-301"><span class="linenos">301</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan.to_dict-302"><a href="#Scan.to_dict-302"><span class="linenos">302</span></a><span class="sd">        Convert the Scan object to a dictionary with keys matching database columns</span>
</span><span id="Scan.to_dict-303"><a href="#Scan.to_dict-303"><span class="linenos">303</span></a><span class="sd">        and values matching database entries</span>
</span><span id="Scan.to_dict-304"><a href="#Scan.to_dict-304"><span class="linenos">304</span></a><span class="sd">        :return: a dictionary</span>
</span><span id="Scan.to_dict-305"><a href="#Scan.to_dict-305"><span class="linenos">305</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan.to_dict-306"><a href="#Scan.to_dict-306"><span class="linenos">306</span></a>        <span class="c1"># Dump to json; then add indents and a top-level key</span>
</span><span id="Scan.to_dict-307"><a href="#Scan.to_dict-307"><span class="linenos">307</span></a>        <span class="n">channels_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
</span><span id="Scan.to_dict-308"><a href="#Scan.to_dict-308"><span class="linenos">308</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span>
</span><span id="Scan.to_dict-309"><a href="#Scan.to_dict-309"><span class="linenos">309</span></a>        <span class="p">)</span>
</span><span id="Scan.to_dict-310"><a href="#Scan.to_dict-310"><span class="linenos">310</span></a>        <span class="n">channels_json</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">channels_json</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
</span><span id="Scan.to_dict-311"><a href="#Scan.to_dict-311"><span class="linenos">311</span></a>        <span class="n">channels_json</span> <span class="o">=</span> <span class="s2">&quot;{</span><span class="se">\n</span><span class="s2">  &quot;</span> <span class="o">+</span> <span class="s1">&#39;&quot;data&quot;: &#39;</span> <span class="o">+</span> <span class="n">channels_json</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">}&quot;</span>
</span><span id="Scan.to_dict-312"><a href="#Scan.to_dict-312"><span class="linenos">312</span></a>
</span><span id="Scan.to_dict-313"><a href="#Scan.to_dict-313"><span class="linenos">313</span></a>        <span class="n">roi_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="Scan.to_dict-314"><a href="#Scan.to_dict-314"><span class="linenos">314</span></a>        <span class="n">roi_json</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_json</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
</span><span id="Scan.to_dict-315"><a href="#Scan.to_dict-315"><span class="linenos">315</span></a>        <span class="n">roi_json</span> <span class="o">=</span> <span class="s2">&quot;{</span><span class="se">\n</span><span class="s2">  &quot;</span> <span class="o">+</span> <span class="s1">&#39;&quot;data&quot;: &#39;</span> <span class="o">+</span> <span class="n">roi_json</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">}&quot;</span>
</span><span id="Scan.to_dict-316"><a href="#Scan.to_dict-316"><span class="linenos">316</span></a>
</span><span id="Scan.to_dict-317"><a href="#Scan.to_dict-317"><span class="linenos">317</span></a>        <span class="c1"># Keys are named the same as database columns</span>
</span><span id="Scan.to_dict-318"><a href="#Scan.to_dict-318"><span class="linenos">318</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="Scan.to_dict-319"><a href="#Scan.to_dict-319"><span class="linenos">319</span></a>            <span class="s2">&quot;scanner_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanner_id</span><span class="p">,</span>
</span><span id="Scan.to_dict-320"><a href="#Scan.to_dict-320"><span class="linenos">320</span></a>            <span class="s2">&quot;slide_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_id</span><span class="p">,</span>
</span><span id="Scan.to_dict-321"><a href="#Scan.to_dict-321"><span class="linenos">321</span></a>            <span class="s2">&quot;exists&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">,</span>
</span><span id="Scan.to_dict-322"><a href="#Scan.to_dict-322"><span class="linenos">322</span></a>            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="Scan.to_dict-323"><a href="#Scan.to_dict-323"><span class="linenos">323</span></a>            <span class="s2">&quot;start_datetime&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_datetime</span><span class="p">,</span>
</span><span id="Scan.to_dict-324"><a href="#Scan.to_dict-324"><span class="linenos">324</span></a>            <span class="s2">&quot;end_datetime&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_datetime</span><span class="p">,</span>
</span><span id="Scan.to_dict-325"><a href="#Scan.to_dict-325"><span class="linenos">325</span></a>            <span class="s2">&quot;scan_time_s&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_time_s</span><span class="p">,</span>
</span><span id="Scan.to_dict-326"><a href="#Scan.to_dict-326"><span class="linenos">326</span></a>            <span class="s2">&quot;tray_pos&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tray_pos</span><span class="p">,</span>
</span><span id="Scan.to_dict-327"><a href="#Scan.to_dict-327"><span class="linenos">327</span></a>            <span class="s2">&quot;slide_pos&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_pos</span><span class="p">,</span>
</span><span id="Scan.to_dict-328"><a href="#Scan.to_dict-328"><span class="linenos">328</span></a>            <span class="s2">&quot;tile_width&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_width_px</span><span class="p">,</span>
</span><span id="Scan.to_dict-329"><a href="#Scan.to_dict-329"><span class="linenos">329</span></a>            <span class="s2">&quot;tile_height&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_height_px</span><span class="p">,</span>
</span><span id="Scan.to_dict-330"><a href="#Scan.to_dict-330"><span class="linenos">330</span></a>            <span class="s2">&quot;tile_x_offset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_x_offset_px</span><span class="p">,</span>
</span><span id="Scan.to_dict-331"><a href="#Scan.to_dict-331"><span class="linenos">331</span></a>            <span class="s2">&quot;tile_y_offset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_y_offset_px</span><span class="p">,</span>
</span><span id="Scan.to_dict-332"><a href="#Scan.to_dict-332"><span class="linenos">332</span></a>            <span class="s2">&quot;tile_overlap&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_overlap_proportion</span><span class="p">,</span>
</span><span id="Scan.to_dict-333"><a href="#Scan.to_dict-333"><span class="linenos">333</span></a>            <span class="s2">&quot;camera&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera</span><span class="p">,</span>
</span><span id="Scan.to_dict-334"><a href="#Scan.to_dict-334"><span class="linenos">334</span></a>            <span class="s2">&quot;objective&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">,</span>
</span><span id="Scan.to_dict-335"><a href="#Scan.to_dict-335"><span class="linenos">335</span></a>            <span class="s2">&quot;pixel_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size_um</span><span class="p">,</span>
</span><span id="Scan.to_dict-336"><a href="#Scan.to_dict-336"><span class="linenos">336</span></a>            <span class="s2">&quot;channels&quot;</span><span class="p">:</span> <span class="n">channels_json</span><span class="p">,</span>
</span><span id="Scan.to_dict-337"><a href="#Scan.to_dict-337"><span class="linenos">337</span></a>            <span class="s2">&quot;roi&quot;</span><span class="p">:</span> <span class="n">roi_json</span><span class="p">,</span>
</span><span id="Scan.to_dict-338"><a href="#Scan.to_dict-338"><span class="linenos">338</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Convert the Scan object to a dictionary with keys matching database columns
and values matching database entries</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a dictionary</p>
</blockquote>
</div>


                            </div>
                            <div id="Scan.from_dict" class="classattr">
                                        <input id="Scan.from_dict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">from_dict</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">scan_dict</span></span><span class="return-annotation">) -> <span class="n">Self</span>:</span></span>

                <label class="view-source-button" for="Scan.from_dict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scan.from_dict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scan.from_dict-340"><a href="#Scan.from_dict-340"><span class="linenos">340</span></a>    <span class="nd">@classmethod</span>
</span><span id="Scan.from_dict-341"><a href="#Scan.from_dict-341"><span class="linenos">341</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">scan_dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="Scan.from_dict-342"><a href="#Scan.from_dict-342"><span class="linenos">342</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan.from_dict-343"><a href="#Scan.from_dict-343"><span class="linenos">343</span></a><span class="sd">        Convert a dictionary from to_dict() or the database to a Scan object</span>
</span><span id="Scan.from_dict-344"><a href="#Scan.from_dict-344"><span class="linenos">344</span></a><span class="sd">        :param scan_dict: a dictionary</span>
</span><span id="Scan.from_dict-345"><a href="#Scan.from_dict-345"><span class="linenos">345</span></a><span class="sd">        :return: a Scan object</span>
</span><span id="Scan.from_dict-346"><a href="#Scan.from_dict-346"><span class="linenos">346</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan.from_dict-347"><a href="#Scan.from_dict-347"><span class="linenos">347</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
</span><span id="Scan.from_dict-348"><a href="#Scan.from_dict-348"><span class="linenos">348</span></a>            <span class="n">scanner_id</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;scanner_id&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-349"><a href="#Scan.from_dict-349"><span class="linenos">349</span></a>            <span class="n">slide_id</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-350"><a href="#Scan.from_dict-350"><span class="linenos">350</span></a>            <span class="n">path</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-351"><a href="#Scan.from_dict-351"><span class="linenos">351</span></a>            <span class="n">exists</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;exists&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-352"><a href="#Scan.from_dict-352"><span class="linenos">352</span></a>            <span class="n">start_datetime</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;start_datetime&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-353"><a href="#Scan.from_dict-353"><span class="linenos">353</span></a>            <span class="n">end_datetime</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;end_datetime&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-354"><a href="#Scan.from_dict-354"><span class="linenos">354</span></a>            <span class="n">scan_time_s</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;scan_time_s&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-355"><a href="#Scan.from_dict-355"><span class="linenos">355</span></a>            <span class="n">tray_pos</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;tray_pos&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-356"><a href="#Scan.from_dict-356"><span class="linenos">356</span></a>            <span class="n">slide_pos</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;slide_pos&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-357"><a href="#Scan.from_dict-357"><span class="linenos">357</span></a>            <span class="n">camera</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;camera&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-358"><a href="#Scan.from_dict-358"><span class="linenos">358</span></a>            <span class="n">objective</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;objective&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-359"><a href="#Scan.from_dict-359"><span class="linenos">359</span></a>            <span class="n">pixel_size_um</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;pixel_size&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-360"><a href="#Scan.from_dict-360"><span class="linenos">360</span></a>            <span class="n">tile_width_px</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;tile_width&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-361"><a href="#Scan.from_dict-361"><span class="linenos">361</span></a>            <span class="n">tile_height_px</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;tile_height&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-362"><a href="#Scan.from_dict-362"><span class="linenos">362</span></a>            <span class="n">tile_x_offset_px</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;tile_x_offset&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-363"><a href="#Scan.from_dict-363"><span class="linenos">363</span></a>            <span class="n">tile_y_offset_px</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;tile_y_offset&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-364"><a href="#Scan.from_dict-364"><span class="linenos">364</span></a>            <span class="n">tile_overlap_proportion</span><span class="o">=</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;tile_overlap&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-365"><a href="#Scan.from_dict-365"><span class="linenos">365</span></a>        <span class="p">)</span>
</span><span id="Scan.from_dict-366"><a href="#Scan.from_dict-366"><span class="linenos">366</span></a>        <span class="c1"># Handle JSON and dictionaries</span>
</span><span id="Scan.from_dict-367"><a href="#Scan.from_dict-367"><span class="linenos">367</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Scan.from_dict-368"><a href="#Scan.from_dict-368"><span class="linenos">368</span></a>            <span class="n">channels_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">])[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
</span><span id="Scan.from_dict-369"><a href="#Scan.from_dict-369"><span class="linenos">369</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Scan.from_dict-370"><a href="#Scan.from_dict-370"><span class="linenos">370</span></a>            <span class="n">channels_dict</span> <span class="o">=</span> <span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
</span><span id="Scan.from_dict-371"><a href="#Scan.from_dict-371"><span class="linenos">371</span></a>        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels_dict</span><span class="p">:</span>
</span><span id="Scan.from_dict-372"><a href="#Scan.from_dict-372"><span class="linenos">372</span></a>            <span class="n">result</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="Scan.from_dict-373"><a href="#Scan.from_dict-373"><span class="linenos">373</span></a>                <span class="bp">cls</span><span class="o">.</span><span class="n">Channel</span><span class="p">(</span>
</span><span id="Scan.from_dict-374"><a href="#Scan.from_dict-374"><span class="linenos">374</span></a>                    <span class="n">name</span><span class="o">=</span><span class="n">channel</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-375"><a href="#Scan.from_dict-375"><span class="linenos">375</span></a>                    <span class="n">exposure_ms</span><span class="o">=</span><span class="n">channel</span><span class="p">[</span><span class="s2">&quot;exposure_ms&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-376"><a href="#Scan.from_dict-376"><span class="linenos">376</span></a>                    <span class="n">intensity</span><span class="o">=</span><span class="n">channel</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-377"><a href="#Scan.from_dict-377"><span class="linenos">377</span></a>                    <span class="n">gain_applied</span><span class="o">=</span><span class="n">channel</span><span class="p">[</span><span class="s2">&quot;gain_applied&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-378"><a href="#Scan.from_dict-378"><span class="linenos">378</span></a>                <span class="p">)</span>
</span><span id="Scan.from_dict-379"><a href="#Scan.from_dict-379"><span class="linenos">379</span></a>            <span class="p">)</span>
</span><span id="Scan.from_dict-380"><a href="#Scan.from_dict-380"><span class="linenos">380</span></a>        <span class="c1"># Handle JSON and dictionaries</span>
</span><span id="Scan.from_dict-381"><a href="#Scan.from_dict-381"><span class="linenos">381</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Scan.from_dict-382"><a href="#Scan.from_dict-382"><span class="linenos">382</span></a>            <span class="n">roi_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">])[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
</span><span id="Scan.from_dict-383"><a href="#Scan.from_dict-383"><span class="linenos">383</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Scan.from_dict-384"><a href="#Scan.from_dict-384"><span class="linenos">384</span></a>            <span class="n">roi_dict</span> <span class="o">=</span> <span class="n">scan_dict</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
</span><span id="Scan.from_dict-385"><a href="#Scan.from_dict-385"><span class="linenos">385</span></a>        <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">roi_dict</span><span class="p">:</span>
</span><span id="Scan.from_dict-386"><a href="#Scan.from_dict-386"><span class="linenos">386</span></a>            <span class="n">result</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="Scan.from_dict-387"><a href="#Scan.from_dict-387"><span class="linenos">387</span></a>                <span class="bp">cls</span><span class="o">.</span><span class="n">ROI</span><span class="p">(</span>
</span><span id="Scan.from_dict-388"><a href="#Scan.from_dict-388"><span class="linenos">388</span></a>                    <span class="n">origin_x_um</span><span class="o">=</span><span class="n">roi</span><span class="p">[</span><span class="s2">&quot;origin_x_um&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-389"><a href="#Scan.from_dict-389"><span class="linenos">389</span></a>                    <span class="n">origin_y_um</span><span class="o">=</span><span class="n">roi</span><span class="p">[</span><span class="s2">&quot;origin_y_um&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-390"><a href="#Scan.from_dict-390"><span class="linenos">390</span></a>                    <span class="n">width_um</span><span class="o">=</span><span class="n">roi</span><span class="p">[</span><span class="s2">&quot;width_um&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-391"><a href="#Scan.from_dict-391"><span class="linenos">391</span></a>                    <span class="n">height_um</span><span class="o">=</span><span class="n">roi</span><span class="p">[</span><span class="s2">&quot;height_um&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-392"><a href="#Scan.from_dict-392"><span class="linenos">392</span></a>                    <span class="n">tile_rows</span><span class="o">=</span><span class="n">roi</span><span class="p">[</span><span class="s2">&quot;tile_rows&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-393"><a href="#Scan.from_dict-393"><span class="linenos">393</span></a>                    <span class="n">tile_cols</span><span class="o">=</span><span class="n">roi</span><span class="p">[</span><span class="s2">&quot;tile_cols&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-394"><a href="#Scan.from_dict-394"><span class="linenos">394</span></a>                    <span class="n">focus_points</span><span class="o">=</span><span class="n">roi</span><span class="p">[</span><span class="s2">&quot;focus_points&quot;</span><span class="p">],</span>
</span><span id="Scan.from_dict-395"><a href="#Scan.from_dict-395"><span class="linenos">395</span></a>                <span class="p">)</span>
</span><span id="Scan.from_dict-396"><a href="#Scan.from_dict-396"><span class="linenos">396</span></a>            <span class="p">)</span>
</span><span id="Scan.from_dict-397"><a href="#Scan.from_dict-397"><span class="linenos">397</span></a>        <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


            <div class="docstring"><p>Convert a dictionary from to_dict() or the database to a Scan object</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>scan_dict</strong>:  a dictionary</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a Scan object</p>
</blockquote>
</div>


                            </div>
                            <div id="Scan.load_czi" class="classattr">
                                        <input id="Scan.load_czi-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">load_czi</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Self</span>:</span></span>

                <label class="view-source-button" for="Scan.load_czi-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scan.load_czi"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scan.load_czi-399"><a href="#Scan.load_czi-399"><span class="linenos">399</span></a>    <span class="nd">@classmethod</span>
</span><span id="Scan.load_czi-400"><a href="#Scan.load_czi-400"><span class="linenos">400</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_czi</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="Scan.load_czi-401"><a href="#Scan.load_czi-401"><span class="linenos">401</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan.load_czi-402"><a href="#Scan.load_czi-402"><span class="linenos">402</span></a><span class="sd">        Extracts metadata from a .czi file, which is the output of the Axioscan</span>
</span><span id="Scan.load_czi-403"><a href="#Scan.load_czi-403"><span class="linenos">403</span></a><span class="sd">        :param input_path: the path to the .czi file</span>
</span><span id="Scan.load_czi-404"><a href="#Scan.load_czi-404"><span class="linenos">404</span></a><span class="sd">        :return: a Scan object</span>
</span><span id="Scan.load_czi-405"><a href="#Scan.load_czi-405"><span class="linenos">405</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan.load_czi-406"><a href="#Scan.load_czi-406"><span class="linenos">406</span></a>        <span class="k">if</span> <span class="n">aicspylibczi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scan.load_czi-407"><a href="#Scan.load_czi-407"><span class="linenos">407</span></a>            <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span>
</span><span id="Scan.load_czi-408"><a href="#Scan.load_czi-408"><span class="linenos">408</span></a>                <span class="s2">&quot;aicspylibczi library not installed. &quot;</span>
</span><span id="Scan.load_czi-409"><a href="#Scan.load_czi-409"><span class="linenos">409</span></a>                <span class="s2">&quot;Install csi-images with [imageio] option to resolve.&quot;</span>
</span><span id="Scan.load_czi-410"><a href="#Scan.load_czi-410"><span class="linenos">410</span></a>            <span class="p">)</span>
</span><span id="Scan.load_czi-411"><a href="#Scan.load_czi-411"><span class="linenos">411</span></a>
</span><span id="Scan.load_czi-412"><a href="#Scan.load_czi-412"><span class="linenos">412</span></a>        <span class="c1"># Normalize paths</span>
</span><span id="Scan.load_czi-413"><a href="#Scan.load_czi-413"><span class="linenos">413</span></a>        <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="Scan.load_czi-414"><a href="#Scan.load_czi-414"><span class="linenos">414</span></a>
</span><span id="Scan.load_czi-415"><a href="#Scan.load_czi-415"><span class="linenos">415</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="Scan.load_czi-416"><a href="#Scan.load_czi-416"><span class="linenos">416</span></a>            <span class="c1"># Read in metadata as XML elements</span>
</span><span id="Scan.load_czi-417"><a href="#Scan.load_czi-417"><span class="linenos">417</span></a>            <span class="n">metadata_xml</span> <span class="o">=</span> <span class="n">aicspylibczi</span><span class="o">.</span><span class="n">CziFile</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">meta</span>
</span><span id="Scan.load_czi-418"><a href="#Scan.load_czi-418"><span class="linenos">418</span></a>            <span class="c1"># Read in shape metadata from binary</span>
</span><span id="Scan.load_czi-419"><a href="#Scan.load_czi-419"><span class="linenos">419</span></a>            <span class="n">rois_shape</span> <span class="o">=</span> <span class="n">aicspylibczi</span><span class="o">.</span><span class="n">CziFile</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">get_dims_shape</span><span class="p">()</span>
</span><span id="Scan.load_czi-420"><a href="#Scan.load_czi-420"><span class="linenos">420</span></a>
</span><span id="Scan.load_czi-421"><a href="#Scan.load_czi-421"><span class="linenos">421</span></a>        <span class="c1"># Populate metadata</span>
</span><span id="Scan.load_czi-422"><a href="#Scan.load_czi-422"><span class="linenos">422</span></a>        <span class="n">scan</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
</span><span id="Scan.load_czi-423"><a href="#Scan.load_czi-423"><span class="linenos">423</span></a>
</span><span id="Scan.load_czi-424"><a href="#Scan.load_czi-424"><span class="linenos">424</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Label/Barcodes/Barcode/Content&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span><span id="Scan.load_czi-425"><a href="#Scan.load_czi-425"><span class="linenos">425</span></a>        <span class="k">if</span> <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scan.load_czi-426"><a href="#Scan.load_czi-426"><span class="linenos">426</span></a>            <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="Scan.load_czi-427"><a href="#Scan.load_czi-427"><span class="linenos">427</span></a>        <span class="c1"># Map the raw scanner ID (service ID) to our IDs</span>
</span><span id="Scan.load_czi-428"><a href="#Scan.load_czi-428"><span class="linenos">428</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SCANNER_IDS</span><span class="p">[</span>
</span><span id="Scan.load_czi-429"><a href="#Scan.load_czi-429"><span class="linenos">429</span></a>            <span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Microscope/UserDefinedName&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span><span id="Scan.load_czi-430"><a href="#Scan.load_czi-430"><span class="linenos">430</span></a>        <span class="p">]</span>
</span><span id="Scan.load_czi-431"><a href="#Scan.load_czi-431"><span class="linenos">431</span></a>
</span><span id="Scan.load_czi-432"><a href="#Scan.load_czi-432"><span class="linenos">432</span></a>        <span class="c1"># Extract start and finish datetimes</span>
</span><span id="Scan.load_czi-433"><a href="#Scan.load_czi-433"><span class="linenos">433</span></a>        <span class="n">date</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Document/CreationDate&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span><span id="Scan.load_czi-434"><a href="#Scan.load_czi-434"><span class="linenos">434</span></a>        <span class="c1"># Strip out sub-second precision</span>
</span><span id="Scan.load_czi-435"><a href="#Scan.load_czi-435"><span class="linenos">435</span></a>        <span class="n">date</span> <span class="o">=</span> <span class="n">date</span><span class="p">[:</span> <span class="n">date</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)]</span> <span class="o">+</span> <span class="n">date</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">date</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">))</span> <span class="p">:]</span>
</span><span id="Scan.load_czi-436"><a href="#Scan.load_czi-436"><span class="linenos">436</span></a>        <span class="n">date_as_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
</span><span id="Scan.load_czi-437"><a href="#Scan.load_czi-437"><span class="linenos">437</span></a>            <span class="n">date</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DATETIME_FORMAT</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">]</span>
</span><span id="Scan.load_czi-438"><a href="#Scan.load_czi-438"><span class="linenos">438</span></a>        <span class="p">)</span>
</span><span id="Scan.load_czi-439"><a href="#Scan.load_czi-439"><span class="linenos">439</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">start_datetime</span> <span class="o">=</span> <span class="n">date_as_datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">STANDARD_DATETIME_FORMAT</span><span class="p">)</span>
</span><span id="Scan.load_czi-440"><a href="#Scan.load_czi-440"><span class="linenos">440</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">scan_time_s</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
</span><span id="Scan.load_czi-441"><a href="#Scan.load_czi-441"><span class="linenos">441</span></a>            <span class="nb">float</span><span class="p">(</span><span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Image/AcquisitionDuration&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span>
</span><span id="Scan.load_czi-442"><a href="#Scan.load_czi-442"><span class="linenos">442</span></a>        <span class="p">)</span>
</span><span id="Scan.load_czi-443"><a href="#Scan.load_czi-443"><span class="linenos">443</span></a>        <span class="n">date_as_datetime</span> <span class="o">+=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">scan</span><span class="o">.</span><span class="n">scan_time_s</span><span class="p">)</span>
</span><span id="Scan.load_czi-444"><a href="#Scan.load_czi-444"><span class="linenos">444</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">end_datetime</span> <span class="o">=</span> <span class="n">date_as_datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">STANDARD_DATETIME_FORMAT</span><span class="p">)</span>
</span><span id="Scan.load_czi-445"><a href="#Scan.load_czi-445"><span class="linenos">445</span></a>
</span><span id="Scan.load_czi-446"><a href="#Scan.load_czi-446"><span class="linenos">446</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tray_pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//SlotNumberOfLoadedTray&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="Scan.load_czi-447"><a href="#Scan.load_czi-447"><span class="linenos">447</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">slide_pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//SlideScannerPosition&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Scan.load_czi-448"><a href="#Scan.load_czi-448"><span class="linenos">448</span></a>
</span><span id="Scan.load_czi-449"><a href="#Scan.load_czi-449"><span class="linenos">449</span></a>        <span class="c1"># Get camera and magnifying info</span>
</span><span id="Scan.load_czi-450"><a href="#Scan.load_czi-450"><span class="linenos">450</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Scan.load_czi-451"><a href="#Scan.load_czi-451"><span class="linenos">451</span></a>            <span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Information/Instrument/Detectors/Detector&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">attrib</span>
</span><span id="Scan.load_czi-452"><a href="#Scan.load_czi-452"><span class="linenos">452</span></a>        <span class="p">)[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span>
</span><span id="Scan.load_czi-453"><a href="#Scan.load_czi-453"><span class="linenos">453</span></a>        <span class="n">magnification</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
</span><span id="Scan.load_czi-454"><a href="#Scan.load_czi-454"><span class="linenos">454</span></a>            <span class="s2">&quot;.//Objectives/Objective/NominalMagnification&quot;</span>
</span><span id="Scan.load_czi-455"><a href="#Scan.load_czi-455"><span class="linenos">455</span></a>        <span class="p">)</span>
</span><span id="Scan.load_czi-456"><a href="#Scan.load_czi-456"><span class="linenos">456</span></a>        <span class="n">aperture</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Objectives/Objective/LensNA&quot;</span><span class="p">)</span>
</span><span id="Scan.load_czi-457"><a href="#Scan.load_czi-457"><span class="linenos">457</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">objective</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">magnification</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">x-</span><span class="si">{</span><span class="n">aperture</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Scan.load_czi-458"><a href="#Scan.load_czi-458"><span class="linenos">458</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Scan.load_czi-459"><a href="#Scan.load_czi-459"><span class="linenos">459</span></a>            <span class="nb">float</span><span class="p">(</span><span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Scaling/Items/Distance/Value&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span>
</span><span id="Scan.load_czi-460"><a href="#Scan.load_czi-460"><span class="linenos">460</span></a>        <span class="p">)</span>
</span><span id="Scan.load_czi-461"><a href="#Scan.load_czi-461"><span class="linenos">461</span></a>        <span class="c1"># Round off the pixel size to nanometers; might not be optimal, but this</span>
</span><span id="Scan.load_czi-462"><a href="#Scan.load_czi-462"><span class="linenos">462</span></a>        <span class="c1"># gets rounded when we send it to the database anyways (to 7 places)</span>
</span><span id="Scan.load_czi-463"><a href="#Scan.load_czi-463"><span class="linenos">463</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="Scan.load_czi-464"><a href="#Scan.load_czi-464"><span class="linenos">464</span></a>
</span><span id="Scan.load_czi-465"><a href="#Scan.load_czi-465"><span class="linenos">465</span></a>        <span class="c1"># Get tile information</span>
</span><span id="Scan.load_czi-466"><a href="#Scan.load_czi-466"><span class="linenos">466</span></a>        <span class="c1"># Note: X Y is untested, could be flipped. I always forget. Just don&#39;t use</span>
</span><span id="Scan.load_czi-467"><a href="#Scan.load_czi-467"><span class="linenos">467</span></a>        <span class="c1"># non-square frames and we&#39;re all good.</span>
</span><span id="Scan.load_czi-468"><a href="#Scan.load_czi-468"><span class="linenos">468</span></a>        <span class="n">selected_detector</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//SelectedDetector&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span><span id="Scan.load_czi-469"><a href="#Scan.load_czi-469"><span class="linenos">469</span></a>        <span class="n">detectors</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//Detectors/Detector&quot;</span><span class="p">)</span>
</span><span id="Scan.load_czi-470"><a href="#Scan.load_czi-470"><span class="linenos">470</span></a>        <span class="k">for</span> <span class="n">detector</span> <span class="ow">in</span> <span class="n">detectors</span><span class="p">:</span>
</span><span id="Scan.load_czi-471"><a href="#Scan.load_czi-471"><span class="linenos">471</span></a>            <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">selected_detector</span><span class="p">:</span>
</span><span id="Scan.load_czi-472"><a href="#Scan.load_czi-472"><span class="linenos">472</span></a>                <span class="n">tile_info</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Frame&quot;</span><span class="p">)</span>
</span><span id="Scan.load_czi-473"><a href="#Scan.load_czi-473"><span class="linenos">473</span></a>                <span class="k">break</span>
</span><span id="Scan.load_czi-474"><a href="#Scan.load_czi-474"><span class="linenos">474</span></a>        <span class="c1"># Convert to integers</span>
</span><span id="Scan.load_czi-475"><a href="#Scan.load_czi-475"><span class="linenos">475</span></a>        <span class="n">tile_info</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">coordinate</span><span class="p">)</span> <span class="k">for</span> <span class="n">coordinate</span> <span class="ow">in</span> <span class="n">tile_info</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
</span><span id="Scan.load_czi-476"><a href="#Scan.load_czi-476"><span class="linenos">476</span></a>
</span><span id="Scan.load_czi-477"><a href="#Scan.load_czi-477"><span class="linenos">477</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_x_offset_px</span> <span class="o">=</span> <span class="n">tile_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Scan.load_czi-478"><a href="#Scan.load_czi-478"><span class="linenos">478</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_y_offset_px</span> <span class="o">=</span> <span class="n">tile_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Scan.load_czi-479"><a href="#Scan.load_czi-479"><span class="linenos">479</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">=</span> <span class="n">tile_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Scan.load_czi-480"><a href="#Scan.load_czi-480"><span class="linenos">480</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">=</span> <span class="n">tile_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="Scan.load_czi-481"><a href="#Scan.load_czi-481"><span class="linenos">481</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_overlap_proportion</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">metadata_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Overlap&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="Scan.load_czi-482"><a href="#Scan.load_czi-482"><span class="linenos">482</span></a>
</span><span id="Scan.load_czi-483"><a href="#Scan.load_czi-483"><span class="linenos">483</span></a>        <span class="c1"># Extract channels and create Channel objects from them</span>
</span><span id="Scan.load_czi-484"><a href="#Scan.load_czi-484"><span class="linenos">484</span></a>        <span class="n">channel_indices</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scan.load_czi-485"><a href="#Scan.load_czi-485"><span class="linenos">485</span></a>        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//Image/Dimensions/Channels/Channel&quot;</span><span class="p">):</span>
</span><span id="Scan.load_czi-486"><a href="#Scan.load_czi-486"><span class="linenos">486</span></a>            <span class="n">channel_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="Scan.load_czi-487"><a href="#Scan.load_czi-487"><span class="linenos">487</span></a>            <span class="n">intensity_xml</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Intensity&quot;</span><span class="p">)</span>
</span><span id="Scan.load_czi-488"><a href="#Scan.load_czi-488"><span class="linenos">488</span></a>            <span class="k">if</span> <span class="n">intensity_xml</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scan.load_czi-489"><a href="#Scan.load_czi-489"><span class="linenos">489</span></a>                <span class="n">intensity</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Scan.load_czi-490"><a href="#Scan.load_czi-490"><span class="linenos">490</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Scan.load_czi-491"><a href="#Scan.load_czi-491"><span class="linenos">491</span></a>                <span class="n">intensity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">intensity_xml</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-2</span>
</span><span id="Scan.load_czi-492"><a href="#Scan.load_czi-492"><span class="linenos">492</span></a>            <span class="n">scan</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="Scan.load_czi-493"><a href="#Scan.load_czi-493"><span class="linenos">493</span></a>                <span class="bp">cls</span><span class="o">.</span><span class="n">Channel</span><span class="p">(</span>
</span><span id="Scan.load_czi-494"><a href="#Scan.load_czi-494"><span class="linenos">494</span></a>                    <span class="n">name</span><span class="o">=</span><span class="n">channel</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
</span><span id="Scan.load_czi-495"><a href="#Scan.load_czi-495"><span class="linenos">495</span></a>                    <span class="n">exposure_ms</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./ExposureTime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span>
</span><span id="Scan.load_czi-496"><a href="#Scan.load_czi-496"><span class="linenos">496</span></a>                    <span class="n">intensity</span><span class="o">=</span><span class="n">intensity</span><span class="p">,</span>
</span><span id="Scan.load_czi-497"><a href="#Scan.load_czi-497"><span class="linenos">497</span></a>                    <span class="n">gain_applied</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># In Axioscan, we will always use gain = 1</span>
</span><span id="Scan.load_czi-498"><a href="#Scan.load_czi-498"><span class="linenos">498</span></a>                <span class="p">)</span>
</span><span id="Scan.load_czi-499"><a href="#Scan.load_czi-499"><span class="linenos">499</span></a>            <span class="p">)</span>
</span><span id="Scan.load_czi-500"><a href="#Scan.load_czi-500"><span class="linenos">500</span></a>        <span class="c1"># Make sure the channels are sorted</span>
</span><span id="Scan.load_czi-501"><a href="#Scan.load_czi-501"><span class="linenos">501</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Scan.load_czi-502"><a href="#Scan.load_czi-502"><span class="linenos">502</span></a>            <span class="n">channel</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">channel_indices</span><span class="p">,</span> <span class="n">scan</span><span class="o">.</span><span class="n">channels</span><span class="p">))</span>
</span><span id="Scan.load_czi-503"><a href="#Scan.load_czi-503"><span class="linenos">503</span></a>        <span class="p">]</span>
</span><span id="Scan.load_czi-504"><a href="#Scan.load_czi-504"><span class="linenos">504</span></a>        <span class="c1"># Verify that the shape corresponds to the channels</span>
</span><span id="Scan.load_czi-505"><a href="#Scan.load_czi-505"><span class="linenos">505</span></a>        <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois_shape</span><span class="p">:</span>
</span><span id="Scan.load_czi-506"><a href="#Scan.load_czi-506"><span class="linenos">506</span></a>            <span class="k">if</span> <span class="n">roi</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">channels</span><span class="p">):</span>
</span><span id="Scan.load_czi-507"><a href="#Scan.load_czi-507"><span class="linenos">507</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Scan.load_czi-508"><a href="#Scan.load_czi-508"><span class="linenos">508</span></a>                    <span class="sa">f</span><span class="s2">&quot;Number of channels </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Scan.load_czi-509"><a href="#Scan.load_czi-509"><span class="linenos">509</span></a>                    <span class="sa">f</span><span class="s2">&quot;is not the same as the number of channels in an ROI: &quot;</span>
</span><span id="Scan.load_czi-510"><a href="#Scan.load_czi-510"><span class="linenos">510</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">roi</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Scan.load_czi-511"><a href="#Scan.load_czi-511"><span class="linenos">511</span></a>                <span class="p">)</span>
</span><span id="Scan.load_czi-512"><a href="#Scan.load_czi-512"><span class="linenos">512</span></a>
</span><span id="Scan.load_czi-513"><a href="#Scan.load_czi-513"><span class="linenos">513</span></a>        <span class="c1"># Get the real ROI limits; the metadata is not always correct</span>
</span><span id="Scan.load_czi-514"><a href="#Scan.load_czi-514"><span class="linenos">514</span></a>        <span class="n">limits_xml</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//AllowedScanArea&quot;</span><span class="p">)</span>
</span><span id="Scan.load_czi-515"><a href="#Scan.load_czi-515"><span class="linenos">515</span></a>        <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Scan.load_czi-516"><a href="#Scan.load_czi-516"><span class="linenos">516</span></a>            <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">limits_xml</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Center&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])),</span>
</span><span id="Scan.load_czi-517"><a href="#Scan.load_czi-517"><span class="linenos">517</span></a>            <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">limits_xml</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Center&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])),</span>
</span><span id="Scan.load_czi-518"><a href="#Scan.load_czi-518"><span class="linenos">518</span></a>            <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">limits_xml</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Size&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])),</span>
</span><span id="Scan.load_czi-519"><a href="#Scan.load_czi-519"><span class="linenos">519</span></a>            <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">limits_xml</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Size&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])),</span>
</span><span id="Scan.load_czi-520"><a href="#Scan.load_czi-520"><span class="linenos">520</span></a>        <span class="p">]</span>
</span><span id="Scan.load_czi-521"><a href="#Scan.load_czi-521"><span class="linenos">521</span></a>        <span class="c1"># Convert to top-left and bottom-right</span>
</span><span id="Scan.load_czi-522"><a href="#Scan.load_czi-522"><span class="linenos">522</span></a>        <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Scan.load_czi-523"><a href="#Scan.load_czi-523"><span class="linenos">523</span></a>            <span class="nb">round</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Scan.load_czi-524"><a href="#Scan.load_czi-524"><span class="linenos">524</span></a>            <span class="nb">round</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Scan.load_czi-525"><a href="#Scan.load_czi-525"><span class="linenos">525</span></a>            <span class="nb">round</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Scan.load_czi-526"><a href="#Scan.load_czi-526"><span class="linenos">526</span></a>            <span class="nb">round</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Scan.load_czi-527"><a href="#Scan.load_czi-527"><span class="linenos">527</span></a>        <span class="p">]</span>
</span><span id="Scan.load_czi-528"><a href="#Scan.load_czi-528"><span class="linenos">528</span></a>
</span><span id="Scan.load_czi-529"><a href="#Scan.load_czi-529"><span class="linenos">529</span></a>        <span class="c1"># Extract ROIs and create ROI objects from them</span>
</span><span id="Scan.load_czi-530"><a href="#Scan.load_czi-530"><span class="linenos">530</span></a>        <span class="n">rois_xml_metadata</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//TileRegions/TileRegion&quot;</span><span class="p">)</span>
</span><span id="Scan.load_czi-531"><a href="#Scan.load_czi-531"><span class="linenos">531</span></a>        <span class="n">scenes_xml_metadata</span> <span class="o">=</span> <span class="n">metadata_xml</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//S/Scenes/Scene&quot;</span><span class="p">)</span>
</span><span id="Scan.load_czi-532"><a href="#Scan.load_czi-532"><span class="linenos">532</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rois_xml_metadata</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rois_shape</span><span class="p">):</span>
</span><span id="Scan.load_czi-533"><a href="#Scan.load_czi-533"><span class="linenos">533</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Scan.load_czi-534"><a href="#Scan.load_czi-534"><span class="linenos">534</span></a>                <span class="sa">f</span><span class="s2">&quot;Metadata and binary data from </span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Scan.load_czi-535"><a href="#Scan.load_czi-535"><span class="linenos">535</span></a>                <span class="sa">f</span><span class="s2">&quot;do not match in number of ROIs&quot;</span>
</span><span id="Scan.load_czi-536"><a href="#Scan.load_czi-536"><span class="linenos">536</span></a>            <span class="p">)</span>
</span><span id="Scan.load_czi-537"><a href="#Scan.load_czi-537"><span class="linenos">537</span></a>        <span class="c1"># We need both to determine the number of rows/columns because the XML lies</span>
</span><span id="Scan.load_czi-538"><a href="#Scan.load_czi-538"><span class="linenos">538</span></a>        <span class="n">roi_indices</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scan.load_czi-539"><a href="#Scan.load_czi-539"><span class="linenos">539</span></a>        <span class="k">for</span> <span class="n">roi_xml</span><span class="p">,</span> <span class="n">roi_shape</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rois_xml_metadata</span><span class="p">,</span> <span class="n">rois_shape</span><span class="p">):</span>
</span><span id="Scan.load_czi-540"><a href="#Scan.load_czi-540"><span class="linenos">540</span></a>            <span class="n">name</span> <span class="o">=</span> <span class="n">roi_xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span>
</span><span id="Scan.load_czi-541"><a href="#Scan.load_czi-541"><span class="linenos">541</span></a>            <span class="c1"># Determine the index of this scene</span>
</span><span id="Scan.load_czi-542"><a href="#Scan.load_czi-542"><span class="linenos">542</span></a>            <span class="n">scene_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="Scan.load_czi-543"><a href="#Scan.load_czi-543"><span class="linenos">543</span></a>            <span class="k">for</span> <span class="n">scene</span> <span class="ow">in</span> <span class="n">scenes_xml_metadata</span><span class="p">:</span>
</span><span id="Scan.load_czi-544"><a href="#Scan.load_czi-544"><span class="linenos">544</span></a>                <span class="k">if</span> <span class="n">scene</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
</span><span id="Scan.load_czi-545"><a href="#Scan.load_czi-545"><span class="linenos">545</span></a>                    <span class="n">scene_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;Index&quot;</span><span class="p">])</span>
</span><span id="Scan.load_czi-546"><a href="#Scan.load_czi-546"><span class="linenos">546</span></a>                    <span class="k">break</span>
</span><span id="Scan.load_czi-547"><a href="#Scan.load_czi-547"><span class="linenos">547</span></a>            <span class="k">if</span> <span class="n">scene_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Scan.load_czi-548"><a href="#Scan.load_czi-548"><span class="linenos">548</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ROI </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not correspond to any scenes&quot;</span><span class="p">)</span>
</span><span id="Scan.load_czi-549"><a href="#Scan.load_czi-549"><span class="linenos">549</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Scan.load_czi-550"><a href="#Scan.load_czi-550"><span class="linenos">550</span></a>                <span class="n">roi_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scene_index</span><span class="p">)</span>
</span><span id="Scan.load_czi-551"><a href="#Scan.load_czi-551"><span class="linenos">551</span></a>            <span class="c1"># Extract other metadata</span>
</span><span id="Scan.load_czi-552"><a href="#Scan.load_czi-552"><span class="linenos">552</span></a>            <span class="n">roi_limits</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Scan.load_czi-553"><a href="#Scan.load_czi-553"><span class="linenos">553</span></a>                <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">roi_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;CenterPosition&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])),</span>
</span><span id="Scan.load_czi-554"><a href="#Scan.load_czi-554"><span class="linenos">554</span></a>                <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">roi_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;CenterPosition&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])),</span>
</span><span id="Scan.load_czi-555"><a href="#Scan.load_czi-555"><span class="linenos">555</span></a>                <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">roi_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ContourSize&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])),</span>
</span><span id="Scan.load_czi-556"><a href="#Scan.load_czi-556"><span class="linenos">556</span></a>                <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">roi_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ContourSize&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])),</span>
</span><span id="Scan.load_czi-557"><a href="#Scan.load_czi-557"><span class="linenos">557</span></a>            <span class="p">]</span>
</span><span id="Scan.load_czi-558"><a href="#Scan.load_czi-558"><span class="linenos">558</span></a>            <span class="c1"># Convert to top-left and bottom-right</span>
</span><span id="Scan.load_czi-559"><a href="#Scan.load_czi-559"><span class="linenos">559</span></a>            <span class="n">roi_limits</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Scan.load_czi-560"><a href="#Scan.load_czi-560"><span class="linenos">560</span></a>                <span class="nb">round</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">roi_limits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Scan.load_czi-561"><a href="#Scan.load_czi-561"><span class="linenos">561</span></a>                <span class="nb">round</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">roi_limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Scan.load_czi-562"><a href="#Scan.load_czi-562"><span class="linenos">562</span></a>                <span class="nb">round</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">roi_limits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Scan.load_czi-563"><a href="#Scan.load_czi-563"><span class="linenos">563</span></a>                <span class="nb">round</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">roi_limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="Scan.load_czi-564"><a href="#Scan.load_czi-564"><span class="linenos">564</span></a>            <span class="p">]</span>
</span><span id="Scan.load_czi-565"><a href="#Scan.load_czi-565"><span class="linenos">565</span></a>            <span class="c1"># Bound the ROI to the actual scan limits</span>
</span><span id="Scan.load_czi-566"><a href="#Scan.load_czi-566"><span class="linenos">566</span></a>            <span class="n">roi_limits</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Scan.load_czi-567"><a href="#Scan.load_czi-567"><span class="linenos">567</span></a>                <span class="nb">max</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="Scan.load_czi-568"><a href="#Scan.load_czi-568"><span class="linenos">568</span></a>                <span class="nb">max</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="Scan.load_czi-569"><a href="#Scan.load_czi-569"><span class="linenos">569</span></a>                <span class="nb">min</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="Scan.load_czi-570"><a href="#Scan.load_czi-570"><span class="linenos">570</span></a>                <span class="nb">min</span><span class="p">(</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="Scan.load_czi-571"><a href="#Scan.load_czi-571"><span class="linenos">571</span></a>            <span class="p">]</span>
</span><span id="Scan.load_czi-572"><a href="#Scan.load_czi-572"><span class="linenos">572</span></a>
</span><span id="Scan.load_czi-573"><a href="#Scan.load_czi-573"><span class="linenos">573</span></a>            <span class="n">tile_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">roi_xml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Rows&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="Scan.load_czi-574"><a href="#Scan.load_czi-574"><span class="linenos">574</span></a>            <span class="c1"># Current best way of reliably extracting; &lt;Columns&gt; entry can be wrong</span>
</span><span id="Scan.load_czi-575"><a href="#Scan.load_czi-575"><span class="linenos">575</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">roi_shape</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="n">tile_rows</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Scan.load_czi-576"><a href="#Scan.load_czi-576"><span class="linenos">576</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Scan.load_czi-577"><a href="#Scan.load_czi-577"><span class="linenos">577</span></a>                    <span class="sa">f</span><span class="s2">&quot;The number of tiles </span><span class="si">{</span><span class="n">roi_shape</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not &quot;</span>
</span><span id="Scan.load_czi-578"><a href="#Scan.load_czi-578"><span class="linenos">578</span></a>                    <span class="sa">f</span><span class="s2">&quot;divisible by the tile rows </span><span class="si">{</span><span class="n">tile_rows</span><span class="si">}</span><span class="s2">; metadata &quot;</span>
</span><span id="Scan.load_czi-579"><a href="#Scan.load_czi-579"><span class="linenos">579</span></a>                    <span class="sa">f</span><span class="s2">&quot;must be messed up. Thanks Zeiss&quot;</span>
</span><span id="Scan.load_czi-580"><a href="#Scan.load_czi-580"><span class="linenos">580</span></a>                <span class="p">)</span>
</span><span id="Scan.load_czi-581"><a href="#Scan.load_czi-581"><span class="linenos">581</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Scan.load_czi-582"><a href="#Scan.load_czi-582"><span class="linenos">582</span></a>                <span class="n">tile_cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">roi_shape</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">tile_rows</span><span class="p">)</span>
</span><span id="Scan.load_czi-583"><a href="#Scan.load_czi-583"><span class="linenos">583</span></a>            <span class="c1"># Support points are actually the relevant focus points for this ROI</span>
</span><span id="Scan.load_czi-584"><a href="#Scan.load_czi-584"><span class="linenos">584</span></a>            <span class="n">focus_points</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scan.load_czi-585"><a href="#Scan.load_czi-585"><span class="linenos">585</span></a>            <span class="k">for</span> <span class="n">focus_point</span> <span class="ow">in</span> <span class="n">roi_xml</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;SupportPoints/SupportPoint&quot;</span><span class="p">):</span>
</span><span id="Scan.load_czi-586"><a href="#Scan.load_czi-586"><span class="linenos">586</span></a>                <span class="n">focus_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="Scan.load_czi-587"><a href="#Scan.load_czi-587"><span class="linenos">587</span></a>                    <span class="p">[</span>
</span><span id="Scan.load_czi-588"><a href="#Scan.load_czi-588"><span class="linenos">588</span></a>                        <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">focus_point</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)),</span>
</span><span id="Scan.load_czi-589"><a href="#Scan.load_czi-589"><span class="linenos">589</span></a>                        <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">focus_point</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)),</span>
</span><span id="Scan.load_czi-590"><a href="#Scan.load_czi-590"><span class="linenos">590</span></a>                        <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">focus_point</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)),</span>
</span><span id="Scan.load_czi-591"><a href="#Scan.load_czi-591"><span class="linenos">591</span></a>                    <span class="p">]</span>
</span><span id="Scan.load_czi-592"><a href="#Scan.load_czi-592"><span class="linenos">592</span></a>                <span class="p">)</span>
</span><span id="Scan.load_czi-593"><a href="#Scan.load_czi-593"><span class="linenos">593</span></a>            <span class="c1"># Strip all sub-micron precision, it does not matter</span>
</span><span id="Scan.load_czi-594"><a href="#Scan.load_czi-594"><span class="linenos">594</span></a>            <span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="Scan.load_czi-595"><a href="#Scan.load_czi-595"><span class="linenos">595</span></a>                <span class="bp">cls</span><span class="o">.</span><span class="n">ROI</span><span class="p">(</span>
</span><span id="Scan.load_czi-596"><a href="#Scan.load_czi-596"><span class="linenos">596</span></a>                    <span class="n">origin_x_um</span><span class="o">=</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Scan.load_czi-597"><a href="#Scan.load_czi-597"><span class="linenos">597</span></a>                    <span class="n">origin_y_um</span><span class="o">=</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="Scan.load_czi-598"><a href="#Scan.load_czi-598"><span class="linenos">598</span></a>                    <span class="n">width_um</span><span class="o">=</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">roi_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Scan.load_czi-599"><a href="#Scan.load_czi-599"><span class="linenos">599</span></a>                    <span class="n">height_um</span><span class="o">=</span><span class="n">roi_limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">roi_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="Scan.load_czi-600"><a href="#Scan.load_czi-600"><span class="linenos">600</span></a>                    <span class="n">tile_rows</span><span class="o">=</span><span class="n">tile_rows</span><span class="p">,</span>
</span><span id="Scan.load_czi-601"><a href="#Scan.load_czi-601"><span class="linenos">601</span></a>                    <span class="n">tile_cols</span><span class="o">=</span><span class="n">tile_cols</span><span class="p">,</span>
</span><span id="Scan.load_czi-602"><a href="#Scan.load_czi-602"><span class="linenos">602</span></a>                    <span class="n">focus_points</span><span class="o">=</span><span class="n">focus_points</span><span class="p">,</span>
</span><span id="Scan.load_czi-603"><a href="#Scan.load_czi-603"><span class="linenos">603</span></a>                <span class="p">)</span>
</span><span id="Scan.load_czi-604"><a href="#Scan.load_czi-604"><span class="linenos">604</span></a>            <span class="p">)</span>
</span><span id="Scan.load_czi-605"><a href="#Scan.load_czi-605"><span class="linenos">605</span></a>        <span class="c1"># Sort based on the scene indices</span>
</span><span id="Scan.load_czi-606"><a href="#Scan.load_czi-606"><span class="linenos">606</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="p">[</span><span class="n">roi</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">roi</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">roi_indices</span><span class="p">,</span> <span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="p">))]</span>
</span><span id="Scan.load_czi-607"><a href="#Scan.load_czi-607"><span class="linenos">607</span></a>
</span><span id="Scan.load_czi-608"><a href="#Scan.load_czi-608"><span class="linenos">608</span></a>        <span class="k">return</span> <span class="n">scan</span>
</span></pre></div>


            <div class="docstring"><p>Extracts metadata from a .czi file, which is the output of the Axioscan</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>input_path</strong>:  the path to the .czi file</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a Scan object</p>
</blockquote>
</div>


                            </div>
                            <div id="Scan.load_txt" class="classattr">
                                        <input id="Scan.load_txt-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">load_txt</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Self</span>:</span></span>

                <label class="view-source-button" for="Scan.load_txt-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scan.load_txt"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scan.load_txt-610"><a href="#Scan.load_txt-610"><span class="linenos">610</span></a>    <span class="nd">@classmethod</span>
</span><span id="Scan.load_txt-611"><a href="#Scan.load_txt-611"><span class="linenos">611</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_txt</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="Scan.load_txt-612"><a href="#Scan.load_txt-612"><span class="linenos">612</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan.load_txt-613"><a href="#Scan.load_txt-613"><span class="linenos">613</span></a><span class="sd">        Loads a Scan object from a .txt file, usually slideinfo.txt, which originates</span>
</span><span id="Scan.load_txt-614"><a href="#Scan.load_txt-614"><span class="linenos">614</span></a><span class="sd">        from the BZScanner. Some metadata is filled in or adjusted to fit</span>
</span><span id="Scan.load_txt-615"><a href="#Scan.load_txt-615"><span class="linenos">615</span></a><span class="sd">        :param input_path: /path/to/file.txt or /path/to/folder containing slideinfo.txt</span>
</span><span id="Scan.load_txt-616"><a href="#Scan.load_txt-616"><span class="linenos">616</span></a><span class="sd">        :return: a Scan object</span>
</span><span id="Scan.load_txt-617"><a href="#Scan.load_txt-617"><span class="linenos">617</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan.load_txt-618"><a href="#Scan.load_txt-618"><span class="linenos">618</span></a>        <span class="c1"># Set paths</span>
</span><span id="Scan.load_txt-619"><a href="#Scan.load_txt-619"><span class="linenos">619</span></a>        <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="Scan.load_txt-620"><a href="#Scan.load_txt-620"><span class="linenos">620</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">input_path</span><span class="p">):</span>
</span><span id="Scan.load_txt-621"><a href="#Scan.load_txt-621"><span class="linenos">621</span></a>            <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="Scan.load_txt-622"><a href="#Scan.load_txt-622"><span class="linenos">622</span></a>                <span class="n">input_path</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">METADATA_FILE_NAME</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">]</span>
</span><span id="Scan.load_txt-623"><a href="#Scan.load_txt-623"><span class="linenos">623</span></a>            <span class="p">)</span>
</span><span id="Scan.load_txt-624"><a href="#Scan.load_txt-624"><span class="linenos">624</span></a>
</span><span id="Scan.load_txt-625"><a href="#Scan.load_txt-625"><span class="linenos">625</span></a>        <span class="c1"># Read in metadata as a dict</span>
</span><span id="Scan.load_txt-626"><a href="#Scan.load_txt-626"><span class="linenos">626</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="Scan.load_txt-627"><a href="#Scan.load_txt-627"><span class="linenos">627</span></a>            <span class="n">metadata_contents</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="Scan.load_txt-628"><a href="#Scan.load_txt-628"><span class="linenos">628</span></a>            <span class="c1"># Read each line, splitting on the = sign</span>
</span><span id="Scan.load_txt-629"><a href="#Scan.load_txt-629"><span class="linenos">629</span></a>            <span class="n">metadata_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Scan.load_txt-630"><a href="#Scan.load_txt-630"><span class="linenos">630</span></a>            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">metadata_contents</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
</span><span id="Scan.load_txt-631"><a href="#Scan.load_txt-631"><span class="linenos">631</span></a>                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
</span><span id="Scan.load_txt-632"><a href="#Scan.load_txt-632"><span class="linenos">632</span></a>                <span class="n">metadata_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="Scan.load_txt-633"><a href="#Scan.load_txt-633"><span class="linenos">633</span></a>
</span><span id="Scan.load_txt-634"><a href="#Scan.load_txt-634"><span class="linenos">634</span></a>        <span class="c1"># Populate metadata</span>
</span><span id="Scan.load_txt-635"><a href="#Scan.load_txt-635"><span class="linenos">635</span></a>        <span class="n">scan</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
</span><span id="Scan.load_txt-636"><a href="#Scan.load_txt-636"><span class="linenos">636</span></a>
</span><span id="Scan.load_txt-637"><a href="#Scan.load_txt-637"><span class="linenos">637</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;SLIDEID&quot;</span><span class="p">]</span>
</span><span id="Scan.load_txt-638"><a href="#Scan.load_txt-638"><span class="linenos">638</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="Scan.load_txt-639"><a href="#Scan.load_txt-639"><span class="linenos">639</span></a>
</span><span id="Scan.load_txt-640"><a href="#Scan.load_txt-640"><span class="linenos">640</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;SLIDEDIR&quot;</span><span class="p">]</span>
</span><span id="Scan.load_txt-641"><a href="#Scan.load_txt-641"><span class="linenos">641</span></a>
</span><span id="Scan.load_txt-642"><a href="#Scan.load_txt-642"><span class="linenos">642</span></a>        <span class="c1"># Extract start and finish datetimes</span>
</span><span id="Scan.load_txt-643"><a href="#Scan.load_txt-643"><span class="linenos">643</span></a>        <span class="n">date</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span>
</span><span id="Scan.load_txt-644"><a href="#Scan.load_txt-644"><span class="linenos">644</span></a>        <span class="n">date_as_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
</span><span id="Scan.load_txt-645"><a href="#Scan.load_txt-645"><span class="linenos">645</span></a>            <span class="n">date</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DATETIME_FORMAT</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">]</span>
</span><span id="Scan.load_txt-646"><a href="#Scan.load_txt-646"><span class="linenos">646</span></a>        <span class="p">)</span>
</span><span id="Scan.load_txt-647"><a href="#Scan.load_txt-647"><span class="linenos">647</span></a>        <span class="n">date_as_datetime</span> <span class="o">=</span> <span class="n">date_as_datetime</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span>
</span><span id="Scan.load_txt-648"><a href="#Scan.load_txt-648"><span class="linenos">648</span></a>            <span class="n">zoneinfo</span><span class="o">.</span><span class="n">ZoneInfo</span><span class="p">(</span><span class="s2">&quot;America/Los_Angeles&quot;</span><span class="p">)</span>
</span><span id="Scan.load_txt-649"><a href="#Scan.load_txt-649"><span class="linenos">649</span></a>        <span class="p">)</span>  <span class="c1"># Hardcoded because BZScanners are here</span>
</span><span id="Scan.load_txt-650"><a href="#Scan.load_txt-650"><span class="linenos">650</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">start_datetime</span> <span class="o">=</span> <span class="n">date_as_datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">STANDARD_DATETIME_FORMAT</span><span class="p">)</span>
</span><span id="Scan.load_txt-651"><a href="#Scan.load_txt-651"><span class="linenos">651</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">scan_time_s</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">*</span> <span class="mi">60</span>  <span class="c1"># estimated 90 minutes per scan</span>
</span><span id="Scan.load_txt-652"><a href="#Scan.load_txt-652"><span class="linenos">652</span></a>        <span class="n">date_as_datetime</span> <span class="o">+=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">scan</span><span class="o">.</span><span class="n">scan_time_s</span><span class="p">)</span>
</span><span id="Scan.load_txt-653"><a href="#Scan.load_txt-653"><span class="linenos">653</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">end_datetime</span> <span class="o">=</span> <span class="n">date_as_datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">STANDARD_DATETIME_FORMAT</span><span class="p">)</span>
</span><span id="Scan.load_txt-654"><a href="#Scan.load_txt-654"><span class="linenos">654</span></a>
</span><span id="Scan.load_txt-655"><a href="#Scan.load_txt-655"><span class="linenos">655</span></a>        <span class="c1"># Map the raw scanner ID (service ID) to our IDs</span>
</span><span id="Scan.load_txt-656"><a href="#Scan.load_txt-656"><span class="linenos">656</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;INSTRUMENT&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Scan.load_txt-657"><a href="#Scan.load_txt-657"><span class="linenos">657</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tray_pos</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># only one tray_pos in a BZScanner</span>
</span><span id="Scan.load_txt-658"><a href="#Scan.load_txt-658"><span class="linenos">658</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">slide_pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;SLIDEPOS&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># 1-indexed</span>
</span><span id="Scan.load_txt-659"><a href="#Scan.load_txt-659"><span class="linenos">659</span></a>
</span><span id="Scan.load_txt-660"><a href="#Scan.load_txt-660"><span class="linenos">660</span></a>        <span class="c1"># Get camera and magnifying info</span>
</span><span id="Scan.load_txt-661"><a href="#Scan.load_txt-661"><span class="linenos">661</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="Scan.load_txt-662"><a href="#Scan.load_txt-662"><span class="linenos">662</span></a>        <span class="n">magnification</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="Scan.load_txt-663"><a href="#Scan.load_txt-663"><span class="linenos">663</span></a>        <span class="n">aperture</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># TODO: find the actual aperture</span>
</span><span id="Scan.load_txt-664"><a href="#Scan.load_txt-664"><span class="linenos">664</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">objective</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">magnification</span><span class="si">}</span><span class="s2">x-</span><span class="si">{</span><span class="n">aperture</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Scan.load_txt-665"><a href="#Scan.load_txt-665"><span class="linenos">665</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span> <span class="o">=</span> <span class="mf">0.591</span>  <span class="c1"># Estimated from image metadata</span>
</span><span id="Scan.load_txt-666"><a href="#Scan.load_txt-666"><span class="linenos">666</span></a>
</span><span id="Scan.load_txt-667"><a href="#Scan.load_txt-667"><span class="linenos">667</span></a>        <span class="c1"># Get tile information</span>
</span><span id="Scan.load_txt-668"><a href="#Scan.load_txt-668"><span class="linenos">668</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">=</span> <span class="mi">1362</span>  <span class="c1"># Known from image metadata</span>
</span><span id="Scan.load_txt-669"><a href="#Scan.load_txt-669"><span class="linenos">669</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">=</span> <span class="mi">1004</span>  <span class="c1"># Known from image metadata</span>
</span><span id="Scan.load_txt-670"><a href="#Scan.load_txt-670"><span class="linenos">670</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_x_offset_px</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Already removed</span>
</span><span id="Scan.load_txt-671"><a href="#Scan.load_txt-671"><span class="linenos">671</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_y_offset_px</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Already removed</span>
</span><span id="Scan.load_txt-672"><a href="#Scan.load_txt-672"><span class="linenos">672</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">tile_overlap_proportion</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Already removed</span>
</span><span id="Scan.load_txt-673"><a href="#Scan.load_txt-673"><span class="linenos">673</span></a>
</span><span id="Scan.load_txt-674"><a href="#Scan.load_txt-674"><span class="linenos">674</span></a>        <span class="c1"># Extract channels and create Channel objects from them</span>
</span><span id="Scan.load_txt-675"><a href="#Scan.load_txt-675"><span class="linenos">675</span></a>        <span class="k">if</span> <span class="s2">&quot;gain_applied&quot;</span> <span class="ow">in</span> <span class="n">metadata_dict</span><span class="p">:</span>
</span><span id="Scan.load_txt-676"><a href="#Scan.load_txt-676"><span class="linenos">676</span></a>            <span class="n">gain_applied</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;gain_applied&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="k">else</span> <span class="kc">False</span>
</span><span id="Scan.load_txt-677"><a href="#Scan.load_txt-677"><span class="linenos">677</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Scan.load_txt-678"><a href="#Scan.load_txt-678"><span class="linenos">678</span></a>            <span class="n">gain_applied</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Previous policy was always to apply gains</span>
</span><span id="Scan.load_txt-679"><a href="#Scan.load_txt-679"><span class="linenos">679</span></a>        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">BZSCANNER_CHANNEL_MAP</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="Scan.load_txt-680"><a href="#Scan.load_txt-680"><span class="linenos">680</span></a>            <span class="n">channel_settings</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span><span id="Scan.load_txt-681"><a href="#Scan.load_txt-681"><span class="linenos">681</span></a>            <span class="k">if</span> <span class="n">channel_settings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
</span><span id="Scan.load_txt-682"><a href="#Scan.load_txt-682"><span class="linenos">682</span></a>                <span class="k">continue</span>
</span><span id="Scan.load_txt-683"><a href="#Scan.load_txt-683"><span class="linenos">683</span></a>            <span class="n">scan</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="Scan.load_txt-684"><a href="#Scan.load_txt-684"><span class="linenos">684</span></a>                <span class="bp">cls</span><span class="o">.</span><span class="n">Channel</span><span class="p">(</span>
</span><span id="Scan.load_txt-685"><a href="#Scan.load_txt-685"><span class="linenos">685</span></a>                    <span class="n">name</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">BZSCANNER_CHANNEL_MAP</span><span class="p">[</span><span class="n">channel</span><span class="p">],</span>
</span><span id="Scan.load_txt-686"><a href="#Scan.load_txt-686"><span class="linenos">686</span></a>                    <span class="n">exposure_ms</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">channel_settings</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="Scan.load_txt-687"><a href="#Scan.load_txt-687"><span class="linenos">687</span></a>                    <span class="n">intensity</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">channel_settings</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="Scan.load_txt-688"><a href="#Scan.load_txt-688"><span class="linenos">688</span></a>                    <span class="n">gain_applied</span><span class="o">=</span><span class="n">gain_applied</span><span class="p">,</span>
</span><span id="Scan.load_txt-689"><a href="#Scan.load_txt-689"><span class="linenos">689</span></a>                <span class="p">)</span>
</span><span id="Scan.load_txt-690"><a href="#Scan.load_txt-690"><span class="linenos">690</span></a>            <span class="p">)</span>
</span><span id="Scan.load_txt-691"><a href="#Scan.load_txt-691"><span class="linenos">691</span></a>
</span><span id="Scan.load_txt-692"><a href="#Scan.load_txt-692"><span class="linenos">692</span></a>        <span class="c1"># Get focus points</span>
</span><span id="Scan.load_txt-693"><a href="#Scan.load_txt-693"><span class="linenos">693</span></a>        <span class="n">focus_points</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scan.load_txt-694"><a href="#Scan.load_txt-694"><span class="linenos">694</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">33</span><span class="p">):</span>
</span><span id="Scan.load_txt-695"><a href="#Scan.load_txt-695"><span class="linenos">695</span></a>            <span class="n">focus_point</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;FOCUSPOS&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span><span id="Scan.load_txt-696"><a href="#Scan.load_txt-696"><span class="linenos">696</span></a>            <span class="k">if</span> <span class="n">focus_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
</span><span id="Scan.load_txt-697"><a href="#Scan.load_txt-697"><span class="linenos">697</span></a>                <span class="k">break</span>
</span><span id="Scan.load_txt-698"><a href="#Scan.load_txt-698"><span class="linenos">698</span></a>            <span class="n">focus_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="Scan.load_txt-699"><a href="#Scan.load_txt-699"><span class="linenos">699</span></a>                <span class="p">[</span>
</span><span id="Scan.load_txt-700"><a href="#Scan.load_txt-700"><span class="linenos">700</span></a>                    <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">focus_point</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
</span><span id="Scan.load_txt-701"><a href="#Scan.load_txt-701"><span class="linenos">701</span></a>                    <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">focus_point</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span>
</span><span id="Scan.load_txt-702"><a href="#Scan.load_txt-702"><span class="linenos">702</span></a>                    <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">focus_point</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
</span><span id="Scan.load_txt-703"><a href="#Scan.load_txt-703"><span class="linenos">703</span></a>                <span class="p">]</span>
</span><span id="Scan.load_txt-704"><a href="#Scan.load_txt-704"><span class="linenos">704</span></a>            <span class="p">)</span>
</span><span id="Scan.load_txt-705"><a href="#Scan.load_txt-705"><span class="linenos">705</span></a>
</span><span id="Scan.load_txt-706"><a href="#Scan.load_txt-706"><span class="linenos">706</span></a>        <span class="c1"># In the BZScanner, the slide is vertical instead of horizontal</span>
</span><span id="Scan.load_txt-707"><a href="#Scan.load_txt-707"><span class="linenos">707</span></a>        <span class="c1"># We put in nominal values for the ROI, which is oriented vertically as well</span>
</span><span id="Scan.load_txt-708"><a href="#Scan.load_txt-708"><span class="linenos">708</span></a>        <span class="n">tile_rows</span> <span class="o">=</span> <span class="mi">96</span>
</span><span id="Scan.load_txt-709"><a href="#Scan.load_txt-709"><span class="linenos">709</span></a>        <span class="n">tile_cols</span> <span class="o">=</span> <span class="mi">24</span>
</span><span id="Scan.load_txt-710"><a href="#Scan.load_txt-710"><span class="linenos">710</span></a>        <span class="n">roi_width</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span> <span class="o">*</span> <span class="n">scan</span><span class="o">.</span><span class="n">tile_width_px</span> <span class="o">*</span> <span class="n">tile_cols</span><span class="p">)</span>
</span><span id="Scan.load_txt-711"><a href="#Scan.load_txt-711"><span class="linenos">711</span></a>        <span class="n">roi_height</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">pixel_size_um</span> <span class="o">*</span> <span class="n">scan</span><span class="o">.</span><span class="n">tile_height_px</span> <span class="o">*</span> <span class="n">tile_rows</span><span class="p">)</span>
</span><span id="Scan.load_txt-712"><a href="#Scan.load_txt-712"><span class="linenos">712</span></a>        <span class="n">origin_x_um</span> <span class="o">=</span> <span class="mi">2500</span> <span class="o">+</span> <span class="nb">round</span><span class="p">((</span><span class="mi">20000</span> <span class="o">-</span> <span class="n">roi_width</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="Scan.load_txt-713"><a href="#Scan.load_txt-713"><span class="linenos">713</span></a>        <span class="n">origin_y_um</span> <span class="o">=</span> <span class="mi">2500</span> <span class="o">+</span> <span class="nb">round</span><span class="p">((</span><span class="mi">58000</span> <span class="o">-</span> <span class="n">roi_height</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="Scan.load_txt-714"><a href="#Scan.load_txt-714"><span class="linenos">714</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="Scan.load_txt-715"><a href="#Scan.load_txt-715"><span class="linenos">715</span></a>            <span class="bp">cls</span><span class="o">.</span><span class="n">ROI</span><span class="p">(</span>
</span><span id="Scan.load_txt-716"><a href="#Scan.load_txt-716"><span class="linenos">716</span></a>                <span class="n">origin_x_um</span><span class="o">=</span><span class="n">origin_x_um</span><span class="p">,</span>
</span><span id="Scan.load_txt-717"><a href="#Scan.load_txt-717"><span class="linenos">717</span></a>                <span class="n">origin_y_um</span><span class="o">=</span><span class="n">origin_y_um</span><span class="p">,</span>
</span><span id="Scan.load_txt-718"><a href="#Scan.load_txt-718"><span class="linenos">718</span></a>                <span class="n">width_um</span><span class="o">=</span><span class="n">roi_width</span><span class="p">,</span>
</span><span id="Scan.load_txt-719"><a href="#Scan.load_txt-719"><span class="linenos">719</span></a>                <span class="n">height_um</span><span class="o">=</span><span class="n">roi_height</span><span class="p">,</span>
</span><span id="Scan.load_txt-720"><a href="#Scan.load_txt-720"><span class="linenos">720</span></a>                <span class="n">tile_rows</span><span class="o">=</span><span class="n">tile_rows</span><span class="p">,</span>
</span><span id="Scan.load_txt-721"><a href="#Scan.load_txt-721"><span class="linenos">721</span></a>                <span class="n">tile_cols</span><span class="o">=</span><span class="n">tile_cols</span><span class="p">,</span>
</span><span id="Scan.load_txt-722"><a href="#Scan.load_txt-722"><span class="linenos">722</span></a>                <span class="n">focus_points</span><span class="o">=</span><span class="n">focus_points</span><span class="p">,</span>
</span><span id="Scan.load_txt-723"><a href="#Scan.load_txt-723"><span class="linenos">723</span></a>            <span class="p">)</span>
</span><span id="Scan.load_txt-724"><a href="#Scan.load_txt-724"><span class="linenos">724</span></a>        <span class="p">)</span>
</span><span id="Scan.load_txt-725"><a href="#Scan.load_txt-725"><span class="linenos">725</span></a>        <span class="k">return</span> <span class="n">scan</span>
</span></pre></div>


            <div class="docstring"><p>Loads a Scan object from a .txt file, usually slideinfo.txt, which originates
from the BZScanner. Some metadata is filled in or adjusted to fit</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>input_path</strong>:  /path/to/file.txt or /path/to/folder containing slideinfo.txt</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a Scan object</p>
</blockquote>
</div>


                            </div>
                            <div id="Scan.load_from_folder" class="classattr">
                                        <input id="Scan.load_from_folder-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">load_from_folder</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Self</span>:</span></span>

                <label class="view-source-button" for="Scan.load_from_folder-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scan.load_from_folder"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scan.load_from_folder-727"><a href="#Scan.load_from_folder-727"><span class="linenos">727</span></a>    <span class="nd">@classmethod</span>
</span><span id="Scan.load_from_folder-728"><a href="#Scan.load_from_folder-728"><span class="linenos">728</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_from_folder</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="Scan.load_from_folder-729"><a href="#Scan.load_from_folder-729"><span class="linenos">729</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan.load_from_folder-730"><a href="#Scan.load_from_folder-730"><span class="linenos">730</span></a><span class="sd">        Load a Scan object from a folder that contains defaultly-named metadata files,</span>
</span><span id="Scan.load_from_folder-731"><a href="#Scan.load_from_folder-731"><span class="linenos">731</span></a><span class="sd">        scan.yaml or slideinfo.txt. Prefers scan.yaml if both exist</span>
</span><span id="Scan.load_from_folder-732"><a href="#Scan.load_from_folder-732"><span class="linenos">732</span></a><span class="sd">        :param input_path: /path/to/folder</span>
</span><span id="Scan.load_from_folder-733"><a href="#Scan.load_from_folder-733"><span class="linenos">733</span></a><span class="sd">        :return: a Scan object</span>
</span><span id="Scan.load_from_folder-734"><a href="#Scan.load_from_folder-734"><span class="linenos">734</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan.load_from_folder-735"><a href="#Scan.load_from_folder-735"><span class="linenos">735</span></a>        <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="Scan.load_from_folder-736"><a href="#Scan.load_from_folder-736"><span class="linenos">736</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span>
</span><span id="Scan.load_from_folder-737"><a href="#Scan.load_from_folder-737"><span class="linenos">737</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">METADATA_FILE_NAME</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">])</span>
</span><span id="Scan.load_from_folder-738"><a href="#Scan.load_from_folder-738"><span class="linenos">738</span></a>        <span class="p">):</span>
</span><span id="Scan.load_from_folder-739"><a href="#Scan.load_from_folder-739"><span class="linenos">739</span></a>            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">load_yaml</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="Scan.load_from_folder-740"><a href="#Scan.load_from_folder-740"><span class="linenos">740</span></a>        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span>
</span><span id="Scan.load_from_folder-741"><a href="#Scan.load_from_folder-741"><span class="linenos">741</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">METADATA_FILE_NAME</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">])</span>
</span><span id="Scan.load_from_folder-742"><a href="#Scan.load_from_folder-742"><span class="linenos">742</span></a>        <span class="p">):</span>
</span><span id="Scan.load_from_folder-743"><a href="#Scan.load_from_folder-743"><span class="linenos">743</span></a>            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">load_txt</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
</span><span id="Scan.load_from_folder-744"><a href="#Scan.load_from_folder-744"><span class="linenos">744</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Scan.load_from_folder-745"><a href="#Scan.load_from_folder-745"><span class="linenos">745</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Scan.load_from_folder-746"><a href="#Scan.load_from_folder-746"><span class="linenos">746</span></a>                <span class="sa">f</span><span class="s2">&quot;No scan metadata files &quot;</span>
</span><span id="Scan.load_from_folder-747"><a href="#Scan.load_from_folder-747"><span class="linenos">747</span></a>                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">METADATA_FILE_NAME</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="Scan.load_from_folder-748"><a href="#Scan.load_from_folder-748"><span class="linenos">748</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">METADATA_FILE_NAME</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">]</span><span class="si">}</span><span class="s2">) found in folder &quot;</span>
</span><span id="Scan.load_from_folder-749"><a href="#Scan.load_from_folder-749"><span class="linenos">749</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Scan.load_from_folder-750"><a href="#Scan.load_from_folder-750"><span class="linenos">750</span></a>            <span class="p">)</span>
</span><span id="Scan.load_from_folder-751"><a href="#Scan.load_from_folder-751"><span class="linenos">751</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Load a Scan object from a folder that contains defaultly-named metadata files,
scan.yaml or slideinfo.txt. Prefers scan.yaml if both exist</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>input_path</strong>:  /path/to/folder</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a Scan object</p>
</blockquote>
</div>


                            </div>
                            <div id="Scan.make_placeholder" class="classattr">
                                        <input id="Scan.make_placeholder-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">make_placeholder</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">cls</span>,</span><span class="param">	<span class="n">slide_id</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">n_tile</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2303</span>,</span><span class="param">	<span class="n">n_roi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">scanner_type</span><span class="p">:</span> <span class="n"><a href="#Scan.Type">Scan.Type</a></span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">:</span> <span class="s1">&#39;bzscanner&#39;</span><span class="o">&gt;</span></span><span class="return-annotation">) -> <span class="n">Self</span>:</span></span>

                <label class="view-source-button" for="Scan.make_placeholder-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scan.make_placeholder"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scan.make_placeholder-753"><a href="#Scan.make_placeholder-753"><span class="linenos">753</span></a>    <span class="nd">@classmethod</span>
</span><span id="Scan.make_placeholder-754"><a href="#Scan.make_placeholder-754"><span class="linenos">754</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">make_placeholder</span><span class="p">(</span>
</span><span id="Scan.make_placeholder-755"><a href="#Scan.make_placeholder-755"><span class="linenos">755</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="Scan.make_placeholder-756"><a href="#Scan.make_placeholder-756"><span class="linenos">756</span></a>        <span class="n">slide_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Scan.make_placeholder-757"><a href="#Scan.make_placeholder-757"><span class="linenos">757</span></a>        <span class="n">n_tile</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2303</span><span class="p">,</span>
</span><span id="Scan.make_placeholder-758"><a href="#Scan.make_placeholder-758"><span class="linenos">758</span></a>        <span class="n">n_roi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Scan.make_placeholder-759"><a href="#Scan.make_placeholder-759"><span class="linenos">759</span></a>        <span class="n">scanner_type</span><span class="p">:</span> <span class="n">Type</span> <span class="o">=</span> <span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">,</span>
</span><span id="Scan.make_placeholder-760"><a href="#Scan.make_placeholder-760"><span class="linenos">760</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="Scan.make_placeholder-761"><a href="#Scan.make_placeholder-761"><span class="linenos">761</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan.make_placeholder-762"><a href="#Scan.make_placeholder-762"><span class="linenos">762</span></a><span class="sd">        Make a placeholder Scan object with only basic required information filled in.</span>
</span><span id="Scan.make_placeholder-763"><a href="#Scan.make_placeholder-763"><span class="linenos">763</span></a><span class="sd">        :param slide_id: the slide ID</span>
</span><span id="Scan.make_placeholder-764"><a href="#Scan.make_placeholder-764"><span class="linenos">764</span></a><span class="sd">        :param n_tile: the number of this tile, which will become the number of</span>
</span><span id="Scan.make_placeholder-765"><a href="#Scan.make_placeholder-765"><span class="linenos">765</span></a><span class="sd">                       tiles in the scan</span>
</span><span id="Scan.make_placeholder-766"><a href="#Scan.make_placeholder-766"><span class="linenos">766</span></a><span class="sd">        :param n_roi: the number of ROIs in the scan</span>
</span><span id="Scan.make_placeholder-767"><a href="#Scan.make_placeholder-767"><span class="linenos">767</span></a><span class="sd">        :return: a Scan object</span>
</span><span id="Scan.make_placeholder-768"><a href="#Scan.make_placeholder-768"><span class="linenos">768</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan.make_placeholder-769"><a href="#Scan.make_placeholder-769"><span class="linenos">769</span></a>        <span class="c1"># Sanitize inputs here</span>
</span><span id="Scan.make_placeholder-770"><a href="#Scan.make_placeholder-770"><span class="linenos">770</span></a>        <span class="n">slide_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">slide_id</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="Scan.make_placeholder-771"><a href="#Scan.make_placeholder-771"><span class="linenos">771</span></a>        <span class="n">n_tile</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_tile</span><span class="p">)</span>
</span><span id="Scan.make_placeholder-772"><a href="#Scan.make_placeholder-772"><span class="linenos">772</span></a>        <span class="n">n_roi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_roi</span><span class="p">)</span>
</span><span id="Scan.make_placeholder-773"><a href="#Scan.make_placeholder-773"><span class="linenos">773</span></a>        <span class="c1"># Generate the object</span>
</span><span id="Scan.make_placeholder-774"><a href="#Scan.make_placeholder-774"><span class="linenos">774</span></a>        <span class="n">scan</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
</span><span id="Scan.make_placeholder-775"><a href="#Scan.make_placeholder-775"><span class="linenos">775</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">slide_id</span> <span class="o">=</span> <span class="n">slide_id</span>
</span><span id="Scan.make_placeholder-776"><a href="#Scan.make_placeholder-776"><span class="linenos">776</span></a>        <span class="k">if</span> <span class="n">scanner_type</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="p">:</span>
</span><span id="Scan.make_placeholder-777"><a href="#Scan.make_placeholder-777"><span class="linenos">777</span></a>            <span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">AXIOSCAN7</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">_placeholder&quot;</span>
</span><span id="Scan.make_placeholder-778"><a href="#Scan.make_placeholder-778"><span class="linenos">778</span></a>        <span class="k">elif</span> <span class="n">scanner_type</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="p">:</span>
</span><span id="Scan.make_placeholder-779"><a href="#Scan.make_placeholder-779"><span class="linenos">779</span></a>            <span class="n">scan</span><span class="o">.</span><span class="n">scanner_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">BZSCANNER</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">_placeholder&quot;</span>
</span><span id="Scan.make_placeholder-780"><a href="#Scan.make_placeholder-780"><span class="linenos">780</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">ROI</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_roi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
</span><span id="Scan.make_placeholder-781"><a href="#Scan.make_placeholder-781"><span class="linenos">781</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tile_rows</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Scan.make_placeholder-782"><a href="#Scan.make_placeholder-782"><span class="linenos">782</span></a>        <span class="n">scan</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tile_cols</span> <span class="o">=</span> <span class="n">n_tile</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="Scan.make_placeholder-783"><a href="#Scan.make_placeholder-783"><span class="linenos">783</span></a>        <span class="k">return</span> <span class="n">scan</span>
</span></pre></div>


            <div class="docstring"><p>Make a placeholder Scan object with only basic required information filled in.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>slide_id</strong>:  the slide ID</li>
<li><strong>n_tile</strong>:  the number of this tile, which will become the number of
tiles in the scan</li>
<li><strong>n_roi</strong>:  the number of ROIs in the scan</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a Scan object</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="Scan.Type">
                            <input id="Scan.Type-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Scan.Type</span><wbr>(<span class="base">enum.Enum</span>):

                <label class="view-source-button" for="Scan.Type-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scan.Type"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scan.Type-34"><a href="#Scan.Type-34"><span class="linenos">34</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Type</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
</span><span id="Scan.Type-35"><a href="#Scan.Type-35"><span class="linenos">35</span></a>        <span class="n">BZSCANNER</span> <span class="o">=</span> <span class="s2">&quot;bzscanner&quot;</span>
</span><span id="Scan.Type-36"><a href="#Scan.Type-36"><span class="linenos">36</span></a>        <span class="n">AXIOSCAN7</span> <span class="o">=</span> <span class="s2">&quot;axioscan7&quot;</span>
</span></pre></div>


    

                            <div id="Scan.Type.BZSCANNER" class="classattr">
                                <div class="attr variable">
            <span class="name">BZSCANNER</span>        =
<span class="default_value">&lt;Type.BZSCANNER: &#39;bzscanner&#39;&gt;</span>

        
    </div>
    <a class="headerlink" href="#Scan.Type.BZSCANNER"></a>
    
    

                            </div>
                            <div id="Scan.Type.AXIOSCAN7" class="classattr">
                                <div class="attr variable">
            <span class="name">AXIOSCAN7</span>        =
<span class="default_value">&lt;Type.AXIOSCAN7: &#39;axioscan7&#39;&gt;</span>

        
    </div>
    <a class="headerlink" href="#Scan.Type.AXIOSCAN7"></a>
    
    

                            </div>
                </section>
                <section id="Scan.Channel">
                            <input id="Scan.Channel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Scan.Channel</span><wbr>(<span class="base">yaml.YAMLObject</span>):

                <label class="view-source-button" for="Scan.Channel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scan.Channel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scan.Channel-60"><a href="#Scan.Channel-60"><span class="linenos">60</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Channel</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">YAMLObject</span><span class="p">):</span>
</span><span id="Scan.Channel-61"><a href="#Scan.Channel-61"><span class="linenos">61</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan.Channel-62"><a href="#Scan.Channel-62"><span class="linenos">62</span></a><span class="sd">        Class that comprises a channel; we usually have multiple (2-5) per scan.</span>
</span><span id="Scan.Channel-63"><a href="#Scan.Channel-63"><span class="linenos">63</span></a><span class="sd">        Contains three fields:</span>
</span><span id="Scan.Channel-64"><a href="#Scan.Channel-64"><span class="linenos">64</span></a><span class="sd">        - name: the name of the channel (e.g. DAPI, AF647, AF555, AF488, BRIGHTFIELD)</span>
</span><span id="Scan.Channel-65"><a href="#Scan.Channel-65"><span class="linenos">65</span></a><span class="sd">        - exposure_ms: the exposure time to capture a frame in milliseconds</span>
</span><span id="Scan.Channel-66"><a href="#Scan.Channel-66"><span class="linenos">66</span></a><span class="sd">        - intensity: the light intensity used OR the gain applied to the channel</span>
</span><span id="Scan.Channel-67"><a href="#Scan.Channel-67"><span class="linenos">67</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan.Channel-68"><a href="#Scan.Channel-68"><span class="linenos">68</span></a>
</span><span id="Scan.Channel-69"><a href="#Scan.Channel-69"><span class="linenos">69</span></a>        <span class="n">yaml_tag</span> <span class="o">=</span> <span class="s2">&quot;csi_images.csi_scans.Scan.Channel&quot;</span>
</span><span id="Scan.Channel-70"><a href="#Scan.Channel-70"><span class="linenos">70</span></a>
</span><span id="Scan.Channel-71"><a href="#Scan.Channel-71"><span class="linenos">71</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="Scan.Channel-72"><a href="#Scan.Channel-72"><span class="linenos">72</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="Scan.Channel-73"><a href="#Scan.Channel-73"><span class="linenos">73</span></a>            <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Scan.Channel-74"><a href="#Scan.Channel-74"><span class="linenos">74</span></a>            <span class="n">exposure_ms</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="Scan.Channel-75"><a href="#Scan.Channel-75"><span class="linenos">75</span></a>            <span class="n">intensity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="Scan.Channel-76"><a href="#Scan.Channel-76"><span class="linenos">76</span></a>            <span class="n">gain_applied</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Scan.Channel-77"><a href="#Scan.Channel-77"><span class="linenos">77</span></a>        <span class="p">):</span>
</span><span id="Scan.Channel-78"><a href="#Scan.Channel-78"><span class="linenos">78</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span><span id="Scan.Channel-79"><a href="#Scan.Channel-79"><span class="linenos">79</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">exposure_ms</span> <span class="o">=</span> <span class="n">exposure_ms</span>
</span><span id="Scan.Channel-80"><a href="#Scan.Channel-80"><span class="linenos">80</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="n">intensity</span>
</span><span id="Scan.Channel-81"><a href="#Scan.Channel-81"><span class="linenos">81</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gain_applied</span> <span class="o">=</span> <span class="n">gain_applied</span>
</span><span id="Scan.Channel-82"><a href="#Scan.Channel-82"><span class="linenos">82</span></a>
</span><span id="Scan.Channel-83"><a href="#Scan.Channel-83"><span class="linenos">83</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Scan.Channel-84"><a href="#Scan.Channel-84"><span class="linenos">84</span></a>            <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Scan.Channel-85"><a href="#Scan.Channel-85"><span class="linenos">85</span></a>
</span><span id="Scan.Channel-86"><a href="#Scan.Channel-86"><span class="linenos">86</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="Scan.Channel-87"><a href="#Scan.Channel-87"><span class="linenos">87</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Class that comprises a channel; we usually have multiple (2-5) per scan.
Contains three fields:</p>

<ul>
<li>name: the name of the channel (e.g. DAPI, AF647, AF555, AF488, BRIGHTFIELD)</li>
<li>exposure_ms: the exposure time to capture a frame in milliseconds</li>
<li>intensity: the light intensity used OR the gain applied to the channel</li>
</ul>
</div>


                            <div id="Scan.Channel.__init__" class="classattr">
                                        <input id="Scan.Channel.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Scan.Channel</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">exposure_ms</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>,</span><span class="param">	<span class="n">intensity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>,</span><span class="param">	<span class="n">gain_applied</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span>)</span>

                <label class="view-source-button" for="Scan.Channel.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scan.Channel.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scan.Channel.__init__-71"><a href="#Scan.Channel.__init__-71"><span class="linenos">71</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="Scan.Channel.__init__-72"><a href="#Scan.Channel.__init__-72"><span class="linenos">72</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="Scan.Channel.__init__-73"><a href="#Scan.Channel.__init__-73"><span class="linenos">73</span></a>            <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Scan.Channel.__init__-74"><a href="#Scan.Channel.__init__-74"><span class="linenos">74</span></a>            <span class="n">exposure_ms</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="Scan.Channel.__init__-75"><a href="#Scan.Channel.__init__-75"><span class="linenos">75</span></a>            <span class="n">intensity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="Scan.Channel.__init__-76"><a href="#Scan.Channel.__init__-76"><span class="linenos">76</span></a>            <span class="n">gain_applied</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Scan.Channel.__init__-77"><a href="#Scan.Channel.__init__-77"><span class="linenos">77</span></a>        <span class="p">):</span>
</span><span id="Scan.Channel.__init__-78"><a href="#Scan.Channel.__init__-78"><span class="linenos">78</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span><span id="Scan.Channel.__init__-79"><a href="#Scan.Channel.__init__-79"><span class="linenos">79</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">exposure_ms</span> <span class="o">=</span> <span class="n">exposure_ms</span>
</span><span id="Scan.Channel.__init__-80"><a href="#Scan.Channel.__init__-80"><span class="linenos">80</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="n">intensity</span>
</span><span id="Scan.Channel.__init__-81"><a href="#Scan.Channel.__init__-81"><span class="linenos">81</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gain_applied</span> <span class="o">=</span> <span class="n">gain_applied</span>
</span></pre></div>


    

                            </div>
                            <div id="Scan.Channel.yaml_tag" class="classattr">
                                <div class="attr variable">
            <span class="name">yaml_tag</span>        =
<span class="default_value">&#39;<a href="#Scan.Channel">Scan.Channel</a>&#39;</span>

        
    </div>
    <a class="headerlink" href="#Scan.Channel.yaml_tag"></a>
    
    

                            </div>
                            <div id="Scan.Channel.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span>

        
    </div>
    <a class="headerlink" href="#Scan.Channel.name"></a>
    
    

                            </div>
                            <div id="Scan.Channel.exposure_ms" class="classattr">
                                <div class="attr variable">
            <span class="name">exposure_ms</span>

        
    </div>
    <a class="headerlink" href="#Scan.Channel.exposure_ms"></a>
    
    

                            </div>
                            <div id="Scan.Channel.intensity" class="classattr">
                                <div class="attr variable">
            <span class="name">intensity</span>

        
    </div>
    <a class="headerlink" href="#Scan.Channel.intensity"></a>
    
    

                            </div>
                            <div id="Scan.Channel.gain_applied" class="classattr">
                                <div class="attr variable">
            <span class="name">gain_applied</span>

        
    </div>
    <a class="headerlink" href="#Scan.Channel.gain_applied"></a>
    
    

                            </div>
                </section>
                <section id="Scan.ROI">
                            <input id="Scan.ROI-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Scan.ROI</span><wbr>(<span class="base">yaml.YAMLObject</span>):

                <label class="view-source-button" for="Scan.ROI-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scan.ROI"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scan.ROI-89"><a href="#Scan.ROI-89"><span class="linenos"> 89</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ROI</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">YAMLObject</span><span class="p">):</span>
</span><span id="Scan.ROI-90"><a href="#Scan.ROI-90"><span class="linenos"> 90</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scan.ROI-91"><a href="#Scan.ROI-91"><span class="linenos"> 91</span></a><span class="sd">        Class that comprises an ROI; we usually have 1, but may have more in a scan.</span>
</span><span id="Scan.ROI-92"><a href="#Scan.ROI-92"><span class="linenos"> 92</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scan.ROI-93"><a href="#Scan.ROI-93"><span class="linenos"> 93</span></a>
</span><span id="Scan.ROI-94"><a href="#Scan.ROI-94"><span class="linenos"> 94</span></a>        <span class="n">yaml_tag</span> <span class="o">=</span> <span class="s2">&quot;csi_images.csi_scans.Scan.ROI&quot;</span>
</span><span id="Scan.ROI-95"><a href="#Scan.ROI-95"><span class="linenos"> 95</span></a>
</span><span id="Scan.ROI-96"><a href="#Scan.ROI-96"><span class="linenos"> 96</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="Scan.ROI-97"><a href="#Scan.ROI-97"><span class="linenos"> 97</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="Scan.ROI-98"><a href="#Scan.ROI-98"><span class="linenos"> 98</span></a>            <span class="n">origin_x_um</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan.ROI-99"><a href="#Scan.ROI-99"><span class="linenos"> 99</span></a>            <span class="n">origin_y_um</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan.ROI-100"><a href="#Scan.ROI-100"><span class="linenos">100</span></a>            <span class="n">width_um</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan.ROI-101"><a href="#Scan.ROI-101"><span class="linenos">101</span></a>            <span class="n">height_um</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan.ROI-102"><a href="#Scan.ROI-102"><span class="linenos">102</span></a>            <span class="n">tile_rows</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan.ROI-103"><a href="#Scan.ROI-103"><span class="linenos">103</span></a>            <span class="n">tile_cols</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan.ROI-104"><a href="#Scan.ROI-104"><span class="linenos">104</span></a>            <span class="n">focus_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Scan.ROI-105"><a href="#Scan.ROI-105"><span class="linenos">105</span></a>        <span class="p">):</span>
</span><span id="Scan.ROI-106"><a href="#Scan.ROI-106"><span class="linenos">106</span></a>            <span class="k">if</span> <span class="n">focus_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scan.ROI-107"><a href="#Scan.ROI-107"><span class="linenos">107</span></a>                <span class="n">focus_points</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scan.ROI-108"><a href="#Scan.ROI-108"><span class="linenos">108</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">origin_x_um</span> <span class="o">=</span> <span class="n">origin_x_um</span>
</span><span id="Scan.ROI-109"><a href="#Scan.ROI-109"><span class="linenos">109</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">origin_y_um</span> <span class="o">=</span> <span class="n">origin_y_um</span>
</span><span id="Scan.ROI-110"><a href="#Scan.ROI-110"><span class="linenos">110</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">width_um</span> <span class="o">=</span> <span class="n">width_um</span>
</span><span id="Scan.ROI-111"><a href="#Scan.ROI-111"><span class="linenos">111</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">height_um</span> <span class="o">=</span> <span class="n">height_um</span>
</span><span id="Scan.ROI-112"><a href="#Scan.ROI-112"><span class="linenos">112</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tile_rows</span> <span class="o">=</span> <span class="n">tile_rows</span>
</span><span id="Scan.ROI-113"><a href="#Scan.ROI-113"><span class="linenos">113</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tile_cols</span> <span class="o">=</span> <span class="n">tile_cols</span>
</span><span id="Scan.ROI-114"><a href="#Scan.ROI-114"><span class="linenos">114</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">focus_points</span> <span class="o">=</span> <span class="n">focus_points</span>
</span><span id="Scan.ROI-115"><a href="#Scan.ROI-115"><span class="linenos">115</span></a>
</span><span id="Scan.ROI-116"><a href="#Scan.ROI-116"><span class="linenos">116</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Scan.ROI-117"><a href="#Scan.ROI-117"><span class="linenos">117</span></a>            <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Scan.ROI-118"><a href="#Scan.ROI-118"><span class="linenos">118</span></a>
</span><span id="Scan.ROI-119"><a href="#Scan.ROI-119"><span class="linenos">119</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="Scan.ROI-120"><a href="#Scan.ROI-120"><span class="linenos">120</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
</span><span id="Scan.ROI-121"><a href="#Scan.ROI-121"><span class="linenos">121</span></a>
</span><span id="Scan.ROI-122"><a href="#Scan.ROI-122"><span class="linenos">122</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">similar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="Scan.ROI-123"><a href="#Scan.ROI-123"><span class="linenos">123</span></a>            <span class="k">return</span> <span class="p">(</span>
</span><span id="Scan.ROI-124"><a href="#Scan.ROI-124"><span class="linenos">124</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">origin_y_um</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">origin_y_um</span>
</span><span id="Scan.ROI-125"><a href="#Scan.ROI-125"><span class="linenos">125</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_x_um</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">origin_x_um</span>
</span><span id="Scan.ROI-126"><a href="#Scan.ROI-126"><span class="linenos">126</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">width_um</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">width_um</span>
</span><span id="Scan.ROI-127"><a href="#Scan.ROI-127"><span class="linenos">127</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">height_um</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">height_um</span>
</span><span id="Scan.ROI-128"><a href="#Scan.ROI-128"><span class="linenos">128</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_rows</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_rows</span>
</span><span id="Scan.ROI-129"><a href="#Scan.ROI-129"><span class="linenos">129</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_cols</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_cols</span>
</span><span id="Scan.ROI-130"><a href="#Scan.ROI-130"><span class="linenos">130</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Class that comprises an ROI; we usually have 1, but may have more in a scan.</p>
</div>


                            <div id="Scan.ROI.__init__" class="classattr">
                                        <input id="Scan.ROI.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Scan.ROI</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">origin_x_um</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>,</span><span class="param">	<span class="n">origin_y_um</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>,</span><span class="param">	<span class="n">width_um</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>,</span><span class="param">	<span class="n">height_um</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>,</span><span class="param">	<span class="n">tile_rows</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>,</span><span class="param">	<span class="n">tile_cols</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>,</span><span class="param">	<span class="n">focus_points</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="Scan.ROI.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scan.ROI.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scan.ROI.__init__-96"><a href="#Scan.ROI.__init__-96"><span class="linenos"> 96</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="Scan.ROI.__init__-97"><a href="#Scan.ROI.__init__-97"><span class="linenos"> 97</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="Scan.ROI.__init__-98"><a href="#Scan.ROI.__init__-98"><span class="linenos"> 98</span></a>            <span class="n">origin_x_um</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan.ROI.__init__-99"><a href="#Scan.ROI.__init__-99"><span class="linenos"> 99</span></a>            <span class="n">origin_y_um</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan.ROI.__init__-100"><a href="#Scan.ROI.__init__-100"><span class="linenos">100</span></a>            <span class="n">width_um</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan.ROI.__init__-101"><a href="#Scan.ROI.__init__-101"><span class="linenos">101</span></a>            <span class="n">height_um</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan.ROI.__init__-102"><a href="#Scan.ROI.__init__-102"><span class="linenos">102</span></a>            <span class="n">tile_rows</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan.ROI.__init__-103"><a href="#Scan.ROI.__init__-103"><span class="linenos">103</span></a>            <span class="n">tile_cols</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scan.ROI.__init__-104"><a href="#Scan.ROI.__init__-104"><span class="linenos">104</span></a>            <span class="n">focus_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Scan.ROI.__init__-105"><a href="#Scan.ROI.__init__-105"><span class="linenos">105</span></a>        <span class="p">):</span>
</span><span id="Scan.ROI.__init__-106"><a href="#Scan.ROI.__init__-106"><span class="linenos">106</span></a>            <span class="k">if</span> <span class="n">focus_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scan.ROI.__init__-107"><a href="#Scan.ROI.__init__-107"><span class="linenos">107</span></a>                <span class="n">focus_points</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scan.ROI.__init__-108"><a href="#Scan.ROI.__init__-108"><span class="linenos">108</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">origin_x_um</span> <span class="o">=</span> <span class="n">origin_x_um</span>
</span><span id="Scan.ROI.__init__-109"><a href="#Scan.ROI.__init__-109"><span class="linenos">109</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">origin_y_um</span> <span class="o">=</span> <span class="n">origin_y_um</span>
</span><span id="Scan.ROI.__init__-110"><a href="#Scan.ROI.__init__-110"><span class="linenos">110</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">width_um</span> <span class="o">=</span> <span class="n">width_um</span>
</span><span id="Scan.ROI.__init__-111"><a href="#Scan.ROI.__init__-111"><span class="linenos">111</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">height_um</span> <span class="o">=</span> <span class="n">height_um</span>
</span><span id="Scan.ROI.__init__-112"><a href="#Scan.ROI.__init__-112"><span class="linenos">112</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tile_rows</span> <span class="o">=</span> <span class="n">tile_rows</span>
</span><span id="Scan.ROI.__init__-113"><a href="#Scan.ROI.__init__-113"><span class="linenos">113</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tile_cols</span> <span class="o">=</span> <span class="n">tile_cols</span>
</span><span id="Scan.ROI.__init__-114"><a href="#Scan.ROI.__init__-114"><span class="linenos">114</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">focus_points</span> <span class="o">=</span> <span class="n">focus_points</span>
</span></pre></div>


    

                            </div>
                            <div id="Scan.ROI.yaml_tag" class="classattr">
                                <div class="attr variable">
            <span class="name">yaml_tag</span>        =
<span class="default_value">&#39;<a href="#Scan.ROI">Scan.ROI</a>&#39;</span>

        
    </div>
    <a class="headerlink" href="#Scan.ROI.yaml_tag"></a>
    
    

                            </div>
                            <div id="Scan.ROI.origin_x_um" class="classattr">
                                <div class="attr variable">
            <span class="name">origin_x_um</span>

        
    </div>
    <a class="headerlink" href="#Scan.ROI.origin_x_um"></a>
    
    

                            </div>
                            <div id="Scan.ROI.origin_y_um" class="classattr">
                                <div class="attr variable">
            <span class="name">origin_y_um</span>

        
    </div>
    <a class="headerlink" href="#Scan.ROI.origin_y_um"></a>
    
    

                            </div>
                            <div id="Scan.ROI.width_um" class="classattr">
                                <div class="attr variable">
            <span class="name">width_um</span>

        
    </div>
    <a class="headerlink" href="#Scan.ROI.width_um"></a>
    
    

                            </div>
                            <div id="Scan.ROI.height_um" class="classattr">
                                <div class="attr variable">
            <span class="name">height_um</span>

        
    </div>
    <a class="headerlink" href="#Scan.ROI.height_um"></a>
    
    

                            </div>
                            <div id="Scan.ROI.tile_rows" class="classattr">
                                <div class="attr variable">
            <span class="name">tile_rows</span>

        
    </div>
    <a class="headerlink" href="#Scan.ROI.tile_rows"></a>
    
    

                            </div>
                            <div id="Scan.ROI.tile_cols" class="classattr">
                                <div class="attr variable">
            <span class="name">tile_cols</span>

        
    </div>
    <a class="headerlink" href="#Scan.ROI.tile_cols"></a>
    
    

                            </div>
                            <div id="Scan.ROI.focus_points" class="classattr">
                                <div class="attr variable">
            <span class="name">focus_points</span>

        
    </div>
    <a class="headerlink" href="#Scan.ROI.focus_points"></a>
    
    

                            </div>
                            <div id="Scan.ROI.similar" class="classattr">
                                        <input id="Scan.ROI.similar-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">similar</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">other</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Scan.ROI.similar-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scan.ROI.similar"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scan.ROI.similar-122"><a href="#Scan.ROI.similar-122"><span class="linenos">122</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">similar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="Scan.ROI.similar-123"><a href="#Scan.ROI.similar-123"><span class="linenos">123</span></a>            <span class="k">return</span> <span class="p">(</span>
</span><span id="Scan.ROI.similar-124"><a href="#Scan.ROI.similar-124"><span class="linenos">124</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">origin_y_um</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">origin_y_um</span>
</span><span id="Scan.ROI.similar-125"><a href="#Scan.ROI.similar-125"><span class="linenos">125</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_x_um</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">origin_x_um</span>
</span><span id="Scan.ROI.similar-126"><a href="#Scan.ROI.similar-126"><span class="linenos">126</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">width_um</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">width_um</span>
</span><span id="Scan.ROI.similar-127"><a href="#Scan.ROI.similar-127"><span class="linenos">127</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">height_um</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">height_um</span>
</span><span id="Scan.ROI.similar-128"><a href="#Scan.ROI.similar-128"><span class="linenos">128</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_rows</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_rows</span>
</span><span id="Scan.ROI.similar-129"><a href="#Scan.ROI.similar-129"><span class="linenos">129</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_cols</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tile_cols</span>
</span><span id="Scan.ROI.similar-130"><a href="#Scan.ROI.similar-130"><span class="linenos">130</span></a>            <span class="p">)</span>
</span></pre></div>


    

                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>